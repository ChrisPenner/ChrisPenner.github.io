<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Chris Penner</title>
    <link href="https://chrispenner.ca/atom.xml" rel="self" type="application/rss+xml" />
  <updated>2019-10-16T18:24:15Z</updated>
  <author>
      <name>Chris Penner</name>
  </author>
  <id>https://chrispenner.ca/</id>

  <entry>
      <title>Beating C with 80 lines of Haskell: wc</title>
      <link href="https://chrispenner.ca/posts/wc"/>
      <id>https://chrispenner.ca/posts/wc</id>
      <updated>2019-10-15T00:00:00Z</updated>
      <summary>An exploration into high-performance Haskell by cloning the wc utility</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/words.jpg" alt="Beating C with 80 lines of Haskell: wc">
              <p>Despite the click-bait title I hope you'll find this post generally illuminating, or at the very least a bit of fun! This article makes no claims that Haskell is "better" than C, nor does it make claims about the respective value of either language, or either implementation. It's simply an exploration into high-performance Haskell, with a few fun tricks and hacks along the way.</p>
<p>You can find source code for this post <a href="https://github.com/ChrisPenner/wc">here</a>.</p>
<p>For reference, I'm using the Mac's version of <code>wc</code>; you can find <a href="https://opensource.apple.com/source/text_cmds/text_cmds-68/wc/wc.c.auto.html">reference source code here</a>. Yes, there are faster <code>wc</code> implementations out there.</p>
<p>The challenge is to build a <em>faster</em> clone of the hand-optimized C implementation of the <code>wc</code> utility in our favourite high-level garbage-collected runtime-based language: Haskell! Sounds simple enough right?</p>
<p>Here's the criteria we'll be considering as we go along:</p>
<ul>
<li>Correctness: Should return identical character, word, and line counts as <code>wc</code> on the test files.</li>
<li>Speed (wall-clock-time): How do we compare to the execution time of <code>wc</code>?</li>
<li>Max Resident Memory: What's the peak of our memory usage? Is our memory usage constant, linear, or otherwise?</li>
</ul>
<p>Those are the main things we need to worry about.</p>
<p>Let's dive in.</p>
<h2 id="the-dumbest-thing-that-could-possibly-work">The dumbest thing that could possibly work</h2>
<p>As always, we should start by just trying the dumbest possible thing and see how it goes. We can build up from there. What's the dumbest way to count characters, lines, and words in Haskell? Well, we could read the file, then run the functions <code>length</code>,<code>length . words</code>, and <code>length . lines</code> to get our counts!</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">stupid ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a>stupid fp <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    contents <span class="ot">&lt;-</span> <span class="fu">readFile</span> fp</span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="fu">return</span> (<span class="fu">length</span> s, <span class="fu">length</span> (<span class="fu">words</span> s), <span class="fu">length</span> (<span class="fu">lines</span> s))</span></code></pre></div>
<p>Amazingly enough, this actually DOES work, and gets us the same answers as <code>wc</code>, IF you're willing to wait for it... I got sick of waiting for it to finish on my large test file (it was taking more than a few minutes), but on a smaller test file (90 MB) got the following results:</p>
<p>90 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>stupid-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>0.37s</td>
<td>17.07s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.86 MB</td>
<td>2403 MB</td>
</tr>
</tbody>
</table>
<p>Yikes... Needless to say there's some room for improvement...</p>
<h2 id="being-slightly-less-dumb">Being slightly less dumb</h2>
<p>Let's think about why this is doing so poorly; the first thing that comes to mind is that we're iterating through the contents of the file 3 separate times! This also means GHC can't garbage collect our list as we iterate through it since we're still using it in other places. The fact that we're keeping every character of the file in a linked list helps explain the 2.4 GB of memory on a file that's only 90 MB! Ouch!</p>
<p>Okay, so that's REALLY not great. Let's see if we can get this down to a SINGLE pass over the structure. We're accumulating 3 simple things, so maybe we can process all three parts at once? When iterating through a structure to get one final result I reach for folds!</p>
<p>It's pretty easy to use a fold to count characters or lines; the character count always adds one to the total, the line count adds one when the current character is a newline; but what about the word count? We can't add one on every space character because consecutive spaces doesn't count as a new word! We'll need to keep track of whether the previous character was a space, and only add one to the counter whenever we start a completely <strong>new</strong> word. That's not too tough to do; we'll use <code>foldl'</code> from <code>Data.List</code> for our implementation.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">import</span> <span class="dt">Data.List</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">import</span> <span class="dt">Data.Char</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="ot">simpleFold ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a>simpleFold fp <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>    countFile <span class="op">&lt;$&gt;</span> <span class="fu">readFile</span> fp</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="ot">countFile ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>)</span>
<span id="cb2-9"><a href="#cb2-9"></a>countFile s <span class="ot">=</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="kw">let</span> (cs, ws, ls, _) <span class="ot">=</span> foldl&#39; go (<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dt">False</span>) s</span>
<span id="cb2-11"><a href="#cb2-11"></a>     <span class="kw">in</span> (cs, ws, ls)</span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="kw">where</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="ot">    go ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Bool</span>)</span>
<span id="cb2-14"><a href="#cb2-14"></a>    go (cs, ws, ls, wasSpace) c <span class="ot">=</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>        <span class="kw">let</span> addLine <span class="op">|</span> c <span class="op">==</span> <span class="ch">&#39;\n&#39;</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>                    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>            addWord <span class="op">|</span> wasSpace <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>                    <span class="op">|</span> <span class="fu">isSpace</span> c <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>                    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>         <span class="kw">in</span> (cs <span class="op">+</span> <span class="dv">1</span>, ws <span class="op">+</span> addWord, ls <span class="op">+</span> addLine, <span class="fu">isSpace</span> c)</span></code></pre></div>
<p>Running this version we run into an even worse problem! The program takes more than a few minutes and quickly spikes up to more than 3 GB of memory! What's gone wrong? Well, we used the strict version of <code>foldl</code> (indicated by the trailing tick <code>'</code>); BUT it's only strict up to "Weak Head Normal Form" (WHNF), which means it'll be strict in the <strong>structure</strong> of the tuple accumulator, but not the actual values! That's annoying, because it means we're building up a HUGE thunk of additions that we never fully evaluate until we've finished iterating through the whole file! Sometimes laziness sneaks in and bites us like this. This is the sort of memory leak that can easily take down web-servers if you aren't careful!</p>
<p>90 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>simple-fold-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>0.37s</td>
<td>longer than I want to wait</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.86 MB</td>
<td>&gt; 3 GB</td>
</tr>
</tbody>
</table>
<p>We can fix it by telling GHC to strictly evaluate the contents of the tuple on ever iteration. An easy way to do that is with the <code>BangPatterns</code> extension; it lets us use <code>!</code> in our argument list to force evaluation on each run of the function. Here's the new version of <code>go</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="ot">{-# LANGUAGE BangPatterns #-}</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="op">...</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="ot">    go ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Bool</span>)</span>
<span id="cb3-5"><a href="#cb3-5"></a>    go (<span class="op">!</span>cs, <span class="op">!</span>ws, <span class="op">!</span>ls, <span class="op">!</span>wasSpace) c <span class="ot">=</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>        <span class="kw">let</span> addLine <span class="op">|</span> c <span class="op">==</span> <span class="ch">&#39;\n&#39;</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>                    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>            addWord <span class="op">|</span> wasSpace <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>                    <span class="op">|</span> <span class="fu">isSpace</span> c <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>                    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>         <span class="kw">in</span> (cs <span class="op">+</span> <span class="dv">1</span>, ws <span class="op">+</span> addWord, ls <span class="op">+</span> addLine, <span class="fu">isSpace</span> c)</span></code></pre></div>
<p>That simple change speeds things up like <strong>CRAZY</strong>; here's our new performance breakdown:</p>
<p>90 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>strict-fold-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>0.37s</td>
<td>8.12s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.86 MB</td>
<td>3.7 MB</td>
</tr>
</tbody>
</table>
<p>Okay; so we're doing WAY better on memory now, a few MBs of memory on a 90 MB file means we must finally be streaming the file contents properly! Even though laziness has already bitten us on this problem, now that we've localized the laziness into the right places it provides us with streaming for free! The streaming happens naturally because <code>readFile</code> actually does <strong>lazy IO</strong>; which can be a real nuisance sometimes for things like web servers since you're never quite sure when the IO is happening, but in our case it gives us much better memory residency.</p>
<h2 id="better-with-bytestrings">Better with ByteStrings</h2>
<p>We can probably stop worrying about memory for now, so we're back to crunching for performance! One thing I can think to try there to switch to using a ByteString rather than a String. Using a String means we're implicitly decoding the file as we read it, which takes time, AND we have the overhead of using a linked list for the whole thing, we can't easily take advantage of batching or buffering our data as we read it.</p>
<p>This change is actually laughably easy, the <code>bytestring</code> package provides the module: <code>Data.ByteString.Lazy.Char8</code>, which provides operations for working with Lazy ByteStrings as though they were strings of characters, but with all the performance benefits of ByteStrings. Note that it DOESN'T actually verify that each byte is a valid Character, or do any decoding, so it's on us to make sure we're passing it valid data. By default <code>wc</code> assumes its input is ASCII, so I think we're safe to do the same. If our input is ASCII then the functions in this module will behave sensibly.</p>
<p>Literally the only changes I need to make are to switch the <code>Data.List</code> import to <code>Data.ByteString.Lazy.Char8</code> and then switch the <code>readFile</code> and <code>foldl'</code> functions to their ByteString versions:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">import</span> <span class="dt">Data.Char</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span> <span class="kw">as</span> <span class="dt">BS</span></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ot">simpleFold ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>)</span>
<span id="cb4-5"><a href="#cb4-5"></a>simpleFold fp <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    simpleFoldCountFile <span class="op">&lt;$&gt;</span> BS.readFile fp</span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="ot">simpleFoldCountFile ::</span> <span class="dt">BS.ByteString</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>)</span>
<span id="cb4-9"><a href="#cb4-9"></a>simpleFoldCountFile s <span class="ot">=</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="kw">let</span> (cs, ws, ls, _) <span class="ot">=</span> BS.foldl&#39; go (<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dt">False</span>) s</span>
<span id="cb4-11"><a href="#cb4-11"></a>     <span class="kw">in</span> (cs, ws, ls)</span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="kw">where</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="ot">    go ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Bool</span>)</span>
<span id="cb4-14"><a href="#cb4-14"></a>    go (<span class="op">!</span>cs, <span class="op">!</span>ws, <span class="op">!</span>ls, <span class="op">!</span>wasSpace) c <span class="ot">=</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>        <span class="kw">let</span> addLine <span class="op">|</span> c <span class="op">==</span> <span class="ch">&#39;\n&#39;</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>                    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>            addWord <span class="op">|</span> wasSpace <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>                    <span class="op">|</span> <span class="fu">isSpace</span> c <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>                    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>         <span class="kw">in</span> (cs <span class="op">+</span> <span class="dv">1</span>, ws <span class="op">+</span> addWord, ls <span class="op">+</span> addLine, <span class="fu">isSpace</span> c)</span></code></pre></div>
<p>This little change chops our time down by nearly half!</p>
<p>90 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>strict-fold-wc</th>
<th>bs-fold-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>0.37s</td>
<td>8.12s</td>
<td>3.41s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.86 MB</td>
<td>3.7 MB</td>
<td>5.48 MB</td>
</tr>
</tbody>
</table>
<p>So we're clearly still making some progress. Our memory usage has increased slightly, but it still seems to be a constant overhead. We're still orders of magnitude away from <code>wc</code> unfortunately; let's see if there's anything else we could do.</p>
<h2 id="moving-to-monoids">Moving to Monoids</h2>
<p>At this point I feel like experimenting a little. Modern PC's tend to have multiple cores, and it seems as though newer machines scale up the number of cores moreso than their processor speed, so it would be beneficial to take advantage of that.</p>
<p>Splitting up a computation like this isn't exactly trivial. In order to use multiple cores we'll need to split up the job into pieces. In theory this is easy, just split the file into chunks and give one chunk to each core! As you think a bit deeper about it the problems start to appear; combining character counts is pretty easy, we can just sum the totals from each chunk. The same with line-counts, but word counts pose a problem! What happens if we split in the middle of a word, or in the middle of several consecutive spaces? In order to combine the word counts we'd need to keep track of the starting and end state of each chunk and be intelligent when we combine them together. That sounds like a lot of book-keeping that I don't really want to do.</p>
<p>Monoids to the rescue! The associative laws of a Monoid mean that so long as we can develop a lawful monoid it WILL work properly in spite of this type of parallelism. That really just passes the buck down the line though, is it possible to write a Monoid that can handle the complexities of word-counting like this?</p>
<p>It sure is! It may not be immediately apparent how a monoid like this works, but there's a class of counting problems that all fall into the same category like this, and luckily for me I've worked on these before. Basically we need to count the number of times a given invariant has <strong>changed</strong> from the start to the end of a sequence. I've generalized this class of monoid before, naming them <a href="http://hackage.haskell.org/package/flux-monoid"><code>flux</code> monoids</a>. What we need to do is count the number of times we change from characters which ARE spaces to those which AREN'T spaces. We could probably express this using the <code>Flux</code> monoid itself, but since we need to be so careful about strictness and performance I'm going to define a bespoke version of the Flux monoid for our purposes. Check this out:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">data</span> <span class="dt">CharType</span> <span class="ot">=</span> <span class="dt">IsSpace</span> <span class="op">|</span> <span class="dt">NotSpace</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>    <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="kw">data</span> <span class="dt">Flux</span> <span class="ot">=</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="dt">Flux</span> <span class="op">!</span><span class="dt">CharType</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>         <span class="ot">{-# UNPACK #-}</span> <span class="op">!</span><span class="dt">Int</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>         <span class="op">!</span><span class="dt">CharType</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="op">|</span> <span class="dt">Unknown</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="kw">deriving</span> <span class="dt">Show</span></span></code></pre></div>
<p>We need these types only for the word-counting part of our solution.</p>
<p>The <code>CharType</code> says whether a given character is considered a space or not; then the <code>Flux</code> type represents a chunk of text, storing fields for whether the left-most character is a space, how many words are in the full block of text, and whether the right-most character is a space. We don't actually keep the text in the structure since we don't need it for this problem. I've <code>UNPACK</code>ed the <code>Int</code> and made all the fields strict to ensure we won't run into the same problems we did with lazy tuples earlier. Using a strict data type means I don't need to use BangPatterns in my computations.</p>
<p>Next we need a semigroup and Monoid instance for this type!</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">instance</span> <span class="dt">Semigroup</span> <span class="dt">Flux</span> <span class="kw">where</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="dt">Unknown</span> <span class="op">&lt;&gt;</span> x <span class="ot">=</span> x</span>
<span id="cb6-3"><a href="#cb6-3"></a>  x <span class="op">&lt;&gt;</span> <span class="dt">Unknown</span> <span class="ot">=</span> x</span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="dt">Flux</span> l n <span class="dt">NotSpace</span> <span class="op">&lt;&gt;</span> <span class="dt">Flux</span> <span class="dt">NotSpace</span> n&#39; r <span class="ot">=</span> <span class="dt">Flux</span> l (n <span class="op">+</span> n&#39; <span class="op">-</span> <span class="dv">1</span>) r</span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="dt">Flux</span> l n _ <span class="op">&lt;&gt;</span> <span class="dt">Flux</span> _ n&#39; r <span class="ot">=</span> <span class="dt">Flux</span> l (n <span class="op">+</span> n&#39;) r</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="kw">instance</span> <span class="dt">Monoid</span> <span class="dt">Flux</span> <span class="kw">where</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="fu">mempty</span> <span class="ot">=</span> <span class="dt">Unknown</span></span></code></pre></div>
<p>The <code>Unknown</code> constructor is there to represent a Monoidal identity, we could actually leave it out and use <code>Maybe</code> to promote our Semigroup into a Monoid, but <code>Maybe</code> introduces unwanted laziness into our semigroup append! I just define it as part of the type for simplicity.</p>
<p>The <code>(&lt;&gt;)</code> operation we define checks whether the join-point of our two text blocks happens in the middle of a word, if it does then we must have counted the start and end of the same word separately, so we subtract one when we add the word totals to make it all balance out.</p>
<p>Lastly we need a way to build a <code>Flux</code> object from individual characters.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">flux ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Flux</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>flux c <span class="op">|</span> <span class="fu">isSpace</span> c <span class="ot">=</span> <span class="dt">Flux</span> <span class="dt">IsSpace</span> <span class="dv">0</span> <span class="dt">IsSpace</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>       <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dt">Flux</span> <span class="dt">NotSpace</span> <span class="dv">1</span> <span class="dt">NotSpace</span></span></code></pre></div>
<p>This is simple enough, we count non-space characters as 'words' which start and end with non-space charactes and for spaces have an empty word count surrounded on both sides with space chars.</p>
<p>It may not be immediately clear, but that's all we need to count words monoidally!</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="fu">foldMap</span> flux <span class="st">&quot;testing one two three&quot;</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="dt">Flux</span> <span class="dt">NotSpace</span> <span class="dv">4</span> <span class="dt">NotSpace</span></span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="op">&gt;&gt;&gt;</span> <span class="fu">foldMap</span> flux <span class="st">&quot;testing on&quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">foldMap</span> flux <span class="st">&quot;e two three&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="dt">Flux</span> <span class="dt">NotSpace</span> <span class="dv">4</span> <span class="dt">NotSpace</span></span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="op">&gt;&gt;&gt;</span> <span class="fu">foldMap</span> flux <span class="st">&quot;testing one &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">foldMap</span> flux <span class="st">&quot; two three&quot;</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="dt">Flux</span> <span class="dt">NotSpace</span> <span class="dv">4</span> <span class="dt">NotSpace</span></span></code></pre></div>
<p>Looks like it's working fine!</p>
<p>We've got the word count part covered, now we need the Monoidal version of the char count and line count. This is a snap to build:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">data</span> <span class="dt">Counts</span> <span class="ot">=</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>    <span class="dt">Counts</span> {<span class="ot"> charCount ::</span> <span class="ot">{-# UNPACK #-}</span> <span class="op">!</span><span class="dt">Int</span></span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a>           ,<span class="ot"> wordCount ::</span>  <span class="op">!</span><span class="dt">Flux</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>           ,<span class="ot"> lineCount ::</span> <span class="ot">{-# UNPACK #-}</span> <span class="op">!</span><span class="dt">Int</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>           }</span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="kw">instance</span> <span class="dt">Semigroup</span> <span class="dt">Counts</span> <span class="kw">where</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>  (<span class="dt">Counts</span> a b c) <span class="op">&lt;&gt;</span> (<span class="dt">Counts</span> a&#39; b&#39; c&#39;) <span class="ot">=</span> <span class="dt">Counts</span> (a <span class="op">+</span> a&#39;) (b <span class="op">&lt;&gt;</span> b&#39;) (c <span class="op">+</span> c&#39;)</span>
<span id="cb9-11"><a href="#cb9-11"></a></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="kw">instance</span> <span class="dt">Monoid</span> <span class="dt">Counts</span> <span class="kw">where</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="fu">mempty</span> <span class="ot">=</span> <span class="dt">Counts</span> <span class="dv">0</span> <span class="fu">mempty</span> <span class="dv">0</span></span></code></pre></div>
<p>No problem! Similarly we'll need a way to turn a single char into a <code>Counts</code> object:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">countChar ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Counts</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>countChar c <span class="ot">=</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="dt">Counts</span> { charCount <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>           , wordCount <span class="ot">=</span> flux c</span>
<span id="cb10-5"><a href="#cb10-5"></a>           , lineCount <span class="ot">=</span> <span class="kw">if</span> (c <span class="op">==</span> <span class="ch">&#39;\n&#39;</span>) <span class="kw">then</span> <span class="dv">1</span> <span class="kw">else</span> <span class="dv">0</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>           }</span></code></pre></div>
<p>Let's try that out too:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="fu">foldMap</span> countChar <span class="st">&quot;one two\nthree&quot;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="dt">Counts</span> {charCount <span class="ot">=</span> <span class="dv">13</span>, wordCount <span class="ot">=</span> <span class="dt">Flux</span> <span class="dt">NotSpace</span> <span class="dv">3</span> <span class="dt">NotSpace</span>, lineCount <span class="ot">=</span> <span class="dv">1</span>}</span></code></pre></div>
<p>Looks good to me! Experiment to your heart's content to convince yourself it's a lawful Monoid.</p>
<p>With a lawful Monoid we no longer need to worry about how we split our file up!</p>
<p>Before going any further, let's try using our monoid with our existing code and make sure it gets the same answers.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">module</span> <span class="dt">MonoidBSFold</span> <span class="kw">where</span></span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="kw">import</span> <span class="dt">Data.Char</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span> <span class="kw">as</span> <span class="dt">BS</span></span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="ot">monoidBSFold ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Counts</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>monoidBSFold paths <span class="ot">=</span> monoidFoldFile <span class="op">&lt;$&gt;</span> BS.readFile fp</span>
<span id="cb12-8"><a href="#cb12-8"></a></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="ot">monoidFoldFile ::</span> <span class="dt">BS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Counts</span></span>
<span id="cb12-10"><a href="#cb12-10"></a>monoidFoldFile <span class="ot">=</span> BS.foldl&#39; (\a b <span class="ot">-&gt;</span> a <span class="op">&lt;&gt;</span> countChar b) <span class="fu">mempty</span></span></code></pre></div>
<p>We've moved some complexity into our <code>Counts</code> type, which allows us to really simplify our implementation here. This is nice in general because it's much easier to test a single data-type rather than testing EVERYWHERE that we do this fold.</p>
<p>As a side benefit, this change has <em>somehow</em> sped things up even more!</p>
<p>We're in the ballpark now!</p>
<p>90 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>strict-bs-fold-wc</th>
<th>monoid-bs-fold-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>0.37s</td>
<td>3.41s</td>
<td>1.94s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.86 MB</td>
<td>5.48 MB</td>
<td>3.83 MB</td>
</tr>
</tbody>
</table>
<p>We've knocked off a good chunk of time AND memory with this change... I'll admit I have no idea WHY, but I won't look a gift-horse in the mouth. It's possible that by using a fully strict data structure we've strictified some laziness that snuck in somewhere; but I'm really not sure. If you can see what happened please let me know!</p>
<p><strong>UPDATE</strong>: <strong>guibou</strong> pointed out to me that our <code>Flux</code> and <code>Counts</code> type use <code>UNPACK</code> pragmas, whereas beforehand we used a regular ol' tuple. Apparently GHC is sometimes smart enough to UNPACK tuples, but it's likely that wasn't happening in this case. By <code>UNPACK</code>ing we can save a few pointer indirections and use less memory!</p>
<h2 id="inlining-away">Inlining away!</h2>
<p>Next in our quest, I think I'll inline some definitions! Why? Because that's just what you do when you want performance! We can use the <code>INLINE</code> pragma to tell GHC that our function is performance critical and it'll inline it for us; possibly triggering further optimizations down the line.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="ot">monoidBSFold ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Counts</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>monoidBSFold paths <span class="ot">=</span> monoidBSFoldFile <span class="op">&lt;$&gt;</span> BS.readFile fp</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="ot">{-# INLINE monoidBSFold #-}</span></span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="ot">monoidBSFoldFile ::</span> <span class="dt">BS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Counts</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>monoidBSFoldFile <span class="ot">=</span> BS.foldl&#39; (\a b <span class="ot">-&gt;</span> a <span class="op">&lt;&gt;</span> countChar b) <span class="fu">mempty</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="ot">{-# INLINE monoidBSFoldFile #-}</span></span></code></pre></div>
<p>I also went ahead and added INLINE's to our <code>countChar</code> and <code>flux</code> functions. Let's see if it made any difference:</p>
<p>90 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>original</th>
<th>inlined</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>1.94s</td>
<td>0.47s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>3.83 MB</td>
<td>4.35 MB</td>
</tr>
</tbody>
</table>
<p>Interestingly it seems to have slashed our time down by 75%! I'm really not sure if this is a fluke, or if we stumbled upon something lucky here; but I'll take it! It's bumped up our memory usage by a smidge; but not enough for me to worry.</p>
<p>Here's how we compare to the C version now:</p>
<p>90 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>inlined-monoid-bs-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>0.37s</td>
<td>0.47s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.86 MB</td>
<td>4.35 MB</td>
</tr>
</tbody>
</table>
<p>At this point we're pretty close to parity with <code>wc</code>; but we're looking at sub-second times, so I'm going to bump up the size of our test file and run a few times to see if we can learn anything new.</p>
<p>I bumped up to a 543 MB plaintext file and ran it a few times in a row to get the caches warmed up. This is clearly important because my times dropped a full 33% after a few runs. I understand my testing method isn't exactly "scientific", but it gives us a good estimate of how we're doing. Anyways, on the much larger file here's how we perform:</p>
<p>543 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>inlined-monoid-bs-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>2.06s</td>
<td>2.73s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.85 MB</td>
<td>3.97 MB</td>
</tr>
</tbody>
</table>
<p>From here we can see that we're actually getting pretty close! Considering we've cloned <code>wc</code> in a high-level garbage collected language in around 80 lines of code I'd say we're doing alright!</p>
<h2 id="using-our-cores">Using our Cores</h2>
<p>One may not expect parallelizing to multiple cores to do a whole lot since presumably this whole operation is IO bounded, but I'm going to do it anyways because I'm stubborn and bored.</p>
<p>We've already expressed our problem as a Monoid, which means it should be pretty trivial to split up the computation! The trick here is actually in reading in our data. If we try to read in all the data and THEN split it into chunks we'll have to load the whole file into memory at once, which is going to be REALLY bad for our memory residency, and will probably hurt our performance too! We could try <strong>streaming</strong> it in and splitting it that way, but then we have to <strong>process</strong> the first chunk before we get to the second split; and hopefully you can see the problem there. Instead I'm going to spin up a separate thread for each core we have then open a separate file handle in each of those threads. Then I'll seek each Handle to disjoint offsets and perform our operation on each non-overlapping piece of the file that way before combining the counts together.</p>
<p>Here's the whole thing, did I mention how much I <strong>love</strong> writing concurrent code in Haskell?</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">import</span> <span class="dt">Types</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="kw">import</span> <span class="dt">Control.Monad</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="kw">import</span> <span class="dt">Data.Traversable</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="kw">import</span> <span class="dt">Data.Bits</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="kw">import</span> <span class="dt">GHC.Conc</span> (numCapabilities)</span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="kw">import</span> <span class="dt">Control.Concurrent.Async</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="kw">import</span> <span class="dt">Data.Foldable</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="kw">import</span> <span class="dt">System.IO</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="kw">import</span> <span class="dt">System.Posix.Files</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy.Char8</span> <span class="kw">as</span> <span class="dt">BL</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="kw">import</span> <span class="dt">Data.ByteString.Internal</span> (c2w)</span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="kw">import</span> <span class="dt">GHC.IO.Handle</span></span>
<span id="cb14-13"><a href="#cb14-13"></a></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="ot">multiCoreCount ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Counts</span></span>
<span id="cb14-15"><a href="#cb14-15"></a>multiCoreCount fp <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb14-16"><a href="#cb14-16"></a>    <span class="fu">putStrLn</span> (<span class="st">&quot;Using available cores: &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> numCapabilities)</span>
<span id="cb14-17"><a href="#cb14-17"></a>    size <span class="ot">&lt;-</span> <span class="fu">fromIntegral</span> <span class="op">.</span> fileSize <span class="op">&lt;$&gt;</span> getFileStatus fp</span>
<span id="cb14-18"><a href="#cb14-18"></a>    <span class="kw">let</span> chunkSize <span class="ot">=</span> <span class="fu">fromIntegral</span> (size <span class="ot">`div`</span> numCapabilities)</span>
<span id="cb14-19"><a href="#cb14-19"></a>    fold <span class="op">&lt;$!&gt;</span> (forConcurrently [<span class="dv">0</span><span class="op">..</span>numCapabilities<span class="op">-</span><span class="dv">1</span>] <span class="op">$</span> \n <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb14-20"><a href="#cb14-20"></a>        <span class="co">-- Take all remaining bytes on the last capability due to integer division anomolies</span></span>
<span id="cb14-21"><a href="#cb14-21"></a>        <span class="kw">let</span> limiter <span class="ot">=</span> <span class="kw">if</span> n <span class="op">==</span> numCapabilities <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-22"><a href="#cb14-22"></a>                         <span class="kw">then</span> <span class="fu">id</span></span>
<span id="cb14-23"><a href="#cb14-23"></a>                         <span class="kw">else</span> BL.take (<span class="fu">fromIntegral</span> chunkSize)</span>
<span id="cb14-24"><a href="#cb14-24"></a>        <span class="kw">let</span> offset <span class="ot">=</span> <span class="fu">fromIntegral</span> (n <span class="op">*</span> chunkSize)</span>
<span id="cb14-25"><a href="#cb14-25"></a>        fileHandle <span class="ot">&lt;-</span> openBinaryFile fp <span class="dt">ReadMode</span></span>
<span id="cb14-26"><a href="#cb14-26"></a>        hSeek fileHandle <span class="dt">AbsoluteSeek</span> offset</span>
<span id="cb14-27"><a href="#cb14-27"></a>        countBytes <span class="op">.</span> limiter <span class="op">&lt;$!&gt;</span> BL.hGetContents fileHandle)</span>
<span id="cb14-28"><a href="#cb14-28"></a><span class="ot">{-# INLINE handleSplitUTF #-}</span></span>
<span id="cb14-29"><a href="#cb14-29"></a></span>
<span id="cb14-30"><a href="#cb14-30"></a><span class="ot">countBytes ::</span> <span class="dt">BL.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Counts</span></span>
<span id="cb14-31"><a href="#cb14-31"></a>countBytes <span class="ot">=</span> BL.foldl&#39; (\a b <span class="ot">-&gt;</span> a <span class="op">&lt;&gt;</span> countChar b) <span class="fu">mempty</span></span>
<span id="cb14-32"><a href="#cb14-32"></a><span class="ot">{-# INLINE countBytes #-}</span></span></code></pre></div>
<p>There's a lot going on here, so I'll break it down as best I can.</p>
<p>We can import the number of "capabilities" available to our program (i.e. the number of cores we have access to) from <code>GHC.Conc</code>. From there, we run a fileStat on the file we want to count to get the number of bytes in the file. From there, we use integer division to determine how many bytes should be handled by each individual core. The integer division rounds the result down, so we'll have to be careful to pick up the bytes that were possibly left out later on. We then use <code>forConcurrently</code> from <code>Control.Concurrent.Async</code> to run a separate thread for each of our capabilities.</p>
<p>Inside each thread we check whether we're inside the thread which handls the LAST chunk of the file, if we are we should read until the EOF to pick up the leftover bytes from the earlier rounding error, otherwise we want to limit ourselves to processing only <code>chunkSize</code> bytes. Then we can calculate our offset into the file by multiplying the chunk size by our thread number. We open a binary file handle and use <code>hSeek</code> to move our handle to the starting offset for our thread. From this point we can simply read our allocated number of bytes and fold them down using the same logic as before. After we've handled each of the threads, we'll use a simple <code>fold</code> to combine the counts of each chunk into a total count.</p>
<p>We use <code>&lt;$!&gt;</code> in a few spots to add additional strictness since we want to ensure that the folding operations happen within each thread, instead of after the threads have been joined. I might go a little overboard on strictness annotations, but it's easier to add too many than it is to track down the places we've accidentally missed them.</p>
<p>Let's take this puppy out for a spin!</p>
<p>After warming up the caches I ran each of them a few times on my 4 core 2013 Macbook Pro with an SSD, and averaged the results together:</p>
<p>543 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>multicore-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>2.07s</td>
<td>1.23s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.87 MB</td>
<td>7.06 MB</td>
</tr>
</tbody>
</table>
<p>It seems to make a pretty big difference! We're actually going FASTER than some C code that's been hand optimized for a few decades. These results are best taken with a hefty grain of salt; it's really hard to tell what sort of caching is going on here. There are probably mutliple layers of disk caching happening. Maybe the multithreading only helps when reading files from a cache?</p>
<p>I did a bit of skimming and it seems that SOME storage devices might experience a speed-up from doing file reads in parallel, some may actually slow down. Your mileage may vary. If anyone's an expert on SSDs I'd love to hear from you on this one. Regardless I'm still pretty happy with the results.</p>
<p><strong>UPDATE</strong>: Turns out some folks out there ARE experts on SSDs! Paul Tanner wrote me an email explaining that modern NVME drives can typically benefit from this sort of parallelism, so long as we're not accessing the same block (and here we're not). Unfortunately, my ancient macbook doesn't have one, but on the plus side that means this code might actually run even FASTER on a modern drive. Thanks Paul!</p>
<p>In case you're wondering, the actual <code>User</code> time for our program comes in at <code>4.22s</code> (which is split across the 4 cores), meaning our parallel program is less efficient than the simple version in terms of actual processor cycles, but the ability to use multiple cores gets the "real" wall-clock time down.</p>
<h2 id="handling-unicode">Handling Unicode</h2>
<p>There's something we've been avoiding so far, we've assumed every file is simple ASCII! That's really not the way the world works. A lot of documents are encoded in UTF-8 these days; which turns out to be identical to an ASCII file IFF the file only contains valid ASCII characters, however if those crazy pre-teens put some Emoji in there then it's going to screw everything up.</p>
<p>The problem is two-fold; firstly we currently count BYTES not CHARACTERS, because in ASCII-land they're semantically the same. With our current code, if we come across a UTF-8 encoded frowny face we're going to count it as at least 2 characters when it should only count as one. Okay, so maybe we should actually be decoding these things, but that's much easier said than done because we're splitting the file up into chunks at arbitrary byte-counts; meaning we might end up splitting that frowny face into two different chunks, leading to an invalid decoding! What a nightmare.</p>
<p>This is another reason why doing a multi-threaded <code>wc</code> is probably a bad idea, but I'm not so easily deterred. In order to proceed I'm going to make a few assumptions:</p>
<ul>
<li>Our input will be encoded using either ASCII or UTF-8 family of encodings. There are of course other popular encodings out there; but in my limited experience most modern text files prefer one of these encodings. In fact there are <a href="http://utf8everywhere.org/">entire sites</a> dedicated to making <code>UTF-8</code> the one format to rule them all.</li>
<li>We count only ASCII spaces and newlines as spaces and newlines; sorry <code>MONGOLIAN VOWEL SEPARATOR</code>, but you're cut from the team.</li>
</ul>
<p>By making these two assumptions we can exploit a few details of the UTF-8 encoding scheme to solve our problem. Firstly, we know from the UTF-8 spec that it's completely back-compatible with ASCII. What this means is that every ASCII byte is encoded in UTF-8 as exactly that same byte. Secondly, we know that NO other bytes in the file will conflict in encoding with a valid ASCII byte; you can see why in a chart on the <a href="https://en.wikipedia.org/wiki/UTF-8">UTF-8 wikipedia page</a>. Continuation bytes start with a leading '1', and no ASCII bytes start with a '1'.</p>
<p>These two facts mean we can safely leave our current 'space' detection logic the same! It's impossible for us to 'split' a space or newline because they're all encoded in a single byte, and we know we won't accidentally count some byte that's part of a different codepoint because there's no overlap in encoding for the ASCII bytes. We do however need to change our character-counting logic.</p>
<p>One last fact about UTF-8 is that every UTF-8 encoded codepoint contains exactly one byte from the set: <code>0xxxxxxx, 110xxxxx, 1110xxxx, 11110xxx</code>. Continuation bytes ALL start with <code>10</code>, so if we count all bytes OTHER than those starting with <code>10</code> then we'll count each code-point exactly once, even if we split a codepoint across different chunks!</p>
<p>All of these facts combined means we can write a per-byte monoid for counting UTF-8 codepoints OR ASCII characters all in one!</p>
<p>Note that technically Unicode <strong>codepoints</strong> are not the same as "characters", there are many codepoints like diacritics which will "fuse" themselves to be displayed as a single character, but so far as I know <code>wc</code> doesn't handle these separately either.</p>
<p>Actually, our current <code>Counts</code> monoid is fine, we'll just need to adapt our <code>countChar</code> function:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">import</span> <span class="dt">Data.Bits</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="kw">import</span> <span class="dt">Data.ByteString.Internal</span> (c2w)</span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="ot">countByte ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Counts</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>countByte c <span class="ot">=</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="dt">Counts</span> {</span>
<span id="cb15-6"><a href="#cb15-6"></a>            <span class="co">-- Only count bytes at the START of a codepoint, not continuation bytes</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>            charCount <span class="ot">=</span> <span class="kw">if</span> (bitAt <span class="dv">7</span> <span class="op">&amp;&amp;</span> <span class="fu">not</span> (bitAt <span class="dv">6</span>)) <span class="kw">then</span> <span class="dv">0</span> <span class="kw">else</span> <span class="dv">1</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>            , wordCount <span class="ot">=</span> flux c</span>
<span id="cb15-9"><a href="#cb15-9"></a>            , lineCount <span class="ot">=</span> <span class="kw">if</span> (c <span class="op">==</span> <span class="ch">&#39;\n&#39;</span>) <span class="kw">then</span> <span class="dv">1</span> <span class="kw">else</span> <span class="dv">0</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>            }</span>
<span id="cb15-11"><a href="#cb15-11"></a>    <span class="kw">where</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>      bitAt <span class="ot">=</span> testBit (c2w c)</span>
<span id="cb15-13"><a href="#cb15-13"></a><span class="ot">{-# INLINE countByte #-}</span></span></code></pre></div>
<p>And that's it! Now we can handle UTF-8 or ASCII; we don't even need to know which encoding we're handling, we'll always give the right answer.</p>
<p><code>wc</code>, at least the version on my Macbook, has a <code>-m</code> flag for handling multi-byte characters when counting. A few quick experiments shows that telling <code>wc</code> to handle multi-byte chars slows down the process pretty significantly (it now decodes every byte); let's see how our version does in comparison. (I've confirmed they get the same results when running on a large UTF-8 encoded document with many non-ASCII characters)</p>
<p>543 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc -mwl</th>
<th>multicore-utf8-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>5.56s</td>
<td>3.07s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.86 MB</td>
<td>7.52 MB</td>
</tr>
</tbody>
</table>
<p>Just as we suspect, we come out pretty far ahead! Our new version is a bit slower than when we just counted every byte (we're now doing a few extra bit-checks), so it's probably a good idea to add a <code>utf</code> flag to our program so we can always run as fast as possible for a given input.</p>
<h1 id="interjection">Interjection!</h1>
<p>Since posting the article, the wonderful <a href="https://github.com/harendra-kumar">Harendra Kumar</a> has provided me with a new performance tweak to try, which (spoiler alert) gives us better memory and performance while also allowing us to STREAM input from stdin! Wow! The code is pretty too!</p>
<p>The secret lies in the <a href="https://github.com/composewell/streamly"><code>streamly</code> library</a>, a wonderful high-level high-performance streaming library. I'd seen it in passing, but these result will definitely have me reaching for it in the future! Enough talk, let's see some code! Thanks again to Harendra Kumar for this implementation:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">module</span> <span class="dt">Streaming</span> <span class="kw">where</span></span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="kw">import</span> <span class="dt">Types</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="kw">import</span> <span class="dt">Data.Traversable</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="kw">import</span> <span class="dt">GHC.Conc</span> (numCapabilities)</span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="kw">import</span> <span class="dt">System.IO</span> (openFile, <span class="dt">IOMode</span>(..))</span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Streamly</span> <span class="kw">as</span> <span class="dt">S</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Streamly.Data.String</span> <span class="kw">as</span> <span class="dt">S</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Streamly.Prelude</span> <span class="kw">as</span> <span class="dt">S</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Streamly.Internal.Memory.Array</span> <span class="kw">as</span> <span class="dt">A</span></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Streamly.Internal.FileSystem.Handle</span> <span class="kw">as</span> <span class="dt">FH</span></span>
<span id="cb16-12"><a href="#cb16-12"></a></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="ot">streamingBytestream ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Counts</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>streamingBytestream fp <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-15"><a href="#cb16-15"></a>    src <span class="ot">&lt;-</span> openFile fp <span class="dt">ReadMode</span></span>
<span id="cb16-16"><a href="#cb16-16"></a>    S.foldl&#39; <span class="fu">mappend</span> <span class="fu">mempty</span></span>
<span id="cb16-17"><a href="#cb16-17"></a>        <span class="op">$</span> S.aheadly</span>
<span id="cb16-18"><a href="#cb16-18"></a>        <span class="op">$</span> S.maxThreads numCapabilities</span>
<span id="cb16-19"><a href="#cb16-19"></a>        <span class="op">$</span> S.mapM countBytes</span>
<span id="cb16-20"><a href="#cb16-20"></a>        <span class="op">$</span> FH.toStreamArraysOf <span class="dv">1024000</span> src</span>
<span id="cb16-21"><a href="#cb16-21"></a>    <span class="kw">where</span></span>
<span id="cb16-22"><a href="#cb16-22"></a>    countBytes <span class="ot">=</span></span>
<span id="cb16-23"><a href="#cb16-23"></a>          S.foldl&#39; (\acc c <span class="ot">-&gt;</span> acc <span class="op">&lt;&gt;</span> countByte c) <span class="fu">mempty</span></span>
<span id="cb16-24"><a href="#cb16-24"></a>        <span class="op">.</span> S.decodeChar8</span>
<span id="cb16-25"><a href="#cb16-25"></a>        <span class="op">.</span> A.toStream</span>
<span id="cb16-26"><a href="#cb16-26"></a></span>
<span id="cb16-27"><a href="#cb16-27"></a><span class="ot">{-# INLINE streamingBytestream #-}</span></span></code></pre></div>
<p>Note; this uses streamly version <code>7.10</code> straight from their Github repo, it'll likely be published to hackage soon. It also uses a few internal modules, but hopefully use-cases like this will prove that these combinators have enough valid uses to expose them.</p>
<p>First things first we simply open the file, nothing fancy there.</p>
<p>Next is the streaming code, we'll read it from the bottom to the top to follow the flow of information.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a>FH.toStreamArraysOf <span class="dv">1024000</span> src</span></code></pre></div>
<p>This chunks the bytes from the file handle into streams of Byte arrays. Using Byte arrays ends up being even faster than using something like a Lazy ByteString! We'll use a separate array for approximately each MB of the file, you can tweak this to your heart's content.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a>S.mapM countBytes</span></code></pre></div>
<p>This uses <code>mapM</code> to run the <code>countBytes</code> function over the array; <code>countBytes</code> itself creates a stream from the array and runs a streaming fold over it with our Monoidal byte counter:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1"></a>countBytes <span class="ot">=</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>      S.foldl&#39; (\acc c <span class="ot">-&gt;</span> acc <span class="op">&lt;&gt;</span> countByte c) <span class="fu">mempty</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="op">.</span> S.decodeChar8</span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="op">.</span> A.toStream</span></code></pre></div>
<p>Next we tell streamly to run the map over arrays in parallel, allowing separate threads to handle each 1MB chunk. We limit the number of threads to our number of capabilities. Once we've read in the data we can process it immediately, and our counting code doesn't have any reasons to block, so adding more threads than capabilities would likely just add more work for the scheduler.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1"></a>S.maxThreads numCapabilities</span></code></pre></div>
<p>Streamly provides many different stream evaluation strategies, We use <code>aheadly</code> as our strategy which allows stream elements to be processed in parallel, but still guarantees output will be emitted in the order corresponding to the input. Since we're using a Monoid, so long as everything ends up in the appropriate order we can chunk up the computations any way we like:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1"></a>S.aheadly</span></code></pre></div>
<p>At this point we've counted 1 MB chunks of our input, but we still need to aggregate all the chunks together, we can do this by <code>mappending</code> them all in another streaming fold:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1"></a>S.foldl&#39; <span class="fu">mappend</span> <span class="fu">mempty</span></span></code></pre></div>
<p>That's the gist! Let's take it for a spin!</p>
<p>Here's the non-utf version on our 543 MB test file:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc</th>
<th>multicore-wc</th>
<th>streaming-wc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>2.07s</td>
<td>1.23s</td>
<td>1.07s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.87 MB</td>
<td>7.06 MB</td>
<td>17.81 MB</td>
</tr>
</tbody>
</table>
<p>We can see it gets even faster, at the expense of a significant amount of memory, which I suspect could be mitigated by tuning our input chunking, let's try it out. Here's a comparison of the 100 KB chunks vs 1 MB chunks:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>streaming-wc (100 KB chunks)</th>
<th>streaming-wc (1 MB chunks)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>1.20s</td>
<td>1.07s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>8.02 MB</td>
<td>17.81 MB</td>
</tr>
</tbody>
</table>
<p>That's about what I suspected, we can trade a bit of performance for a decent hunk of memory. I'm already pretty happy with our results, but feel free to test other tuning strategies.</p>
<p>Lastly let's try the UTF8 version on our 543 MB test file, here's everything side by side:</p>
<table>
<thead>
<tr class="header">
<th></th>
<th>wc -mwl</th>
<th>multicore-utf8-wc</th>
<th>streaming-utf-wc (1 MB chunks)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time</td>
<td>5.56s</td>
<td>3.07s</td>
<td>2.67s</td>
</tr>
<tr class="even">
<td>max mem.</td>
<td>1.86 MB</td>
<td>7.52 MB</td>
<td>17.92 MB</td>
</tr>
</tbody>
</table>
<p>We're still getting faster! For the final version we may want to cut the memory usage down a bit though!</p>
<p>Overall I think the streaming version is my favourite, it's very high-level, very readable, and reads from an arbitrary file handle, including <code>stdin</code>, which is a very common use-case for <code>wc</code>. Streamly is pretty cool.</p>
<h2 id="conclusions">Conclusions</h2>
<p>So; how does our high-level garbage-collected runtime-based language Haskell stack up? Pretty dang well I'd say! We ended up really quite close with our single-core lazy-bytestring <code>wc</code>. Switching to a multi-core approach ultimately allowed us to pull ahead! Whether our <code>wc</code> clone is faster in practice without a warmed up disk-cache is something that should be considered, but in terms of raw performance we managed to build something faster! The streaming version shouldn't have the same dependencies on disk caching to be optimal.</p>
<p>Haskell as a language isn't perfect, but if I can get ball-park comparable performance to a C program while writing high-level fully type-checked code then I'll call that a win any day.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Optics + Regex: Greater than the sum of their parts</title>
      <link href="https://chrispenner.ca/posts/lens-regex-pcre"/>
      <id>https://chrispenner.ca/posts/lens-regex-pcre</id>
      <updated>2019-09-20T00:00:00Z</updated>
      <summary>Optics + Regex: greater than the sum of their parts.</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/magnifier.jpg" alt="Optics + Regex: Greater than the sum of their parts">
              <p>The library presented in this post is one of many steps towards getting everyone interested in the amazing world of Optics! If you're at all interested in learning their ins &amp; outs; check out the comprehensive book I'm writing on the topic: <a href="https://opticsbyexample.com">Optics By Example</a></p>
<hr />
<p>Regardless of the programming language, regular expressions have always been a core tool in the programmer's toolbox. Though some have a distaste for their difficult to maintain nature, they're an adaptable quick'n'dirty way to get things done.</p>
<p>As much love as I have for Regular Expressions, they've become an incredibly hacky thing; they support a lot of options and a lot of different behaviours, so the interfaces to regular expressions in all languages tends to leave a bit to be desired.</p>
<h2 id="the-status-quo">The Status Quo</h2>
<p>I don't know about you, but I've found almost every regular expression interface I've ever used in any language to be a bit clunky and inelegant; that's not meant to insult or demean any of those libraries, I think it's because regular expressions have a complex set of possible operations and the combination of them makes it tough to design a clean interface. Here are just a few reasons why it's hard to design a regex interface:</p>
<ul>
<li>Regular expressions can be used to either get <strong>or</strong> set</li>
<li>Sometimes you want only <strong>one</strong> match, sometimes a few, sometimes you want <strong>all</strong> of them!</li>
<li>Sometimes you want <strong>just</strong> the match groups; sometimes you want the <strong>whole</strong> match, sometimes you want <strong>BOTH</strong>!</li>
<li>Regular Expression searching is <strong>expensive</strong>; we want to be <strong>lazy</strong> to avoid work!</li>
<li>Regular expressions patterns are written as text; what if it's not valid?</li>
</ul>
<p>Luckily Haskell has a few tricks that help make some of these inherently difficult things a bit easier. Inherently lazy data structures and computations allows us to punt off laziness to the language rather than worrying about how to do the minimal amount of work possible. TemplateHaskell allows us to statically check Regular Expressions to ensure they're valid at compile time, and could even possibly allow us to statically analyze the existence of match groups. But that still leaves a lot of surface area to cover! It's easy to see how come these interfaces are complicated!</p>
<p>Think about designing a single interface which can support ALL of the following operations performantly and elegantly:</p>
<ul>
<li>Get me the second match group from the first three matches</li>
<li>Replace only the first match with this text</li>
<li>Get me all groups AND match text from ALL matches</li>
<li>Replace the first match with this value, the next with this one, and so on...</li>
<li>Lazily get me the full match text of the first 2 matches where match-group 1 has a certain property.</li>
</ul>
<p>Yikes... That's going to take either a lot of methods or a lot of options!</p>
<p>In a language like Haskell which doesn't have keyword or optional arguments it means we have to either overload operators with a lot of different meanings based on context; or provide a LOT of functions that the user has to learn, increasing our API's surface area. You may be familiar with the laughably overloaded "do everything" regex operator in many Haskell regex libs:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">(=~) ::</span> ( <span class="dt">RegexMaker</span> <span class="dt">Regex</span> <span class="dt">CompOption</span> <span class="dt">ExecOption</span> source2</span>
<span id="cb1-2"><a href="#cb1-2"></a>        , <span class="dt">RegexContext</span> <span class="dt">Regex</span> source1 target</span>
<span id="cb1-3"><a href="#cb1-3"></a>        ) <span class="ot">=&gt;</span> source1 <span class="ot">-&gt;</span> source2 <span class="ot">-&gt;</span> target</span></code></pre></div>
<p>And even that doesn't handle replacement!</p>
<p>Overloading is one approach, but as it turns out, it requires a lot of spelunking through types and documentation to even find out what the valid possible uses are! I'm going to rule out this approach as unwieldy and tough to reason about. That leaves us with the other option; add a whole bunch of methods or options, which doesn't sound great either, mainly because I don't want someone to need to learn a dozen <strong>specialized</strong> functions just to use <strong>my</strong> library. If only there was some existing vocabulary of operations which could be composed in different permutations to express complex ideas!</p>
<h2 id="something-different">Something Different</h2>
<p>Introducing <a href="https://github.com/ChrisPenner/lens-regex-pcre"><code>lens-regex-pcre</code></a>; a Haskell regular expression library which uses optics as its primary interface.</p>
<p>Think about what regular expressions are meant to do; they're an interface which allows you to <strong>get</strong> or <strong>set</strong> zero or more small pieces of text in a larger whole. This is practically the <strong>dictionary definition</strong> of a Traversal in optics! Interop with optics means you <strong>instantly</strong> benefit from the plethora of existing optics combinators! In fact, optics fit this problem <strong>so nicely</strong> that the lensy wrapper I built supports <strong>more features</strong>, with <strong>less code</strong>, and runs <em><strong>faster</strong></em> (for replacements) than the regex library it wraps! Stay tuned for more on how that's even possible near the end!</p>
<p>Using optics as an interface has the benefit that the user is either <strong>already familiar</strong> with most of the combinators and tools they'll need from using optics previously, or that everything they learn here is transferable into work with optics in the future! As more optics are discovered, added, and optimized, the regex library passively benefits without any extra work from anyone!</p>
<p>I don't want to discount the fact that optics can be tough to work with; I'm aware that they have a reputation of being too hard to learn and sometimes have poor type-inference and tricky error messages. I'm <a href="https://opticsbyexample.com/">doing my best to address those problems through education</a>, and there are new optics libraries coming out every year that improve error messages and usability! Despite current inconveniences, optics are fundamental constructions which model problems well; I believe <strong>optics are inevitable</strong>! So rather than shying away from an incredibly elegant solution because of a few temporary issues with the domain I'd rather push through them, use all the power the domain provides me, and continue to do all I can to chip away at the usability problems over time.</p>
<blockquote>
<p>Optics are inevitable.</p>
</blockquote>
<p>Okay! I'll put my soapbox away, now it's time to see how this all actually works. Notice how most of the following examples actually read roughly like a sentence!</p>
<h2 id="examples">Examples</h2>
<p><code>lens-regex-pcre</code> provides <code>regex</code>, <code>match</code>, <code>group</code> and <code>groups</code> in the following examples, everything else is regular ol' optics from the <code>lens</code> library!</p>
<p>We'll search through this text in the following examples:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="ot">txt ::</span> <span class="dt">Text</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>txt <span class="ot">=</span> <span class="st">&quot;raindrops on roses and whiskers on kittens&quot;</span></span></code></pre></div>
<p>First off, let's check if a pattern exists in the text:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="op">&gt;&gt;&gt;</span> has [regex|wh.skers|] txt</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="dt">True</span></span></code></pre></div>
<p>Looks like we found it!</p>
<p><code>regex</code> is a QuasiQuoter which constructs a traversal over all the text that matches the pattern you pass to it; behind the scenes it compiles the regex with <code>pcre-heavy</code> and will check your regex for you at compile time! Look; if we give it a bad pattern we find out right away!</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">-- Search</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="op">&gt;&gt;&gt;</span> has [regex|?|] txt</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">1</span><span class="op">:</span><span class="dv">12</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>    • <span class="dt">Exception</span> when trying to run compile<span class="op">-</span>time code<span class="op">:</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>        <span class="dt">Text.Regex.PCRE.Light</span><span class="op">:</span> <span class="dt">Error</span> <span class="kw">in</span> regex<span class="op">:</span> nothing to <span class="fu">repeat</span></span></code></pre></div>
<p>Handy!</p>
<p>Okay! Moving on, what if we just want to find the first match? We can use <code>firstOf</code> from <code>lens</code> to get <code>Just</code> the first focus or <code>Nothing</code>.</p>
<p>Here we use a fun regex to return the first word with doubles of a letter inside; it turns out <code>kittens</code> has a double <code>t</code>!</p>
<p>We use <code>match</code> to say we want to extract the text that was matched.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="op">&gt;&gt;&gt;</span> firstOf ([regex|\w*(\w)\1\w*|] <span class="op">.</span> match) txt</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="dt">Just</span> <span class="st">&quot;kittens&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">-- Alias: ^?</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="op">&gt;&gt;&gt;</span> txt <span class="op">^?</span> [regex|\w*(\w)\1\w*|] <span class="op">.</span> match</span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="dt">Just</span> <span class="st">&quot;kittens&quot;</span></span></code></pre></div>
<p>Next we want to get <strong>ALL</strong> the matches for a pattern, this one is probably the most common task we want to perform, luckily it's common when working with optics too!</p>
<p>Let's find all the words starting with <code>r</code> using <code>toListOf</code></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="op">&gt;&gt;&gt;</span> toListOf ([regex|\br\w*|] <span class="op">.</span> match) txt</span>
<span id="cb6-2"><a href="#cb6-2"></a>[<span class="st">&quot;raindrops&quot;</span>,<span class="st">&quot;roses&quot;</span>]</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">-- ALIAS: ^..</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="op">&gt;&gt;&gt;</span> txt <span class="op">^..</span> [regex|\br\w*|] <span class="op">.</span> match</span>
<span id="cb6-6"><a href="#cb6-6"></a>[<span class="st">&quot;raindrops&quot;</span>,<span class="st">&quot;roses&quot;</span>]</span></code></pre></div>
<p>What if we want to count the number of matches instead?</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="op">&gt;&gt;&gt;</span> lengthOf [regex|\br\w*|] txt</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="dv">2</span></span></code></pre></div>
<p>Basically anything you can think to ask is already provided by <code>lens</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">-- Do any matches contain &quot;drop&quot;?</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="op">&gt;&gt;&gt;</span> anyOf ([regex|\br\w*|] <span class="op">.</span> match) (T.isInfixOf <span class="st">&quot;drop&quot;</span>) txt</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="dt">True</span></span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">-- Are all of our matches greater than 3 chars?</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="op">&gt;&gt;&gt;</span> allOf ([regex|\br\w*|] <span class="op">.</span> match) ((<span class="op">&gt;</span><span class="dv">3</span>) <span class="op">.</span> T.length) txt</span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="dt">True</span></span>
<span id="cb8-8"><a href="#cb8-8"></a></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">-- &quot;Is &#39;roses&#39; one of our matches&quot;</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="op">&gt;&gt;&gt;</span> elemOf ([regex|\br\w*|] <span class="op">.</span> match) <span class="st">&quot;roses&quot;</span> txt</span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="dt">True</span></span></code></pre></div>
<h2 id="substitutions-and-replacements">Substitutions and replacements</h2>
<p>But that's not all! We can edit and mutate our matches in-place! This is something that the lensy interface does much better than any regex library I've ever seen. Hold my beer.</p>
<p>We can do the boring basic regex replace without even breaking a sweat:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="op">&gt;&gt;&gt;</span> set ([regex|\br\w*|] <span class="op">.</span> match) <span class="st">&quot;brillig&quot;</span> txt</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">&quot;brillig on brillig and whiskers on kittens&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">-- Alias .~</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="op">&gt;&gt;&gt;</span> txt <span class="op">&amp;</span> [regex|\br\w*|] <span class="op">.</span> match <span class="op">.~</span> <span class="st">&quot;brillig&quot;</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="st">&quot;brillig on brillig and whiskers on kittens&quot;</span></span></code></pre></div>
<p>Now for the fun stuff; we can <strong>mutate</strong> a match in-place!</p>
<p>Let's reverse all of our matches:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="op">&gt;&gt;&gt;</span> over ([regex|\br\w*|] <span class="op">.</span> match) T.reverse txt</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">&quot;spordniar on sesor and whiskers on kittens&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co">-- Alias %~</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="op">&gt;&gt;&gt;</span> txt <span class="op">&amp;</span> [regex|\br\w*|] <span class="op">.</span> match <span class="op">%~</span> T.reverse</span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="st">&quot;spordniar on sesor and whiskers on kittens&quot;</span></span></code></pre></div>
<p>Want to replace matches using a list of substitutions? No problem! We can use <code>partsOf</code> to edit our matches as a list!</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="op">&gt;&gt;&gt;</span> txt <span class="op">&amp;</span> partsOf ([regex|\br\w*|] <span class="op">.</span> match) <span class="op">.~</span> [<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>]</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="st">&quot;one on two and whiskers on kittens&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">-- Providing too few simply leaves extras alone</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="op">&gt;&gt;&gt;</span> txt <span class="op">&amp;</span> partsOf ([regex|\br\w*|] <span class="op">.</span> match) <span class="op">.~</span> [<span class="st">&quot;one&quot;</span>]</span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">&quot;one on roses and whiskers on kittens&quot;</span></span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">-- Providing too many performs as many substitutions as it can</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="op">&gt;&gt;&gt;</span> txt <span class="op">&amp;</span> partsOf ([regex|\br\w*|] <span class="op">.</span> match) <span class="op">.~</span> [<span class="st">&quot;one&quot;</span>, <span class="st">&quot;two&quot;</span>, <span class="st">&quot;three&quot;</span>]</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="st">&quot;one on two and whiskers on kittens&quot;</span></span></code></pre></div>
<p>We can even do updates which require effects!</p>
<p>Let's find and replace variables in a block of text with values from environment variables using <code>IO</code>!</p>
<p>Note that <code>%%~</code> is the combinator for running a <code>traverse</code> over the targets. We could also use <code>traverseOf</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">import</span> <span class="dt">Control.Lens</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="kw">import</span> <span class="dt">Control.Lens.Regex</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="kw">import</span> <span class="dt">System.Environment</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="kw">import</span> <span class="dt">Data.Text.Lens</span></span>
<span id="cb12-6"><a href="#cb12-6"></a></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="ot">src ::</span> <span class="dt">T.Text</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>src <span class="ot">=</span> <span class="st">&quot;Hello $NAME, how&#39;s your $THING?&quot;</span></span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="ot">replaceEnv ::</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">T.Text</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>replaceEnv <span class="ot">=</span> [regex|\$\w+|] <span class="op">.</span> match <span class="op">.</span> unpacked <span class="op">%%~</span> getEnv <span class="op">.</span> <span class="fu">tail</span></span></code></pre></div>
<p>Let's run it:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="op">&gt;&gt;&gt;</span> setEnv <span class="st">&quot;NAME&quot;</span> <span class="st">&quot;Joey&quot;</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="op">&gt;&gt;&gt;</span> setEnv <span class="st">&quot;THING&quot;</span> <span class="st">&quot;dog&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="op">&gt;&gt;&gt;</span> replaceWithEnv src</span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">&quot;Hello Joey, how&#39;s your dog?&quot;</span></span></code></pre></div>
<p>When you think about what we've managed to do with <code>replaceWithEnv</code> in a single line of code I think it's pretty impressive.</p>
<p>And we haven't even looked at groups yet!</p>
<h2 id="using-groups">Using Groups</h2>
<p>Any sufficiently tricky regex problem will need groups eventually! <code>lens-regex-pcre</code> supports that!</p>
<p>Instead of using <code>match</code> after <code>regex</code> we just use <code>groups</code> instead! It's that easy.</p>
<p>Let's say we want to collect only the names of every variable in a template string:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a><span class="ot">template ::</span> <span class="dt">T.Text</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>template <span class="ot">=</span> <span class="st">&quot;Hello $NAME, glad you came to $PLACE&quot;</span></span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="op">&gt;&gt;&gt;</span> toListOf ([regex|\$(\w+)|] <span class="op">.</span> <span class="fu">group</span> <span class="dv">0</span>) template</span>
<span id="cb14-5"><a href="#cb14-5"></a>[<span class="st">&quot;NAME&quot;</span>,<span class="st">&quot;PLACE&quot;</span>]</span></code></pre></div>
<p>You can substitute/edit groups too!</p>
<p>What if we got all our our area codes and local numbers messed up in our phone numbers? We can fix that in one fell swoop:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="ot">phoneNumbers ::</span> <span class="dt">T.Text</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>phoneNumbers <span class="ot">=</span> <span class="st">&quot;555-123-4567, 999-876-54321&quot;</span></span>
<span id="cb15-3"><a href="#cb15-3"></a></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co">-- &#39;reverse&#39; will switch the first and second groups in the list of groups matches!</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="op">&gt;&gt;&gt;</span> phoneNumbers <span class="op">&amp;</span> [regex|(\d{3})-(\d{3})|] <span class="op">.</span> groups <span class="op">%~</span> Prelude.reverse</span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="st">&quot;123-555-4567, 876-999-54321&quot;</span></span></code></pre></div>
<h2 id="bringing-it-in">Bringing it in</h2>
<p>So with this new vocabulary how do we solve all the problems we posed earlier?</p>
<ul>
<li>Get me the second match group from the first three matches</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="st">&quot;a:b, c:d, e:f, g:h&quot;</span> <span class="op">^..</span> taking <span class="dv">3</span> ([regex|(\w):(\w)|] <span class="op">.</span> <span class="fu">group</span> <span class="dv">1</span>)</span>
<span id="cb16-2"><a href="#cb16-2"></a>[<span class="st">&quot;b&quot;</span>,<span class="st">&quot;d&quot;</span>,<span class="st">&quot;f&quot;</span>]</span></code></pre></div>
<p>You can replace the call to <code>taking</code> with a simple <code>Prelude.take 3</code> on the whole list of matches if you prefer, it'll lazily do the minimum amount of work!</p>
<ul>
<li>Replace only the first match with this text</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="st">&quot;one two three&quot;</span> <span class="op">&amp;</span> [regex|\w+|] <span class="op">.</span> <span class="fu">index</span> <span class="dv">0</span> <span class="op">.</span> match <span class="op">.~</span> <span class="st">&quot;new&quot;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="st">&quot;new two three&quot;</span></span></code></pre></div>
<ul>
<li>Get me all groups AND match text from ALL matches</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="st">&quot;a:b, c:d, e:f&quot;</span> <span class="op">^..</span> [regex|(\w):(\w)|] <span class="op">.</span> matchAndGroups</span>
<span id="cb18-2"><a href="#cb18-2"></a>[(<span class="st">&quot;a:b&quot;</span>,[<span class="st">&quot;a&quot;</span>,<span class="st">&quot;b&quot;</span>]),(<span class="st">&quot;c:d&quot;</span>,[<span class="st">&quot;c&quot;</span>,<span class="st">&quot;d&quot;</span>]),(<span class="st">&quot;e:f&quot;</span>,[<span class="st">&quot;e&quot;</span>,<span class="st">&quot;f&quot;</span>])]</span></code></pre></div>
<ul>
<li>Replace the first match with this value, the next with this one, and so on...</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1"></a><span class="co">-- If we get more matches than replacements it just leaves the extras alone</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="op">&gt;&gt;&gt;</span> <span class="st">&quot;one two three four&quot;</span> <span class="op">&amp;</span> partsOf ([regex|\w+|] <span class="op">.</span> match) <span class="op">.~</span> [<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;3&quot;</span>]</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="st">&quot;1 2 3 four&quot;</span></span></code></pre></div>
<ul>
<li>Lazily get me the full match text of the first 2 matches where match-group 1 has a certain property.</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1"></a><span class="co">-- The resulting list will be lazily evaluated!</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="op">&gt;&gt;&gt;</span> <span class="st">&quot;a:b, c:d, e:f, g:h&quot;</span> </span>
<span id="cb20-3"><a href="#cb20-3"></a>      <span class="op">^..</span> [regex|(\w):(\w)|] </span>
<span id="cb20-4"><a href="#cb20-4"></a>      <span class="op">.</span> filtered (has (<span class="fu">group</span> <span class="dv">0</span> <span class="op">.</span> filtered (<span class="op">&gt;</span> <span class="st">&quot;c&quot;</span>))) </span>
<span id="cb20-5"><a href="#cb20-5"></a>      <span class="op">.</span> match</span>
<span id="cb20-6"><a href="#cb20-6"></a>[<span class="st">&quot;e:f&quot;</span>,<span class="st">&quot;g:h&quot;</span>]</span></code></pre></div>
<p>Anyways, at this point I'm rambling, but I hope you see that this is too useful of an abstraction for us to give up!</p>
<p>Huge thanks to everyone who has done work on <code>pcre-light</code> and <code>pcre-heavy</code>; and of course everyone who helped to build <code>lens</code> too! This wouldn't be possible without both of them!</p>
<p>The library has a Text interface which supports Unicode, and a <code>ByteString</code> interface for when you've gotta go <strong>fast</strong>!</p>
<h1 id="performance">Performance</h1>
<p>Typically one would expect that the more expressive an interface, the worse it would perform, in this case the opposite is true! <code>lens-regex-pcre</code> utilizes <code>pcre-heavy</code> ONLY for regex compilation and finding match positions with <code>scanRanges</code>, that's it! In fact, I don't use <code>pcre-heavy</code>'s built-in support for replacements <strong>at all</strong>! After finding the match positions it lazily walks over the full <code>ByteString</code> splitting it into chunks. Chunks are tagged with whether they're a match or not, then the "match" chunks are split further to represent whether the text is in a group or not. This allows us to implement all of our regex operations as a simple traversal over a nested list of <code>Either</code>s. These traversals are the ONLY things we actually need to implement, all other functionality including listing matches, filtering matches, and even setting or updating matches already exists in <code>lens</code> as generic optics combinators!</p>
<p>This means I didn't need to optimize for replacements or for viewing separately, because I didn't optimize for specific actions <strong>at all</strong>! I just built a single Traversal, and everything else follows from that.</p>
<p>You heard that right! I didn't write ANY special logic for viewing, updating, setting, or anything else! I just provided the appropriate traversals, optics combinators do the rest, and it's still performant!</p>
<p>There was a little bit of fiddly logic involved with splitting the text up into chunks, but after that it all gets pretty easy to reason about. To optimize the Traversal itself I was easily able to refactor things to use <code>ByteString</code> 'Builder's rather than full <code>ByteString</code>s, which have much better concatenation performance.</p>
<p>With the caveat that I don't claim to be an expert at benchmarks; (please <a href="https://github.com/ChrisPenner/lens-regex-pcre/blob/master/bench/Bench.hs">take a look</a> and tell me if I'm making any critical mistakes!) this single change took <code>lens-regex-pcre</code> from being about <strong>half the speed</strong> of <code>pcre-heavy</code> to being within 0.6% of <strong>equal</strong> for search, and <strong>~10% faster</strong> for replacements. It's just as fast for arbitrary pure or effectful <strong>modifications</strong>, which is something other regex libraries simply don't support. If there's a need for it, it can also trivially support things like inverting the match to operate over all <strong>unmatched</strong> text, or things like splitting up a text on matches, etc.</p>
<p>I suspect that these performance improvements are simple enough they could also be back-ported to <code>pcre-heavy</code> if anyone has the desire to do so, I'd be curious if it works just as well for <code>pcre-heavy</code> as it did for <code>lens-regex-pcre</code>.</p>
<p>You can try out the library <a href="https://github.com/ChrisPenner/lens-regex-pcre">here!</a>; make sure you're using <code>v1.0.0.0</code>.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Slick 1.0 Release - Now with a quick and easy template!</title>
      <link href="https://chrispenner.ca/posts/slick-template"/>
      <id>https://chrispenner.ca/posts/slick-template</id>
      <updated>2019-09-18T00:00:00Z</updated>
      <summary>Build a static site using Haskell, Shake and Pandoc!</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/slick.jpg" alt="Slick 1.0 Release - Now with a quick and easy template!">
              <p>TLDR; Build a site with <a href="https://github.com/ChrisPenner/slick">slick 1.0</a>: <a href="https://github.com/ChrisPenner/slick-template">fork the slick-template</a>.</p>
<p>Hey folks! Slick has been around for a while already, it's a light wrapper over Shake which allows for blazing fast static site builds! It provides Pandoc helpers to load in pages or posts as markdown, or ANYTHING that Pandoc can read (which is pretty much EVERYTHING nowadays). It offers support for Mustache templates as well!</p>
<p>Shake was always great as a build tool, but its Makefile-style of dependency targets was always a little backwards for building a site. Slick 1.0 switches to recommending using Shake's FORWARD discoverable build style. This means you can basically write normal Haskell code in the Action monad to build and render your site, and Shake will <strong>automagically</strong> cache everything for you with proper and efficient cache-busting! A dream come true.</p>
<p>Slick lets you build and deploy a static website using Github Pages (or literally any static file host) very easily while still maintaining completely open for extensibility. You can use any shake compatible lib, or even just IO if you want; Shake's forward build tools can even detect caching rules when running arbitrary external processes (caveat emptor).</p>
<p>Hope you like it! In case you're curious what a site might be like; this very blog is built with slick!</p>
<p>Here's a full snippet of code for building a simple blog (with awesome caching) from markdown files; check it out:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ot">{-# LANGUAGE DeriveAnyClass #-}</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw">import</span>           <span class="dt">Control.Lens</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">import</span>           <span class="dt">Control.Monad</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">import</span>           <span class="dt">Data.Aeson</span>                 <span class="kw">as</span> <span class="dt">A</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw">import</span>           <span class="dt">Data.Aeson.Lens</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="kw">import</span>           <span class="dt">Development.Shake</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="kw">import</span>           <span class="dt">Development.Shake.Classes</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="kw">import</span>           <span class="dt">Development.Shake.Forward</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="kw">import</span>           <span class="dt">Development.Shake.FilePath</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="kw">import</span>           <span class="dt">GHC.Generics</span>               (<span class="dt">Generic</span>)</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="kw">import</span>           <span class="dt">Slick</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span>                  <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="ot">outputFolder ::</span> <span class="dt">FilePath</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>outputFolder <span class="ot">=</span> <span class="st">&quot;docs/&quot;</span></span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">-- | Data for the index page</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="kw">data</span> <span class="dt">IndexInfo</span> <span class="ot">=</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>  <span class="dt">IndexInfo</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>    {<span class="ot"> posts ::</span> [<span class="dt">Post</span>]</span>
<span id="cb1-26"><a href="#cb1-26"></a>    } <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Show</span>, <span class="dt">FromJSON</span>, <span class="dt">ToJSON</span>)</span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="co">-- | Data for a blog post</span></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="kw">data</span> <span class="dt">Post</span> <span class="ot">=</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>    <span class="dt">Post</span> {<span class="ot"> title   ::</span> <span class="dt">String</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>         ,<span class="ot"> author  ::</span> <span class="dt">String</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>         ,<span class="ot"> content ::</span> <span class="dt">String</span></span>
<span id="cb1-33"><a href="#cb1-33"></a>         ,<span class="ot"> url     ::</span> <span class="dt">String</span></span>
<span id="cb1-34"><a href="#cb1-34"></a>         ,<span class="ot"> date    ::</span> <span class="dt">String</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>         ,<span class="ot"> image   ::</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb1-36"><a href="#cb1-36"></a>         }</span>
<span id="cb1-37"><a href="#cb1-37"></a>    <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>, <span class="dt">Show</span>, <span class="dt">FromJSON</span>, <span class="dt">ToJSON</span>, <span class="dt">Binary</span>)</span>
<span id="cb1-38"><a href="#cb1-38"></a></span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="co">-- | given a list of posts this will build a table of contents</span></span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="ot">buildIndex ::</span> [<span class="dt">Post</span>] <span class="ot">-&gt;</span> <span class="dt">Action</span> ()</span>
<span id="cb1-41"><a href="#cb1-41"></a>buildIndex posts&#39; <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-42"><a href="#cb1-42"></a>  indexT <span class="ot">&lt;-</span> compileTemplate&#39; <span class="st">&quot;site/templates/index.html&quot;</span></span>
<span id="cb1-43"><a href="#cb1-43"></a>  <span class="kw">let</span> indexInfo <span class="ot">=</span> <span class="dt">IndexInfo</span> {posts <span class="ot">=</span> posts&#39;}</span>
<span id="cb1-44"><a href="#cb1-44"></a>      indexHTML <span class="ot">=</span> T.unpack <span class="op">$</span> substitute indexT (toJSON indexInfo)</span>
<span id="cb1-45"><a href="#cb1-45"></a>  writeFile&#39; (outputFolder <span class="op">&lt;/&gt;</span> <span class="st">&quot;index.html&quot;</span>) indexHTML</span>
<span id="cb1-46"><a href="#cb1-46"></a></span>
<span id="cb1-47"><a href="#cb1-47"></a><span class="co">-- | Find and build all posts</span></span>
<span id="cb1-48"><a href="#cb1-48"></a><span class="ot">buildPosts ::</span> <span class="dt">Action</span> [<span class="dt">Post</span>]</span>
<span id="cb1-49"><a href="#cb1-49"></a>buildPosts <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-50"><a href="#cb1-50"></a>  pPaths <span class="ot">&lt;-</span> getDirectoryFiles <span class="st">&quot;.&quot;</span> [<span class="st">&quot;site/posts//*.md&quot;</span>]</span>
<span id="cb1-51"><a href="#cb1-51"></a>  forP pPaths buildPost</span>
<span id="cb1-52"><a href="#cb1-52"></a></span>
<span id="cb1-53"><a href="#cb1-53"></a><span class="co">-- | Load a post, process metadata, write it to output, then return the post object</span></span>
<span id="cb1-54"><a href="#cb1-54"></a><span class="co">-- Detects changes to either post content or template</span></span>
<span id="cb1-55"><a href="#cb1-55"></a><span class="ot">buildPost ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Action</span> <span class="dt">Post</span></span>
<span id="cb1-56"><a href="#cb1-56"></a>buildPost srcPath <span class="ot">=</span> cacheAction (<span class="st">&quot;build&quot;</span><span class="ot"> ::</span> <span class="dt">T.Text</span>, srcPath) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>  liftIO <span class="op">.</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Rebuilding post: &quot;</span> <span class="op">&lt;&gt;</span> srcPath</span>
<span id="cb1-58"><a href="#cb1-58"></a>  postContent <span class="ot">&lt;-</span> readFile&#39; srcPath</span>
<span id="cb1-59"><a href="#cb1-59"></a>  <span class="co">-- load post content and metadata as JSON blob</span></span>
<span id="cb1-60"><a href="#cb1-60"></a>  postData <span class="ot">&lt;-</span> markdownToHTML <span class="op">.</span> T.pack <span class="op">$</span> postContent</span>
<span id="cb1-61"><a href="#cb1-61"></a>  <span class="kw">let</span> postUrl <span class="ot">=</span> T.pack <span class="op">.</span> dropDirectory1 <span class="op">$</span> srcPath <span class="op">-&lt;.&gt;</span> <span class="st">&quot;html&quot;</span></span>
<span id="cb1-62"><a href="#cb1-62"></a>      withPostUrl <span class="ot">=</span> _Object <span class="op">.</span> at <span class="st">&quot;url&quot;</span> <span class="op">?~</span> <span class="dt">String</span> postUrl</span>
<span id="cb1-63"><a href="#cb1-63"></a>  <span class="co">-- Add additional metadata we&#39;ve been able to compute</span></span>
<span id="cb1-64"><a href="#cb1-64"></a>  <span class="kw">let</span> fullPostData <span class="ot">=</span> withPostUrl <span class="op">$</span> postData</span>
<span id="cb1-65"><a href="#cb1-65"></a>  template <span class="ot">&lt;-</span> compileTemplate&#39; <span class="st">&quot;site/templates/post.html&quot;</span></span>
<span id="cb1-66"><a href="#cb1-66"></a>  writeFile&#39; (outputFolder <span class="op">&lt;/&gt;</span> T.unpack postUrl) <span class="op">.</span> T.unpack <span class="op">$</span> substitute template fullPostData</span>
<span id="cb1-67"><a href="#cb1-67"></a>  <span class="co">-- Convert the metadata into a Post object</span></span>
<span id="cb1-68"><a href="#cb1-68"></a>  convert fullPostData</span>
<span id="cb1-69"><a href="#cb1-69"></a></span>
<span id="cb1-70"><a href="#cb1-70"></a><span class="co">-- | Copy all static files from the listed folders to their destination</span></span>
<span id="cb1-71"><a href="#cb1-71"></a><span class="ot">copyStaticFiles ::</span> <span class="dt">Action</span> ()</span>
<span id="cb1-72"><a href="#cb1-72"></a>copyStaticFiles <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-73"><a href="#cb1-73"></a>    filepaths <span class="ot">&lt;-</span> getDirectoryFiles <span class="st">&quot;./site/&quot;</span> [<span class="st">&quot;images//*&quot;</span>, <span class="st">&quot;css//*&quot;</span>, <span class="st">&quot;js//*&quot;</span>]</span>
<span id="cb1-74"><a href="#cb1-74"></a>    void <span class="op">$</span> forP filepaths <span class="op">$</span> \filepath <span class="ot">-&gt;</span></span>
<span id="cb1-75"><a href="#cb1-75"></a>        copyFileChanged (<span class="st">&quot;site&quot;</span> <span class="op">&lt;/&gt;</span> filepath) (outputFolder <span class="op">&lt;/&gt;</span> filepath)</span>
<span id="cb1-76"><a href="#cb1-76"></a></span>
<span id="cb1-77"><a href="#cb1-77"></a><span class="co">-- | Specific build rules for the Shake system</span></span>
<span id="cb1-78"><a href="#cb1-78"></a><span class="co">--   defines workflow to build the website</span></span>
<span id="cb1-79"><a href="#cb1-79"></a><span class="ot">buildRules ::</span> <span class="dt">Action</span> ()</span>
<span id="cb1-80"><a href="#cb1-80"></a>buildRules <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-81"><a href="#cb1-81"></a>  allPosts <span class="ot">&lt;-</span> buildPosts</span>
<span id="cb1-82"><a href="#cb1-82"></a>  buildIndex allPosts</span>
<span id="cb1-83"><a href="#cb1-83"></a>  copyStaticFiles</span>
<span id="cb1-84"><a href="#cb1-84"></a></span>
<span id="cb1-85"><a href="#cb1-85"></a><span class="co">-- | Kick it all off</span></span>
<span id="cb1-86"><a href="#cb1-86"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-87"><a href="#cb1-87"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-88"><a href="#cb1-88"></a>  <span class="kw">let</span> shOpts <span class="ot">=</span> forwardOptions <span class="op">$</span> shakeOptions { shakeVerbosity <span class="ot">=</span> <span class="dt">Chatty</span>}</span>
<span id="cb1-89"><a href="#cb1-89"></a>  shakeArgsForward shOpts buildRules</span></code></pre></div>
<p>See you next time!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Haskell IDE Support (hie-core lsp Sept. 2019)</title>
      <link href="https://chrispenner.ca/posts/hie-core"/>
      <id>https://chrispenner.ca/posts/hie-core</id>
      <updated>2019-09-07T00:00:00Z</updated>
      <summary>Configuring editor support for Haskell (hie-core 2019)</summary>
      <content type="html"><![CDATA[
              <p><strong>EDIT</strong>: This project has been renamed to <code>ghcide</code> now; you can find it <a href="https://github.com/digital-asset/ghcide">here</a>!</p>
<p>Here's a super quick guide on adding hie-core to your workflow!</p>
<p>Disclaimer; this post depends on the state of the world as of Saturday Morning, Sept. 7th 2019; it's likely changed since then. I'm not a maintainer of any of these libraries, and this is a complicated and confusing process. There's a good chance this won't work for you, but I'm afraid I can't support every possible set up. Use it as a guide-post, but you'll probably need to fix a few problems yourself. Feel free to let me know if things are broken, but I make no guarantees that I can help, sorry! Good luck!</p>
<p>This is a guide for using it with stack projects, or at least using the stack tool. If your project isn't a stack project, you can probably just run <code>stack init</code> first.</p>
<p><code>hie-core</code> currently requires a whole suite of tools to run, including <code>hie-bios</code>, <code>hie-core</code>, and <code>haskell-lsp</code>. Each of these need to be installed against the proper GHC version and LTS that you'll be using in your project. This is a bit annoying of course, but the end result is worth it.</p>
<p>We need separate binaries for every GHC version, so to avoid getting them all confused, we'll install everything in LTS specific sandboxes!</p>
<ul>
<li>First navigate to the project you want to run <code>hie-core</code> with</li>
<li>Now <code>stack update</code>; sometimes stack doesn't keep your hackage index up-to-date and most of the packages we'll be using are pretty new.</li>
<li><code>stack build hie-bios hie-core haskell-lsp --copy-compiler-tool</code>
<ul>
<li>We need these three executables installed, using <code>stack build</code> doesn't install them globally (which is what we want to avoid conflicts), but <code>--copy-compiler-tool</code> allows us to share binaries with other projects of the same LTS.</li>
<li>This will probably FAIL the first time you run it, stack will suggest that you add extra-deps to your <code>stack.yaml</code>; go ahead and do that and try again. Repeat this process until success!</li>
</ul></li>
</ul>
<p>If you've got all those running, time to go for a walk, or make a cup of tea. It'll take a while.</p>
<p>If you're using an LTS OLDER than <code>14.1</code> then <code>haskell-lsp</code> will probably be too old to work with <code>hie-core</code>; you can <strong>try</strong> to fix it by adding the following to your extra-deps:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">extra-deps</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">-</span><span class="at"> haskell-lsp-0.15.0.0</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">-</span><span class="at"> haskell-lsp-types-0.15.0.0</span></span></code></pre></div>
<p>If that doesn't work, sorry, I really have no idea :'(</p>
<p>Okay, so now we've got all the tools installed we can start configuring the editor. I can't tell you how to install it for every possible editor, but the key parts to know is that it's a <strong>language server</strong>, so search for integrations for your editor that handle that protocol. Usually "$MyEditorName lsp" is a good google search. Once you find a plugin you need to configure it. Typically there's a spot in the settings to associate file-types with the language server binary. Punch in the Haskell filetype or extensions accordingly, the lsp binary is <code>stack exec hie-core -- --lsp</code>; this'll use the <code>hie-core</code> you install specifically for this LTS, and will add the other dependencies to the path properly. You'll likely need to specify the binary and arguments separately, see the following vim setup for an example.</p>
<h2 id="vim-setup">Vim Setup</h2>
<p>Here's my setup for using <code>hie-core</code> with <a href="https://neovim.io/">Neovim</a> using the amazing <a href="https://github.com/neoclide/coc.nvim">Coc plugin</a>. Note that you'll need to install Neovim from latest HEAD to get proper pop-up support, if you're on a Mac you can do that with <code>brew unlink neovim; brew install --HEAD neovim</code>.</p>
<p>Follow the instructions in the Coc README for installing that however you like; then run <code>:CocConfig</code> inside neovim to open up the config file.</p>
<p>Here's my current config:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="dt">&quot;languageserver&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="dt">&quot;haskell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;stack&quot;</span><span class="fu">,</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="dt">&quot;args&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;exec&quot;</span><span class="ot">,</span> <span class="st">&quot;hie-core&quot;</span><span class="ot">,</span> <span class="st">&quot;--&quot;</span><span class="ot">,</span> <span class="st">&quot;--lsp&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="dt">&quot;rootPatterns&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>      <span class="st">&quot;.stack.yaml&quot;</span><span class="ot">,</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>      <span class="st">&quot;cabal.config&quot;</span><span class="ot">,</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>      <span class="st">&quot;package.yaml&quot;</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="dt">&quot;filetypes&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>      <span class="st">&quot;hs&quot;</span><span class="ot">,</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>      <span class="st">&quot;lhs&quot;</span><span class="ot">,</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>      <span class="st">&quot;haskell&quot;</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="dt">&quot;initializationOptions&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>      <span class="dt">&quot;languageServerHaskell&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>      <span class="fu">}</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="fu">}</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>  <span class="fu">}</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="fu">}</span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="fu">}</span></span></code></pre></div>
<p>Also make sure to read the <a href="https://github.com/neoclide/coc.nvim#example-vim-configuration">Sample Vim Configuration</a> for Coc to set up bindings and such.</p>
<p>After you've done all that, I <strong>hope</strong> it's working for you, if not, something crazy has probably changed and you're probably on your own. Good luck!</p>
<p>PS; I have a little bash script I use for installing this in every new project in case you want to see how terrible I am at writing BASH. It includes a helper which auto-adds all the necessary extra-deps for you: <a href="https://github.com/ChrisPenner/dotfiles/blob/master/bin/hie-init">My crappy bash script</a></p>
<p>You'll probably need to run the script more than once as it attempts to add all the needed extra-deps. Hopefully this'll get better as these tools get added to stackage.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Higher Kinded Option Parsing</title>
      <link href="https://chrispenner.ca/posts/hkd-options"/>
      <id>https://chrispenner.ca/posts/hkd-options</id>
      <updated>2019-05-04T00:00:00Z</updated>
      <summary>Collecting options for your application from multiple sources using Higher Kinded Data</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/hkd-option-parsing/tools.jpg" alt="Higher Kinded Option Parsing">
              <p>Higher Kinded Data Types (HKDTs) have piqued my interest lately. They seem to have a lot of potential applications, however the ergonomics still aren't so great in most of these cases. Today we'll look at one case where I think the end result ends up quite nice! Let's parse some options!</p>
<p>First the problem; if you've worked on a non-trivial production app you've probably come across what I'll call the <strong>Configuration Conundrum</strong>. Specifically, this is when an app collects configuration values from <em>many sources</em>. Maybe it parses some options from CLI flags, some from Environment Variables, yet more come from a configuration file in JSON or YAML or TOML or or even worse it may pull from SEVERAL files. Working with these is a mess, option priority gets tricky, providing useful error messages gets even harder, and the code for managing all these sources is confusing, complicated, and spread out. Though we may not solve ALL these problems today, we'll build an approach that's modular and extensible enough that you can mix and match bits and pieces to get whatever you need.</p>
<p>Here's an example of some messy code which pulls options from the environment or from a JSON value file:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">getOptions ::</span> <span class="dt">IO</span> <span class="dt">Options</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>getOptions <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    configJson <span class="ot">&lt;-</span> readConfigFile</span>
<span id="cb1-4"><a href="#cb1-4"></a>    mServerHostEnv <span class="ot">&lt;-</span> readServerHostEnv</span>
<span id="cb1-5"><a href="#cb1-5"></a>    mNumThreadsEnv <span class="ot">&lt;-</span> readNumThreadsEnv</span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="kw">let</span> mServerHostJson <span class="ot">=</span> configJson <span class="op">^?</span> key <span class="st">&quot;server_host&quot;</span> <span class="op">.</span> _String <span class="op">.</span> unpacked</span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="kw">let</span> mNumThreadsJson <span class="ot">=</span> configJson <span class="op">^?</span> key <span class="st">&quot;num_threads&quot;</span> <span class="op">.</span> _Number <span class="op">.</span> to <span class="fu">round</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="dt">Options</span> <span class="op">&lt;$&gt;</span> fromMaybe serverHostDef (mServerHostEnv <span class="op">&lt;|&gt;</span> mServerHostJson)</span>
<span id="cb1-9"><a href="#cb1-9"></a>                     <span class="op">&lt;*&gt;</span> fromMaybe numThreadsDef (mNumThreadsEnv <span class="op">&lt;|&gt;</span> mNumThreadsJson)</span></code></pre></div>
<p>Here's a peek at how our configuration parsing code will end up:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="ot">getOptions ::</span> <span class="dt">IO</span> <span class="dt">Options</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>getOptions <span class="ot">=</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  withDefaults defaultOpts <span class="op">&lt;$&gt;</span> fold [envOpts, jsonOptsCustom <span class="op">&lt;$&gt;</span> readConfigFile]</span></code></pre></div>
<p>This is slightly disingenuous as some of the logic is abstracted away behind the scenes in the second example; but the point here is that the logic CAN be abstracted, whereas it's very difficult to abstract over the steps in the first example without creating a bunch of intermediate types.</p>
<h2 id="kinds-of-options">Kinds of Options</h2>
<p>If you're unfamiliar with HKDTs (higher kinded data types); it's a very simple idea with some mind bending implications. Many data types are parameterized by a value type (e.g. <code>[a]</code> is a list is parameterized by the types of values it contains); however HKDTs are parameterized by some <strong>wrapper</strong> type (typically a functor, but not always) around the data of the record. Easiest to just show an example and see it in practice. Let's define a very simple type to contain all the options our app needs:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">data</span> <span class="dt">Options_</span> f <span class="ot">=</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>    <span class="dt">Options_</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    {<span class="ot"> serverHost ::</span> f <span class="dt">String</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    ,<span class="ot"> numThreads ::</span> f <span class="dt">Int</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    ,<span class="ot"> verbosity  ::</span> f <span class="dt">Int</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    }</span></code></pre></div>
<p>Notice that each field is <em>wrapped</em> in <code>f</code>. I use a <code>_</code> suffix as a convention to denote that it's a HKDT. <code>f</code> could be anything at all of the kind <code>Type -&gt; Type</code>; e.g. <code>Maybe</code>, <code>IO</code>, <code>Either String</code>, or even strange constructions like <code>Compose Maybe (Join (Biff (,) IO Reader))</code> ! You'll discover the implications as we go along, so don't worry if you don't get it yet. For our first example we'll describe how to get options from Environment Variables!</p>
<h2 id="getting-environment-variables">Getting Environment Variables</h2>
<p>Applications will often set configuration values using Environment Variables; it's an easy way to implicitly pass information into programs and is nice for sensitive data like secrets. We can describe the options in our HKDT in terms of Environment Variables which may or may not exist. First we'll need a way to lookup an option for a given key, and a way to convert it into the type we expect. You may want to use something more sophisticated in your app; but for the blog post I'll just lean on the <code>Read</code> typeclass to make a small helper.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">import</span> <span class="dt">System.Environment</span> (lookupEnv, setEnv)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">import</span> <span class="dt">Text.Read</span> (readMaybe)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ot">readEnv ::</span> <span class="dt">Read</span> a <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> a)</span>
<span id="cb4-5"><a href="#cb4-5"></a>readEnv envKey <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    lookupEnv envKey <span class="op">&gt;&gt;=</span> <span class="fu">pure</span> <span class="op">.</span> \<span class="kw">case</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>        <span class="dt">Just</span> x <span class="ot">-&gt;</span> readMaybe x</span>
<span id="cb4-8"><a href="#cb4-8"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>This function looks up the given key in the environment, returning a <code>Nothing</code> if it doesn't exist or fails to parse. We'll talk about more civilized error handling later on, don't worry ;)</p>
<p>Now we can describe how to get each option in our type using this construct:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">-- This doesn&#39;t work!</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="ot">envOpts ::</span> <span class="dt">Options_</span> <span class="op">??</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>envOpts <span class="ot">=</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="dt">OptionsF</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    { serverHost <span class="ot">=</span> readEnv <span class="st">&quot;SERVER_HOST&quot;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>    , numThreads <span class="ot">=</span> readEnv <span class="st">&quot;NUM_THREADS&quot;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>    , verbosity  <span class="ot">=</span> <span class="fu">pure</span> <span class="dt">Nothing</span> <span class="co">-- Don&#39;t read verbosity from environment</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    }</span></code></pre></div>
<p>Close; but if you'll note earlier, each field should contain field's underlying type wrapped in some <code>f</code>. Here we've got <code>IO (Maybe a)</code>, we can't assign <code>f</code> to <code>IO (Maybe _)</code> so we need to compose the two Functors somehow. We can employ <code>Compose</code> here to collect both <code>IO</code> and <code>Maybe</code> into a single Higher Kinded Type to serve as our <code>f</code>. Try the following instead:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">import</span> <span class="dt">Data.Functor.Compose</span> (<span class="dt">Compose</span>(..))</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">-- Add a Compose to our helper</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="ot">readEnv ::</span> <span class="dt">Read</span> a <span class="ot">=&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> (<span class="dt">IO</span> <span class="ot">`Compose`</span> <span class="dt">Maybe</span>) a</span>
<span id="cb6-5"><a href="#cb6-5"></a>readEnv envKey <span class="ot">=</span> <span class="dt">Compose</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="op">...</span></span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="ot">envOpts ::</span> <span class="dt">Options_</span> (<span class="dt">IO</span> <span class="ot">`Compose`</span> <span class="dt">Maybe</span>)</span>
<span id="cb6-9"><a href="#cb6-9"></a>envOpts <span class="ot">=</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="dt">OptionsF</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>    { serverHost <span class="ot">=</span> readEnv <span class="st">&quot;SERVER_HOST&quot;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>    , numThreads <span class="ot">=</span> readEnv <span class="st">&quot;NUM_THREADS&quot;</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>    , verbosity  <span class="ot">=</span> <span class="dt">Compose</span> <span class="op">$</span> <span class="fu">pure</span> <span class="dt">Nothing</span> <span class="co">-- Don&#39;t read verbosity from environment</span></span>
<span id="cb6-14"><a href="#cb6-14"></a>    }</span></code></pre></div>
<p>I personally find it more readable to write <code>Compose</code> as infix like this, but some disagree. Very cool; we've got a version of our record where each field contains an action which gets and parses the right value from the environment! It's clear at a glance that we haven't forgotten to check any fields (if you have <code>-Wall</code> enabled you'd get a warning about missing fields)! We've effectively turned the traditional <code>Options &lt;$&gt; ... &lt;*&gt; ...</code> design <strong>inside out</strong>. It's much more declarative this way, and now that it's all collected as structured data it'll be easier for us to work with from now on too!</p>
<p>Let's build another one!</p>
<h2 id="parsing-jsonyaml-configs">Parsing JSON/YAML Configs</h2>
<p>JSON and YAML configuration files are pretty common these days. I won't bother to dive into where to store them or how we'll parse them, let's assume you've done that already and just pretend we've got ourselves an Aeson <code>Value</code> object from some config file and we want to dump the values into our options object.</p>
<p>We have two options here and I'll show both! The simplest is just to derive <code>FromJSON</code> and cast the value directly into our type!</p>
<p>Unfortunately it's not quite so easy as just tacking on a <code>deriving FromJSON</code>; Since GHC doesn't know what type <code>f</code> is it has a tough time figuring out what you want it to do. If you try you'll get an error like:</p>
<pre><code>• No instance for (FromJSON (f String))</code></pre>
<p>We need to help out GHC a bit. No worries though; someone thought of that! Time to pull in the <a href="http://hackage.haskell.org/package/barbies"><code>barbies</code></a> library. An incredibly useful tool for working with HKDT in general. Add the <code>barbies</code> library to your project, then we'll derive a few handy instances:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ot">{-# LANGUAGE DeriveAnyClass #-}</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="ot">{-# LANGUAGE StandaloneDeriving #-}</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co">-- ...</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">import</span> <span class="dt">GHC.Generics</span> (<span class="dt">Generic</span>)</span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Aeson</span> <span class="kw">as</span> <span class="dt">A</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="kw">import</span> <span class="dt">Data.Barbie</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">-- ...</span></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co">-- Go back and add the deriving clause:</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="kw">data</span> <span class="dt">Options_</span> f <span class="ot">=</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>    <span class="dt">Options_</span> {<span class="op">...</span>}</span>
<span id="cb8-13"><a href="#cb8-13"></a>    <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">FunctorB</span>, <span class="dt">TraversableB</span>, <span class="dt">ProductB</span>, <span class="dt">ConstraintsB</span>, <span class="dt">ProductBC</span>)</span>
<span id="cb8-14"><a href="#cb8-14"></a></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="kw">deriving</span> <span class="kw">instance</span> (<span class="dt">AllBF</span> <span class="dt">Show</span> f <span class="dt">Options_</span>) <span class="ot">=&gt;</span> <span class="dt">Show</span> (<span class="dt">Options_</span> f)</span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="kw">deriving</span> <span class="kw">instance</span> (<span class="dt">AllBF</span> <span class="dt">Eq</span> f <span class="dt">Options_</span>) <span class="ot">=&gt;</span> <span class="dt">Eq</span> (<span class="dt">Options_</span> f)</span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="kw">deriving</span> <span class="kw">instance</span> (<span class="dt">AllBF</span> <span class="dt">A.FromJSON</span> f <span class="dt">Options_</span>) <span class="ot">=&gt;</span> <span class="dt">A.FromJSON</span> (<span class="dt">Options_</span> f)</span></code></pre></div>
<p>Okay! Let's step through some of that. First we derive <code>Generic</code>, it's used by both <code>aeson</code> and <code>barbies</code> for most of their type classes. We derive a bunch of handy <code>*B</code> helpers (B for Barbies) which also come from the <code>barbies</code> lib, we'll explain them as we use them. The important part right now is the <code>deriving instance</code> clauses. <code>AllBF</code> from <code>barbies</code> asserts that <strong>all</strong> the wrapped fields of the typeclass adhere to some type class. For example, <code>AllBF Show f Options_</code> says that <code>f a</code> is Showable for every field in our product. More concretely, in our case <code>AllBF Show f Options</code> expands into something equivalent to <code>(Show (f String), Show (f Int))</code> since we have fields of type <code>String</code> and <code>Int</code>. Nifty! So we can now derive type classes with behaviour dependent on the wrapping type. In most cases this works as expected, and can sometimes be really handy!</p>
<p>One example where this ends up being useful is <code>FromJSON</code>. The behaviour of our <code>FromJSON</code> instance will depend on the wrapper type; if we choose <code>f ~ Maybe</code> then all of our fields become optional! Let's use this behaviour to say that we want to parse our JSON file into an <code>Options</code> object, but it's okay if fields are missing.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">import</span> <span class="dt">Control.Lens</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="ot">jsonOptsDerived ::</span> <span class="dt">A.Value</span> <span class="ot">-&gt;</span> <span class="dt">Options_</span> <span class="dt">Maybe</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>jsonOptsDerived <span class="ot">=</span> fromResult <span class="op">.</span> A.fromJSON</span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="kw">where</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="ot">    fromResult ::</span> <span class="dt">A.Result</span> (<span class="dt">Options_</span> <span class="dt">Maybe</span>) <span class="ot">-&gt;</span> <span class="dt">Options_</span> <span class="dt">Maybe</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>    fromResult (<span class="dt">A.Success</span> a) <span class="ot">=</span> a</span>
<span id="cb9-8"><a href="#cb9-8"></a>    fromResult (<span class="dt">A.Error</span> _) <span class="ot">=</span> buniq <span class="dt">Nothing</span></span></code></pre></div>
<p>A few things to point out here; we call <code>fromJson :: FromJSON a =&gt; Value -&gt; Result a</code> here, but we don't really need the outer <code>Result</code> type; we'd prefer if the failure was localized at the individual field level; simply using <code>Nothing</code> for fields which are missing. So we use <code>fromResult</code> to unpack the result if successful, or to construct an <code>Options_ Maybe</code> filled completely with <code>Nothing</code> if the parsing fails for some reason (you'll probably want to come back an improve this error handling behaviour later). You'll notice that nothing we do really has much to do with <code>Options_</code>; so let's generalize this into a combinator we can re-use in the future:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">jsonOptsDerived ::</span> (<span class="dt">A.FromJSON</span> (b <span class="dt">Maybe</span>), <span class="dt">ProductB</span> b) <span class="ot">=&gt;</span> <span class="dt">A.Value</span> <span class="ot">-&gt;</span> b <span class="dt">Maybe</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>jsonOptsDerived <span class="ot">=</span> fromResult <span class="op">.</span> A.fromJSON</span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="kw">where</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="ot">    fromResult ::</span> <span class="dt">ProductB</span> b <span class="ot">=&gt;</span> <span class="dt">A.Result</span> (b <span class="dt">Maybe</span>) <span class="ot">-&gt;</span> b <span class="dt">Maybe</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>    fromResult (<span class="dt">A.Success</span> a) <span class="ot">=</span> a</span>
<span id="cb10-6"><a href="#cb10-6"></a>    fromResult (<span class="dt">A.Error</span> _) <span class="ot">=</span> buniq <span class="dt">Nothing</span></span></code></pre></div>
<p><code>buniq</code> requires a <code>ProductB</code> constraint which asserts that the type we're constructing is a Record type or some other Product. This is required because <code>buniq</code> wouldn't know which constructor to instantiate if it were a Sum-type.</p>
<p>Okay, we've seen the generic version; here's a different approach where we can choose HOW to deserialize each option from the provided <code>Value</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">import</span> <span class="dt">Data.Text.Lens</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">import</span> <span class="dt">Data.Aeson.Lens</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="kw">import</span> <span class="dt">Control.Lens</span></span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="ot">jsonOptsCustom ::</span> <span class="dt">A.Value</span> <span class="ot">-&gt;</span> <span class="dt">Options_</span> <span class="dt">Maybe</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>jsonOptsCustom <span class="ot">=</span> bsequence</span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="dt">Options_</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>    { serverHost <span class="ot">=</span> findField <span class="op">$</span> key <span class="st">&quot;host&quot;</span>        <span class="op">.</span> _String <span class="op">.</span> unpacked</span>
<span id="cb11-9"><a href="#cb11-9"></a>    , numThreads <span class="ot">=</span> findField <span class="op">$</span> key <span class="st">&quot;num_threads&quot;</span> <span class="op">.</span> _Number <span class="op">.</span> to <span class="fu">round</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>    , verbosity  <span class="ot">=</span> findField <span class="op">$</span> key <span class="st">&quot;verbosity&quot;</span>   <span class="op">.</span> _Number <span class="op">.</span> to <span class="fu">round</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>    }</span>
<span id="cb11-12"><a href="#cb11-12"></a>      <span class="kw">where</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="ot">        findField ::</span> <span class="dt">Fold</span> <span class="dt">A.Value</span> a <span class="ot">-&gt;</span> <span class="dt">Compose</span> ((<span class="ot">-&gt;</span>) <span class="dt">A.Value</span>) <span class="dt">Maybe</span> a</span>
<span id="cb11-14"><a href="#cb11-14"></a>        findField p <span class="ot">=</span> <span class="dt">Compose</span> (preview p)</span></code></pre></div>
<p>Some of these types get a bit funky; but IMHO they wouldn't be too terrible if this were all bundled up in some lib for readability. As I said earlier, some of the ergonomics still have room for improvement.</p>
<p>Let's talk about what this thing does! First we import a bunch of lensy stuff; then in each field of our options type we build a getter function from <code>Value -&gt; Maybe a</code> which tries to extract the field from the JSON Value. <code>preview</code> mixed with <code>Data.Aeson.Lens</code> happens to be a handy way to do this. I pulled out the <code>findField</code> helper mainly to draw attention to the rather cryptic <code>Compose ((-&gt;) A.Value) Maybe a</code> type signature. This is just <code>Compose</code> wrapped around a function <code>A.Value -&gt; Maybe a</code>; why do we need the <code>Compose</code> here? What we REALLY want is <code>A.Value -&gt; Option_ Maybe</code>; but remember that every field MUST contain something that matches <code>f a</code> for some <code>f</code>. A function signature like <code>A.Value -&gt; Maybe a</code> doesn't match this form, but <code>Compose ((-&gt;) A.Value) Maybe a</code> does (where <code>f ~ Compose ((-&gt;) A.Value) Maybe</code>)! Ideally we'd then like to pull the function bits to the outside since we'll be calling each field with the same argument. Conveniently; <code>barbies</code> provides us with <code>bsequence</code>; whose type looks like this:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="ot">bsequence ::</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  (<span class="dt">Applicative</span> f, <span class="dt">TraversableB</span> b) <span class="ot">=&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  b (<span class="dt">Compose</span> f g) <span class="ot">-&gt;</span> f (b g)</span></code></pre></div>
<p>Or if we specialize it to this particular case:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="ot">bsequence ::</span> <span class="dt">Options_</span> (<span class="dt">Compose</span> ((<span class="ot">-&gt;</span>) <span class="dt">A.Value</span>) <span class="dt">Maybe</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a>          <span class="ot">-&gt;</span> (<span class="dt">A.Value</span> <span class="ot">-&gt;</span> <span class="dt">Options_</span> <span class="dt">Maybe</span>)</span></code></pre></div>
<p>We use the <code>-&gt;</code> applicative (also known as <code>Reader</code>) to extract the function Functor to the outside of the structure! This of course requires that the individual fields can be traversed; implying the <code>TraversableB</code> constraint. Hopefully this demonstrates the flexibility of this technique, we can provide an arbitrary lens chain to extract the value for each setting, maybe it's overkill in this case, but I can think of a few situations where it would be pretty handy.</p>
<p>While we're at it, let's <code>bsequence</code> our earlier Environment Variable object to get the IO on the outside!</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a><span class="ot">envOpts ::</span> <span class="dt">IO</span> (<span class="dt">Options_</span> <span class="dt">Maybe</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a>envOpts <span class="ot">=</span> bsequence</span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="dt">Options_</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="co">-- serverHost is already a string so we don&#39;t need to &#39;read&#39; it.</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    { serverHost <span class="ot">=</span> <span class="dt">Compose</span> <span class="op">.</span> lookupEnv <span class="op">$</span> <span class="st">&quot;SERVER_HOST&quot;</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>    , numThreads <span class="ot">=</span> readEnv <span class="st">&quot;NUM_THREADS&quot;</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="co">-- We can &#39;ignore&#39; a field by simply returning Nothing.</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>    , verbosity    <span class="ot">=</span> <span class="dt">Compose</span> <span class="op">.</span> <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Nothing</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>    }</span></code></pre></div>
<p>This is dragging on a bit; let's see how we can actually use these things!</p>
<h2 id="combining-options-objects">Combining Options Objects</h2>
<p>Now that we've got two different ways to collect options for our program let's see how we can combine them. Let's write a simple action in IO for getting and combining our options parsers.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">import</span> <span class="dt">Control.Applicative</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="co">-- Fake config file for convenience</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="ot">readConfigFile ::</span> <span class="dt">IO</span> <span class="dt">A.Value</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>readConfigFile <span class="ot">=</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>    <span class="fu">pure</span> <span class="op">$</span> A.object [ <span class="st">&quot;host&quot;</span> <span class="op">A..=</span> <span class="dt">A.String</span> <span class="st">&quot;example.com&quot;</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>                    , <span class="st">&quot;verbosity&quot;</span> <span class="op">A..=</span> <span class="dt">A.Number</span> <span class="dv">42</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>                    ]</span>
<span id="cb15-9"><a href="#cb15-9"></a></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="ot">getOptions ::</span> <span class="dt">IO</span> (<span class="dt">Options_</span> <span class="dt">Maybe</span>)</span>
<span id="cb15-11"><a href="#cb15-11"></a>getOptions <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>    configJson <span class="ot">&lt;-</span> readConfigFile</span>
<span id="cb15-13"><a href="#cb15-13"></a>    envOpts&#39; <span class="ot">&lt;-</span> envOpts</span>
<span id="cb15-14"><a href="#cb15-14"></a>    <span class="fu">return</span> <span class="op">$</span> bzipWith (<span class="op">&lt;|&gt;</span>) envOpts&#39; (jsonOptsCustom configJson)</span></code></pre></div>
<p>Let's try it out, then I'll explain it.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a>λ<span class="op">&gt;</span> getOptions</span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="dt">Options_</span> {serverHost <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;example.com&quot;</span>, numThreads <span class="ot">=</span> <span class="dt">Nothing</span>, verbosity <span class="ot">=</span> <span class="dt">Just</span> <span class="dv">42</span>}</span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a>λ<span class="op">&gt;</span> setEnv <span class="st">&quot;NUM_THREADS&quot;</span> <span class="st">&quot;1337&quot;</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>λ<span class="op">&gt;</span> getOptions</span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="dt">Options_</span> {serverHost <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;example.com&quot;</span>, numThreads <span class="ot">=</span> <span class="dt">Just</span> <span class="dv">1337</span>, verbosity <span class="ot">=</span> <span class="dt">Just</span> <span class="dv">42</span>}</span>
<span id="cb16-7"><a href="#cb16-7"></a></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="co">-- We&#39;ve set things up so that environment variables override our JSON config.</span></span>
<span id="cb16-9"><a href="#cb16-9"></a>λ<span class="op">&gt;</span> setEnv <span class="st">&quot;SERVER_HOST&quot;</span> <span class="st">&quot;chrispenner.ca&quot;</span></span>
<span id="cb16-10"><a href="#cb16-10"></a>λ<span class="op">&gt;</span> getOptions</span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="dt">Options_</span> {serverHost <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;chrispenner.ca&quot;</span>, numThreads <span class="ot">=</span> <span class="dt">Just</span> <span class="dv">1337</span>, verbosity <span class="ot">=</span> <span class="dt">Just</span> <span class="dv">42</span>}</span></code></pre></div>
<p>Now that we're combining sets of config values we need to decide what semantics we want when values overlap! I've decided to use <code>&lt;|&gt;</code> from <code>Alternative</code> to combine our <code>Maybe</code> values. This basically means "take the first non-Nothing value and ignore the rest". That means in our case that the first setting to be "set" wins out. <code>bzipWith</code> performs element-wise zipping of each element within our <code>Options_</code> record, with the caveat that the function you give it must work over any possible <code>a</code> contained inside. In our case the type is specialized to:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a><span class="ot">bzipWith  ::</span> (<span class="kw">forall</span> a<span class="op">.</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a)</span>
<span id="cb17-2"><a href="#cb17-2"></a>          <span class="ot">-&gt;</span> <span class="dt">Options_</span> <span class="dt">Maybe</span> <span class="ot">-&gt;</span> <span class="dt">Options_</span> <span class="dt">Maybe</span> <span class="ot">-&gt;</span> <span class="dt">Options_</span> <span class="dt">Maybe</span></span></code></pre></div>
<p>Which does what we want. This end bit is going to get messy if we add any more sources though, let's see if we can't clean it up! My first thought is that I'd love to use <code>&lt;|&gt;</code> without any lifting/zipping, but the kinds don't line up; <code>Options_</code> is kind <code>(Type -&gt; Type) -&gt; Type</code> whereas <code>Type -&gt; Type</code> is required by <code>Alternative</code>. How do we lift Alternative to Higher Kinds? Well we could try something clever, <strong>OR</strong> we could go the opposite direction and use <code>Alternative</code> to build a <code>Monoid</code> instance for our type; then use that to combine our values!</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">instance</span> (<span class="dt">Alternative</span> f) <span class="ot">=&gt;</span> <span class="dt">Semigroup</span> (<span class="dt">Options_</span> f) <span class="kw">where</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  (<span class="op">&lt;&gt;</span>) <span class="ot">=</span> bzipWith (<span class="op">&lt;|&gt;</span>)</span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="kw">instance</span> (<span class="dt">Alternative</span> f) <span class="ot">=&gt;</span> <span class="dt">Monoid</span> (<span class="dt">Options_</span> f) <span class="kw">where</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="fu">mempty</span> <span class="ot">=</span> buniq empty</span></code></pre></div>
<p>Now we have a Monoid for <code>Options_</code> whenever <code>f</code> is an <code>Alternative</code> such as <code>Maybe</code>! There are many possible <code>Monoid</code> instance for HKDTs, but in our case it works great! <code>Alternative</code> is actually just a Monoid in the category of Applicative Functors, so it makes sense that it makes a suitable Monoid if we apply it to values within an HKDT.</p>
<p>Let's see how we can refactor things.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1"></a><span class="ot">getOptions ::</span> <span class="dt">IO</span> (<span class="dt">Options_</span> <span class="dt">Maybe</span>)</span>
<span id="cb19-2"><a href="#cb19-2"></a>getOptions <span class="ot">=</span> envOpts <span class="op">&lt;&gt;</span> (jsonOptsCustom <span class="op">&lt;$&gt;</span> readConfigFile)</span></code></pre></div>
<p>Wait a minute; what about the <code>IO</code>? Here I'm actually employing <code>IO</code>s little known Monoid instance! <code>IO</code> is a Monoid whenever the result of the <code>IO</code> is a Monoid; it simply runs both <code>IO</code> actions then <code>mappends</code> the results (e.g. <code>liftA2 (&lt;&gt;)</code>). In this case it's perfect! As we get even more possible option parsers we could even just put them in a list and <code>fold</code> them together: <code>fold [envOpts, jsonOptsCustom &lt;$&gt; readConfigFile, ...]</code></p>
<p>But wait! There's more!</p>
<h2 id="setting-default-values">Setting Default Values</h2>
<p>We've seen how we can specify multiple <strong>partial</strong> configuration sources, but at the end of the day we're still left with an <code>Options_ Maybe</code>! What if we want to guarantee that we have a value for all required config values? Let's write a new helper.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1"></a><span class="ot">withDefaults ::</span> <span class="dt">ProductB</span> b <span class="ot">=&gt;</span> b <span class="dt">Identity</span> <span class="ot">-&gt;</span> b <span class="dt">Maybe</span> <span class="ot">-&gt;</span> b <span class="dt">Identity</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>withDefaults <span class="ot">=</span> bzipWith fromMaybeI</span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="kw">where</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="ot">    fromMaybeI ::</span> <span class="dt">Identity</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Identity</span> a</span>
<span id="cb20-5"><a href="#cb20-5"></a>    fromMaybeI (<span class="dt">Identity</span> a) <span class="dt">Nothing</span>  <span class="ot">=</span> <span class="dt">Identity</span> a</span>
<span id="cb20-6"><a href="#cb20-6"></a>    fromMaybeI _            (<span class="dt">Just</span> a) <span class="ot">=</span> <span class="dt">Identity</span> a</span></code></pre></div>
<p>This new helper uses our old friend <code>bzipWith</code> to lift a slightly altered <code>fromMaybe</code> to run over HKDTs! We have to do a little bit of annoying wrapping/unwrapping of Identity, but it's not too bad. This function will take the config value from any <code>Just</code>'s in our <code>Options_ Maybe</code> and will choose the default for the <code>Nothing</code>s!</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">import</span> <span class="dt">Data.Foldable</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="co">---</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="kw">type</span> <span class="dt">Options</span> <span class="ot">=</span> <span class="dt">Options_</span> <span class="dt">Identity</span></span>
<span id="cb21-4"><a href="#cb21-4"></a></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="ot">getOptions ::</span> <span class="dt">IO</span> <span class="dt">Options</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>getOptions <span class="ot">=</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>  withDefaults defaultOpts <span class="op">&lt;$&gt;</span> fold [envOpts, jsonOptsCustom <span class="op">&lt;$&gt;</span> readConfigFile]</span></code></pre></div>
<p>We introduce the alias <code>type Options = Options_ Identity</code> as a convenience.</p>
<h2 id="better-errors">Better Errors</h2>
<p>So far our system silently fails in a lot of places. Let's see how HKDTs can give us more expressive error handling!</p>
<p>The first cool thing is that we can store error messages directly alongside fields they pertain to!</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="co">---</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="ot">optErrors ::</span> <span class="dt">Options_</span> (<span class="dt">Const</span> <span class="dt">String</span>)</span>
<span id="cb22-4"><a href="#cb22-4"></a>optErrors <span class="ot">=</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="dt">Options_</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>    { serverHost <span class="ot">=</span> <span class="st">&quot;server host required but not provided&quot;</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>    , numThreads <span class="ot">=</span> <span class="st">&quot;num threads required but not provided&quot;</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>    , verbosity  <span class="ot">=</span> <span class="st">&quot;verbosity required but not provided&quot;</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>    }</span></code></pre></div>
<p>If we use <code>Const String</code> in our HKDT we are saying that we actually don't care about the type of the field itself, we just want to store a string no matter what! If we turn on <code>OverloadedStrings</code> we can even leave out the <code>Const</code> constructor if we like! But I'll leave that choice up to you.</p>
<p>Now that we've got errors which relate to each field we can construct a helpful error message if we're missing required fields:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">import</span> <span class="dt">Data.Either.Validation</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="co">---</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="ot">validateOptions ::</span> (<span class="dt">TraversableB</span> b, <span class="dt">ProductB</span> b)</span>
<span id="cb23-4"><a href="#cb23-4"></a>                <span class="ot">=&gt;</span> b (<span class="dt">Const</span> <span class="dt">String</span>)</span>
<span id="cb23-5"><a href="#cb23-5"></a>                <span class="ot">-&gt;</span> b <span class="dt">Maybe</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>                <span class="ot">-&gt;</span> <span class="dt">Validation</span> [<span class="dt">String</span>] (b <span class="dt">Identity</span>)</span>
<span id="cb23-7"><a href="#cb23-7"></a>validateOptions errMsgs mOpts <span class="ot">=</span> bsequence&#39; <span class="op">$</span> bzipWith validate mOpts errMsgs</span>
<span id="cb23-8"><a href="#cb23-8"></a>  <span class="kw">where</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="ot">    validate ::</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> <span class="dt">Const</span> <span class="dt">String</span> a <span class="ot">-&gt;</span> <span class="dt">Validation</span> [<span class="dt">String</span>] a</span>
<span id="cb23-10"><a href="#cb23-10"></a>    validate (<span class="dt">Just</span> x) _          <span class="ot">=</span> <span class="dt">Success</span> x</span>
<span id="cb23-11"><a href="#cb23-11"></a>    validate <span class="dt">Nothing</span> (<span class="dt">Const</span> err) <span class="ot">=</span> <span class="dt">Failure</span> [err]</span></code></pre></div>
<p><code>validateOptions</code> takes any traversable product HKDT with <code>Maybe</code> fields and an HKDT filled with error messages inside <code>Const</code> and will return a <code>Validation</code> object containing either a summary of errors or a validated <code>Identity</code> HKDT. Just as before we use <code>bzipWith</code> with a function which operates at the level of functors as a Natural Transformation; i.e. it cares only about the containers, not the values. Note that Validation is very similar to the <code>Either</code> type, but accumulates all available errors rather than failing fast. We use <code>bsequence'</code> here, which is just like <code>bsequence</code>; but saves us the trouble of explicitly threading an <code>Identity</code> into our structure. Check the docs in <code>barbies</code> if you'd like to learn more.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1"></a><span class="ot">getOptions ::</span> <span class="dt">IO</span> (<span class="dt">Validation</span> [<span class="dt">String</span>] <span class="dt">Options</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a>getOptions <span class="ot">=</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>  validateOptions optErrors <span class="op">&lt;$&gt;</span> fold [envOpts, jsonOptsCustom <span class="op">&lt;$&gt;</span> readConfigFile]</span></code></pre></div>
<p>Now if we end up with values missing we get a list of errors!</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1"></a>λ<span class="op">&gt;</span> getOptions</span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="dt">Failure</span> [<span class="st">&quot;num threads required but not provided&quot;</span>]</span></code></pre></div>
<p>You can trust me that if we had more than one thing missing it would collect them all. That's a lot of content all at once, so I'll leave some other experiments for next time. Once you start to experiment a world of opportunities opens up; you can describe validation, forms, documentations, schemas, and a bunch of other stuff I haven't even though of yet!! A challenge for the reader: try writing a proper validator using HKDTs which validates that each field fulfills specific properties. For example, check that the number of threads is &gt; 0; check that the host is non-empty, etc. You may find the following newtype helpful ;) <code>newtype Checker a = Checker (a -&gt; Maybe String)</code></p>
<h2 id="bonus-parsing-cli-options">Bonus: Parsing CLI Options</h2>
<p>Just for fun here's a bonus config source for getting options from the Command Line using Optparse Applicative</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">import</span> <span class="dt">Options.Applicative</span> <span class="kw">hiding</span> (<span class="dt">Failure</span>, <span class="dt">Success</span>)</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="co">---</span></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="ot">cliOptsParser ::</span> <span class="dt">Options_</span> <span class="dt">Parser</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>cliOptsParser <span class="ot">=</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>    <span class="dt">Options_</span></span>
<span id="cb26-6"><a href="#cb26-6"></a>    { serverHost <span class="ot">=</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>          strOption (long <span class="st">&quot;serverHost&quot;</span> <span class="op">&lt;&gt;</span> metavar <span class="st">&quot;HOST&quot;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;host for API interactions&quot;</span>)</span>
<span id="cb26-8"><a href="#cb26-8"></a>    , numThreads <span class="ot">=</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>          option auto</span>
<span id="cb26-10"><a href="#cb26-10"></a>                 (long <span class="st">&quot;threads&quot;</span> <span class="op">&lt;&gt;</span> short <span class="ch">&#39;t&#39;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;number of threads&quot;</span> <span class="op">&lt;&gt;</span> metavar <span class="st">&quot;INT&quot;</span>)</span>
<span id="cb26-11"><a href="#cb26-11"></a>    , verbosity  <span class="ot">=</span> option auto</span>
<span id="cb26-12"><a href="#cb26-12"></a>                          (long <span class="st">&quot;verbosity&quot;</span></span>
<span id="cb26-13"><a href="#cb26-13"></a>                           <span class="op">&lt;&gt;</span> short <span class="ch">&#39;v&#39;</span></span>
<span id="cb26-14"><a href="#cb26-14"></a>                           <span class="op">&lt;&gt;</span> help <span class="st">&quot;Level of verbosity&quot;</span></span>
<span id="cb26-15"><a href="#cb26-15"></a>                           <span class="op">&lt;&gt;</span> metavar <span class="st">&quot;VERBOSITY&quot;</span>)</span>
<span id="cb26-16"><a href="#cb26-16"></a>    }</span>
<span id="cb26-17"><a href="#cb26-17"></a></span>
<span id="cb26-18"><a href="#cb26-18"></a></span>
<span id="cb26-19"><a href="#cb26-19"></a><span class="ot">mkOptional ::</span> <span class="dt">FunctorB</span> b <span class="ot">=&gt;</span> b <span class="dt">Parser</span> <span class="ot">-&gt;</span> b (<span class="dt">Parser</span> <span class="ot">`Compose`</span> <span class="dt">Maybe</span>)</span>
<span id="cb26-20"><a href="#cb26-20"></a>mkOptional <span class="ot">=</span> bmap (<span class="dt">Compose</span> <span class="op">.</span> optional)</span>
<span id="cb26-21"><a href="#cb26-21"></a></span>
<span id="cb26-22"><a href="#cb26-22"></a><span class="ot">toParserInfo ::</span> (<span class="dt">TraversableB</span> b) <span class="ot">=&gt;</span> b (<span class="dt">Parser</span> <span class="ot">`Compose`</span> <span class="dt">Maybe</span>) <span class="ot">-&gt;</span> <span class="dt">ParserInfo</span> (b <span class="dt">Maybe</span>)</span>
<span id="cb26-23"><a href="#cb26-23"></a>toParserInfo b <span class="ot">=</span> info (bsequence b) briefDesc</span>
<span id="cb26-24"><a href="#cb26-24"></a></span>
<span id="cb26-25"><a href="#cb26-25"></a><span class="ot">cliOpts ::</span> <span class="dt">IO</span> (<span class="dt">Options_</span> <span class="dt">Maybe</span>)</span>
<span id="cb26-26"><a href="#cb26-26"></a>cliOpts <span class="ot">=</span> execParser <span class="op">$</span> toParserInfo (mkOptional cliOptsParser)</span>
<span id="cb26-27"><a href="#cb26-27"></a></span>
<span id="cb26-28"><a href="#cb26-28"></a><span class="ot">getOptions ::</span> <span class="dt">IO</span> (<span class="dt">Validation</span> [<span class="dt">String</span>] <span class="dt">Options</span>)</span>
<span id="cb26-29"><a href="#cb26-29"></a>getOptions <span class="ot">=</span></span>
<span id="cb26-30"><a href="#cb26-30"></a>  validateOptions optErrors <span class="op">&lt;$&gt;</span> fold [cliOpts, envOpts, jsonOptsCustom <span class="op">&lt;$&gt;</span> readConfigFile]</span></code></pre></div>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Mocking Effects using Constraints and Phantom Data Kinds</title>
      <link href="https://chrispenner.ca/posts/mock-effects-with-data-kinds"/>
      <id>https://chrispenner.ca/posts/mock-effects-with-data-kinds</id>
      <updated>2018-09-29T00:00:00Z</updated>
      <summary>We learn a method to mock multiple effects when writing tests without an exponential explosion of instances.</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/mock-effects-with-data-kinds/phantom.jpg" alt="Mocking Effects using Constraints and Phantom Data Kinds">
              <p>This ended up being a pretty long post; if you're pretty comfortable with monad constraints and testing in Haskell you may want to jump down to the Phantom Data Kinds section and get to the interesting stuff!</p>
<h2 id="refresher-on-granular-classes">Refresher on granular classes</h2>
<p>I've been seeing a lot of talk on the <a href="https://reddit.com/r/haskell">Haskell subreddit</a> about how to properly test Haskell applications; particular how to test actions which require effects. I've seen a lot of confusion/concern about writing your own monad transformers in tests. This post is my attempt to clear up some confusion and misconceptions and show off my particular ideas for testing using <code>mtl-style</code> constraints. The ideas contained here can also help you with writing multiple 'interpreters' for your monad stacks without needing a <code>newtype</code> for each permutation of possible implementations.</p>
<p>First things first, what do I mean by <code>mtl-style</code> constraints? I'd recommend you consult <a href="https://chrispenner.ca/posts/monadio-considered-harmful">MonadIO Considered Harmful</a>, it's a post I wrote on the topic almost exactly a year ago. Here's the spark-notes version:</p>
<ul>
<li>Monads with semantics attached should define a <code>Monad*</code> type-class for interacting with those constraints (E.g. <code>MonadState</code>, <code>MonadReader</code>)</li>
<li>Actions which require effects should use type-class constraints instead of using concrete monads (E.g. <code>myAction :: MonadReader AppEnv m =&gt; m ()</code> rather than <code>myAction :: AppM ()</code>)</li>
<li>Your app should break up 'big' monad classes into smaller ones with clearer semantics and intent. (E.g. Break down <code>MonadIO</code> into <code>MonadHttp</code> and <code>MonadFilesystem</code>, etc.)</li>
</ul>
<p>Okay, so assuming we're all on board with writing our code polymorphically using Monad Constraints, what's the problem? Well, the reason we're doing it polymorphically is so we can specialize the monad to <strong>different implementations</strong> if we want! This is one way to implement the <a href="https://en.wikipedia.org/wiki/Dependency_injection"><strong>dependency injection</strong></a> pattern in Haskell; and lets us substitute out the implementation of our monadic effects with 'dummy' or 'mock' versions in tests.</p>
<p>The trick is that we run into a lot of annoying repetition and boiler-plate which gets out of control as we scale up the number of effects we use. To show the problem let's assume we have some action that does something, and needs the following three constraints which you can assume are type-classes we've defined using the 'granular mtl' style:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">myAction ::</span> (<span class="dt">MonadFileSystem</span> m, <span class="dt">MonadDB</span> m, <span class="dt">MonadLogger</span> m) <span class="ot">=&gt;</span> m ()</span></code></pre></div>
<p>Now, assume we've already implemented <code>MonadFileSystem</code>, <code>MonadDB</code>, and <code>MonadLogger</code> for our application's main monad, but when we test it we probably don't want to hit our real DB or file-system so we should probably mock those out. We'll need a new monad type to implement instances against:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">data</span> <span class="dt">TestState</span> <span class="ot">=</span> <span class="dt">TestState</span> </span>
<span id="cb2-2"><a href="#cb2-2"></a>    {<span class="ot"> fakeFilesystem ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">String</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    ,<span class="ot"> fakeDB ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">String</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    ,<span class="ot"> logs ::</span> [<span class="dt">String</span>]</span>
<span id="cb2-5"><a href="#cb2-5"></a>    }</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="kw">newtype</span> <span class="dt">TestM</span> a <span class="ot">=</span> <span class="dt">TestM</span> (<span class="dt">State</span> <span class="dt">TestState</span> a)</span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="kw">instance</span> <span class="dt">MonadFileSystem</span> <span class="dt">TestM</span> <span class="kw">where</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">-- ...</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="kw">instance</span> <span class="dt">MonadDB</span> <span class="dt">TestM</span> <span class="kw">where</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">-- ...</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="kw">instance</span> <span class="dt">MonadLogger</span> <span class="dt">TestM</span> <span class="kw">where</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">-- ...</span></span></code></pre></div>
<p>I'm not getting into many details yet and have elided the implementations here for brevity, but hopefully that shows how you could implement those interfaces in terms of some pure monad stack like <code>State</code> in order to more easily write tests. BUT! What if for a new test we want the file-system to behave differently and fail on every request to read a file? We could add a boolean into the state that dictates this behaviour, but that will definitely complicate the implementation of our instance, we could add a newtype wrapper which has a different <code>MonadFileSystem</code> instance, but we'd need to regain all our instances for the other type-classes again! We can use <code>GeneralizedNewtypeDeriving</code> to help, but say we now want multiple behaviours for our MonadDB instance! Things get out of control really quickly, this post investigates a (slightly) cleaner way to go about this.</p>
<p>Our goals are as follows:</p>
<ul>
<li>I want to write exactly 1 instance definition per type-class behaviour I want</li>
<li>Adding a new effect or behaviour shouldn't require any newtypes.</li>
<li>I should be able to easily choose a set of behaviours for each of my effects each time I run a test.</li>
</ul>
<p>That's a tall order! Let's dig in and see if we can manage it!</p>
<h2 id="case-study">Case Study</h2>
<p>This topic is tough to explain without concrete examples, so bear with me while we set some things up. Let's start by looking at how someone may have written a really simple app and some functions for working with their database.</p>
<p>Here's our base monad type:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw">import</span> <span class="dt">Control.Monad.Except</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span></span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="kw">data</span> <span class="dt">DBError</span> <span class="ot">=</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="dt">DBError</span> <span class="dt">String</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">-- Our application can access the database via IO and possibly throw DB errors.</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="kw">newtype</span> <span class="dt">AppM</span> a <span class="ot">=</span> <span class="dt">AppM</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>  {<span class="ot"> runAppM ::</span> <span class="dt">ExceptT</span> <span class="dt">DBError</span> <span class="dt">IO</span> a</span>
<span id="cb3-13"><a href="#cb3-13"></a>  } <span class="kw">deriving</span> (<span class="dt">Functor</span>, <span class="dt">Applicative</span>, <span class="dt">Monad</span>, <span class="dt">MonadIO</span>, <span class="dt">MonadError</span> <span class="dt">DBError</span>)</span></code></pre></div>
<p>We've abstracted over our database actions already with the following type-class:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="ot">{-# LANGUAGE FunctionalDependencies #-}</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">type</span> <span class="dt">Key</span> <span class="ot">=</span> <span class="dt">String</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">-- Our database associates string keys to some value type.</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">-- The specific value we can fetch is dependent on the monad</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">-- (but we&#39;ll just use strings for simplicity in our case)</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="kw">class</span> (<span class="dt">MonadError</span> <span class="dt">DBError</span> m) <span class="ot">=&gt;</span> <span class="dt">MonadDB</span> m v <span class="op">|</span> m <span class="ot">-&gt;</span> v <span class="kw">where</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="ot">  getEntity ::</span> <span class="dt">Key</span> <span class="ot">-&gt;</span> m v</span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="ot">  storeEntity ::</span> <span class="dt">Key</span> <span class="ot">-&gt;</span> v <span class="ot">-&gt;</span> m ()</span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="kw">instance</span> <span class="dt">MonadDB</span> <span class="dt">AppM</span> <span class="dt">String</span> <span class="kw">where</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">-- ...</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">-- Assume we&#39;ve written some instance for interacting with our DB via IO, </span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">-- which returns any errors via ExceptT.</span></span></code></pre></div>
<p>Cool! This looks pretty normal, we have a primary app monad and we can get and store strings in our database via IO using it!</p>
<p>Now that we've got our basic DB interface let's say we want to write a more complex action using it:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">-- given a database key and a monad which can interact with a database containing strings</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">-- we can look up the value, uppercase it, then write it back.</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ot">upperCase ::</span> (<span class="dt">MonadDB</span> m <span class="dt">String</span>) <span class="ot">=&gt;</span> <span class="dt">Key</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb5-4"><a href="#cb5-4"></a>upperCase key <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  thing <span class="ot">&lt;-</span> getEntity key</span>
<span id="cb5-6"><a href="#cb5-6"></a>  storeEntity key (<span class="fu">fmap</span> <span class="fu">toUpper</span> thing)</span></code></pre></div>
<p>It's a pretty simple action, but we should probably add some unit tests! Let's set it up using our AppM instance!</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">-- Spec.hs</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb6-3"><a href="#cb6-3"></a>main <span class="ot">=</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  hspec <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>    describe <span class="st">&quot;upperCase&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>      it <span class="st">&quot;uppercases the value stored at the given key in the DB&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>        result <span class="ot">&lt;-</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>          <span class="co">-- we unpack AppM, run the exceptT, then lift it into the IO part of our spec</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>          liftIO <span class="op">.</span> runExceptT <span class="op">.</span> runAppM <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>            storeEntity <span class="st">&quot;my-key&quot;</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>            upperCase <span class="st">&quot;my-key&quot;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>            getEntity <span class="st">&quot;my-key&quot;</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>        result <span class="ot">`shouldBe`</span> <span class="dt">Right</span> <span class="st">&quot;VALUE&quot;</span></span></code></pre></div>
<p>Well, this should work, but we're using <code>IO</code> directly in tests; not only is this going to be slow; but it means we need to have a database running somewhere, and that the tests might pass or fail depending on the initial state of that database! Clearly that's not ideal! We really only want to test the semantics of <code>upperCase</code> and how it <strong>glues together</strong> the interface of our database; we don't really care which database it's operating over.</p>
<p>Our <code>uppercase</code> action is polymorphic over the monad it uses, so that means we can write a new instance for <code>MonadDB</code> and get it to use that in the tests instead!</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">import</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">-- We&#39;ll use a Map as our database implementation, storing it in a state monad</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">-- We also add ExceptT so we can see if our DB failed to look something up!</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="kw">newtype</span> <span class="dt">TestM</span> a <span class="ot">=</span> <span class="dt">TestM</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  {<span class="ot"> runTestM ::</span> <span class="dt">ExceptT</span> <span class="dt">DBError</span> (<span class="dt">State</span> (<span class="dt">M.Map</span> <span class="dt">String</span> <span class="dt">String</span>)) a</span>
<span id="cb7-7"><a href="#cb7-7"></a>  } <span class="kw">deriving</span> ( <span class="dt">Functor</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>             , <span class="dt">Applicative</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>             , <span class="dt">Monad</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>             , <span class="dt">MonadError</span> <span class="dt">DBError</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>             , <span class="dt">MonadState</span> (<span class="dt">M.Map</span> <span class="dt">String</span> <span class="dt">String</span>)</span>
<span id="cb7-12"><a href="#cb7-12"></a>             )</span>
<span id="cb7-13"><a href="#cb7-13"></a></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">-- We&#39;ll implement an instance of MonadDB for our TestM monad.</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="kw">instance</span> <span class="dt">MonadDB</span> <span class="dt">TestM</span> <span class="dt">String</span> <span class="kw">where</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>  getEntity key <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>    db <span class="ot">&lt;-</span> get</span>
<span id="cb7-18"><a href="#cb7-18"></a>    <span class="kw">case</span> M.lookup key db <span class="kw">of</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwError <span class="op">.</span> <span class="dt">DBError</span> <span class="op">$</span> <span class="st">&quot;didn&#39;t find &quot;</span> <span class="op">++</span> key <span class="op">++</span> <span class="st">&quot; in db&quot;</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>      <span class="dt">Just</span> v <span class="ot">-&gt;</span> <span class="fu">return</span> v</span>
<span id="cb7-21"><a href="#cb7-21"></a>  storeEntity key value <span class="ot">=</span> modify (M.insert key value)</span>
<span id="cb7-22"><a href="#cb7-22"></a></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="ot">runTestM&#39; ::</span> <span class="dt">M.Map</span> <span class="dt">String</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">TestM</span> a <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">DBError</span> a</span>
<span id="cb7-24"><a href="#cb7-24"></a>runTestM&#39; db (<span class="dt">TestM</span> m) <span class="ot">=</span> <span class="fu">flip</span> evalState db <span class="op">.</span> runExceptT <span class="op">$</span> m</span></code></pre></div>
<p>Now we have a completely <strong>pure</strong> way of modeling our DB, which we can seed with initial data, and we can even inspect the final state if we like! This makes writing tests <em>so</em> much easier. We can re-write the <code>upperCase</code> test using <code>State</code> instead of <code>IO</code>! This means we have fewer dependencies, fewer unknowns, and can more directly test the behaviour of the action which we actually care about.</p>
<p>Here's the re-written spec, the test itself is the same, but we no longer run it in IO:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb8-2"><a href="#cb8-2"></a>main <span class="ot">=</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  hspec <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>    describe <span class="st">&quot;upperCase&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>      it <span class="st">&quot;uppercases the value stored at the given key in the DB&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>        <span class="kw">let</span> result <span class="ot">=</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>              runTestM&#39; <span class="fu">mempty</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>                storeEntity <span class="st">&quot;my-key&quot;</span> <span class="st">&quot;value&quot;</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>                upperCase <span class="st">&quot;my-key&quot;</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>                getEntity <span class="st">&quot;my-key&quot;</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>        result <span class="ot">`shouldBe`</span> <span class="dt">Right</span> <span class="st">&quot;VALUE&quot;</span></span></code></pre></div>
<p>Nifty!</p>
<h2 id="parameterizing-test-implementations">Parameterizing test implementations</h2>
<p>The thing about <strong>test</strong>s is that you often want to <strong>test</strong> unique and interesting behaviour! This means we'll probably want multiple implementations of our mocked services which each behave differently. Let's say that we want to test what happens if our DB fails on every single call? We <strong>could</strong> implement a whole new <code>TestM</code> monad with a new instance for <code>MonadDB</code> which errors on every call, and this would work fine, but in the real world we'll probably be mocking out a half-dozen services or more! That means we'll need a half dozen instances for each and every <code>TestM</code> we build! I don't feel like working overtime, so let's see if we can knock down the boilerplate by an order of magnitude. It's getting tough to talk about this abstractly so let's expand our example to include at least one other mocked service. We'll add some capability to our AppM to handle input and output from the console!</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">class</span> <span class="dt">MonadCli</span> m <span class="kw">where</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="co">-- &#39;print&#39; something to output</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="ot">  say ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="co">-- get a string from the user input</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="ot">  listen ::</span> m <span class="dt">String</span></span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="kw">instance</span> <span class="dt">MonadCli</span> <span class="dt">AppM</span> <span class="kw">where</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  say <span class="ot">=</span> liftIO <span class="op">.</span> <span class="fu">print</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>  listen <span class="ot">=</span> liftIO <span class="fu">getLine</span></span></code></pre></div>
<p>Now we can get something from the user and store it in the DB!</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">storeName ::</span> (<span class="dt">MonadDB</span> m <span class="dt">String</span>, <span class="dt">MonadCli</span> m) <span class="ot">=&gt;</span> m ()</span>
<span id="cb10-2"><a href="#cb10-2"></a>storeName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  say <span class="st">&quot;What&#39;s your name?&quot;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  name <span class="ot">&lt;-</span> listen</span>
<span id="cb10-5"><a href="#cb10-5"></a>  storeEntity <span class="st">&quot;name&quot;</span> name</span></code></pre></div>
<p>Let's jump into testing it! To do so we'll need to make <code>TestM</code> an instance of <code>MonadCli</code> too! Now that we have multiple concerns going on I'm going to use a shared state and add some lenses to make working with everything a bit easier. It's a bit of set-up up-front, but from now on adding additional functionality should be pretty straight-forward!</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="ot">{-# LANGUAGE TemplateHaskell #-}</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">import</span> <span class="dt">Control.Lens</span></span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">-- We&#39;ll store all our mock data in this data type</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="kw">data</span> <span class="dt">TestState</span> <span class="ot">=</span> <span class="dt">TestState</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  {<span class="ot"> _cliInput ::</span> [<span class="dt">String</span>]</span>
<span id="cb11-7"><a href="#cb11-7"></a>  ,<span class="ot"> _cliOutput ::</span> [<span class="dt">String</span>]</span>
<span id="cb11-8"><a href="#cb11-8"></a>  ,<span class="ot"> _db ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">String</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>  } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb11-10"><a href="#cb11-10"></a></span>
<span id="cb11-11"><a href="#cb11-11"></a>makeLenses &#39;<span class="dt">&#39;TestState</span></span>
<span id="cb11-12"><a href="#cb11-12"></a></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="kw">newtype</span> <span class="dt">TestM</span> a <span class="ot">=</span> <span class="dt">TestM</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>  {<span class="ot"> runTestM ::</span> <span class="dt">ExceptT</span> <span class="dt">DBError</span> (<span class="dt">State</span> <span class="dt">TestState</span>) a</span>
<span id="cb11-15"><a href="#cb11-15"></a>  } <span class="kw">deriving</span> ( <span class="dt">Functor</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>             , <span class="dt">Applicative</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>             , <span class="dt">Monad</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>             , <span class="dt">MonadError</span> <span class="dt">DBError</span></span>
<span id="cb11-19"><a href="#cb11-19"></a>             , <span class="dt">MonadState</span> <span class="dt">TestState</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>             )</span>
<span id="cb11-21"><a href="#cb11-21"></a></span>
<span id="cb11-22"><a href="#cb11-22"></a></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="ot">runTestM&#39; ::</span> <span class="dt">TestState</span> <span class="ot">-&gt;</span> <span class="dt">TestM</span> a <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">DBError</span> a</span>
<span id="cb11-24"><a href="#cb11-24"></a>runTestM&#39; startState (<span class="dt">TestM</span> m) <span class="ot">=</span> <span class="fu">flip</span> evalState startState <span class="op">.</span> runExceptT <span class="op">$</span> m</span>
<span id="cb11-25"><a href="#cb11-25"></a></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="kw">instance</span> <span class="dt">MonadDB</span> <span class="dt">TestM</span> <span class="dt">String</span> <span class="kw">where</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="co">-- Implementation here&#39;s not important, assume we do pretty much the same thing as earlier</span></span>
<span id="cb11-28"><a href="#cb11-28"></a></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="kw">instance</span> <span class="dt">MonadCli</span> <span class="dt">TestM</span> <span class="kw">where</span></span>
<span id="cb11-30"><a href="#cb11-30"></a>  <span class="co">-- We&#39;ll just record things we say in our list of output</span></span>
<span id="cb11-31"><a href="#cb11-31"></a>  say msg <span class="ot">=</span> cliOutput <span class="op">%=</span> (<span class="op">++</span> [msg])</span>
<span id="cb11-32"><a href="#cb11-32"></a>  <span class="co">-- We&#39;ll pull input from our state as long as we have some.</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>  listen <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-34"><a href="#cb11-34"></a>    inputs <span class="ot">&lt;-</span> use cliInput</span>
<span id="cb11-35"><a href="#cb11-35"></a>    <span class="kw">case</span> inputs <span class="kw">of</span></span>
<span id="cb11-36"><a href="#cb11-36"></a>      [] <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="st">&quot;NO MORE INPUT&quot;</span></span>
<span id="cb11-37"><a href="#cb11-37"></a>      (msg<span class="op">:</span>rest) <span class="ot">-&gt;</span> cliInput <span class="op">.=</span> rest <span class="op">&gt;&gt;</span> <span class="fu">return</span> msg</span>
<span id="cb11-38"><a href="#cb11-38"></a></span>
<span id="cb11-39"><a href="#cb11-39"></a><span class="ot">emptyState ::</span> <span class="dt">TestState</span></span>
<span id="cb11-40"><a href="#cb11-40"></a>emptyState <span class="ot">=</span> <span class="dt">TestState</span> {_cliInput <span class="ot">=</span> <span class="fu">mempty</span>, _cliOutput <span class="ot">=</span> <span class="fu">mempty</span>, _db <span class="ot">=</span> <span class="fu">mempty</span>}</span></code></pre></div>
<p>Now we can test our <code>storeName</code> function!</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb12-2"><a href="#cb12-2"></a>main <span class="ot">=</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  hspec <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>    describe <span class="st">&quot;storeName&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>      it <span class="st">&quot;stores a name from user input&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>        <span class="kw">let</span> result <span class="ot">=</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>              <span class="co">-- We&#39;ll seed a name as our cli input</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>              runTestM&#39; (emptyState <span class="op">&amp;</span> cliInput <span class="op">.~</span> [<span class="st">&quot;Steven&quot;</span>]) <span class="op">$</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>              <span class="co">-- Running storeName should store the cli input </span></span>
<span id="cb12-10"><a href="#cb12-10"></a>              <span class="co">-- in the DB under the &quot;name&quot; key!</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>              storeName <span class="op">&gt;&gt;</span> getEntity <span class="st">&quot;name&quot;</span></span>
<span id="cb12-12"><a href="#cb12-12"></a>        result <span class="ot">`shouldBe`</span> <span class="dt">Right</span> <span class="st">&quot;Steven&quot;</span></span></code></pre></div>
<p>Hopefully that comes out green!</p>
<p>Great! So, like I said before we'd like to customize our implementations of some of our mocked out services, let's say we want the DB to fail on every call! One option would be to wrap <code>TestM</code> in a newtype and use <code>deriving MonadCli</code> with <code>GeneralizedNewtypeDeriving</code> to get back our implementation of <code>MonadCli</code> then write a NEW instance for <code>MonadDB</code> which fails on every call. If we have to do this for every customized behaviour for each of our services though this results in an <code>(n*k)</code> number of newtypes! We need a different newtype for EACH pairing of every possible set of behaviours we can imagine! Let's solve this problem the way we solve all problems in Haskell: Add more type parameters!</p>
<h2 id="phantom-data-kinds">Phantom Data Kinds</h2>
<p>Let's parameterize <code>TestM</code> with slots which represent possible implementations of each service. To help users know how it works and also prevent incorrect usage we'll qualify the parameters using <code>DataKinds</code>!</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="ot">{-# LANGUAGE DataKinds #-}</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="ot">{-# LANGUAGE KindSignatures #-}</span></span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="kw">data</span> <span class="dt">DBImpl</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="ot">=</span> <span class="dt">DBUseMap</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="op">|</span> <span class="dt">DBOnFire</span></span>
<span id="cb13-7"><a href="#cb13-7"></a></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="kw">data</span> <span class="dt">CliImpl</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="ot">=</span> <span class="dt">CliUseList</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>  <span class="op">|</span> <span class="dt">CliStatic</span></span>
<span id="cb13-11"><a href="#cb13-11"></a></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="kw">newtype</span> <span class="dt">TestM</span> (<span class="ot">db ::</span> <span class="dt">DBImpl</span>) (<span class="ot">cli ::</span> <span class="dt">CliImpl</span>) a <span class="ot">=</span> <span class="dt">TestM</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>  {<span class="ot"> runTestM ::</span> <span class="dt">ExceptT</span> <span class="dt">DBError</span> (<span class="dt">State</span> <span class="dt">TestState</span>) a</span>
<span id="cb13-14"><a href="#cb13-14"></a>  } <span class="kw">deriving</span> ( <span class="dt">Functor</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>             , <span class="dt">Applicative</span></span>
<span id="cb13-16"><a href="#cb13-16"></a>             , <span class="dt">Monad</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>             , <span class="dt">MonadError</span> <span class="dt">DBError</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>             , <span class="dt">MonadState</span> <span class="dt">TestState</span></span>
<span id="cb13-19"><a href="#cb13-19"></a>             )</span>
<span id="cb13-20"><a href="#cb13-20"></a></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="ot">runTestM&#39; ::</span> <span class="dt">TestState</span> <span class="ot">-&gt;</span> <span class="dt">TestM</span> db cli a <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">DBError</span> a</span>
<span id="cb13-22"><a href="#cb13-22"></a>runTestM&#39; startState (<span class="dt">TestM</span> m) <span class="ot">=</span> <span class="fu">flip</span> evalState startState <span class="op">.</span> runExceptT <span class="op">$</span> m</span></code></pre></div>
<p>Notice that we don't actually need to use these params inside the definition of the <code>TestM</code> newtype; they're just there as annotations for the compiler, I call these 👻 Phantom Data Kinds 👻. Now let's update the instance we've defined already to handle the type params, as well as add some new instances!</p>
<p>The instance signatures are the most important part here; but read the rest if you like 🤷‍♂️</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">instance</span> <span class="dt">MonadDB</span> (<span class="dt">TestM</span> <span class="dt">DBUseMap</span> cli) <span class="dt">String</span> <span class="kw">where</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  getEntity key <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>    db&#39; <span class="ot">&lt;-</span> use db</span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="kw">case</span> M.lookup key db&#39; <span class="kw">of</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwError <span class="op">.</span> <span class="dt">DBError</span> <span class="op">$</span> <span class="st">&quot;didn&#39;t find &quot;</span> <span class="op">++</span> key <span class="op">++</span> <span class="st">&quot; in db&quot;</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>      <span class="dt">Just</span> v <span class="ot">-&gt;</span> <span class="fu">return</span> v</span>
<span id="cb14-7"><a href="#cb14-7"></a>  storeEntity key value <span class="ot">=</span> db <span class="op">%=</span> M.insert key value</span>
<span id="cb14-8"><a href="#cb14-8"></a></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co">-- This DB mock tests how actions react if every call to the DB fails</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="kw">instance</span> <span class="dt">MonadDB</span> (<span class="dt">TestM</span> <span class="dt">DBOnFire</span> cli) <span class="dt">String</span> <span class="kw">where</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>  getEntity _ <span class="ot">=</span> throwError <span class="op">.</span> <span class="dt">DBError</span> <span class="op">$</span> <span class="st">&quot;🔥 DB is on FIRE! 🔥&quot;</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>  storeEntity _ _ <span class="ot">=</span> throwError <span class="op">.</span> <span class="dt">DBError</span> <span class="op">$</span> <span class="st">&quot;🔥 DB is on FIRE! 🔥&quot;</span></span>
<span id="cb14-13"><a href="#cb14-13"></a></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="co">-- A simple cli mock which pulls input from a list and </span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="co">-- stores printed strings in state for later inspection</span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="kw">instance</span> <span class="dt">MonadCli</span> (<span class="dt">TestM</span> db <span class="dt">CliUseList</span>) <span class="kw">where</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>  say msg <span class="ot">=</span> cliOutput <span class="op">%=</span> (msg <span class="op">:</span>)</span>
<span id="cb14-18"><a href="#cb14-18"></a>  listen <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb14-19"><a href="#cb14-19"></a>    inputs <span class="ot">&lt;-</span> use cliInput</span>
<span id="cb14-20"><a href="#cb14-20"></a>    <span class="kw">case</span> inputs <span class="kw">of</span></span>
<span id="cb14-21"><a href="#cb14-21"></a>      [] <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="st">&quot;NO MORE INPUT&quot;</span></span>
<span id="cb14-22"><a href="#cb14-22"></a>      (msg<span class="op">:</span>rest) <span class="ot">-&gt;</span> cliInput <span class="op">.=</span> rest <span class="op">&gt;&gt;</span> <span class="fu">return</span> msg</span>
<span id="cb14-23"><a href="#cb14-23"></a></span>
<span id="cb14-24"><a href="#cb14-24"></a><span class="co">-- A simple cli mock which always returns the same thing</span></span>
<span id="cb14-25"><a href="#cb14-25"></a><span class="kw">instance</span> <span class="dt">MonadCli</span> (<span class="dt">TestM</span> db <span class="dt">CliStatic</span>) <span class="kw">where</span></span>
<span id="cb14-26"><a href="#cb14-26"></a>  say _ <span class="ot">=</span> <span class="fu">return</span> ()</span>
<span id="cb14-27"><a href="#cb14-27"></a>  listen <span class="ot">=</span> <span class="fu">return</span> <span class="st">&quot;INPUT&quot;</span></span></code></pre></div>
<p>The cool thing about this is that each instance can choose an instance based on one parameter while leaving the type variable in the other slots unspecified! So for our MonadDB implementation we can have a different implementation for each value of the <code>db :: DBImpl</code> type param while not caring at all what's in the <code>cli :: CliImpl</code> parameter! This means that we only need to implement each behaviour once, and we can mix and match implementations for different services at will! We <em>do</em> need to make sure that there's some way to actually implement that behaviour against our <code>TestM</code>; but for the vast majority of cases you can just carve out a spot in the <code>State</code> to keep track of what you need for your mock. Using lenses means that adding something new won't affect existing implementations.</p>
<p>Whoops; just about forgot, we need a way to pick which behaviour we want when we're actually running our tests! <code>TypeApplications</code> are a huge help here! We use <code>TypeApplications</code> to pick which <code>DBImpl</code> and <code>CliImpl</code> we want so that GHC doesn't get mad at us about ambiguous type variables. Use them like this:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="ot">{-# LANGUAGE TypeApplications #-}</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a>runTestM&#39; <span class="op">@</span><span class="dt">DBUseMap</span> <span class="op">@</span><span class="dt">CliUseList</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>            (emptyState <span class="op">&amp;</span> cliInput <span class="op">.~</span> [<span class="st">&quot;Steven&quot;</span>]) <span class="op">$</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>            storeName <span class="op">&gt;&gt;</span> getEntity <span class="st">&quot;name&quot;</span></span></code></pre></div>
<p>Now you can pretty easily keep a separate module where you define <code>TestM</code> and all of its behaviours and instances, then just use Type Applications to specialize your test monad when you run it to get the behaviour you want!</p>
<p>And that wraps up our dive into testing using <code>mtl-style</code> constraints! Thanks for joining me!</p>
<p>Special thanks to Sandy Maguire A.K.A. isovector for proofreading and helping me vet my ideas!</p>
<p>If you have questions or comments hit me up on <a href="https://twitter.com/chrislpenner">Twitter</a> or <a href="https://www.reddit.com/user/ChrisPenner">Reddit</a>!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Update Monads: Variation on State Monads</title>
      <link href="https://chrispenner.ca/posts/update-monad"/>
      <id>https://chrispenner.ca/posts/update-monad</id>
      <updated>2018-09-03T00:00:00Z</updated>
      <summary>We explore the applications and implementation of a generalized version of Reader/Writer monads.</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/update-monad/change.jpg" alt="Update Monads: Variation on State Monads">
              <p>Today we're going to take a peek at the Update monad! It's a monad which was formalized and described in <a href="https://danelahman.github.io/papers/types13postproc.pdf">Update Monads: Cointerpreting Directed Containers</a> by Danel Ahman and Tarmo Uustalu. Most folks probably haven't heard of it before, likely because most of what you'd use it for is well encompassed by the Reader, Writer, and State monads. The Update Monad can do everything that Reader, Writer, and State can do, but as a trade-off tends to be less efficient at each of those tasks. It's definitely still worth checking out though; not only is it interesting, there are a few things it handles quite elegantly that might be a bit awkward to do in other ways.</p>
<p>Heads up; this probably isn't a great post for absolute beginners, you'll want to have a decent understanding of <a href="https://wiki.haskell.org/Monoid">monoids</a> and how <a href="https://wiki.haskell.org/State_Monad">StateT</a> works before you dive in here.</p>
<p>For readers who've spent a bit of time in Javascript land you may notice that the Update Monad is basically a formalization of the <a href="https://www.dotnetcurry.com/reactjs/1356/redux-pattern-tutorial">Flux architecture</a>, most commonly associated with the Redux library; although of course the Update Monad paper came first 😉. Most of the concepts carry over in some form. The <code>Store</code> in redux corresponds to the state of the Update monad, the <code>Action</code>s in Redux correspond directly to our monoidal Actions in the Update monad, and the view and dispatcher are left up to the implementor, but could be likened to a base monad in a monad transformer stack which could render, react, or get user input (e.g. IO).</p>
<p>The Update monad is very similar to the State monad; and in fact you can implement either of them in terms of the other! Each has tasks at which it excels; the Update Monad is good at keeping an audit log of updates and limiting computations to a fixed set of permissible updates. State on the other hand has a simpler interface, less boiler-plate, and is MUCH more efficient at most practical tasks. It's no wonder that <code>State</code> won out in the end, but the Update monad is still fun to look at!</p>
<h2 id="structure-of-the-update-monad">Structure of the Update Monad</h2>
<p>The Update Monad kinda looks like Reader, Writer and State got into a horrific car accident and are now hopelessly entangled! Each computation receives the current computation <code>state</code> (like <code>Reader</code>) and can result in a monoidal action (like <code>Writer</code>). The action is them applied to the state according to a helper typeclass which I'll call <code>ApplyAction</code>: it has a single method <code>applyAction :: p -&gt; s -&gt; s</code>; which applies a given monoidal action <code>p</code> to a state resulting in a new state. This edited state is passed on to the next computation (like <code>State</code>) and away we go! Here's my implementation of this idea for a new data type called <code>Update</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">class</span> (<span class="dt">Monoid</span> p) <span class="ot">=&gt;</span> <span class="dt">ApplyAction</span> p s <span class="kw">where</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ot">  applyAction ::</span> p <span class="ot">-&gt;</span> s <span class="ot">-&gt;</span> s</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">data</span> <span class="dt">Update</span> s p a <span class="ot">=</span> <span class="dt">Update</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>  {<span class="ot"> runUpdate ::</span> (s <span class="ot">-&gt;</span> (p, a))</span>
<span id="cb1-6"><a href="#cb1-6"></a>  } <span class="kw">deriving</span> (<span class="dt">Functor</span>)</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">instance</span> (<span class="dt">ApplyAction</span> p s) <span class="ot">=&gt;</span> <span class="dt">Applicative</span> (<span class="dt">Update</span> s p) <span class="kw">where</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="fu">pure</span> a <span class="ot">=</span> <span class="dt">Update</span> <span class="op">$</span> \_ <span class="ot">-&gt;</span> (<span class="fu">mempty</span>, a)</span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="dt">Update</span> u <span class="op">&lt;*&gt;</span> <span class="dt">Update</span> t <span class="ot">=</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="dt">Update</span> <span class="op">$</span> \s</span>
<span id="cb1-12"><a href="#cb1-12"></a>      <span class="co">-- Run the first &#39;Update&#39; with the initial state </span></span>
<span id="cb1-13"><a href="#cb1-13"></a>      <span class="co">-- and get the monoidal action and the function out</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>     <span class="ot">-&gt;</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>      <span class="kw">let</span> (p, f) <span class="ot">=</span> u s</span>
<span id="cb1-16"><a href="#cb1-16"></a>      <span class="co">-- Run the second &#39;Update&#39; with a state which has been altered by</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>      <span class="co">-- the first action to get the &#39;a&#39; and another action</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>          (p&#39;, a) <span class="ot">=</span> t (applyAction p s)</span>
<span id="cb1-19"><a href="#cb1-19"></a>      <span class="co">-- Combine the actions together and run the function</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>       <span class="kw">in</span> (p&#39; <span class="op">&lt;&gt;</span> p, f a)</span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="kw">instance</span> (<span class="dt">ApplyAction</span> p s) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">Update</span> s p) <span class="kw">where</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>  <span class="dt">Update</span> u <span class="op">&gt;&gt;=</span> f <span class="ot">=</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>    <span class="dt">Update</span> <span class="op">$</span> \s</span>
<span id="cb1-25"><a href="#cb1-25"></a>      <span class="co">-- Run the first &#39;Update&#39; with the initial state </span></span>
<span id="cb1-26"><a href="#cb1-26"></a>      <span class="co">-- and get the monoidal action and the function out</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>     <span class="ot">-&gt;</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>      <span class="kw">let</span> (p, a) <span class="ot">=</span> u s</span>
<span id="cb1-29"><a href="#cb1-29"></a>      <span class="co">-- Run the given function over our resulting value to get our next Update</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>          <span class="dt">Update</span> t <span class="ot">=</span> f a</span>
<span id="cb1-31"><a href="#cb1-31"></a>      <span class="co">-- Run our new &#39;Update&#39; over the altered state</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>          (p&#39;, a&#39;) <span class="ot">=</span> t (applyAction p s)</span>
<span id="cb1-33"><a href="#cb1-33"></a>      <span class="co">-- Combine the actions together and return the result</span></span>
<span id="cb1-34"><a href="#cb1-34"></a>       <span class="kw">in</span> (p <span class="op">&lt;&gt;</span> p&#39;, a&#39;)</span></code></pre></div>
<p>We could of course also implement an <code>UpdateT</code> monad transformer, but for the purposes of clarity I find it's easier to understand the concrete <code>Update</code> type. If you like you can take a peek at some other fun implementations <a href="https://github.com/chrispenner/update-monad">here</a>. Hopefully it's relatively clear from the implementation how things fit together. Hopefully you can kind of see the similarities to Reader and Writer; we are always returning and combining our monoidal actions as we continue along, and each action has access to the state, but can't <em>directly</em> modify it (you may only modify it by providing <strong>actions</strong>). It's also worth noting that within any individual step has only the latest <code>state</code> and it's not possible to view any previous actions which may have occurred, just like the Writer monad.</p>
<p>Now that we've implemented our Update Monad we've got our <code>&gt;&gt;=</code> and <code>return</code>; but how do we actually accomplish anything with it? There's no <code>MonadUpdate</code> type-class provided in the paper, but here's my personal take on how to get some utility out of it, I've narrowed it down to these two methods which seem to encompass the core ideas behind the Update Monad:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="ot">{-# LANGUAGE FunctionalDependencies #-}</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">class</span> (<span class="dt">ApplyAction</span> s p, <span class="dt">Monad</span> m) <span class="ot">=&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>      <span class="co">-- Because each of our methods only uses p OR m but not both </span></span>
<span id="cb2-4"><a href="#cb2-4"></a>      <span class="co">-- we use functional dependencies to assert to the type system that </span></span>
<span id="cb2-5"><a href="#cb2-5"></a>      <span class="co">-- both s and p are determined by &#39;m&#39;; this helps GHC be confident</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>      <span class="co">-- that we can&#39;t end up in spots where types could be ambiguous.</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>      <span class="dt">MonadUpdate</span> m s p <span class="op">|</span> m <span class="ot">-&gt;</span> s , m <span class="ot">-&gt;</span> p</span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="kw">where</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="ot">    putAction ::</span> p <span class="ot">-&gt;</span> m ()</span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="ot">    getState ::</span> m s</span></code></pre></div>
<p>You'll notice some similarities here too! <code>putAction</code> matches the signature for <code>tell</code>, and <code>getState</code> matches <code>ask</code>! This class still provides new value though, because unlike Reader and Writer the environment and the actions are related to each other through the <code>ApplyAction</code> class; and unlike <code>get</code> and <code>put</code> from <code>State</code> our <code>putAction</code> and <code>getState</code> operate over <strong>different</strong> types; you can only <code>put</code> <strong>actions</strong>, and you can only <code>get</code> <strong>state</strong>. We can formalize the expected relationship between these methods with these laws I made up (take with a deluge of salt):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">-- Applying the &#39;empty&#39; action to your state shouldn&#39;t change your state</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>applyAction <span class="fu">mempty</span> <span class="op">==</span> <span class="fu">id</span></span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">-- Putting an action and then another action should be the same as </span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">-- putting the combination of the two actions.</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">-- This law effectively enforces that `bind` is </span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">-- employing your monoid as expected</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>putAction p <span class="op">&gt;&gt;</span> putAction q <span class="op">==</span> putAction (p <span class="ot">`mappend`</span> q)</span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">-- We expect that when we &#39;put&#39; an action that it gets applied to the state</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">-- and that the change is visible immediately</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co">-- This law enforces that your implementation of bind </span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">-- is actually applying your monoid to the state using ApplyAction</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>applyAction p <span class="op">&lt;$&gt;</span> getState <span class="op">==</span> putAction p <span class="op">&gt;&gt;</span> getState</span></code></pre></div>
<p>Okay! Now of course we have to implement <code>MonadUpdate</code> for our <code>Update</code> monad; easy-peasy:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">instance</span> (<span class="dt">ApplyAction</span> p s) <span class="ot">=&gt;</span> <span class="dt">MonadUpdate</span> (<span class="dt">Update</span> p s) p s <span class="kw">where</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  putAction p <span class="ot">=</span> <span class="dt">Update</span> <span class="op">$</span> \_ <span class="ot">-&gt;</span> (p, ())</span>
<span id="cb4-3"><a href="#cb4-3"></a>  getState <span class="ot">=</span> <span class="dt">Update</span> <span class="op">$</span> \s <span class="ot">-&gt;</span> (<span class="fu">mempty</span>, s)</span></code></pre></div>
<p>All the plumbing is set up! Let's start looking into some actual use-cases! I'll start by fully describing one particular use-case so we get an understanding of how this all works, then we'll experiment by tweaking our monoid or our <code>applyAction</code> function.</p>
<h2 id="a-concrete-use-case">A Concrete Use-Case</h2>
<p>Let's pick a use-case which I often see used for demonstrating the State monad so we can see how our Update monad is similar, but slightly different!</p>
<p>We're going to build a system which allows users to interact with their bank account! We'll have three actions they can perform: <code>Deposit</code>, <code>Withdraw</code>, and <code>CollectInterest</code>. These actions will be applied to a simple state <code>BankAccount Int</code> which keeps track of how many dollars we have in the account!</p>
<p>Let's whip up the data types and operations we'll need:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">-- Simple type to keep track our bank balance</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">newtype</span> <span class="dt">BankBalance</span> <span class="ot">=</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="dt">BankBalance</span> <span class="dt">Int</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Ord</span>, <span class="dt">Show</span>)</span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">-- The three types of actions we can take on our account</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="kw">data</span> <span class="dt">AccountAction</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>  <span class="ot">=</span> <span class="dt">Deposit</span> <span class="dt">Int</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="op">|</span> <span class="dt">Withdraw</span> <span class="dt">Int</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>  <span class="op">|</span> <span class="dt">ApplyInterest</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Ord</span>, <span class="dt">Show</span>)</span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">-- We can apply any of our actions to our bank balance to get a new balance</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="ot">processTransaction ::</span> <span class="dt">AccountAction</span> <span class="ot">-&gt;</span> <span class="dt">BankBalance</span> <span class="ot">-&gt;</span> <span class="dt">BankBalance</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>processTransaction (<span class="dt">Deposit</span> n) (<span class="dt">BankBalance</span> b) </span>
<span id="cb5-16"><a href="#cb5-16"></a>    <span class="ot">=</span> <span class="dt">BankBalance</span> (b <span class="op">+</span> n)</span>
<span id="cb5-17"><a href="#cb5-17"></a>processTransaction (<span class="dt">Withdraw</span> n) (<span class="dt">BankBalance</span> b) </span>
<span id="cb5-18"><a href="#cb5-18"></a>    <span class="ot">=</span> <span class="dt">BankBalance</span> (b <span class="op">-</span> n)</span>
<span id="cb5-19"><a href="#cb5-19"></a></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="co">-- This is a gross oversimplification...</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="co">-- I really hope my bank does something smarter than this</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="co">-- We (kinda sorta) add 10% interest, truncating any cents.</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="co">-- Who likes pocket-change anyways ¯\_(ツ)_/¯</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>processTransaction <span class="dt">ApplyInterest</span> (<span class="dt">BankBalance</span> b) </span>
<span id="cb5-25"><a href="#cb5-25"></a>    <span class="ot">=</span> <span class="dt">BankBalance</span> (<span class="fu">fromIntegral</span> balance <span class="op">*</span> <span class="fl">1.1</span>)</span></code></pre></div>
<p>Now we've got our Action type and our State type, let's relate them together using <code>ApplyAction</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">instance</span> <span class="dt">ApplyAction</span> <span class="dt">AccountAction</span> <span class="dt">BankBalance</span> <span class="kw">where</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  applyAction <span class="ot">=</span> processTransaction</span></code></pre></div>
<p>One problem though! <code>AccountAction</code> isn't a monoid! Hrmmm, this is a bit upsetting; it seems to quite clearly represent the domain we want to work with, I'd really rather not muck up our data-type just to make it fit here. Maybe there's something else we can do! In our case, what does it mean to combine two actions? For a bank balance we probably just want to run the first action, then the second one! We'll need a value that acts as an 'empty' value for our monoid's <code>mempty</code> too; for that we can just have some notion of performing no actions!</p>
<p>There are a few ways to promote our <code>AccountAction</code> type into a monoid with these properties; but one in particular stands out (I can already hear some of you shouting it at your screens). That's right! The <a href="https://en.wikipedia.org/wiki/Free_monoid">Free Monoid</a> A.K.A. the List Monoid! Lists are kind of a special monoid in that they can turn ANY type into a monoid for <strong>free</strong>! We get <code>mappend == (++)</code> and <code>mempty == []</code>. This means that instead of <em>actually</em> combining things we kinda just collect them all, but fear not it still satisfies all the monoid laws correctly. This isn't a post on Free Monoids though, so we'll upgrade our <code>AccountAction</code> to <code>[AccountAction]</code> and move on:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">instance</span> <span class="dt">ApplyAction</span> [<span class="dt">AccountAction</span>] <span class="dt">BankBalance</span> <span class="kw">where</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  applyAction actions balance <span class="ot">=</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="kw">let</span><span class="ot"> allTransactions ::</span> <span class="dt">BankBalance</span> <span class="ot">-&gt;</span> <span class="dt">BankBalance</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>        allTransactions <span class="ot">=</span> appEndo <span class="op">$</span> <span class="fu">foldMap</span> (<span class="dt">Endo</span> <span class="op">.</span> processTransaction) (<span class="fu">reverse</span> actions)</span>
<span id="cb7-5"><a href="#cb7-5"></a>     <span class="kw">in</span> allTransactions balance</span></code></pre></div>
<p>We can keep our <code>processTransaction</code> function and partially apply it to our list of Actions giving us a list of <code>[BankBalance -&gt; BankBalance]</code>; we can then use the <code>Endo</code> monoid to compose all of the functions together! Unfortunately Endo does right-to-left composition, so we'll need to reverse the list first (keeners will note we could use <code>Dual . Endo</code> for the same results). Then we use <code>appEndo</code> to unpack the resulting <code>BankBalance -&gt; BankBalance</code> which we can apply to our balance! Now that we have an instance for <code>ApplyAction</code> we can start writing programs using <code>Update</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="ot">useATM ::</span> <span class="dt">Update</span> [<span class="dt">AccountAction</span>] <span class="dt">BankBalance</span> ()</span>
<span id="cb8-2"><a href="#cb8-2"></a>useATM <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  putAction [<span class="dt">Deposit</span> <span class="dv">20</span>] <span class="co">-- BankBalance 20</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  putAction [<span class="dt">Deposit</span> <span class="dv">30</span>] <span class="co">-- BankBalance 50</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  putAction [<span class="dt">ApplyInterest</span>] <span class="co">-- BankBalance 55</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>  putAction [<span class="dt">Withdraw</span> <span class="dv">10</span>] <span class="co">-- BankBalance 45</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>  getState</span>
<span id="cb8-8"><a href="#cb8-8"></a></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="op">$&gt;</span> runUpdate useATM (<span class="dt">BankBalance</span> <span class="dv">0</span>)</span>
<span id="cb8-10"><a href="#cb8-10"></a>([<span class="dt">Deposit</span> <span class="dv">20</span>,<span class="dt">Deposit</span> <span class="dv">30</span>,<span class="dt">ApplyInterest</span>,<span class="dt">Withdraw</span> <span class="dv">10</span>],<span class="dt">BankBalance</span> <span class="dv">45</span>)</span></code></pre></div>
<p>Hrmm, a bit clunky that we have to wrap every action with a list, but we could pretty easily write a helper <code>putAction' :: MonadUpdate m [p] s =&gt; p -&gt; m ()</code> to help with that. By running the program we can see that we've collected the actions in the right order and have 'combined' them all by running <code>mappend</code>. We also see that our bank balance ends up where we'd expect! This seems to be pretty similar to the State Monad, we could write helpers that perform each of those actions over the State pretty easily using <code>modify</code>; but the Update Monad gives us a nice audit log of everything that happened! Not to mention that it limits the available actions to ones that we support; users can't just multiply their bank balance by 100, they have use the approved actions. This means we could verify that actions happened in the correct order, or we could run the same actions over a different starting state and see how it works out!</p>
<p>The Update Monad also has a few tricks when it comes to testing your programs. Since the only thing that can affect our state is a sequence of actions, we can skip all the monad nonsense and test our business logic by just testing that our <code>applyAction</code> function works properly over different lists of actions! Observe:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="ot">testBankSystem ::</span> <span class="dt">Bool</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>testBankSystem <span class="ot">=</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  applyAction [<span class="dt">Deposit</span> <span class="dv">20</span>, <span class="dt">Deposit</span> <span class="dv">30</span>, <span class="dt">ApplyInterest</span>, <span class="dt">Withdraw</span> <span class="dv">10</span>] (<span class="dt">BankBalance</span> <span class="dv">0</span>) </span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="op">==</span> <span class="dt">BankBalance</span> <span class="dv">45</span></span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="op">$&gt;</span> testBankSystem</span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="dt">True</span></span></code></pre></div>
<p>Cool stuff! We can write the tests for our business logic without worrying about the impure ways we'll probably be getting those actions (like <code>IO</code>). This separation makes complicated business logic pretty easy to test, and we can write separate tests for the 'glue' code with confidence that the logic of our actions is correct and that our program <strong>CAN'T</strong> edit our state in an invalid way since all updates <strong>must</strong> be performed through the <code>performTransaction</code> function. Note that using an impure base monad like IO could certainly cause the list of actions which are collected to change, but the list of actions which is collected <strong>fully describes</strong> the state changes which take place; and so testing only the application of actions is sufficient for testing state updates.</p>
<p>There's really only so much we can do with <code>Update</code> alone, but it's pretty easy to write an <code>UpdateT</code> transformer! I'll leave you to check out the implementation <a href="https://github.com/ChrisPenner/update-monad/blob/master/src/UpdateT.hs">here</a> if you like; but this allows us to do things like decide which actions to take based on user input (via <code>IO</code>), use our state to make choices in the middle of our monad, or use other monads to perform more interesting logic!</p>
<h2 id="customizing-the-update-monad-with-monoids">Customizing the Update Monad with Monoids</h2>
<p>Okay! We've got one concrete use-case under our belts and have a pretty good understanding of how all this works! let's see what we can tweak to make things a bit more interesting!</p>
<p>Something that immediately interested me with the update monad is that there are several distinct places to tweak its behaviour without even needing to change which implementation of <code>MonadUpdate</code> we use! We can change the action monoid, or which state we carry, or even our <code>applyAction</code> function! This sort of tweakability leads to all sorts of cool behaviour without too much work, and people can build all sorts of things we didn't initially expect when we wrote the type-classes!</p>
<p>I won't get super in depth on each of these and encourage you to implement them yourself, but here are a few ideas to start with!</p>
<p>Customizations:</p>
<ul>
<li><code>Update w () a</code> with <code>applyAction _ () = ()</code>
<ul>
<li>A simple implementation of <code>Writer</code>!</li>
<li>The state doesn't matter; only the monoidal actions are tracked!</li>
</ul></li>
<li><code>Update () r a</code> with <code>applyAction () r = r</code>
<ul>
<li>A simple implementation of <code>Reader</code>!</li>
<li>There're no sensible updates to do; so your state always stays the same.</li>
</ul></li>
<li><code>Update (Last s) s a</code> with <code>applyAction (Last p) s = fromMaybe s p</code>
<ul>
<li>This is the state monad implemented in Update!</li>
<li><code>get == getState</code></li>
<li><code>put == putAction . Last . Just</code></li>
<li><code>modify f == getState &gt;&gt;= putAction . Last . Just . f</code></li>
</ul></li>
<li><code>Update (Dual (Endo s)) s a</code> with <code>applyAction (Dual (Endo p)) s = p s</code>
<ul>
<li>Another possible implementation of State inside Update!</li>
<li><code>get == getState</code></li>
<li><code>put == putAction . Dual . Endo . const</code></li>
<li><code>modify == putAction . Dual . Endo</code></li>
</ul></li>
<li><code>Update Any Bool a</code> with <code>applyAction (Any b) s = b || s</code>
<ul>
<li>You could implement a short-circuiting approach where future actions don't bother running if any previous action has succeeded! You can flip the logic using <code>All</code> and <code>&amp;&amp;</code>.</li>
</ul></li>
</ul>
<h2 id="bonus-performance">Bonus: Performance</h2>
<p>The definition of the Update monad given here is quite simple because it's the easiest to explain, but there are a few problems with it; the most notable is that it ONLY passes along the new monoidal sum; NOT the edited state from step to step. In mathematic terms it's still correct since we can compute an up-to-date version of the state; but we have to compute it from scratch every time we run an action! Clearly not great for performance! Like I said earlier you can actually implement a more efficient version of <code>MonadUpdate</code> using <code>State</code>! We DO still need a dependency on <code>ApplyAction p s</code> though, so keep that in mind. If we have one available we can do something like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">instance</span> <span class="dt">ApplyAction</span> p s <span class="ot">=&gt;</span> <span class="dt">MonadUpdate</span> (<span class="dt">State</span> (p, s)) p s <span class="kw">where</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  putAction p&#39; <span class="ot">=</span> modify (\(p, s) <span class="ot">-&gt;</span> (p <span class="op">&lt;&gt;</span> p&#39;, applyAction p&#39; s))</span>
<span id="cb10-3"><a href="#cb10-3"></a>  getState <span class="ot">=</span> <span class="fu">snd</span> <span class="op">&lt;$&gt;</span> get</span></code></pre></div>
<p>Technically we don't even need to keep track of the monoidal sum as we go along; there's no need for it! Unfortunately due to FunctionalDependencies in our MonadUpdate class GHC gets mad if it doesn't show up inside our State Monad <strong>somewhere</strong>. This implementation keeps track of the latest state and just applies updates as it goes along, giving us a more efficient implementation. Note that using <code>put</code> or <code>modify</code> directly will probably cause some unexpected behaviour in your Update Monad, so you may want to wrap your <code>State</code> in a newtype first to prevent anyone from messing with the internals.</p>
<p>Thanks for reading! I'm not perfect and really just go through all this stuff in my spare time, so if I've missed something (or you enjoyed the post 😄) please let me know! You can find me on <a href="https://twitter.com/chrislpenner">Twitter</a> or <a href="https://www.reddit.com/user/ChrisPenner">Reddit</a>!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Typesafe Versioned APIs</title>
      <link href="https://chrispenner.ca/posts/typesafe-api-versioning"/>
      <id>https://chrispenner.ca/posts/typesafe-api-versioning</id>
      <updated>2018-08-04T00:00:00Z</updated>
      <summary>Exploring writing multiple versions of your application in a typesafe way using data-kinds and functional dependencies</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/typesafe-api-versioning/numbers.jpg" alt="Typesafe Versioned APIs">
              <p>Today we're going to look at the idea of using Haskell's type system to <strong>specialize our app implementation according to type-level flags</strong>. More specifically we're going to look at a fun way to write a monadic action which alters its behaviour based on which <strong>version</strong> of a system it's embedded in, simultaneously gaining ground on <a href="https://en.wikipedia.org/wiki/Expression_problem">the expression problem</a> and giving us compile-time guarantees that we haven't accidentally mixed up code from different versions of our app!</p>
<p>The concrete example we'll be looking at is a simple web handler which returns a JSON representation of a User; we'll start with a single possible representation of the user, but will the evolve our system to be able to return a different JSON schema depending on which <strong>version</strong> of the API the user has selected.</p>
<p>Disclaimer; the system I present probably isn't a great idea in a large production app, but is a fun experiment to learn more about higher kinded types and functional dependencies so we're going to do it anyways. Let's dive right in!</p>
<h2 id="starting-app">Starting App</h2>
<p>Let's build a quick starting app so we have something to work with; I'll elide all the web and http related bits, we'll have a simple handler that fetches a user and our <code>main</code> will run the handler and print things out.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">-- You&#39;ll need to have the &#39;mtl&#39; and &#39;aeson&#39; packages in your project</span></span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="ot">{-# LANGUAGE NamedFieldPuns #-}</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span></span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">import</span> <span class="dt">Data.Aeson</span></span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">-- User -----------------------------------</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="kw">data</span> <span class="dt">User</span> <span class="ot">=</span> <span class="dt">User</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>  {<span class="ot"> name ::</span> <span class="dt">String</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>  } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="kw">instance</span> <span class="dt">ToJSON</span> (<span class="dt">User</span>) <span class="kw">where</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>  toJSON (<span class="dt">User</span> {name}) <span class="ot">=</span> object [<span class="st">&quot;name&quot;</span> <span class="op">.=</span> name]</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">-- App Monad --------------------------------</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="kw">newtype</span> <span class="dt">AppM</span> a <span class="ot">=</span> <span class="dt">AppM</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>  {<span class="ot"> runApp ::</span> <span class="dt">IO</span> a</span>
<span id="cb1-21"><a href="#cb1-21"></a>  } <span class="kw">deriving</span> (<span class="dt">Functor</span>, <span class="dt">Applicative</span>, <span class="dt">Monad</span>, <span class="dt">MonadIO</span>)</span>
<span id="cb1-22"><a href="#cb1-22"></a></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co">-- User Service --------------------------------</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="kw">class</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>      <span class="dt">MonadUserService</span> m</span>
<span id="cb1-26"><a href="#cb1-26"></a>  <span class="kw">where</span></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="ot">  getUser ::</span> m <span class="dt">User</span></span>
<span id="cb1-28"><a href="#cb1-28"></a></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="kw">instance</span> <span class="dt">MonadUserService</span> <span class="dt">AppM</span> <span class="kw">where</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>  getUser <span class="ot">=</span> <span class="fu">return</span> (<span class="dt">User</span> <span class="st">&quot;Bob Johnson&quot;</span>)</span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co">-- App -----------------------------------------</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="ot">userHandler ::</span> (<span class="dt">MonadUserService</span> m) <span class="ot">=&gt;</span> m <span class="dt">Value</span></span>
<span id="cb1-34"><a href="#cb1-34"></a>userHandler <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>  user <span class="ot">&lt;-</span> getUser</span>
<span id="cb1-36"><a href="#cb1-36"></a>  <span class="fu">return</span> <span class="op">$</span> toJSON user</span>
<span id="cb1-37"><a href="#cb1-37"></a></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="ot">app ::</span> (<span class="dt">MonadIO</span> m, <span class="dt">MonadUserService</span> m) <span class="ot">=&gt;</span> m ()</span>
<span id="cb1-39"><a href="#cb1-39"></a>app <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-40"><a href="#cb1-40"></a>  userJSON <span class="ot">&lt;-</span> userHandler</span>
<span id="cb1-41"><a href="#cb1-41"></a>  liftIO <span class="op">$</span> <span class="fu">print</span> userJSON</span>
<span id="cb1-42"><a href="#cb1-42"></a></span>
<span id="cb1-43"><a href="#cb1-43"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-44"><a href="#cb1-44"></a>main <span class="ot">=</span> runApp app</span></code></pre></div>
<p>Hopefully that's not too cryptic 😅</p>
<p>We've defined a simple user object and wrote an Aeson <code>ToJSON</code> instance for it so we can serialize it. Then we wrote a newtype wrapper around <code>IO</code> which we can use to implement various instances on; note that we use <code>GeneralizedNewtypeDeriving</code> to get our <code>Monad</code> and <code>MonadIO</code> instances for free.</p>
<p>Next we define our interface for a User Service as the <code>MonadUserService</code> typeclass; this has a single member: <code>getUser</code> which defines how to get a user within a given monad. In our case we'll write the simplest possible implementation for our service and just return a static "Bob Johnson" user.</p>
<p>Next up we have our handler which gets a user, serializes, then returns it. Lastly we've got an <code>app</code> which calls the user then prints it, and a <code>main</code> which runs the app.</p>
<p>Brilliant, we're all set up; let's run it and see what we get!</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="op">&gt;</span> main</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="dt">Object</span> (fromList [(<span class="st">&quot;name&quot;</span>,<span class="dt">String</span> <span class="st">&quot;Bob Johnson&quot;</span>)])</span></code></pre></div>
<h2 id="chapter-2-wherein-our-api-evolves">Chapter 2; wherein our API evolves</h2>
<p>They said we'd never succeed, but damn them all! In spite all of our investor's criticisms our app is doing wonderfully! We have a whole 7 of users and are making tens of dollars! Some users at large have requested the ability to get a user's first and last name separately; but other users have legacy systems built against our v1 API! Clearly it would be far too much work to duplicate our entire user handler and make alterations for our v2 API, let's see if we can <strong>parameterize</strong> our app over our <strong>API version</strong> and <strong>defer</strong> the choice of app version (and implementation) until the last possible minute!</p>
<p>Like most Haskell refactors we can just start building what we want and let the compiler guide the way; let's change our <code>User</code> data type to reflect the needs of our users:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">-- First attempt</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">data</span> <span class="dt">User</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="ot">=</span> <span class="dt">UserV1</span> {<span class="ot"> name ::</span> <span class="dt">String</span> }</span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="op">|</span> <span class="dt">UserV2</span> {<span class="ot"> firstName ::</span> <span class="dt">String</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>           ,<span class="ot"> lastName ::</span> <span class="dt">String</span> }</span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>)</span></code></pre></div>
<p>This reflects the choice in our app that the user type could be either of the two shapes; but there's a few problems with this approach. First and foremost is that this means that at EVERY stage in the app where we use a <code>User</code> we need to pattern match over the constructors and handle EVERY one; regardless of which version we happen to be working with. Not only is this not what we wanted, but as we add more versions later on the number of possible code paths we need to handle explodes! One way we can avoid this chaos is to let the type system know that our data is <strong>versioned</strong>. Enter <code>GADT</code>s!</p>
<h2 id="gadts-with-phantom-types">GADT's with Phantom types</h2>
<p>Take a gander at this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="ot">{-# LANGUAGE GADTs #-}</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="ot">{-# LANGUAGE DataKinds #-}</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="ot">{-# LANGUAGE KindSignatures #-}</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw">import</span> <span class="dt">GHC.TypeLits</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="kw">data</span> <span class="dt">User</span> (<span class="ot">v ::</span> <span class="dt">Nat</span>) <span class="kw">where</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="dt">UserV1</span><span class="ot"> ::</span> {<span class="ot"> name ::</span> <span class="dt">String</span>} <span class="ot">-&gt;</span> <span class="dt">User</span> <span class="dv">1</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="dt">UserV2</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="ot">    ::</span> {<span class="ot"> firstName ::</span> <span class="dt">String</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>       ,<span class="ot"> lastName ::</span> <span class="dt">String</span>}</span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="ot">-&gt;</span> <span class="dt">User</span> <span class="dv">2</span></span></code></pre></div>
<p>If you haven't worked with <code>GADT</code>s before this may all look a bit strange, let's break it down a bit:</p>
<p>First off; in order to even talk about <code>GADT</code>s we need the <code>GADTs</code> language extension; this unlocks the <code>data ... where</code> syntax! There's a bit more to it, but the basic idea is that this allows us to effectively specify our data constructors like we would normal functions in haskell. This means we can specify constaints on our parameters, and in our case we can specialize the types of the resulting value based on which particular constructor was used. So if someone uses the <code>UserV1</code> constructor they MUST get a <code>User 1</code>, and similarly with <code>UserV2</code>. The compiler remembers this info and in our case can actually tell that if we have a function which accepts a <code>User 1</code> that we only need to match over the <code>UserV1</code> constructor since any values of <code>User 1</code> MUST have been constructed using <code>UserV1</code>.</p>
<p>Maybe I'm getting ahead of myself; how is it we can suddenly have numbers like <code>1</code> and <code>2</code> in our types? The answer lies within the <code>(v :: Nat)</code> annotation. This is a <strong>Kind Signature</strong>, and as such naturally requires the <code>KindSignatures</code> extension. Others have written more exhaustively on the subject, but the basic idea is that <code>Nat</code> is a kind, i.e. a 'type' for types. This means that the <code>v</code> parameter can't take on just any type, but only types that are part of the <code>Nat</code> kind, which corresponds to the natural (aka non-negative) integers. This is handy, because it means people can't create a user with a version number of <code>String</code> or <code>()</code> or something silly like that. Lastly we need the <code>DataKinds</code> extension to allow us to use Data Constructors in our types; once that's enabled we can import <code>GHC.TypeLits</code> and use integer literals in our types and GHC will figure it all out.</p>
<p>The <code>v</code> paramter of our user is also something called a "phantom type". It's a type parameter on a data type that doesn't actually have an associated value in the right hand side of the data definition. These sorts of things are useful for adding additional information at the type level.</p>
<p>Step one done! We've successfully parameterized our datatype over a version number at the type level! At this point your compiler is probably bugging you about the fact that the <code>User</code> constructor no longer exists; we originally implemented the <code>ToJSON</code> class for the base User type, but now User needs an additional type parameter. This is good! It means we can implement a different instance for each version of user we have; which is basically what we wanted to do in the first place!</p>
<p>Let's alter our <code>ToJSON</code> instance so it has a single name parameter for v1 and a separate first and last name for v2!</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">-- ...</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">instance</span> <span class="dt">ToJSON</span> (<span class="dt">User</span> <span class="dv">1</span>) <span class="kw">where</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  toJSON (<span class="dt">UserV1</span> {name}) <span class="ot">=</span> object [<span class="st">&quot;name&quot;</span> <span class="op">.=</span> name]</span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="kw">instance</span> <span class="dt">ToJSON</span> (<span class="dt">User</span> <span class="dv">2</span>) <span class="kw">where</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>  toJSON (<span class="dt">UserV2</span> {firstName, lastName}) <span class="ot">=</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    object [<span class="st">&quot;firstName&quot;</span> <span class="op">.=</span> firstName, <span class="st">&quot;lastName&quot;</span> <span class="op">.=</span> lastName]</span></code></pre></div>
<p>Here we're specifying <strong>different instances</strong> of <code>ToJSON</code> for the different members of our <code>User</code> datatype. Note that, as promised, the compiler KNOWS that only the matching constructor needs to be matched on and that a <code>UserV1</code> won't show up in an instance for <code>User 2</code>. We'll need <code>FlexibleInstances</code> turned on so GHC can handle complex types like <code>User 1</code> in an instance definition.</p>
<p>Next it's time to fix up our <code>MonadUserService</code> class, we know that <code>getUser</code> needs to return a user, but which user type should it return? We can imagine someone implementing a <code>MonadUserService</code> for <code>User 1</code> and also for <code>User 2</code>, so it would be nice if instances could specify which version they want to work with. To accomplish that we can add an additional parameter to the class:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">-- ...</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">class</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>      <span class="dt">MonadUserService</span> v m</span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="kw">where</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="ot">  getUser ::</span> m (<span class="dt">User</span> v)</span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="kw">instance</span> <span class="dt">MonadUserService</span> <span class="dv">1</span> <span class="dt">AppM</span> <span class="kw">where</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  getUser <span class="ot">=</span> <span class="fu">return</span> (<span class="dt">UserV1</span> <span class="st">&quot;Bob Johnson&quot;</span>)</span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="kw">instance</span> <span class="dt">MonadUserService</span> <span class="dv">2</span> <span class="dt">AppM</span> <span class="kw">where</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>  getUser <span class="ot">=</span> <span class="fu">return</span> (<span class="dt">UserV2</span> <span class="st">&quot;Bob&quot;</span> <span class="st">&quot;Johnson&quot;</span>)</span></code></pre></div>
<p>Just like <code>ToJSON</code> we can now implement the typeclass instance differently for each version of our user. We'll need <code>MultiParamTypeClasses</code> to add the <code>v</code> parameter to our typeclass.</p>
<h2 id="generalizing-the-handler-and-app-over-version">Generalizing the handler and app over version</h2>
<p>We're moving along nicely! Next we need our <code>userHandler</code> and <code>app</code> to know about version numbers, however this layer of our app doesn't really care which exact version of user it's working with, mostly it just cares that certain instances exist for that user. Ideally we can write versions of these that work for either of our user versions all at once.</p>
<p>The first step is to introduce our new paramterized typeclasses:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="ot">userHandler ::</span> (<span class="dt">ToJSON</span> (<span class="dt">User</span> v), <span class="dt">MonadUserService</span> v m) <span class="ot">=&gt;</span> m <span class="dt">Value</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>userHandler <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  user <span class="ot">&lt;-</span> getUser</span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">return</span> <span class="op">$</span> toJSON user</span>
<span id="cb7-7"><a href="#cb7-7"></a></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="ot">app ::</span> (<span class="dt">ToJSON</span> (<span class="dt">User</span> v), <span class="dt">MonadIO</span> m, <span class="dt">MonadUserService</span> v m) <span class="ot">=&gt;</span> m ()</span>
<span id="cb7-9"><a href="#cb7-9"></a>app <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>  userJSON <span class="ot">&lt;-</span> userHandler</span>
<span id="cb7-11"><a href="#cb7-11"></a>  liftIO <span class="op">$</span> <span class="fu">print</span> userJSON</span></code></pre></div>
<p>Now we run into a bit of a problem;</p>
<pre><code>    • Could not deduce (MonadUserService v0 m)
      from the context: (MonadIO m, MonadUserService v m)
        bound by the type signature for:
                   app :: forall (m :: * -&gt; *) (v :: Nat).
                          (MonadIO m, MonadUserService v m) =&gt;
                          m ()
        at /Users/cpenner/dev/typesafe-versioning/src/Before2.hs:54:8-48
      The type variable ‘v0’ is ambiguous
    • In the ambiguity check for ‘app’
      To defer the ambiguity check to use sites, enable AllowAmbiguousTypes
      In the type signature:
        app :: (MonadIO m, MonadUserService v m) =&gt; m ()</code></pre>
<p>It's telling us it can't tell which user version we want it to use! So there are a few ways we can fix this; one way would be to specify the specific type that we'd like <code>v</code> to be each time it's used; we can enable <code>AllowAmbiguousTypes</code>, <code>TypeApplications</code> and <code>ScopedTypeVariables</code> to try that; but this ends up being pretty verbose and isn't the nicest to work with. We won't dive into that possibility, but I'd recommend you give it a try though if you like a challenge!</p>
<p>The other option we have is to clear up the disambiguity by giving the type system another way to determine what <code>v</code> should be; in our case the monad <code>m</code> is pervasive throughout our app, so if we can somehow infer <code>v</code> from <code>m</code> then we can save ourselves a lot of trouble. We're already associating the two within the typeclass definition <code>class (Monad m) =&gt; MonadUserService v m</code>; however the type system recognizes that there could be an instance for several different values of <code>v</code>; and of course we've implemented exactly that!</p>
<p>The way to fix this is to tell the type system that there's <strong>one-and-only-one</strong> <code>v</code> for each <code>m</code> using <strong>FunctionalDependencies</strong>; and then find a way to encode the <code>v</code> inside the <code>m</code> so we can still run the different versions of our app.</p>
<p>Lets add a new extension and alter our typeclass appropriately:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="ot">{-# LANGUAGE FunctionalDependencies #-}</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="kw">class</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">MonadUserService</span> v m <span class="op">|</span> m <span class="ot">-&gt;</span> v</span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="kw">where</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="ot">  getUser ::</span> m (<span class="dt">User</span> v)</span></code></pre></div>
<p>We've added a the <code>| m -&gt; v</code> annotation which reads something like "... where <code>m</code> determines <code>v</code>". Adding this annotation allows us to avoid the <code>Ambiguous Type</code> errors because we've told the type system that for any given <code>m</code> there's only one <code>v</code>; so if it knows <code>m</code>, (which in our case it does) then it can safely determine exactly which <code>v</code> to use.</p>
<p>Now you'll probably see something like this:</p>
<pre><code>Functional dependencies conflict between instance declarations:
    instance MonadUserService 1 AppM
    -- Defined at ...
    instance MonadUserService 2 AppM
    -- Defined at ...</code></pre>
<p>We told the type system there'd only be a single <code>v</code> for every <code>m</code>; then immediately gave it two instances for <code>AppM</code>; GHC caught us lying! That's okay, GHC will forgive us if we can somehow make the two <code>m</code>'s different! We can do this by adding a phantom type to the <code>AppM</code> monad which simply denotes which version we're working with; let's try editing our <code>AppM</code> monad like this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">newtype</span> <span class="dt">AppM</span> (<span class="ot">v ::</span> <span class="dt">Nat</span>) a <span class="ot">=</span> <span class="dt">AppM</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  {<span class="ot"> runApp ::</span> <span class="dt">IO</span> a</span>
<span id="cb11-3"><a href="#cb11-3"></a>  } <span class="kw">deriving</span> (<span class="dt">Functor</span>, <span class="dt">Applicative</span>, <span class="dt">Monad</span>, <span class="dt">MonadIO</span>)</span></code></pre></div>
<p>We've added the <code>(v :: Nat)</code> type argument here, it doesn't show up any where in our data, meaning it's a <strong>Phantom Type</strong> which is just there to help use denote something at the type level, in this case we denote which user version we're currently working with. Now we can add that additional info to our <code>MonadUserService</code> instances:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">instance</span> <span class="dt">MonadUserService</span> <span class="dv">1</span> (<span class="dt">AppM</span> <span class="dv">1</span>) <span class="kw">where</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  getUser <span class="ot">=</span> <span class="fu">return</span> (<span class="dt">UserV1</span> <span class="st">&quot;Bob Johnson&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="kw">instance</span> <span class="dt">MonadUserService</span> <span class="dv">2</span> (<span class="dt">AppM</span> <span class="dv">2</span>) <span class="kw">where</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  getUser <span class="ot">=</span> <span class="fu">return</span> (<span class="dt">UserV2</span> <span class="st">&quot;Bob&quot;</span> <span class="st">&quot;Johnson&quot;</span>)</span></code></pre></div>
<p>It seems a bit redundant, but it gets us where we're going!</p>
<p>Not done yet! We still need to tell GHC which version of our <code>app</code> we want to run! You can use <code>TypeApplications</code> for this if you like, but the easier way is to just specify with a type annotation:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb13-2"><a href="#cb13-2"></a>main <span class="ot">=</span> runApp (<span class="ot">app ::</span> <span class="dt">AppM</span> <span class="dv">1</span> ())</span></code></pre></div>
<p>Try running the different versions and see what you get!</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="op">&gt;</span> runApp (<span class="ot">app ::</span> <span class="dt">AppM</span> <span class="dv">1</span> ())</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="dt">Object</span> (fromList [(<span class="st">&quot;name&quot;</span>,<span class="dt">String</span> <span class="st">&quot;Bob Johnson&quot;</span>)])</span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="op">&gt;</span> runApp (<span class="ot">app ::</span> <span class="dt">AppM</span> <span class="dv">2</span> ())</span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="dt">Object</span> (fromList [(<span class="st">&quot;lastName&quot;</span>,<span class="dt">String</span> <span class="st">&quot;Johnson&quot;</span>),(<span class="st">&quot;firstName&quot;</span>,<span class="dt">String</span> <span class="st">&quot;Bob&quot;</span>)])</span></code></pre></div>
<p>That should do it! We can quickly and easily switch between versions of our app by changing the type annotation; if we like we could even write some aliases to help out:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="ot">appV1 ::</span> <span class="dt">AppM</span> <span class="dv">1</span> ()</span>
<span id="cb15-2"><a href="#cb15-2"></a>appV1 <span class="ot">=</span> app</span>
<span id="cb15-3"><a href="#cb15-3"></a></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="ot">appV2 ::</span> <span class="dt">AppM</span> <span class="dv">2</span> ()</span>
<span id="cb15-5"><a href="#cb15-5"></a>appV2 <span class="ot">=</span> app</span></code></pre></div>
<p>Nice! Now we can write our app in such a way that it's <strong>generic</strong> and <strong>polymorphic</strong> over the <strong>version</strong> of user when that part of the app doesn't care which version it is, but we can still <strong>specialize</strong> to a specific user version when needed by using specific typeclasses or by pattern matching on the User constructor. The type system will guarantee that we never accidentally switch between user versions in the middle of our app; and we can defer the choice of version until the last possible second (at the top level call site). Sounds like a win to me!</p>
<p>Hope you learned something!</p>
<h2 id="bonus-section-asserting-version-compatibility">Bonus Section: Asserting Version Compatibility</h2>
<p>If you take this pattern even further you might end up with multiple versions in your app; something like this:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="dt">AppM</span> (<span class="ot">userVersion ::</span> <span class="dt">Nat</span>) (<span class="ot">postVersion ::</span> <span class="dt">Nat</span>) a <span class="ot">=</span> <span class="dt">AppM</span></span></code></pre></div>
<p>This works fine of course, but as the number of version parameters grows it gets tough to keep track of which versions are compatible with each other, maybe <code>userVersion == 2</code> is only compatible with a <code>postVersion &gt;= 3</code>? Here's a fun trick using <code>ConstraintKinds</code> and <code>TypeFamilies</code> to let us easily assert that our app is never run with incompatible versions:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a><span class="ot">{-# LANGUAGE TypeOperators #-}</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="ot">{-# LANGUAGE UndecidableInstances #-}</span></span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="kw">import</span> <span class="dt">Data.Kind</span></span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Compatible</span> (<span class="ot">userVersion ::</span> <span class="dt">Nat</span>) (<span class="ot">postVersion ::</span> <span class="dt">Nat</span>)<span class="ot"> ::</span> <span class="dt">Constraint</span> <span class="kw">where</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="dt">Compatible</span> <span class="dv">1</span> <span class="dv">1</span> <span class="ot">=</span> ()</span>
<span id="cb17-9"><a href="#cb17-9"></a>  <span class="dt">Compatible</span> <span class="dv">2</span> <span class="dv">3</span> <span class="ot">=</span> ()</span>
<span id="cb17-10"><a href="#cb17-10"></a>  <span class="dt">Compatible</span> <span class="dv">2</span> <span class="dv">4</span> <span class="ot">=</span> ()</span>
<span id="cb17-11"><a href="#cb17-11"></a>  <span class="dt">Compatible</span> a b <span class="ot">=</span> <span class="dt">TypeError</span> (<span class="dt">Text</span> <span class="st">&quot;userVersion &quot;</span> <span class="op">:&lt;&gt;:</span> <span class="dt">ShowType</span> a </span>
<span id="cb17-12"><a href="#cb17-12"></a>                         <span class="op">:&lt;&gt;:</span> <span class="dt">Text</span> <span class="st">&quot; is not compatible with postVersion &quot;</span> <span class="op">:&lt;&gt;:</span> <span class="dt">ShowType</span> b)</span></code></pre></div>
<p>You may need to dig into this a bit on your own to understand it fully, but the basic idea is that it's a function over types which when given two versions will either result in an empty constraint (i.e. <code>()</code>) which will allow compilation to continue, or will result in a failing <code>TypeError</code> and will print a nice error message to the user. You can use it like this:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a><span class="ot">runAppWithCheck ::</span> <span class="dt">Compatible</span> userVersion postVersion <span class="ot">=&gt;</span> <span class="dt">AppM</span> userVersion postVersion a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co">-- We only really need the additional type information, under the hood we can just call `runApp`</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>runAppWithCheck <span class="ot">=</span> runApp</span></code></pre></div>
<p>Now if you try to run your app with incompatible versions you'll get a nice error something like:</p>
<pre><code>error:
    • userVersion 2 is not compatible with postVersion 1
    • In the expression: runAppWithCheck (app :: AppM 2 1 ())
      In an equation for ‘main’:
          main = runAppWithCheck (app :: AppM 2 1 ())
   |
   | main = runAppWithCheck (app :: AppM 2 1 ())</code></pre>
<p>Good stuff! You can even use <code>DataKinds</code> to add a little structure to your version numbers so you can't accidentally mix up your userVersions with your postVersions, but I'll leave that for you to figure out 😉</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Monoidal Sorting</title>
      <link href="https://chrispenner.ca/posts/monoid-sort"/>
      <id>https://chrispenner.ca/posts/monoid-sort</id>
      <updated>2018-07-22T00:00:00Z</updated>
      <summary>We explore a merge-sort monoid</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/monoid-sort/sorting.jpg" alt="Monoidal Sorting">
              <p>As I dive deeper into functional programming I'm beginning to think that monoids can solve most problems. In general monoids work well in combination with other structures and algorithms, for instance <a href="/posts/intro-to-finger-trees">Finger Trees</a>, and folds!</p>
<p>This post is just yet-another-demonstration of how adaptable monoids can really be by solving a problem most people wouldn't immediately associate with monoids.</p>
<h2 id="sorting">Sorting</h2>
<p>We're going to write a wrapper around lists which rather than the traditional monoid for lists (concat) instead sorts the two into each other; not much to talk about really, lets see the code!</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">newtype</span> <span class="dt">Sort</span> a <span class="ot">=</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="dt">Sort</span> {</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ot">        getSorted ::</span> [a]</span>
<span id="cb1-4"><a href="#cb1-4"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">-- So long as the elements can be ordered we can combine two sorted lists using mergeSort</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">instance</span> (<span class="dt">Ord</span> a) <span class="ot">=&gt;</span> <span class="dt">Monoid</span> (<span class="dt">Sort</span> a) <span class="kw">where</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="fu">mempty</span> <span class="ot">=</span> <span class="dt">Sort</span> []</span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="fu">mappend</span> (<span class="dt">Sort</span> a) (<span class="dt">Sort</span> b) <span class="ot">=</span> <span class="dt">Sort</span> <span class="op">$</span> mergeSort a b</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">-- simple merge sort implementation</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="ot">mergeSort ::</span> <span class="dt">Ord</span> a <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</span>
<span id="cb1-14"><a href="#cb1-14"></a>mergeSort [] xs <span class="ot">=</span> xs</span>
<span id="cb1-15"><a href="#cb1-15"></a>mergeSort xs [] <span class="ot">=</span> xs</span>
<span id="cb1-16"><a href="#cb1-16"></a>mergeSort (x<span class="op">:</span>xs) (y<span class="op">:</span>ys)</span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="op">|</span> y <span class="op">&lt;</span> x <span class="ot">=</span> y <span class="op">:</span> mergeSort (x <span class="op">:</span> xs) ys</span>
<span id="cb1-18"><a href="#cb1-18"></a>mergeSort (x<span class="op">:</span>xs) ys <span class="ot">=</span> x <span class="op">:</span> mergeSort xs ys</span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">-- We&#39;ll keep the &#39;Sort&#39; constructor private and expose this smart constructor instead so we can</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="co">-- guarantee that every list inside a `Sort` is guaranteed to be sorted.</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">-- We could use a simple sort function for this, but might as well use mergeSort since </span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co">-- we already wrote it.</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="ot">toSort ::</span> [a] <span class="ot">-&gt;</span> <span class="dt">Sort</span> a</span>
<span id="cb1-25"><a href="#cb1-25"></a>toSort <span class="ot">=</span> <span class="fu">foldMap</span> (<span class="dt">Sort</span> <span class="op">.</span> <span class="fu">pure</span>)</span></code></pre></div>
<p>Let's try it out:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="op">&gt;</span> toSort [<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">3</span>] <span class="ot">`mappend`</span> toSort [<span class="dv">10</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">4</span>]</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="dt">Sort</span> {getSorted <span class="ot">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">10</span>]}</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="op">&gt;</span> <span class="fu">foldMap</span> (toSort <span class="op">.</span> <span class="fu">pure</span>) [<span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">8</span>]</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="dt">Sort</span> {getSorted <span class="ot">=</span> [<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">8</span>]}</span></code></pre></div>
<p>Nothing too complicated really! <code>mappend</code> over sorted lists just sorts the combined list; we have the benefit in this case of knowing that any list within a <code>Sort</code> is guaranteed to be sorted already so we can an efficient merge sort algorithm. This doesn't make much difference when we're appending small sets of values together, but in particular cases like FingerTrees where intermediate monoidal sums are cached it can really speed things up!</p>
<p>Just like that we've got a cool monoid which sorts lists for us, and by combining it with <code>foldMap</code> we can easily sort the values from any foldable structure. One other benefit here is that since we know monoids are associative, if we have a huge list of elements we need sorted we can actually split up the list, sort chunks in parallel and combine them all and we have a guarantee that it'll all work out.</p>
<p>Anyways, that's about it for this one, nothing to write home about, but I think it's fun to discover new monoids!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>A Practical Introduction to Finger Trees</title>
      <link href="https://chrispenner.ca/posts/intro-to-finger-trees"/>
      <id>https://chrispenner.ca/posts/intro-to-finger-trees</id>
      <updated>2018-07-21T00:00:00Z</updated>
      <summary>How to use finger trees to solve problems by choosing the appropriate monoid measure.</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/intro-to-finger-trees/finger-tree.jpg" alt="A Practical Introduction to Finger Trees">
              <p>Finger Trees are definitely the coolest data structure I was never taught in school. The gist of Finger Trees is that they represent sequences of elements where the elements also have a measurable 'descriptor' of some kind. If that sounds vague it's because it is! The generality here is what allows Finger Trees to solve so many different types of problems, but it does require a few examples and explanations to understand. In this post we'll talk about how the trees work at a high level, then we'll use them to build a random-access array-like structure with reasonable performance characteristics.</p>
<p>This data structure stands on the shoulders of giants, it uses a structure called a <code>Monoid</code> at its core.</p>
<h2 id="monoids">Monoids</h2>
<p>If you're entirely unfamiliar with the concept of monoids, or just need a refresher, it would be a good idea to get a solid grounding there first; <a href="https://www.schoolofhaskell.com/user/mgsloan/monoids-tour">here's a good place to start</a>.</p>
<p>Monoids are incredibly useful; and the more I learn about Category Theory the more applications I find for monoidal structures. Once you start to think in monoids you start to realize how many things you once thought were unique and interesting problems are actually just a monoid and a fold away from some other well-solved problem. We're going to start off by introducing a new tool (i.e. data structure) which employs monoids to do amazing things! Enter <a href="https://en.wikipedia.org/wiki/Finger_tree">Finger Trees</a>! Finger Trees are an adaptable purely functional data structure; they're actually an extremely general structure which makes it a bit difficult to explain without a concrete use case. This is because they utilize a Monoid in the foundation of the data structure, and the Monoid you choose can drastically affect how the structure behaves. Here's a glance at the sort of things you could do by choosing different Monoids:</p>
<ul>
<li>Random access/sequence slicing using <a href="https://hackage.haskell.org/package/base-4.11.1.0/docs/Data-Monoid.html#t:Sum"><code>Sum</code></a>: see <a href="https://hackage.haskell.org/package/containers-0.6.0.1/docs/Data-Sequence.html">Data.Sequence</a>; we'll explore this one just below!</li>
<li>Heap using <a href="https://hackage.haskell.org/package/base-4.11.1.0/docs/Data-Semigroup.html#t:Max"><code>Max/Min</code></a>: see <a href="https://hackage.haskell.org/package/fingertree-0.1.4.1/docs/Data-PriorityQueue-FingerTree.html">Data.PriorityQueue.FingerTree</a></li>
<li>Ordered Sequence slicing using <a href="https://hackage.haskell.org/package/base-4.11.1.0/docs/Data-Monoid.html#t:Last">Last</a>: see the section on <a href="http://www.staff.city.ac.uk/~ross/papers/FingerTree.pdf">Ordered Sequences</a></li>
<li>Interval Searching using a custom interval expansion Monoid: see <a href="https://hackage.haskell.org/package/fingertree-0.1.4.1/docs/Data-IntervalMap-FingerTree.html">Data.IntervalMap.FingerTree</a></li>
<li>Text slicing and dicing using a product of <code>Sum</code>s: see <a href="https://hackage.haskell.org/package/yi-rope">Yi.Rope</a></li>
<li>Performant merge sort using a custom merge monoid: blog post coming eventually!</li>
<li>Many more! Just use your imagination!</li>
</ul>
<p>How does it all work? Let's learn how to build a simple random-access &lt;air-quotes&gt; Array &lt;/air-quotes&gt; using a Finger Tree so we can get a sense of things</p>
<h2 id="random-access-array-using-a-finger-trees">Random Access Array using a Finger Trees</h2>
<p>Let's implement a simple random access list using a Finger Tree! After a quick glance through the <a href="https://hackage.haskell.org/package/fingertree-0.1.4.1/docs/Data-FingerTree.html">Data.FingerTree Docs</a> it's a bit tough to tell where we might start! The workhorse of the Finger Tree library is the <code>split</code> function:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">split ::</span> <span class="dt">Measured</span> v a <span class="ot">=&gt;</span> (v <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">FingerTree</span> v a <span class="ot">-&gt;</span> (<span class="dt">FingerTree</span> v a, <span class="dt">FingerTree</span> v a)</span></code></pre></div>
<p>Yikes, let's break this down:</p>
<ul>
<li><code>Measured v a</code>: Measured is a simple typeclass which given an <code>a</code> can convert it into some monoid <code>v</code></li>
<li><code>(v -&gt; Bool)</code>: This is our search predicate, <code>split</code> will use it to split a sequence into two smaller subsequences: The longest subsequence such that running the predicate on the measure of this subsequence <code>False</code>, and the everything that's left-over.</li>
<li><code>FingerTree v a</code>: This is the tree we want to split, with a monoidal measure <code>v</code> and elements of type <code>a</code>.</li>
<li><code>(FingerTree v a, FingerTree v a)</code>: The two (possibly empty) subsequences, the first is before the split point the second contains the inflection point of our predicate and everything past it.</li>
</ul>
<p>That's all great, but how can we actually use it to solve our problem? What does splitting up a sequence actually have to do with indexing into a list? Finger Trees get their performance characterics by searching through subtrees using a strategy very similar to a binary search, they run the predicate on cached "measures" of subtrees recursively honing in on the <strong>inflection point</strong> where the predicate flips from <code>False</code> to <code>True</code>. So what we need to do is find some pairing of a monoid and a predicate on that monoid which finds the place in the sequence we're looking for. Getting the first or last element of a Finger Tree is a simple <code>O(1)</code> operation, so if we can split the list either directly <em>before</em> or directly <em>after</em> the index we're looking for, then we're pretty much done!</p>
<p>Building a predicate for this is pretty simple, we just need to be able to determine whether the index we're looking for is within some prefix of our total sequence, which phrased simply is just: <code>length sequence &gt; index</code>; we can use this predicate to recursively hone in on the point where adding a single element alters the predicate's result from false to true, and we've found our index! The predicate runs on the measure of the values, which must be a monoid; so we need to represent the length of our sequence as some monoid, the combination of the monoidal measure of two sequences must also match the measure of the combination of the sequences themselves! Luckily for us the length of the combination of two lists is just the sum of the lengths! This gives us the hint that we can use the <a href="https://hackage.haskell.org/package/base-4.11.1.0/docs/Data-Monoid.html#t:Sum"><code>Sum</code> Monoid</a> as our measure!</p>
<p>We're so close now, let's write some code to make it happen.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="ot">{-# LANGUAGE MultiParamTypeClasses #-}</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">import</span> <span class="dt">Data.FingerTree</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="kw">import</span> <span class="dt">Data.Monoid</span></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">-- We need to wrap our primitive value type in a newtype;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">-- This allows us to store ANY value in the sequence and helps us avoid</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">-- some trouble with functional dependencies and orphan instances.</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="kw">newtype</span> <span class="dt">Size</span> a <span class="ot">=</span> <span class="dt">Size</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  {<span class="ot"> getSize ::</span> a</span>
<span id="cb2-13"><a href="#cb2-13"></a>  } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb2-14"><a href="#cb2-14"></a></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">-- Measured is the typeclass we implement to tell the FingerTree how to measure</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co">-- our values into a monoid. In our case every individual element is simply of length &#39;1&#39;</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="kw">instance</span> <span class="dt">Measured</span> (<span class="dt">Sum</span> <span class="dt">Int</span>) (<span class="dt">Size</span> a) <span class="kw">where</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>  measure _ <span class="ot">=</span> <span class="dt">Sum</span> <span class="dv">1</span></span>
<span id="cb2-19"><a href="#cb2-19"></a></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co">-- We wrap our values in the &#39;Size&#39;i wrapper and build a Finger Tree</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="ot">alphabet ::</span> <span class="dt">FingerTree</span> (<span class="dt">Sum</span> <span class="dt">Int</span>) (<span class="dt">Size</span> <span class="dt">Char</span>)</span>
<span id="cb2-22"><a href="#cb2-22"></a>alphabet <span class="ot">=</span> fromList (<span class="fu">fmap</span> <span class="dt">Size</span> <span class="st">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>)</span>
<span id="cb2-23"><a href="#cb2-23"></a></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co">-- Get a given index from the tree if it exists</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="ot">atIndex ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">FingerTree</span> (<span class="dt">Sum</span> <span class="dt">Int</span>) (<span class="dt">Size</span> a) <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</span>
<span id="cb2-26"><a href="#cb2-26"></a>atIndex n t <span class="ot">=</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>  <span class="kw">case</span> viewl <span class="op">.</span> <span class="fu">snd</span> <span class="op">$</span> split (<span class="op">&gt;</span> <span class="dt">Sum</span> n) t <span class="kw">of</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>    <span class="dt">Size</span> c <span class="op">:&lt;</span> _ <span class="ot">-&gt;</span> <span class="dt">Just</span> c</span>
<span id="cb2-29"><a href="#cb2-29"></a>    _ <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>Hopefully the first bits are pretty self explanatory, we set up our datatypes so the tree knows how to measure our elements, and it already knows how to combine measures via Sum's Monoid instance. Lastly in <code>atIndex</code> we tell the tree to split open at the point where the length of the measured subsequence would surpass the index we've provided. Then we simply check if there's an element to the right of that split. This operation doesn't quite get us the <code>O(1)</code> time complexity we know and love from traditional arrays, but for an immutable, general data structure which we could build ourselves without ANY special compiler support, getting logarithmic performance isn't too bad. In fact the actual performance is <code>O(log(min(i,n-i)))</code> where <code>i</code> is the index we wish to access and <code>n</code> is the length of the sequence. If we're often accessing the first or last elements then we're down to pretty much constant time!</p>
<p>There we go! We've used 'Sum' as a measure within a finger tree to get efficient indexing into a sequence! We can also notice that the length of the whole sequence is computed in <code>O(1)</code> if we use <code>length = measure</code>; and that we can concat two sequences relatively efficiently using <code>(&gt;&lt;)</code>; listed in <code>Data.FingerTree</code> as time complexity <code>O(log(min(n1, n2)))</code> where n1 and n2 are the length of each sequence respectively.</p>
<p><code>Sum</code> is probably the simplest monoid we can use; take a minute to think about how other monoids you know of might behave; the majority of monoids will create SOME sort of useful structure when used with a Finger Tree!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANkAAAAzCAYAAAAaYa2SAAAABGdBTUEAALGPC/xhBQAAC8VJREFUeAHtXQmwFMUZ/npmFpHzcQgBRSFcAnIfcimICEFEEFAEj5SlUMYkVTEKJpgQSSmSUGWMFimJUEQTFa8UEdAkGENEi0MBBQQMgiCX3Icc8t7MdP6/Z2d2dt/bdd/bHdis/Vc9tqePv3u+7r//ayzF2XvHSmjSCGgEIkPAiIyzZqwR0AgoBLSQ6YOgEYgYAS1kEQOs2WsEtJDpM6ARiBgBLWQRA6zZawS0kOkzoBGIGAEtZBEDrNlrBLSQ6TOgEYgYAS1kEQOs2WsEtJDpM6ARiBgBLWQRA6zZawS0kOkzoBGIGAEtZBEDrNlrBLSQ6TOgEYgYAS1kEQOs2WsErFwhKFlxKmAx+eIYHr60WvAcFBo3hXn1UBjtOgIlDYCyMsj9e+CuWwX3vbfpuTToqgsagWJDIGchs90EJE6iGJTMEeNgDL0JwjSDOlwIiDp1YbRuDzlkJOy5v4PctiXRrksagSJCIFJz0Rw/Eeb1Y5MFLAU8UVIf1k+mQbRql9KiHzUCxYFAZEImuvYmE3FIVigJKwbrnvuBC6pn1f+cd2rYGIK0LupfRCpYZJ6e3kU0awHRvFXhvk/mN/j/bi1A/HM2F9PtiDXilnRNFdaLuvVgkFC6S9+osD1TpfXwLBiXNE/qItnPO3yQ/L6VcP6xEDj7NdCoCapNfyqpX/jBWbEMzvOzvSrDhDl8LIxBwyGqk30bJ3nkEJxFL8Nducyv8n7rNYQ1YSJE+84QNJZJSgm5/b9wXpwDuXeX14/+Da9XOg7KptwNnE74tubNd8EcdH3Q3573JNwP36/c+oPRyQVz+M0wb/D2Rp46ibKfTQRsO7lTypPxvdGwRo5PqpUuOQeHDsD9dAOcxa8CJ44F7enmEC1aIzZlRtAvXaH0wbtgXDWk/JyEFY4egvv5VjhLaM79exMsqoi/vfAFuHw+4mQMHQVr1G3qqfQ+won2MFeKRpNRoEM0aVbptRldrqz0mPAA3nh5aD/kscMQsWoQ37kY5rAxsO68L9xNlaVjQ5Lghf9gl3n9DAPWA9M9U5cETLou5NdnVJuoT8L0/R/CuGZYwFM0vRSxaU/AuKKbEjB58ivI40dJ6QkYLdvC+vlvINp1CvqHC+yrGh27h6vKPSc1xh8yrr+iAfE6o8/AoFXUrAWjU8/gOZsCC6b86jhpdAOCLi2ThCE25TGgRs1geK5zBIziBcaS9xW0D4KsCrNnf8Qeehxo0Ej1yAV/ky4Q0AUfJUWiyfhwV4WqOi6Y6/gxlP3yR94jbUaMNBxrIdG5F2Amv6q77O9wXnsuGBouGAOHwfhuW1XlrF5OmuiPKgIqOnSBNfEBJcDm6DvgkuYDCZ85YZKah7WS86enPa1Do8XlHWFNehDiwhqk5Sah7Nc/TYqk8mEVtSkA1KUX3FXvqvlEk0sgLmoMeYLaKDiUjjKtP90YNnkFHUx1Ga1fo+Y1+lwDd+2KdEPK1duzZ0CSJgGt27r1Hhjdeiueis+/FiuzOt0ccuc2lE4mrR2n2CO/Bws6ayb7DzP9aoAEOUz2nFnenHRxmjfeCnPwCIWp2W8QnDcWVBl/noPPhzn6djjznw5PmddyJJqMfawqkZUsCFXi4Q86fAA4c1o9STYrSHNlSyaZiEwsBM5fnvFMTdZmG9YqYZBnTkHu3K6EQVzWUmkr7u+u+k8gYGr8lg1w6eAx8Q2cqrHUYeW29l0AOkCqX1yryR10kPNMLAhMPK+zOi7U7UnD1imp/EyMTchk5ouBKeMchCFOnkj8+aYY7024Pt1qyAVwN65NtNaohZzw/3KP4mX2uhoifqkmmOevlMdTnViUPHIw8VCZEvk7ORFpDPOm28npoeBD2ysg6jWA8qFenV+OrdGha7nD5S57C3LPFxTgaKj6q7RCSg7PeWkunBfmBPyM3gODsty8Pij7BZcEzfeBRFMyoUNaw6WbnQ8J+6NsTsr1H5L51kMNdT9ZF5R9XuHftOsnH7BCoqASax0md80KyI3rlKksuP7KAeQL/63CYWkra9WB2XdQ0Cz37laBnrzO4XOnfQULFGl5k9JBPrmbPkpySyqN/56dEHQBG517whx3N+yZD/ms8/objZDt2Ab2S0St2pVaLB+sXEipfsq7hYk3Ihx08NuUv5Zi1soNayApAMG+FJPyPfwB/i87/GGKCyRXVdQ/qS7UV7Ggm9wlwTKvuk5ttLPtU4gWbSBLz1JAYWN4lnLltOtPI2QGRXtZoDgYo8xD1go8N/k3Jvlp2QqZdS8dRNY8fDGQ78okSSNwIMjo1icvc6S+bOzHv0itgrP8n5CfkJBRoMKnJKzjlUl1KfgLCNivP48YuQHGpS1g9Bvss8rrbyRCRkY/nHeWwCL7OVuSFHRwSJPkQuzHsM/AxBqCE+Fm/8EUkOiKsqk/SGLNX5s47y1NqpO7d3qmYbxW1KWvU1KJ0wwc5fKDJOyQx4lzfqmxKNZSPinn3X+I/7off+AJGWkwuXWTOris/VBK0dEMlHb9acYYfT1Tkc0yX/uKmGfWKz/wslZkAn+WZnSoujq9P5t9ZDK7FL2VW9ZDRW/pYsjbHKHpuOiy6Ux4GG06qBbPT37W65Uj/jj4Jdy3F4EDIOaN4+C+m3wmvEly+zcaIaM1cSje7dQdRvPWWa3QWfiiCgln1TldJ44YfrFdtfKv4M+5rr0Bgj7lEi0vp2DCsWAkm7Ry08fBc7ggj1J0kkxN0aa9MlNw+mTQbI65kw7TIDIrd8JZMA9yXyI0L9ifigcw/AFhP6wijSopBM6RS0Hml+/PuOT7fRNlWn+5sQ0bBcl+DrRYoyaU68IRQScLIbOfnO4FIVI55HGOVNbOK/PVnNb9jyhB40CRU7c+cPxIzvjzXM5bf6WLZ4A6J0afAanT5/zs6fuc2VTAgG56e/ZMuN/wuRSbLzZFiPwAQQWcqlZFiWOO7iUoVcckWlJLzr/fVFVsfqokOQkcKChjdO+rtACH3dlcYwGTu3ZAaR4awSaZ0f86UqOeuSlIOxkDhipebFJx4KQcUY7KF3b/pnY3rinXLZcKk/xGNoE5FWGTP2k/Nzv4C9beo596x6rOcy7m4Pwkk6h2AVkpt6hyzvgzF9LCzut/VvwEf3CQZ4pMk6l1kmliP/ErsnWvhUl5pXDujM1DdlSdJa9lZ6Zk8+J1SxB7nIISdKDCZppLWk1u3wrQbesTJ5nDuS6ul+QH2U89CvedN+H26O/Z6RSQqDbjGUj6qNk3r7iv89KzKnzPZXvBXMQmP0rh6NqwbpsEOeYOleD1fVJOjNucBkgT4XTXf5AISuz6HDh2BKDkaibKtP7UcXxLM3EgR32QHerAkVKDLiM/Z1aZcH6IjdIEUc8hP9usLjRer9K8ZOaBLq9c8ed1c7LfpY8h+HvafFO0QqZW78JdvlT9KWeZv8K3SyHpawH1FUYe30h9aUF+ERPnrEBhfJdMQmfxK4RicsBCBTeEmTS7pASrIhIGe9ZUstHHk2YarHIyvoBxOoC/EpAfrU6MpTrOgXHeSHSkhDRpQCaVj9q62ROwA/sS/VNKbB5yX16/DIeoU/qFHzOuP9RRkB/DeSsmd+3KUItX5OCBMldpzSrXFYp+luucpuJczOFP7Sxa4F0KhJU1cgI4h8ZffuSCf8D75XkQU3+r9sGvy8evyPV/nVTr/cTnQFOaxTCtov/UJR8rPZ882PQsqQdJjj7o64OMRBE39gXZvJT7KA/jB0gyDtKNeUOgAPGPXpPlDb3zyIiDJNnm/jhpvW/3eVzst3zqAsQ/usDHt3yv9etrBHwEtJD5SOhfjUBECORsLp7sVzOipWm2GoHiQEBrsuLYR/0WBYyAFrIC3hy9tOJAQAtZceyjfosCRkALWQFvjl5acSCghaw49lG/RQEjoIWsgDdHL604ENBCVhz7qN+igBHQQlbAm6OXVhwIaCErjn3Ub1HACGghK+DN0UsrDgS0kBXHPuq3KGAEtJAV8ObopRUHAlrIimMf9VsUMAJayAp4c/TSigMBLWTFsY/6LQoYgf8BIVTf3IgGuLEAAAAASUVORK5CYII=" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Postman API Explorer: You&#39;ve got mail!</title>
      <link href="https://chrispenner.ca/posts/postman"/>
      <id>https://chrispenner.ca/posts/postman</id>
      <updated>2018-06-03T00:00:00Z</updated>
      <summary>A guide to using Postman for API exploration and testing</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/postman/mail.jpg" alt="Postman API Explorer: You&#39;ve got mail!">
              <p>For those who haven't heard of it, postman is a tool for interacting with and exploring API's. Effectively it's a pretty UI on top of curl; but it makes a big difference when figuring out how exactly to structure an API call, or testing what the response from an api might look like.</p>
<p>Let's get started, first go ahead and <a href="https://www.getpostman.com/">GET POSTMAN</a>;</p>
<p>Here's roughly what you'll see when you start it up:</p>
<p><img src="/images/postman/overview.png" alt="Overview" /></p>
<h1 id="requests">Requests</h1>
<p>Let's walk through the Request interface (in order of importance, stop when you get bored)</p>
<p><img src="/images/postman/request.png" alt="Requests" /></p>
<ol>
<li>URL
<ul>
<li>This bit's pretty important, put a URL in here, click the SEND button. Now you can use Postman.</li>
</ul></li>
<li>HTTP VERB
<ul>
<li>Here you can choose what type of request to make; GET, POST, PATCH, DELETE, etc.</li>
<li>This choice effects which other options are available; for instance you can't set a BODY on a GET request.</li>
</ul></li>
<li>SEND
<ul>
<li>Hit this button to make the magic happen and actually send off your request.</li>
</ul></li>
<li>Params
<ul>
<li>This gives you a nice interface for editing GET parameters as keys and values. Don't get it confused with the idea of sending keys and values with a POST request.</li>
</ul></li>
<li>Body
<ul>
<li>Only available on non-GET requests</li>
<li>Can choose your body type and it'll encode it for you</li>
<li>Use 'raw' and use the dropdown on the right to set the content-type to JSON for most APIs</li>
<li>Use form-data if you're simulating an old-school form submission or some older-style APIs</li>
</ul></li>
<li>Headers
<ul>
<li>Set any HTTP headers you need here;</li>
<li>Typically just used for Authentication headers; You can put a jwt auth header in here for instance.</li>
</ul></li>
<li>Authorization
<ul>
<li>Sometimes helpful for interacting with 3rd party APIs</li>
<li>Choosing Basic Auth will encode a username and password into the request for you.</li>
</ul></li>
</ol>
<h1 id="responses">Responses</h1>
<p><img src="/images/postman/response.png" alt="Responses" /></p>
<p>Cool stuff; we can set up our request. Now let's say we hit the big blue SEND button and we have a response!</p>
<ol>
<li>Body
<ul>
<li>We're probably most interested in the Body of the response</li>
</ul></li>
<li>Headers
<ul>
<li>If you want to check the headers of the response this's where you'll find'em</li>
</ul></li>
<li>Response Type
<ul>
<li>Postman can pretty print the response if we tell it to; set this to JSON and it'll nicely format the response for you.</li>
</ul></li>
<li>Utilities
<ul>
<li>First one is "Copy to Clipboard"; handy for sharing with your helpful co-workers</li>
<li>Second opens a search in the response</li>
<li>Third let's you save it for later</li>
</ul></li>
<li>Stats
<ul>
<li>Here we can see Response Time, Status Code and response size.</li>
</ul></li>
</ol>
<p>So that's pretty much it for making simple requests, but I've missed a few of the more useful things about postman; you can save collections of requests to share with people; and also save lists of environment variables which can be interpolated into requests.</p>
<h2 id="history">History</h2>
<p><img src="/images/postman/history.png" alt="History" /></p>
<p>You can see your request history via the tab at the top and load up any past requests, which is handy if you've edited a request and want to get back to a previous version of it; or you're like me and you can't remember anything that happened more than 15 minutes ago.</p>
<h2 id="collections">Collections</h2>
<p><img src="/images/postman/collections.png" alt="Collections" /></p>
<p>This panel on the left will probably have nothing in it when you start. At any time you can hit the 'save' button to the right of the URL bar to save a request for later.</p>
<p>I keep collections of requests around when I'm testing, and I often make collections to share with my team.</p>
<h1 id="environments">Environments</h1>
<p><img src="/images/postman/environments.png" alt="Environments" /></p>
<p>Here we can set a context to execute our requests in. An environment can contain a set of key-value settings which we can use anywhere in our request. This is great if you're testing api's as different users, or if you have to test the same calls against several different hosts.</p>
<p>If you set up some environment variables you can interpolate them into your requests using double curly braces. For example you might make a request to <code>example.com/my-endpoint?apiKey={{apiKey}}&amp;apiUser={{apiUser}}</code>, now if you have postman environments set up for each user and key you can switch between them easily. You can use <code>{{}}</code> anywhere it would make sense; e.g. urls, params, POST bodies, etc.</p>
<h1 id="need-a-session-with-the-site-use-interceptor">Need a session with the site? Use Interceptor</h1>
<p>Interceptor is one of Postman's cooler features; it allows the Postman app to route the requests through your chrome instance; this means they'll include any cookies (and therefore sessions) you have in chrome.</p>
<p><img src="/images/postman/interceptor.png" alt="Interceptor" /></p>
<p>NOTE! Interceptor is currently only available in the chrome Postman plugin, NOT the desktop app; so if you don't see this icon, you're probably using the desktop app and will need to switch over to <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop">Postman chrome app</a> to use it. You'll also need to install the <a href="https://chrome.google.com/webstore/detail/postman-interceptor/aicmkgpgakddgnaphhhpliifpcfhicfo?hl=en">Postman Interceptor Chrome Extension</a>.</p>
<p>Now if we click to enable the chrome interceptor plugin, all our requests will pick up any cookies that exist in our chrome session! Handy! You can also flip a switch in the browser extension and have it track requests happening in your browser through Postman's history.</p>
<h1 id="importingexporting">Importing/Exporting</h1>
<p>Postman has the ability to import curl requests using the "import" button on the top left, but you can also export code for each request in a language of your choice using the "code" button on the right. You can export as Python, HTTP, curl, Go, Java, Node, etc.</p>
<p>That's pretty much it for Postman. Tip your <em><em>servers</em></em>, I'm here all week.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Query a Google Sheets Spreadsheet from BigQuery</title>
      <link href="https://chrispenner.ca/posts/bigquery-sheets"/>
      <id>https://chrispenner.ca/posts/bigquery-sheets</id>
      <updated>2018-06-02T00:00:00Z</updated>
      <summary>A guide to using a google sheets spreadsheet as a BigQuery datasource</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/postman/mail.jpg" alt="Query a Google Sheets Spreadsheet from BigQuery">
              <p>In line with google's goal to have the whole world running inside a google-doc by 2050 they've added a new feature to Big Query which allows you query directly from a Google Spreadsheet! That's right, it reads directly from the sheet so you don't need to worry about keeping your bigquery tables up to date.</p>
<p>First I want to stress that we should AVOID USING GOOGLE SHEETS AS A PRIMARY DATASTORE whenever possible, but sometimes you've just got a bunch of data that you'd like to run some queries on; this was the case for me earlier; and this is a great solution for how to do that.</p>
<h2 id="prepping-the-sheet">Prepping The Sheet</h2>
<p>BQ has a few quirks, it can (currently) ONLY query the FIRST SHEET of a google sheet, and doesn't do any special handling of the header row of your spreadsheet. There's a trick you can do to mitigate this though. Either make a new sheet as the first sheet and read from the 'real' sheet and drop the headers. If your other sheet is named MYDATA then you could use something like <code>=FILTER(MYDATA!A2:A, NOT(ISBLANK(MYDATA!A2:A)))</code> which imports every non-blank row from the MYDATA sheet after dropping the first row.</p>
<p>If you don't want to edit a sheet directly, you can make a new google sheet and use the <a href="https://support.google.com/docs/answer/3093340">IMPORTRANGE</a> command to import the data from a different spreadsheet.</p>
<h2 id="creating-a-dataset">Creating a Dataset</h2>
<p>First step is to create a new bigquery dataset; go to bigquery, select your google cloud project on the left (or create one if you need to); then create a new 'dataset' in that project we'll set up to sync with our spreadsheet.</p>
<p><img src="/images/bigquery-sheets/new_table_screen.png" alt="BQ UI" /></p>
<p>Now we'll see this screen:</p>
<p><img src="/images/bigquery-sheets/new_bq_table.png" alt="Create BQ Table" /></p>
<ol>
<li>Choose 'Google Drive' as your Location</li>
<li>Paste the url of your spreadsheet in the box (just copy it from the url bar when you're at the spreadsheet)</li>
<li>Set File Format to Google Sheets</li>
<li>Add a table name like you normally would</li>
</ol>
<h2 id="schema">Schema</h2>
<p>In regards to adding a schema, BigQuery does NOT infer this for you, so you'll have to add one yourself. Each field of the schema corresponds to a column of the spreadsheet. For small spreadsheets you can enter it by hand, for bigger spreadsheets you can just generate a schema definition by copying the headers row from your spreadsheet and running it through this script: <a href="https://gist.github.com/ChrisPenner/2525b29f49cdb6613175cda8c85cb585">HERE</a>, then click 'Edit as Text' by the schema definiton and paste in the result</p>
<p>Lastly, hit 'Create Table'</p>
<h2 id="querying">Querying</h2>
<p>You're good to go now, query away! Note that you won't have the 'Preview' button like other data tables, this is because no data is actually located in BQ, it streams data from sheets whenever you make a query. This means the data will always be kept up to date!</p>
<h2 id="breaking-changes">Breaking Changes</h2>
<p>BQ queries the spreadsheet directly so the data will always be up to date, but this also means that if someone shuffles around columns that the schema will be out of date with the data. Just note that if the column ordering changes you'll have to update your schema to match.</p>
<p>Hope that helps, cheers!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>ASTs with Fix and Free</title>
      <link href="https://chrispenner.ca/posts/asts-with-fix-and-free"/>
      <id>https://chrispenner.ca/posts/asts-with-fix-and-free</id>
      <updated>2018-02-24T00:00:00Z</updated>
      <summary>Using Fix and Free datatypes to represent compiler ASTs</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/tree.jpg" alt="ASTs with Fix and Free">
              <p>I've been working on a <a href="https://github.com/ChrisPenner/Candor">toy compiler</a> lately so I've been thinking about <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">ASTs</a>! It's a new thing for me and I've gotten a bit obsessed with the idea of simplifying both the representation of the tree itself as well as the code to interpret it.</p>
<p>ASTs are (typically) <strong>recursive</strong> data-types; this means that within the data-type they have an embedded instance of the same type! The simplest version of a recursive tree we can look at is actually a simple list! A list is a recursive (degenerate) tree where every node has 0 or 1 branches. Here's how the definition of a simple List AST might look in Haskell:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">data</span> <span class="dt">List</span> a <span class="ot">=</span> <span class="dt">Cons</span> a (<span class="dt">List</span> a) <span class="op">|</span> <span class="dt">End</span></span></code></pre></div>
<p>Contrary to what your kindergarten teacher taught you, this is one case where it's okay to use the term in its own definition!</p>
<p>A slightly more complex AST for a toy calculator program might look like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">data</span> <span class="dt">Op</span> <span class="ot">=</span> <span class="dt">Add</span> <span class="op">|</span> <span class="dt">Mult</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">data</span> <span class="dt">AST</span> <span class="ot">=</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="dt">BinOp</span> <span class="dt">Op</span> <span class="dt">AST</span> <span class="dt">AST</span> </span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="op">|</span> <span class="dt">Num</span> <span class="dt">Int</span></span></code></pre></div>
<p>In this case we've defined a recursive tree of math operations where you can add or multiply numbers together. Here's how we'd represent this simple math expression <code>(1 + 2) * 3</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="ot">simpleExpr ::</span> <span class="dt">AST</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>simpleExpr <span class="ot">=</span> <span class="dt">BinOp</span> <span class="dt">Mult</span> (<span class="dt">BinOp</span> <span class="dt">Add</span> (<span class="dt">Num</span> <span class="dv">1</span>) (<span class="dt">Num</span> <span class="dv">2</span>)) (<span class="dt">Num</span> <span class="dv">3</span>)</span></code></pre></div>
<p>Maybe not the easiest for a human to read, but it's easy for the computer to figure out! We won't bother writing a parser in this post, instead we'll look at other possible ways we can represent these ASTs with data structures that give us tools to work with them.</p>
<h2 id="recursion-schemes">Recursion Schemes</h2>
<p>Recursion schemes are a pretty complex subject peppered with <a href="https://www.reddit.com/r/programming/comments/6ml1y/a_pretty_useful_haskell_snippet/c04ako5/">zygohistomorphic prepromorphisms</a> and things; but don't fret, we won't go too deep into the topic, instead we'll just touch on how we can use the general recursion folding function <code>cata</code> to interpret generic ASTs in a really clean fashion!</p>
<p>The core notion of the <a href="https://hackage.haskell.org/package/recursion-schemes">recursion-schemes library</a> is to factor out the recursion from data-types so that the library can handle any complicated recursive cases and make it easy for you to express how the recursion should behave.</p>
<p>There's a bit of a catch though, we don't get all that for free, we first need to refactor our data-type to <strong>factor out the recursion</strong>. What's that mean? Well basically we need to make our <strong>concrete</strong> data-type into a <strong>Functor</strong> over its recursive bits. It's easier to understand with a concrete example; let's start with our <code>List</code> example from earlier:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb4-1"><a href="#cb4-1"></a><span class="st">- data List a    = Cons a (List a) | End</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="va">+ data ListF a r = Cons a r        | End</span></span></code></pre></div>
<p>See the difference? We've replaced any of slots where the type <strong>recursed</strong> with a new type parameter <code>r</code> (for <code>*r*ecursion</code>). We've also renamed our new type to <code>ListF</code> as is the convention with recursion schemes. The <code>F</code> stands for <code>Functor</code>, representing that this is the version of our data-type with a Functor over the recursive bits.</p>
<p>How's our AST look if we do the same thing? Let's take a look:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb5-1"><a href="#cb5-1"></a>data Op = Add | Mult</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="st">- data AST =</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">-   BinOp Op AST AST </span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="st">-   | Num Int</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="va">+ data ASTF r =</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="va">+   BinOpF Op r r </span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="va">+   | NumF Int</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    deriving (Show, Functor)</span></code></pre></div>
<p>Pretty similar overall! Let's move on to representing some calculations with our new type!</p>
<h2 id="avoiding-infinity-using-fix">Avoiding Infinity using Fix</h2>
<p>If you're a bit of a keener you may have already tried re-writing our previous math formula using our new AST type, and if so probably ran into a bit of a problem! Let's give it a try together using the same math problem <code>(1 + 2) * 3</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="ot">simpleExpr ::</span> <span class="op">?</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>simpleExpr <span class="ot">=</span> <span class="dt">BinOpF</span> <span class="dt">Mult</span> (<span class="dt">BinOpF</span> <span class="dt">Add</span> (<span class="dt">Num</span> <span class="dv">1</span>) (<span class="dt">Num</span> <span class="dv">2</span>)) (<span class="dt">Num</span> <span class="dv">3</span>)</span></code></pre></div>
<p>We can write the expression out without too much trouble, but what type is it?</p>
<p>The type of the outer layer is <code>ASTF r</code> where <code>_</code> represents the recursive portion of the AST; if we fill it in we get <code>ASTF (ASTF r)</code>, but the <code>r</code> ALSO represents <code>ASTF r</code>; if we try to keep writing this in we end up with: <code>ASTF (ASTF (ASTF (ASTF (ASTF (ASTF ...)))))</code> which repeats ad nauseum.</p>
<p>We really need some way to tell GHC that the type parameter represents infinite recursion! Luckily we have that available to us in the form of the <code>Fix</code> newtype!</p>
<p>We'll start out with the short but confusing definition of <code>Fix</code> lifted straight from the <a href="https://hackage.haskell.org/package/recursion-schemes-5.0.2/docs/Data-Functor-Foldable.html#t:Fix">recursion-schemes</a> library</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">newtype</span> <span class="dt">Fix</span> f <span class="ot">=</span> <span class="dt">Fix</span> (f (<span class="dt">Fix</span> f))</span></code></pre></div>
<p>Short and sweet, but confusing as all hell. What's going on? Well basically we're just 'cheating' the type system by deferring the definition of our type signature into a lazily evaluated recursive type. We do this by inserting a new layer of the <code>Fix</code> data-type in between each layer of recursion, this satisfies the typechecker and saves us from manually writing out an infinite type. There are <a href="https://stackoverflow.com/a/45916939/3907685">better explanations</a> of <code>Fix</code> out there, so if you're really set on understanding it I encourage you to go dig in! That said, we really don't need to fully understand how it works in order to use it here, so we're going to move on to the fun part.</p>
<p>Here's our expression written out using the <code>Fix</code> type, notice how we have a <code>Fix</code> wrapper in between each layer of our recursive type:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="ot">simpleExprFix ::</span> <span class="dt">Fix</span> <span class="dt">ASTF</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>simpleExprFix <span class="ot">=</span> <span class="dt">Fix</span> (<span class="dt">BinOpF</span> <span class="dt">Mult</span> (<span class="dt">Fix</span> (<span class="dt">BinOpF</span> <span class="dt">Add</span> (<span class="dt">Fix</span> (<span class="dt">Num</span> <span class="dv">1</span>)) (<span class="dt">Fix</span> (<span class="dt">Num</span> <span class="dv">2</span>)))) (<span class="dt">Fix</span> (<span class="dt">Num</span> <span class="dv">3</span>)))</span></code></pre></div>
<p>At this point it probably just seems like we've made this whole thing a lot more complicated, but hold in there! Now that we've factored out the recursion and are able to represent our trees using <code>Fix</code> we can finally reap the benefits that <code>recursion-schemes</code> can provide!</p>
<h2 id="using-cata">Using <code>cata</code></h2>
<p>The recursion-schemes library provides combinators and tools for working with recursive datatypes like the <code>ASTF</code> type we've just defined. Usually we need to tell the library about how to convert between our original recursive type (<code>AST</code>) and the version with recursion factored out (<code>ASTF</code>) by implementing a few typeclasses, namely the <code>Recursive</code> type and the <code>Base</code> type family; but as it turns out any <code>Functor</code> wrapped in <code>Fix</code> gets an implementation of these typeclasses for free! That means we can go ahead and use the <code>recursion-schemes</code> tools right away!</p>
<p>There are all sorts of functions in <code>recursion-schemes</code>, but the one we'll be primarily looking at is the <code>cata</code> combinator (short for <code>catamorphism</code>). It's a cryptic name, but basically its a fold function which lets us collapse our recursive data-types down to a single value using simple functions.</p>
<p>Here's how we can use it:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="ot">interpret ::</span> <span class="dt">Fix</span> <span class="dt">ASTF</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>interpret <span class="ot">=</span> cata algebra</span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="kw">where</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="ot">    algebra ::</span> <span class="dt">ASTF</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>    algebra (<span class="dt">Num</span> n) <span class="ot">=</span> n</span>
<span id="cb9-6"><a href="#cb9-6"></a>    algebra (<span class="dt">BinOpF</span> <span class="dt">Add</span> a b) <span class="ot">=</span> a <span class="op">+</span> b</span>
<span id="cb9-7"><a href="#cb9-7"></a>    algebra (<span class="dt">BinOpF</span> <span class="dt">Mult</span> a b) <span class="ot">=</span> a <span class="op">*</span> b</span></code></pre></div>
<p>Okay so what's this magic? Basically <code>cata</code> knows how to traverse through a datatype wrapped in <code>Fix</code> and "unfix" it by running a function on each level of the recursive structure! All we need to do is give it an <code>algebra</code> (a function matching the general type <code>Functor f =&gt; f a -&gt; a</code>).</p>
<p>Notice how we never need to worry about evaluating the subtrees in our AST? <code>cata</code> will automatically dive down to the bottom of the tree and evaluate it from the bottom up, replacing the recursive portions of each level with the <strong>result</strong> of evaluating each subtree. It was a lot of setup to get here, but the simplicity of our algebra makes it worth it!</p>
<h2 id="using-free-in-place-of-fix">Using Free in place of Fix</h2>
<p>Using <code>Fix</code> and <code>recursion-schemes</code> is one way to represent our AST, but there's another that I'd like to dig into: Free Monads!</p>
<p>Free monads are often used to represent DSLs or to represent a set of commands which we plan to interpret or run <strong>later on</strong>. I see a few parallels to an AST in there! While not inherently related to recursion we can pretty easily leverage Free to represent recursion in our AST. I won't be going into much detail about how Free works, so you may want to read up on that first before preceeding if it's new to you.</p>
<p>Let's start by defining a new version of our AST type:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">data</span> <span class="dt">Op</span> <span class="ot">=</span> <span class="dt">Add</span> <span class="op">|</span> <span class="dt">Mult</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>    <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="kw">data</span> <span class="dt">ASTFree</span> a <span class="ot">=</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="dt">BinOpFree</span> <span class="dt">Op</span> a a</span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Functor</span>)</span></code></pre></div>
<p>Notice that in this case we've removed our <code>Num Int</code> branch, that means that the base <code>ASTFree</code> type would recurse forever if we wrapped it in <code>Fix</code>, but as it happens <code>Free</code> provides a termination branch via <code>Pure</code> that we can use as a replacement for <code>Num Int</code> as our Functor's fixed point (i.e. termination point).</p>
<p>Here's our original expression written using Free:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="ot">simpleExprFree ::</span> <span class="dt">Free</span> <span class="dt">ASTFree</span> <span class="dt">Int</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>simpleExprFree <span class="ot">=</span> <span class="dt">Free</span> (<span class="dt">BinOpFree</span> <span class="dt">Mult</span> (<span class="dt">Free</span> (<span class="dt">BinOpFree</span> <span class="dt">Add</span> (<span class="dt">Pure</span> <span class="dv">1</span>) (<span class="dt">Pure</span> <span class="dv">2</span>))) (<span class="dt">Pure</span> <span class="dv">3</span>))</span></code></pre></div>
<p>Notice how in this case we've also extracted the type of our terminal expression (<code>Int</code>) into the outer type rather than embedding it in the <code>AST</code> type. This means we can now easily write expressions over Strings, or Floats or whatever you like, we'll just have to make sure that our interpreter can handle it.</p>
<p>Speaking of the interpreter, we can leverage <code>iter</code> from <code>Control.Monad.Free</code> to fill the role that <code>cata</code> did with our <code>Fix</code> datatype:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="ot">interpFree ::</span> <span class="dt">Free</span> <span class="dt">ASTFree</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>interpFree <span class="ot">=</span> iter alg</span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="kw">where</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>    alg (<span class="dt">BinOpFree</span> <span class="dt">Add</span> a b) <span class="ot">=</span> a <span class="op">+</span> b</span>
<span id="cb12-5"><a href="#cb12-5"></a>    alg (<span class="dt">BinOpFree</span> <span class="dt">Mult</span> a b) <span class="ot">=</span> a <span class="op">*</span> b</span></code></pre></div>
<p>Not so tough! This may be a bit of an abuse of the Free Monad, but it works pretty well! Try it out:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="op">&gt;&gt;&gt;</span> interpFree simpleExprFree</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="dv">9</span></span></code></pre></div>
<p>You can of course employ these techniques with more complex ASTs and transformations!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>MonadIO Considered Harmful</title>
      <link href="https://chrispenner.ca/posts/monadio-considered-harmful"/>
      <id>https://chrispenner.ca/posts/monadio-considered-harmful</id>
      <updated>2017-09-11T00:00:00Z</updated>
      <summary>Avoid using IO or MonadIO directly</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/cables.jpg" alt="MonadIO Considered Harmful">
              <p>Now that we've got the click-bait out of the way (sorry about that) we can have a nice chat! Here's my point: MonadIO, and of course IO, are too general. This isn't news really, it's has been addressed in many ways by many people. Options presented in the past include using Free or Free-er monads (e.g. the <a href="https://leanpub.com/purescript/read#leanpub-auto-the-eff-monad">Eff Monad</a>), and these tend to work pretty well, but they're all-encompassing and intrusive, they can be pretty tough to work into legacy projects; converting all uses of a given effect into a Free monad can be tricky and time consuming (though certainly can be worthwhile!).</p>
<p>What I'm going to talk about here is an alternative which provides most of the benefits with a very low barrier to entry: splitting up IO into granular monad type classes. First a quick recap:</p>
<h2 id="monad-classes"><code>Monad*</code> classes</h2>
<p>I'm going to assume that most readers are at least passively familiar with <a href="http://hackage.haskell.org/package/mtl">mtl</a>; if not then maybe come back to this post later on. <a href="http://hackage.haskell.org/package/mtl">mtl</a> popularized the idea of the <code>Monad*</code> typeclasses e.g. <code>MonadReader</code>, <code>MonadState</code>, and of course <code>MonadIO</code>. This pattern has been adopted by most modern monad-based libraries because it allows abstracting away the concrete monad which is used in a function to allow greater portability and re-usability.</p>
<p>Here's an example of an action written using type signatures using both concrete monad types and abstract monad typeclasses:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">concreteUserIncrement ::</span> <span class="dt">StateT</span> <span class="dt">Int</span> <span class="dt">IO</span> <span class="dt">Int</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>concreteUserIncrement <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  incAmount <span class="ot">&lt;-</span> liftIO <span class="fu">readLn</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  modify (<span class="op">+</span>incAmount)</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="fu">return</span> incAmount</span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="ot">classUserIncrement ::</span> (<span class="dt">MonadState</span> <span class="dt">Int</span> m, <span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> m <span class="dt">Int</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>classUserIncrement <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>  incAmount <span class="ot">&lt;-</span> liftIO <span class="fu">readLn</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>  modify (<span class="op">+</span>incAmount)</span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="fu">return</span> incAmount</span></code></pre></div>
<p>The actions do the same thing, but I'd recommend the class-based approach for a few reasons.</p>
<p>Firstly, it allows us to re-use this function with other monad stacks, for instance later on let's say we realize that we'll need to have access to the options configured for our program in a few spots. To accomodate this we add <code>ReaderT Options</code> to our stack and end up with: <code>ReaderT Options (StateT Int IO)</code>. In the first case we'd need to rewrite all signatures which use the old concrete type and replace them with the new concrete type. We could use a type alias of course, but I'm making a point here, so give me a sec. The class-based signature is already good to go in the new monad since it still unifies with the given requirements!</p>
<p>A second and perhaps more important benefit to class-based signatures is that they make it clear which effects a function plans to use. Let's take a look at another example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="ot">concreteReset ::</span> <span class="dt">ReaderT</span> <span class="dt">Options</span> (<span class="dt">StateT</span> <span class="dt">Int</span> <span class="dt">IO</span>) ()</span>
<span id="cb2-2"><a href="#cb2-2"></a>concreteReset <span class="ot">=</span> put <span class="dv">0</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="ot">classbasedReset ::</span> <span class="dt">MonadState</span> <span class="dt">Int</span> m <span class="ot">=&gt;</span> m ()</span>
<span id="cb2-5"><a href="#cb2-5"></a>classbasedReset <span class="ot">=</span> put <span class="dv">0</span></span></code></pre></div>
<p>Again, both implementations are the same, but what do the types tell us? Well, the class-based approach tells us clearly that <code>classbasedReset</code> intends to (and in fact can only) interact with the Int which we've got stored in <code>StateT</code>. We're not allowed to do IO or check Options in there without adding it to the signature. In the concrete case we're not given any hints. We know which monad the action is intended to be used in; but for all we know the implementation could take advantage of the <code>IO</code> at the base and alter the file-system or do logging, or read from stdIn, who knows?</p>
<p>Okay, so I think I've made my case that <code>Monad*</code> classes improve both code re-usability and code clarity, but if I'm not supposed to use <code>IO</code> or even <code>MonadIO</code> then how am I supposed to get anything done? Good question, glad you asked!</p>
<h2 id="breaking-up-monadio">Breaking up MonadIO</h2>
<p>Having a <code>MonadState Int m</code> in the signature was great because it limited the scope of what the monad could do, allowing us to see the action's intent. <code>MonadIO m</code> is a <code>Monad*</code> class, but what does it tell us? Unfortunately it's so general it tells us pretty much zilch. It says that we need access to IO, but are we printing something? Reading from the filesystem? Writing to a database? Launching nuclear missiles? Who knows!? It's making my head spin! <code>MonadIO</code> is too general, its only method is <code>liftIO</code> which has absolutely zero semantic meaning. Compare this to <code>ask</code> from <code>MonadReader</code> or <code>modify</code> from <code>MonadState</code>. We can tell that these transformers have a clear scope because they have meaningful function names.</p>
<p>Let's bring some semantic meaning into our MonadIO by defining a new, more meaningful class:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">class</span> <span class="dt">MonadFiles</span> m <span class="kw">where</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ot">  readAFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m <span class="dt">String</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="ot">  writeAFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="kw">instance</span> <span class="dt">MonadFiles</span> <span class="dt">IO</span> <span class="kw">where</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>  readAFile <span class="ot">=</span> <span class="fu">readFile</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>  writeAFile <span class="ot">=</span> <span class="fu">writeFile</span></span></code></pre></div>
<p>Now instead of tossing around a <code>MonadIO</code> everywhere we can clearly specify that all we really need is to work with the file system. We've implemented the interface in the IO monad so we can still use it just like we did before.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="ot">getDiary ::</span> <span class="dt">MonadFiles</span> m <span class="ot">=&gt;</span> m <span class="dt">String</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>getDiary <span class="ot">=</span> readAFile <span class="st">&quot;my-diary.txt&quot;</span></span></code></pre></div>
<p>Now no-one can launch those pesky nukes when all I want to do is read my diary! As a bonus this lets us choose a different underlying <code>MonadFiles</code> whenever we like! For instance we probably don't need our tests to be writing files all over our system:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">instance</span> <span class="dt">MonadFiles</span> (<span class="dt">State</span> (<span class="dt">M.Map</span> <span class="dt">String</span> <span class="dt">String</span>)) <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  readAFile fileName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>    files <span class="ot">&lt;-</span> get</span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="kw">let</span> contents <span class="ot">=</span> fromMaybe <span class="st">&quot;&quot;</span> (M.lookup fileName files)</span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="fu">return</span> contents</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a>  writeAFile fileName contents <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    modify (M.insert fileName contents)</span></code></pre></div>
<p>Now we can substitute a <code>State (M.Map String String)</code> for <code>IO</code> in our tests to substitute out the filesystem for a simple Map. Our actions don't care where they run so long as the interface has files can be read and written somewhere!</p>
<p>I'd probably go a bit further and split this up even more granularly, separating reading and writing files.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">class</span> <span class="dt">MonadFileReader</span> m <span class="kw">where</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ot">  readAFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m <span class="dt">String</span></span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="kw">class</span> <span class="dt">MonadFileWriter</span> m <span class="kw">where</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="ot">  writeAFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> m ()</span></code></pre></div>
<p>We can get back our <code>MonadFiles</code> type class pretty easily using the <a href="https://kseo.github.io/posts/2017-01-13-constraint-kinds.html"><code>ConstraintKinds</code></a> GHC extension:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">{-# language ConstraintKinds #-}</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">type</span> <span class="dt">MonadFiles</span> m <span class="ot">=</span> (<span class="dt">MonadFileReader</span> m, <span class="dt">MonadFileWriter</span> m)</span></code></pre></div>
<p>As an aside, feel free to implement an instance of your interfaces for your Free Algebras too!</p>
<p>Anyways, that's pretty much it, the next time you find yourself using IO or MonadIO consider breaking it up into smaller chunks; having a separate <code>MonadDB</code>, <code>MonadFiles</code> and <code>MonadHttp</code>, will improve your code clarity and versatility.</p>
<p>Cheers!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Type Tac Toe: Advanced Type Safety</title>
      <link href="https://chrispenner.ca/posts/type-tac-toe"/>
      <id>https://chrispenner.ca/posts/type-tac-toe</id>
      <updated>2017-08-25T00:00:00Z</updated>
      <summary>Upgrading your type programming game</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/tictactoe.png" alt="Type Tac Toe: Advanced Type Safety">
              <p>Today we'll be looking at type programming in Haskell. Programming in type-land allows us to teach the compiler a few new tricks and to verify additional constraints at compile-time rather than run-time. The canonical example is that you can encode the length of a list as a type so that you can verify that appending an element to a list of <code>n</code> elements yields a list of <code>n + 1</code> elements. If you haven't read about or experimented with an example like that before I'd say to check out <a href="http://www.parsonsmatt.org/2017/04/26/basic_type_level_programming_in_haskell.html">Matt Parson's post on type programming</a> first. We're going to go a step further and we'll actually encode the rules of a game of Tic Tac Toe into types so that we can statically guarantee that nobody cheats! If you're into spoilers you can see the finished code at the <a href="https://github.com/ChrisPenner/Type-Tac-Toe">git repo here</a>.</p>
<p>Type programming is a newly popularized idea, so the tools for it are still a bit rough (in Haskell at least), check out <a href="https://www.idris-lang.org/">Idris</a> if you'd like to see something a bit more polished.</p>
<p>There are some libraries popping up in the Haskell ecosystem which are making the ideas presented here easier to work with, most notably the <a href="http://hackage.haskell.org/package/singletons">singletons</a> library which can generate a lot of the type-level primitives we write here. Check it out if you like, but I find it's a bit confusing for people new to this stuff, so I'll be spelling most things out in long-hand.</p>
<p>Let's get moving!</p>
<p>Here's a representation of the de-facto 3x3 Tic Tac Toe board:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">-- | Either X, O, or Nothing</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">data</span> <span class="dt">PieceT</span> <span class="ot">=</span> <span class="dt">X</span> <span class="op">|</span> <span class="dt">O</span> <span class="op">|</span> <span class="dt">N</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw">data</span> <span class="dt">Trip</span> a <span class="ot">=</span> <span class="dt">Trip</span> a a a</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">newtype</span> <span class="dt">Board</span> a <span class="ot">=</span> <span class="dt">Board</span> (<span class="dt">Trip</span> (<span class="dt">Trip</span> a))</span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="ot">newBoard ::</span> <span class="dt">Board</span> <span class="dt">PieceT</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>newBoard <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> <span class="dt">Trip</span> (<span class="dt">Trip</span> <span class="dt">N</span> <span class="dt">N</span> <span class="dt">N</span>)</span>
<span id="cb1-13"><a href="#cb1-13"></a>                        (<span class="dt">Trip</span> <span class="dt">N</span> <span class="dt">N</span> <span class="dt">N</span>)</span>
<span id="cb1-14"><a href="#cb1-14"></a>                        (<span class="dt">Trip</span> <span class="dt">N</span> <span class="dt">N</span> <span class="dt">N</span>)</span></code></pre></div>
<p>Note that we'll need the <code>{-# language DeriveFunctor #-}</code> pragma for this.</p>
<p>We'll need a way to refer to individual squares in the grid so our player can say where they'd like to move. Let's just use simple <code>(x, y)</code> coordinates. We'll use a custom datatype rather than <code>Int</code> so that we know the coordinates are in bounds.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">data</span> <span class="dt">CoordT</span> <span class="ot">=</span> <span class="dt">A</span> <span class="op">|</span> <span class="dt">B</span> <span class="op">|</span> <span class="dt">C</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span></code></pre></div>
<p>Here's a quick function which lets us change a slot inside a Triple:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">-- | Utility function to alter a value inside a triple</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">-- Can set values using `const x`</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="ot">overTrip ::</span> <span class="dt">CoordT</span> <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">Trip</span> a <span class="ot">-&gt;</span> <span class="dt">Trip</span> a</span>
<span id="cb3-4"><a href="#cb3-4"></a>overTrip <span class="dt">A</span> f (<span class="dt">Trip</span> a b c) <span class="ot">=</span> <span class="dt">Trip</span> (f a) b c</span>
<span id="cb3-5"><a href="#cb3-5"></a>overTrip <span class="dt">B</span> f (<span class="dt">Trip</span> a b c) <span class="ot">=</span> <span class="dt">Trip</span> a (f b) c</span>
<span id="cb3-6"><a href="#cb3-6"></a>overTrip <span class="dt">C</span> f (<span class="dt">Trip</span> a b c) <span class="ot">=</span> <span class="dt">Trip</span> a b (f c)</span></code></pre></div>
<p>And that gives us everything we need to place pieces on the board:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="ot">play ::</span> <span class="dt">PieceT</span> <span class="ot">-&gt;</span> (<span class="dt">CoordT</span>, <span class="dt">CoordT</span>) <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="dt">PieceT</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>play p (x, y) (<span class="dt">Board</span> b) <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> overTrip y (overTrip x (<span class="fu">const</span> p)) b</span></code></pre></div>
<p>Looking good! But wait, there's really no validation going on here! Players could play on the same square over and over again! Or maybe player <code>X</code> just keeps on playing without giving <code>O</code> a turn! We could do error handling at runtime inside the function, but that would mean throwing runtime exceptions (Yikes!), running things inside an error monad, or returning an Either. But those are all boring and involve runtime checks so lets see how types can help do this work at compile-time!</p>
<h2 id="alternating-turns">Alternating Turns</h2>
<p>To start simple and see if there's a way we could make <code>X</code> and <code>O</code> alternate turns! In order to do that we're going to need types which represent <code>X</code> and <code>O</code>!</p>
<p>Here's a first attempt:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">data</span> <span class="dt">X</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">data</span> <span class="dt">O</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">data</span> <span class="dt">N</span></span></code></pre></div>
<p>Now we'd have types for each, but we get a conflict! We have duplicate definitions of <code>X</code>, <code>O</code> and <code>N</code> because of <code>PieceT</code>! Let's introduce our next GHC extension: <code>{-# language DataKinds #-}</code>! DataKinds takes a bit of fiddling with to understand, don't worry if you have a hard time understanding where the boundaries are. I still have to shake my head and think it through most of the time.</p>
<p>DataKinds let's you use constructors from any datatypes (defined with <code>data</code> or <code>newtype</code>) as types! To reference the 'type' version of a data constructor you prefix it with an apostrophe. Since we already defined <code>PieceT</code>, by enabling DataKinds we now have <code>'X</code>, <code>'O</code>, <code>'N</code> in scope at the type level! Technically you can leave off the <code>'</code> if it's clear to the compiler that you're referring to a type, but I like to be explicit about it for readability.</p>
<p>There's one more bonus that DataKinds gives us, it creates a new <code>Kind</code> for each family of constructors. Kinds are kind of like types for types, most Haskell types are of Kind <code>*</code>, and higher order kinds are <code>* -&gt; *</code>, you can check it in ghci:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a>λ<span class="op">&gt;</span> <span class="op">:</span>k <span class="dt">Int</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="dt">Int</span><span class="ot"> ::</span> <span class="op">*</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>λ<span class="op">&gt;</span> <span class="op">:</span>k <span class="dt">Maybe</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="dt">Maybe</span><span class="ot"> ::</span> <span class="op">*</span> <span class="ot">-&gt;</span> <span class="op">*</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>λ<span class="op">&gt;</span> <span class="op">:</span>k <span class="dt">Maybe</span> <span class="dt">Int</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="dt">Maybe</span> <span class="dt">Int</span><span class="ot"> ::</span> <span class="op">*</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>λ<span class="op">&gt;</span> <span class="op">:</span>k <span class="dt">&#39;X</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="dt">&#39;X</span><span class="ot"> ::</span> <span class="dt">PieceT</span></span></code></pre></div>
<p>That last one is interesting! GHC notices that <code>'X</code> isn't quite like other types, but that it was defined as part of the PieceT data group. This means that when we're writing functions on types we can actually specify what Kind of types we want to allow.</p>
<p>The first and easiest thing we could require of our game is that <code>X</code> and <code>O</code> always alternate turns. In order to that we'll need to store who's turn it is as part of the type of our board. Let's edit our <code>Board</code> type to have an additional parameter called <code>t</code> for <code>turn</code>, we don't actually have to have the type in our data-structure though, the compiler will do the check at compile-time so we won't need to store this info at the value level. A type which is used only on the left side of a data definition is called a "Phantom type". They're useful for specifying type constraints.</p>
<p>We'll also edit the signature of <code>newBoard</code> to show that <code>X</code> goes first; we don't need to change the definition at all though!</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">newtype</span> <span class="dt">Board</span> t a <span class="ot">=</span> <span class="dt">Board</span> (<span class="dt">Trip</span> (<span class="dt">Trip</span> a))</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">-- | New empty board</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="ot">newBoard ::</span> <span class="dt">Board</span> <span class="dt">&#39;X</span> <span class="dt">PieceT</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>newBoard <span class="ot">=</span> <span class="co">-- Unchanged</span></span></code></pre></div>
<p>When we do this we'll get a compiler error that GHC was expecting a type, but we gave it something of Kind <code>PieceT</code>. GHC usually expects basic types of kind <code>*</code>, so if we do anything fancy we need to let it know what we're thinking. In this case we can add a type annotation to the <code>Board</code> type:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">-- Add this new pragma at the top:</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ot">{-# language KindSignatures #-}</span></span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="kw">newtype</span> <span class="dt">Board</span> (<span class="ot">t ::</span> <span class="dt">PieceT</span>) a <span class="ot">=</span> <span class="dt">Board</span> (<span class="dt">Trip</span> (<span class="dt">Trip</span> a))</span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span></code></pre></div>
<p>The KindSignatures pragma lets say what 'kind' we want all our types to be. This makes GHC happy, and helps us too by allowing us to specify that the 't' parameter should always be one of our pieces rather than some arbitrary type.</p>
<p>Unfortunately, changing the type of <code>Board</code> has broken our <code>play</code> function. We need to put something in as a 'turn' parameter there too. For now it's easiest to split it up into a <code>playX</code> and <code>playY</code> function which can specify their types more concretely.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="ot">playX ::</span> (<span class="dt">CoordT</span>, <span class="dt">CoordT</span>) <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="dt">&#39;X</span> <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="dt">&#39;O</span> <span class="dt">PieceT</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>playX (x, y) (<span class="dt">Board</span> b) <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> overTrip y (overTrip x (<span class="fu">const</span> <span class="dt">X</span>)) b</span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="ot">playO ::</span> (<span class="dt">CoordT</span>, <span class="dt">CoordT</span>) <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="dt">&#39;O</span> <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="dt">&#39;X</span> <span class="dt">PieceT</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>playO (x, y) (<span class="dt">Board</span> b) <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> overTrip y (overTrip x (<span class="fu">const</span> <span class="dt">O</span>)) b</span></code></pre></div>
<p>Don't worry about the duplication, we'll clean that up later. Now you can only <code>playX</code> on a board when it's X's turn! Huzzah! If you try it the wrong way around GHC will complain:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a>λ<span class="op">&gt;</span> playO (<span class="dt">A</span>, <span class="dt">B</span>) newBoard</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">error</span><span class="op">:</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>    • <span class="dt">Couldn&#39;t</span> match <span class="kw">type</span> ‘<span class="dt">&#39;X</span>’ with ‘<span class="dt">&#39;O</span>’</span>
<span id="cb10-4"><a href="#cb10-4"></a>      <span class="dt">Expected</span> <span class="kw">type</span><span class="op">:</span> <span class="dt">Board</span> <span class="dt">&#39;O</span> <span class="dt">PieceT</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>        <span class="dt">Actual</span> <span class="kw">type</span><span class="op">:</span> <span class="dt">Board</span> <span class="dt">&#39;X</span> <span class="dt">PieceT</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>    • <span class="dt">In</span> the second argument <span class="kw">of</span> ‘playO’, namely ‘newBoard’</span>
<span id="cb10-7"><a href="#cb10-7"></a>      <span class="dt">In</span> the expression<span class="op">:</span> playO (<span class="dt">A</span>, <span class="dt">B</span>) newBoard</span>
<span id="cb10-8"><a href="#cb10-8"></a>      <span class="dt">In</span> an equation for ‘it’<span class="op">:</span> it <span class="ot">=</span> playO (<span class="dt">A</span>, <span class="dt">B</span>) Prog.newBoard</span></code></pre></div>
<p>Pretty cool!</p>
<h2 id="preventing-replays">Preventing Replays</h2>
<p>Now the real fun starts! Let's see if we can ensure that people don't play on a space that's already been played!</p>
<p>A simple <code>X</code> or <code>O</code> in our type isn't going to cut it anymore, let's bulk up our representation of the board state. Let's keep track of each place someone has played! We can do this by writing a type level list of coordinates and piece types:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">-- | Keep a list of each Piece played and its location</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">data</span> <span class="dt">BoardRep</span> <span class="ot">=</span> <span class="dt">Empty</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>              <span class="op">|</span> <span class="dt">Cons</span> <span class="dt">CoordT</span> <span class="dt">CoordT</span> <span class="dt">PieceT</span> <span class="dt">BoardRep</span></span></code></pre></div>
<p>Remember that we're using DataKinds, so now <code>BoardRep</code> is a kind and <code>Empty</code> is a type and so is <code>Cons</code> when it's applied to two Coordinates, a Piece type and another <code>BoardRep</code>. It'll keep recursing until we hit an <code>'Empty</code>.</p>
<p>Now that we have a board representation, let's replace the <code>t</code> in our datatype with the type level representation of the board:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">newtype</span> <span class="dt">Board</span> (<span class="ot">b ::</span> <span class="dt">BoardRep</span>) a <span class="ot">=</span> <span class="dt">Board</span> (<span class="dt">Trip</span> (<span class="dt">Trip</span> a))</span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co">-- New boards are &#39;Empty now</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="ot">newBoard ::</span> <span class="dt">Board</span> <span class="dt">&#39;Empty</span> <span class="dt">PieceT</span></span></code></pre></div>
<p>Now every time we play a piece we'll also represent the change at the type level, in order to do that we need to be able to get the "type" of the coordinates of each move. This is a bit tricky, since the coordinate values themselves are all of the same type <code>CoordT</code> and <em>NOTHING</em> is a member of the <em>types</em> A, B, or C.</p>
<p>This is where we start to introduce some <em>hacks</em> to get things to work. Say hello to GADTs!</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">-- New pragma for the top</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="ot">{-# language GADTs #-}</span></span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co">-- | A proxy type which represents a coordinate</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="kw">data</span> <span class="dt">Coord</span> (<span class="ot">a ::</span> <span class="dt">CoordT</span>) <span class="kw">where</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="dt">A&#39;</span><span class="ot"> ::</span> <span class="dt">Coord</span> <span class="dt">&#39;A</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="dt">B&#39;</span><span class="ot"> ::</span> <span class="dt">Coord</span> <span class="dt">&#39;B</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="dt">C&#39;</span><span class="ot"> ::</span> <span class="dt">Coord</span> <span class="dt">&#39;C</span></span>
<span id="cb13-9"><a href="#cb13-9"></a></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="co">-- | Get the coord&#39;s actual value from a wrapper type</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="ot">coordVal ::</span> <span class="dt">Coord</span> a <span class="ot">-&gt;</span> <span class="dt">CoordT</span></span>
<span id="cb13-12"><a href="#cb13-12"></a>coordVal <span class="dt">A&#39;</span> <span class="ot">=</span> <span class="dt">A</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>coordVal <span class="dt">B&#39;</span> <span class="ot">=</span> <span class="dt">B</span></span>
<span id="cb13-14"><a href="#cb13-14"></a>coordVal <span class="dt">C&#39;</span> <span class="ot">=</span> <span class="dt">C</span></span></code></pre></div>
<p>This is going to look weird and strangely verbose to most of you; it's unfortunate that we need to do things this way, maybe someday we'll find a better way. You can also look into using the <code>Proxy</code> type from <code>Data.Proxy</code>, but it suffers similar verbosity issues.</p>
<p>Let me explain how this works, we've written a new type <code>Coord</code> which has a constructor for each of our Coordinate values, but each constructur also sets the phantom type parameter of the <code>Coord</code> to the appropriate type-level version of the coordinate. We've also written a function <code>coordVal</code> which translates from our wrapper type into the matching <code>CoordT</code> value.</p>
<p>Bleh, a little ugly, but now we can write some well-typed <code>play</code> functions:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a><span class="co">-- View patterns help us clean up our definitions a lot:</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="ot">{-# language ViewPatterns #-}</span></span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="ot">playX ::</span> (<span class="dt">Coord</span> x, <span class="dt">Coord</span> y) <span class="ot">-&gt;</span> <span class="dt">Board</span> b <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> x y <span class="dt">&#39;X</span> b) <span class="dt">PieceT</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>playX (coordVal <span class="ot">-&gt;</span> x, coordVal <span class="ot">-&gt;</span> y) (<span class="dt">Board</span> b) </span>
<span id="cb14-6"><a href="#cb14-6"></a>        <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> overTrip y (overTrip x (<span class="fu">const</span> <span class="dt">X</span>)) b</span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="ot">playO ::</span> (<span class="dt">Coord</span> x, <span class="dt">Coord</span> y) <span class="ot">-&gt;</span> <span class="dt">Board</span> b <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> x y <span class="dt">&#39;O</span> b) <span class="dt">PieceT</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>playO (coordVal <span class="ot">-&gt;</span> x, coordVal <span class="ot">-&gt;</span> y) (<span class="dt">Board</span> b) </span>
<span id="cb14-10"><a href="#cb14-10"></a>        <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> overTrip y (overTrip x (<span class="fu">const</span> <span class="dt">O</span>)) b</span></code></pre></div>
<p>If ViewPatterns are new to you, check out <a href="https://ocharles.org.uk/blog/posts/2014-12-02-view-patterns.html">Oliver Charles' post</a> to learn more.</p>
<p>Now we get both the type level coordinates AND the value level coordinates! Awesome. We're storing the played pieces in the type list now, but we still need to check that it's an unplayed square! We wouldn't be type programming without type functions, let's dive in! In Haskell type functions are called Type Families, but really they're just functions on types:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="co">-- Another pragma &gt;_&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="ot">{-# language TypeFamilies #-}</span></span>
<span id="cb15-3"><a href="#cb15-3"></a></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co">-- | Has a square been played already?</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Played</span> (<span class="ot">x ::</span> <span class="dt">CoordT</span>) (<span class="ot">y ::</span> <span class="dt">CoordT</span>) (<span class="ot">b ::</span> <span class="dt">BoardRep</span>)<span class="ot"> ::</span> <span class="dt">Bool</span> <span class="kw">where</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>   <span class="co">--  Nothing is played on the &#39;Empty board</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="dt">Played</span> _ _ <span class="dt">&#39;Empty</span> <span class="ot">=</span> <span class="dt">&#39;False</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>   <span class="co">--  We found a match, so the square has already been played</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>  <span class="dt">Played</span> x y (<span class="dt">&#39;Cons</span> x y _ _) <span class="ot">=</span> <span class="dt">&#39;True</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>   <span class="co">--  No match yet, but there might be one in the rest of the list</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>  <span class="dt">Played</span> x y (<span class="dt">&#39;Cons</span> _ _ _ rest) <span class="ot">=</span> <span class="dt">Played</span> x y rest</span></code></pre></div>
<p>This is implemented as a linear search through the list looking for a match. If we ever find a matching set of coordinates in the list then we know we've played there already. Notice that type families also return a type, so we specify the Kind of that return value, in this case <code>Bool</code>, so the returned type will be either <code>'True</code> or <code>'False</code>.</p>
<p>Let's use this to write constraints for our play functions:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="ot">playX ::</span> (<span class="dt">Played</span> x y b <span class="op">~</span> <span class="dt">&#39;False</span>) </span>
<span id="cb16-2"><a href="#cb16-2"></a>      <span class="ot">=&gt;</span> (<span class="dt">Coord</span> x, <span class="dt">Coord</span> y) <span class="ot">-&gt;</span> <span class="dt">Board</span> b <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> x y <span class="dt">&#39;X</span> b) <span class="dt">PieceT</span></span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="ot">playO ::</span> (<span class="dt">Played</span> x y b <span class="op">~</span> <span class="dt">&#39;False</span>) </span>
<span id="cb16-5"><a href="#cb16-5"></a>      <span class="ot">=&gt;</span> (<span class="dt">Coord</span> x, <span class="dt">Coord</span> y) <span class="ot">-&gt;</span> <span class="dt">Board</span> b <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> x y <span class="dt">&#39;O</span> b) <span class="dt">PieceT</span></span></code></pre></div>
<p>Now we're asserting that in order to call this function the board must not have played on those coordinates yet! If you haven't seen it before, <code>~</code> does an equality check on two types and creates a constraint which requires them to be equal.</p>
<p>We're close to done, but unfortunately in our upgrade we forgot to ensure that <code>X</code> and <code>O</code> always alternate!</p>
<h2 id="rechecking-alterating-turns">Rechecking Alterating Turns</h2>
<p>Checking whose turn it is with our new representation is easier than you might think; if the last play was <code>X</code> then it's <code>O</code>s turn, and in all other cases it's <code>X</code>s turn!</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Turn</span> (<span class="ot">b ::</span> <span class="dt">BoardRep</span>)<span class="ot"> ::</span> <span class="dt">PieceT</span> <span class="kw">where</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="dt">Turn</span> (<span class="dt">&#39;Cons</span> _ _ <span class="dt">&#39;X</span> _) <span class="ot">=</span> <span class="dt">&#39;O</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="dt">Turn</span> _ <span class="ot">=</span> <span class="dt">&#39;X</span></span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="ot">playX ::</span> (<span class="dt">Played</span> x y b <span class="op">~</span> <span class="dt">&#39;False</span>, <span class="dt">Turn</span> b <span class="op">~</span> <span class="dt">&#39;X</span>) <span class="ot">=&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6"></a>         (<span class="dt">Coord</span> x, <span class="dt">Coord</span> y) <span class="ot">-&gt;</span> <span class="dt">Board</span> b <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> x y <span class="dt">&#39;X</span> b) <span class="dt">PieceT</span></span>
<span id="cb17-7"><a href="#cb17-7"></a></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="ot">playO ::</span> (<span class="dt">Played</span> x y b <span class="op">~</span> <span class="dt">&#39;False</span>, <span class="dt">Turn</span> b <span class="op">~</span> <span class="dt">&#39;O</span>) <span class="ot">=&gt;</span> </span>
<span id="cb17-9"><a href="#cb17-9"></a>         (<span class="dt">Coord</span> x, <span class="dt">Coord</span> y) <span class="ot">-&gt;</span> <span class="dt">Board</span> b <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> x y <span class="dt">&#39;O</span> b) <span class="dt">PieceT</span></span></code></pre></div>
<p>We also altered the constraints of playX and playO to reflect the requirement!</p>
<p>We're in good shape now! We can play a game!</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a>λ<span class="op">&gt;</span> <span class="kw">import</span> <span class="dt">Data.Function</span> ((&amp;))</span>
<span id="cb18-2"><a href="#cb18-2"></a>λ<span class="op">&gt;</span> newBoard</span>
<span id="cb18-3"><a href="#cb18-3"></a>    <span class="op">&amp;</span> playX (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>)</span>
<span id="cb18-4"><a href="#cb18-4"></a>    <span class="op">&amp;</span> playO (<span class="dt">C&#39;</span>, <span class="dt">C&#39;</span>)</span>
<span id="cb18-5"><a href="#cb18-5"></a>    <span class="op">&amp;</span> playX (<span class="dt">A&#39;</span>, <span class="dt">A&#39;</span>)</span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="dt">Board</span> (<span class="dt">Trip</span> (<span class="dt">Trip</span> <span class="dt">X</span> <span class="dt">N</span> <span class="dt">N</span>) (<span class="dt">Trip</span> <span class="dt">X</span> <span class="dt">N</span> <span class="dt">N</span>) (<span class="dt">Trip</span> <span class="dt">N</span> <span class="dt">N</span> <span class="dt">O</span>))</span>
<span id="cb18-7"><a href="#cb18-7"></a></span>
<span id="cb18-8"><a href="#cb18-8"></a>λ<span class="op">&gt;</span> newBoard</span>
<span id="cb18-9"><a href="#cb18-9"></a>    <span class="op">&amp;</span> playX (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>)</span>
<span id="cb18-10"><a href="#cb18-10"></a>    <span class="op">&amp;</span> playX (<span class="dt">C&#39;</span>, <span class="dt">C&#39;</span>)</span>
<span id="cb18-11"><a href="#cb18-11"></a></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="fu">error</span><span class="op">:</span></span>
<span id="cb18-13"><a href="#cb18-13"></a>    • <span class="dt">Couldn&#39;t</span> match <span class="kw">type</span> ‘<span class="dt">&#39;O</span>’ with ‘<span class="dt">&#39;X</span>’ arising from a use <span class="kw">of</span> ‘playX’</span>
<span id="cb18-14"><a href="#cb18-14"></a>    • <span class="dt">In</span> the second argument <span class="kw">of</span> ‘(<span class="op">&amp;</span>)’, namely ‘playX (<span class="dt">C&#39;</span>, <span class="dt">C&#39;</span>)’</span>
<span id="cb18-15"><a href="#cb18-15"></a>      <span class="dt">In</span> the expression<span class="op">:</span> newBoard <span class="op">&amp;</span> playX (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>) <span class="op">&amp;</span> playX (<span class="dt">C&#39;</span>, <span class="dt">C&#39;</span>)</span>
<span id="cb18-16"><a href="#cb18-16"></a></span>
<span id="cb18-17"><a href="#cb18-17"></a>λ<span class="op">&gt;</span> newBoard</span>
<span id="cb18-18"><a href="#cb18-18"></a>    <span class="op">&amp;</span> playX (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>)</span>
<span id="cb18-19"><a href="#cb18-19"></a>    <span class="op">&amp;</span> playO (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>)</span>
<span id="cb18-20"><a href="#cb18-20"></a></span>
<span id="cb18-21"><a href="#cb18-21"></a><span class="fu">error</span><span class="op">:</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>    • <span class="dt">Couldn&#39;t</span> match <span class="kw">type</span> ‘<span class="dt">&#39;True</span>’ with ‘<span class="dt">&#39;False</span>’</span>
<span id="cb18-23"><a href="#cb18-23"></a>        arising from a use <span class="kw">of</span> ‘playO’</span>
<span id="cb18-24"><a href="#cb18-24"></a>    • <span class="dt">In</span> the second argument <span class="kw">of</span> ‘(<span class="op">&amp;</span>)’, namely ‘playO (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>)’</span>
<span id="cb18-25"><a href="#cb18-25"></a>      <span class="dt">In</span> the expression<span class="op">:</span> newBoard <span class="op">&amp;</span> playX (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>) <span class="op">&amp;</span> playO (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>)</span></code></pre></div>
<p>Looks good to me! As an exercise try combining <code>playX</code> and <code>playO</code> into a more general <code>play</code>! Here's a hint, you'll want to make another wrapper type like we did with <code>Coord</code>!</p>
<p>Here's the finished product all at once, it's also available as a stack project in a <a href="https://github.com/ChrisPenner/Type-Tac-Toe">git repo here</a>.:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1"></a><span class="ot">{-# language DeriveFunctor #-}</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="ot">{-# language KindSignatures #-}</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="ot">{-# language DataKinds #-}</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="ot">{-# language ViewPatterns #-}</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="ot">{-# language GADTs #-}</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="ot">{-# language TypeFamilies #-}</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="kw">module</span> <span class="dt">TypeTacToe</span> <span class="kw">where</span></span>
<span id="cb19-8"><a href="#cb19-8"></a></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="kw">import</span> <span class="dt">Data.Function</span> ((&amp;))</span>
<span id="cb19-10"><a href="#cb19-10"></a></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="co">-- | Either X, O, or Nothing</span></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="kw">data</span> <span class="dt">PieceT</span> <span class="ot">=</span> <span class="dt">X</span> <span class="op">|</span> <span class="dt">O</span> <span class="op">|</span> <span class="dt">N</span></span>
<span id="cb19-13"><a href="#cb19-13"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb19-14"><a href="#cb19-14"></a></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="kw">data</span> <span class="dt">CoordT</span> <span class="ot">=</span> <span class="dt">A</span> <span class="op">|</span> <span class="dt">B</span> <span class="op">|</span> <span class="dt">C</span></span>
<span id="cb19-16"><a href="#cb19-16"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb19-17"><a href="#cb19-17"></a></span>
<span id="cb19-18"><a href="#cb19-18"></a><span class="co">-- | A proxy type which represents a coordinate</span></span>
<span id="cb19-19"><a href="#cb19-19"></a><span class="kw">data</span> <span class="dt">Coord</span> (<span class="ot">a ::</span> <span class="dt">CoordT</span>) <span class="kw">where</span></span>
<span id="cb19-20"><a href="#cb19-20"></a>  <span class="dt">A&#39;</span><span class="ot"> ::</span> <span class="dt">Coord</span> <span class="dt">&#39;A</span></span>
<span id="cb19-21"><a href="#cb19-21"></a>  <span class="dt">B&#39;</span><span class="ot"> ::</span> <span class="dt">Coord</span> <span class="dt">&#39;B</span></span>
<span id="cb19-22"><a href="#cb19-22"></a>  <span class="dt">C&#39;</span><span class="ot"> ::</span> <span class="dt">Coord</span> <span class="dt">&#39;C</span></span>
<span id="cb19-23"><a href="#cb19-23"></a></span>
<span id="cb19-24"><a href="#cb19-24"></a><span class="co">-- | Get the coord&#39;s actual value from a wrapper type</span></span>
<span id="cb19-25"><a href="#cb19-25"></a><span class="ot">coordVal ::</span> <span class="dt">Coord</span> a <span class="ot">-&gt;</span> <span class="dt">CoordT</span></span>
<span id="cb19-26"><a href="#cb19-26"></a>coordVal <span class="dt">A&#39;</span> <span class="ot">=</span> <span class="dt">A</span></span>
<span id="cb19-27"><a href="#cb19-27"></a>coordVal <span class="dt">B&#39;</span> <span class="ot">=</span> <span class="dt">B</span></span>
<span id="cb19-28"><a href="#cb19-28"></a>coordVal <span class="dt">C&#39;</span> <span class="ot">=</span> <span class="dt">C</span></span>
<span id="cb19-29"><a href="#cb19-29"></a></span>
<span id="cb19-30"><a href="#cb19-30"></a><span class="kw">data</span> <span class="dt">Trip</span> a <span class="ot">=</span> <span class="dt">Trip</span> a a a</span>
<span id="cb19-31"><a href="#cb19-31"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb19-32"><a href="#cb19-32"></a></span>
<span id="cb19-33"><a href="#cb19-33"></a><span class="co">-- | Utility function to alter a value inside a triple</span></span>
<span id="cb19-34"><a href="#cb19-34"></a><span class="co">-- Can build get / set using `flip const ()` and `const x` respectively</span></span>
<span id="cb19-35"><a href="#cb19-35"></a><span class="ot">overTrip ::</span> <span class="dt">CoordT</span> <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">Trip</span> a <span class="ot">-&gt;</span> <span class="dt">Trip</span> a</span>
<span id="cb19-36"><a href="#cb19-36"></a>overTrip <span class="dt">A</span> f (<span class="dt">Trip</span> a b c) <span class="ot">=</span> <span class="dt">Trip</span> (f a) b c</span>
<span id="cb19-37"><a href="#cb19-37"></a>overTrip <span class="dt">B</span> f (<span class="dt">Trip</span> a b c) <span class="ot">=</span> <span class="dt">Trip</span> a (f b) c</span>
<span id="cb19-38"><a href="#cb19-38"></a>overTrip <span class="dt">C</span> f (<span class="dt">Trip</span> a b c) <span class="ot">=</span> <span class="dt">Trip</span> a b (f c)</span>
<span id="cb19-39"><a href="#cb19-39"></a></span>
<span id="cb19-40"><a href="#cb19-40"></a><span class="co">-- | Keep a list of each Piece played and its location</span></span>
<span id="cb19-41"><a href="#cb19-41"></a><span class="kw">data</span> <span class="dt">BoardRep</span> <span class="ot">=</span> <span class="dt">Empty</span></span>
<span id="cb19-42"><a href="#cb19-42"></a>              <span class="op">|</span> <span class="dt">Cons</span> <span class="dt">CoordT</span> <span class="dt">CoordT</span> <span class="dt">PieceT</span> <span class="dt">BoardRep</span></span>
<span id="cb19-43"><a href="#cb19-43"></a></span>
<span id="cb19-44"><a href="#cb19-44"></a></span>
<span id="cb19-45"><a href="#cb19-45"></a><span class="co">-- A board is a 3x3 grid alongside its type representation</span></span>
<span id="cb19-46"><a href="#cb19-46"></a><span class="kw">newtype</span> <span class="dt">Board</span> (<span class="ot">b ::</span> <span class="dt">BoardRep</span>) a <span class="ot">=</span> <span class="dt">Board</span> (<span class="dt">Trip</span> (<span class="dt">Trip</span> a))</span>
<span id="cb19-47"><a href="#cb19-47"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb19-48"><a href="#cb19-48"></a></span>
<span id="cb19-49"><a href="#cb19-49"></a><span class="co">-- | New empty board</span></span>
<span id="cb19-50"><a href="#cb19-50"></a><span class="ot">newBoard ::</span> <span class="dt">Board</span> <span class="dt">&#39;Empty</span> <span class="dt">PieceT</span></span>
<span id="cb19-51"><a href="#cb19-51"></a>newBoard <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> <span class="dt">Trip</span> (<span class="dt">Trip</span> <span class="dt">N</span> <span class="dt">N</span> <span class="dt">N</span>)</span>
<span id="cb19-52"><a href="#cb19-52"></a>                        (<span class="dt">Trip</span> <span class="dt">N</span> <span class="dt">N</span> <span class="dt">N</span>)</span>
<span id="cb19-53"><a href="#cb19-53"></a>                        (<span class="dt">Trip</span> <span class="dt">N</span> <span class="dt">N</span> <span class="dt">N</span>)</span>
<span id="cb19-54"><a href="#cb19-54"></a></span>
<span id="cb19-55"><a href="#cb19-55"></a><span class="co">-- | Has a square been played already?</span></span>
<span id="cb19-56"><a href="#cb19-56"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Played</span> (<span class="ot">x ::</span> <span class="dt">CoordT</span>) (<span class="ot">y ::</span> <span class="dt">CoordT</span>) (<span class="ot">b ::</span> <span class="dt">BoardRep</span>)<span class="ot"> ::</span> <span class="dt">Bool</span> <span class="kw">where</span></span>
<span id="cb19-57"><a href="#cb19-57"></a>  <span class="dt">Played</span> _ _ <span class="dt">&#39;Empty</span> <span class="ot">=</span> <span class="dt">&#39;False</span></span>
<span id="cb19-58"><a href="#cb19-58"></a>  <span class="dt">Played</span> x y (<span class="dt">&#39;Cons</span> x y _ _) <span class="ot">=</span> <span class="dt">&#39;True</span></span>
<span id="cb19-59"><a href="#cb19-59"></a>  <span class="dt">Played</span> x y (<span class="dt">&#39;Cons</span> _ _ _ rest) <span class="ot">=</span> <span class="dt">Played</span> x y rest</span>
<span id="cb19-60"><a href="#cb19-60"></a></span>
<span id="cb19-61"><a href="#cb19-61"></a></span>
<span id="cb19-62"><a href="#cb19-62"></a><span class="co">-- | Get who&#39;s turn it is</span></span>
<span id="cb19-63"><a href="#cb19-63"></a><span class="kw">type</span> <span class="kw">family</span> <span class="dt">Turn</span> (<span class="ot">b ::</span> <span class="dt">BoardRep</span>)<span class="ot"> ::</span> <span class="dt">PieceT</span> <span class="kw">where</span></span>
<span id="cb19-64"><a href="#cb19-64"></a>  <span class="dt">Turn</span> (<span class="dt">&#39;Cons</span> _ _ <span class="dt">&#39;X</span> _) <span class="ot">=</span> <span class="dt">&#39;O</span></span>
<span id="cb19-65"><a href="#cb19-65"></a>  <span class="dt">Turn</span> _ <span class="ot">=</span> <span class="dt">&#39;X</span></span>
<span id="cb19-66"><a href="#cb19-66"></a></span>
<span id="cb19-67"><a href="#cb19-67"></a><span class="co">-- | Play a piece on square (x, y) if it&#39;s valid to do so</span></span>
<span id="cb19-68"><a href="#cb19-68"></a><span class="ot">playX ::</span> (<span class="dt">Played</span> x y b <span class="op">~</span> <span class="dt">&#39;False</span>, <span class="dt">Turn</span> b <span class="op">~</span> <span class="dt">&#39;X</span>)</span>
<span id="cb19-69"><a href="#cb19-69"></a>      <span class="ot">=&gt;</span> (<span class="dt">Coord</span> x, <span class="dt">Coord</span> y) <span class="ot">-&gt;</span> <span class="dt">Board</span> b <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> x y <span class="dt">&#39;X</span> b) <span class="dt">PieceT</span></span>
<span id="cb19-70"><a href="#cb19-70"></a>playX (coordVal <span class="ot">-&gt;</span> x, coordVal <span class="ot">-&gt;</span> y) (<span class="dt">Board</span> b) </span>
<span id="cb19-71"><a href="#cb19-71"></a>      <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> overTrip y (overTrip x (<span class="fu">const</span> <span class="dt">X</span>)) b</span>
<span id="cb19-72"><a href="#cb19-72"></a></span>
<span id="cb19-73"><a href="#cb19-73"></a><span class="ot">playO ::</span> (<span class="dt">Played</span> x y b <span class="op">~</span> <span class="dt">&#39;False</span>, <span class="dt">Turn</span> b <span class="op">~</span> <span class="dt">&#39;O</span>)</span>
<span id="cb19-74"><a href="#cb19-74"></a>      <span class="ot">=&gt;</span> (<span class="dt">Coord</span> x, <span class="dt">Coord</span> y) <span class="ot">-&gt;</span> <span class="dt">Board</span> b <span class="dt">PieceT</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> x y <span class="dt">&#39;O</span> b) <span class="dt">PieceT</span></span>
<span id="cb19-75"><a href="#cb19-75"></a>playO (coordVal <span class="ot">-&gt;</span> x, coordVal <span class="ot">-&gt;</span> y) (<span class="dt">Board</span> b) </span>
<span id="cb19-76"><a href="#cb19-76"></a>      <span class="ot">=</span> <span class="dt">Board</span> <span class="op">$</span> overTrip y (overTrip x (<span class="fu">const</span> <span class="dt">O</span>)) b</span>
<span id="cb19-77"><a href="#cb19-77"></a></span>
<span id="cb19-78"><a href="#cb19-78"></a><span class="ot">game ::</span> <span class="dt">Board</span> (<span class="dt">&#39;Cons</span> <span class="dt">&#39;A</span> <span class="dt">&#39;A</span> <span class="dt">&#39;O</span> (<span class="dt">&#39;Cons</span> <span class="dt">&#39;A</span> <span class="dt">&#39;B</span> <span class="dt">&#39;X</span> <span class="dt">&#39;Empty</span>)) <span class="dt">PieceT</span></span>
<span id="cb19-79"><a href="#cb19-79"></a>game <span class="ot">=</span> newBoard</span>
<span id="cb19-80"><a href="#cb19-80"></a>     <span class="op">&amp;</span> playX (<span class="dt">A&#39;</span>, <span class="dt">B&#39;</span>)</span>
<span id="cb19-81"><a href="#cb19-81"></a>     <span class="op">&amp;</span> playO (<span class="dt">A&#39;</span>, <span class="dt">A&#39;</span>)</span></code></pre></div>
<p>That last type there is a doozy! The type actually includes the entire game board, and it'll only grow as we add moves! This exposes some issues with using this approach for a real-life tic-tac-toe game. Not only are the types unwieldy if you ever need to specify them, but the type is actually so well defined that we can't really write a function to use user input!</p>
<p>Give it a try if you don't believe me, we'd want something along the lines of:</p>
<pre><code>String -&gt; Board b PieceT -&gt; Board ? PieceT</code></pre>
<p>We'd parse the string into the coords for a move. It's really tough to decide what would go into the <code>?</code> though, we can't give it a type because we don't know what the Coords will be until after we've already parsed the string! This is the sort of thing that's sometimes possible in Idris' dependent types, but is pretty tricky in Haskell. You can see Brian McKenna show how to build a <a href="https://www.youtube.com/watch?v=fVBck2Zngjo">type-safe <code>printf</code></a> in Idris if you're interested.</p>
<p>Thanks for joining me, let me know if you found anything confusing; hope you learned something!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Conway&#39;s Game of Life using Representable and Comonads</title>
      <link href="https://chrispenner.ca/posts/conways-game-of-life"/>
      <id>https://chrispenner.ca/posts/conways-game-of-life</id>
      <updated>2017-08-08T00:00:00Z</updated>
      <summary>Quick ~100 line implementation of Conway&#39;s game of life in Haskell</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/conway.png" alt="Conway&#39;s Game of Life using Representable and Comonads">
              <p>Just a quick post today, I had some time free this weekend and figured I'd take a crack at an old classic: "<a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Conway's Game of Life</a>".</p>
<p>This is an interesting puzzle because it centers around context-based computations, each cell determines whether it lives or dies in the next generation based on its nearby neighbours. This is typically considered one of the trickier things to do in a functional language and solutions often end up being a bit clunky at best. I think clunkiness usually results when attempting to port a solution from an imperative language over to a functional language. To do so you need to figure out some way to iterate over your grid in 2 dimensions at once doing complicated indexing to compute your neighbours and attempting to store your results somewhere as you go. It definitely can be done, you can fake loops using folds and traversable, but I feel like there are better approaches. Allow me to present my take on it.</p>
<p>If you like to load up code and follow along you can find the source <a href="https://github.com/ChrisPenner/conway">here</a>!</p>
<p>We'll be using some pretty standard language extensions, and we'll be using Representable and Comonads, so let's import a few things to get started:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">{-# language GeneralizedNewtypeDeriving #-}</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ot">{-# language TypeFamilies #-}</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">module</span> <span class="dt">Conway</span> <span class="kw">where</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw">import</span> <span class="dt">Data.Functor.Compose</span> (<span class="dt">Compose</span>(..))</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Vector</span> <span class="kw">as</span> <span class="dt">V</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw">import</span> <span class="dt">Data.Bool</span> (bool)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">import</span> <span class="dt">Data.Distributive</span> (<span class="dt">Distributive</span>(..))</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">import</span> <span class="dt">Data.Functor.Rep</span> (<span class="dt">Representable</span>(..), distributeRep)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw">import</span> <span class="dt">Data.Functor.Identity</span> (<span class="dt">Identity</span>(..))</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="kw">import</span> <span class="dt">Control.Arrow</span> ((***))</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="kw">import</span> <span class="dt">Control.Comonad.Representable.Store</span> (<span class="dt">Store</span>(..), <span class="dt">StoreT</span>(..), store, experiment)</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="kw">import</span> <span class="dt">Control.Comonad</span> (<span class="dt">Comonad</span>(..))</span></code></pre></div>
<p>Conway's game of life runs on a grid, so we'll need to think up some way to represent that. We'll need to be able to index into that grid and be able to compute neighbours of a given location, so we can let that guide our representation.</p>
<p>I've often seen people try to represent grids in Haskell as List Zippers generalized to higher dimensions, i.e. if we have a structure like <code>data Zipper a = Zipper [a] a [a]</code>, you might try representing a grid as <code>Zipper (Zipper a)</code>.</p>
<p>While this is a totally valid representation, indexing into it and defining comonad's <code>extend</code> becomes prohibitively difficult to reason about. I propose we try something a little different by extracting the 'index' from the data structure and holding them together side by side. We'll represent our grid as a Vector of Vectors just as you'd expect, but then we'll pair that with a set of <code>(x, y)</code> coordinates and set up some indexing logic to take care of our Comonad instance for us!</p>
<p>If your Category Theory senses are tingling you may recognize this as the <a href="http://hackage.haskell.org/package/comonad-5.0.2/docs/Control-Comonad-Store.html">Store Comonad</a>. <code>Store</code> is typically represented as a tuple of <code>(s -&gt; a, s)</code>. This means that you have some index type <code>s</code> and you know how to look up an <code>a</code> from it. We can model our grid as <code>(Vector (Vector a), (Int, Int))</code> then our <code>s -&gt; a</code> is simply a partially applied Vector lookup! I tried setting this up, but the default Store comonad does no optimization or memoization over the underling function so for each progressive step in Conway's game of life it had to compute all previous steps again! That's clearly pretty inefficient, we can do better!</p>
<p>Enter <code>Control.Comonad.Representable.Store</code>! As we just noticed, a Store is just an indexing function alongside an index, since Representable Functors are indexable by nature, they make a great companion for the Store comonad. Now instead of partially applying our index function we can actually just keep the Representable functor around and do operations over that, so the Store is going to look something like this: <code>(Vector (Vector a), (Int, Int))</code>.</p>
<p>Unfortunately there isn't a Representable instance defined for Vectors (since they can vary in size), so we'll need to take care of that first. For simplicity we'll deal with a fixed grid-size of <code>20x20</code>, meaning we can enforce that each vector is of exactly length 20 which lets us write a representable instance for it!. We'll wrap the Vectors in a <code>VBounded</code> newtype to keep things straight:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">newtype</span> <span class="dt">VBounded</span> a <span class="ot">=</span> <span class="dt">VBounded</span> (<span class="dt">V.Vector</span> a)</span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>, <span class="dt">Functor</span>, <span class="dt">Foldable</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">instance</span> <span class="dt">Distributive</span> <span class="dt">VBounded</span> <span class="kw">where</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>  distribute <span class="ot">=</span> distributeRep</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="ot">gridSize ::</span> <span class="dt">Int</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>gridSize <span class="ot">=</span> <span class="dv">20</span></span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="kw">instance</span> <span class="dt">Representable</span> <span class="dt">VBounded</span> <span class="kw">where</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="kw">type</span> <span class="dt">Rep</span> <span class="dt">VBounded</span> <span class="ot">=</span> <span class="dt">Int</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="fu">index</span> (<span class="dt">VBounded</span> v) i <span class="ot">=</span> v <span class="op">V.!</span> (i <span class="ot">`mod`</span> gridSize)</span>
<span id="cb2-13"><a href="#cb2-13"></a>  tabulate desc <span class="ot">=</span> <span class="dt">VBounded</span> <span class="op">$</span> V.generate gridSize desc</span></code></pre></div>
<p>There's the heavy lifting done! Notice that in the Representable instance for VBounded we're doing pac-man 'wrap-around' logic by taking the modulus of indices by grid size before indexing.</p>
<p>Now let's wrap it up in a Store, we're using <code>store</code> provided by <code>Control.ComonadRepresentable.Store</code> takes a tabulation function and a starting index and builds up a representable instace for us. For our starting position we'll take a list of coordinates which are 'alive'. That means that our tabulation function can just compute whether the index it's passed is part of the 'living' list!</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">type</span> <span class="dt">Grid</span> a <span class="ot">=</span> <span class="dt">Store</span> (<span class="dt">Compose</span> <span class="dt">VBounded</span> <span class="dt">VBounded</span>) a</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">type</span> <span class="dt">Coord</span> <span class="ot">=</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="ot">mkGrid ::</span> [<span class="dt">Coord</span>] <span class="ot">-&gt;</span> <span class="dt">Grid</span> <span class="dt">Bool</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>mkGrid xs <span class="ot">=</span> store <span class="fu">lookup</span> (<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="kw">where</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="fu">lookup</span> crd <span class="ot">=</span> crd <span class="ot">`elem`</span> xs</span></code></pre></div>
<p>Now for the meat and potatoes, we need to compute the successive iterations of the grid over time. We may want to switch the set of life rules later, so let's make it generic. We need to know the neighbours of each cell in order to know how it will change, which means we need to somehow get each cell, find its neighbours, compute its liveness, then slot that into the grid as the next iteration. That sounds like a lot of work! If we think about it though, contextual computations are a comonad's specialty! Our Representable Store is a comonad, which means it implements <code>extend :: (Grid a -&gt; b) -&gt; Grid a -&gt; Grid b</code>. Each Grid passed to the function is focused on one of the slots in the grid, and whatever the function returns will be put into that slot! This makes it pretty easy to write our rule!</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">type</span> <span class="dt">Rule</span> <span class="ot">=</span> <span class="dt">Grid</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">-- Offsets for the neighbouring 8 tiles, avoiding (0, 0) which is the cell itself</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ot">neighbourCoords ::</span> [(<span class="dt">Int</span>, <span class="dt">Int</span>)]</span>
<span id="cb4-5"><a href="#cb4-5"></a>neighbourCoords <span class="ot">=</span> [(x, y) <span class="op">|</span> x <span class="ot">&lt;-</span> [<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>], y <span class="ot">&lt;-</span> [<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>], (x, y) <span class="op">/=</span> (<span class="dv">0</span>, <span class="dv">0</span>)]</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="ot">basicRule ::</span> <span class="dt">Rule</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>basicRule g <span class="ot">=</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>  (alive <span class="op">&amp;&amp;</span> numNeighboursAlive <span class="ot">`elem`</span> [<span class="dv">2</span>, <span class="dv">3</span>]) <span class="op">||</span> (<span class="fu">not</span> alive <span class="op">&amp;&amp;</span> numNeighboursAlive <span class="op">==</span> <span class="dv">3</span>)</span>
<span id="cb4-10"><a href="#cb4-10"></a>  <span class="kw">where</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    alive <span class="ot">=</span> extract g</span>
<span id="cb4-12"><a href="#cb4-12"></a>    addCoords (x, y) (x&#39;, y&#39;) <span class="ot">=</span> (x <span class="op">+</span> x&#39;, y <span class="op">+</span> y&#39;)</span>
<span id="cb4-13"><a href="#cb4-13"></a>    neighbours <span class="ot">=</span> experiment (\s <span class="ot">-&gt;</span> addCoords s <span class="op">&lt;$&gt;</span> neighbourCoords) g</span>
<span id="cb4-14"><a href="#cb4-14"></a>    numNeighboursAlive <span class="ot">=</span> <span class="fu">length</span> (<span class="fu">filter</span> <span class="fu">id</span> neighbours)</span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="ot">step ::</span> <span class="dt">Rule</span> <span class="ot">-&gt;</span> <span class="dt">Grid</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Grid</span> <span class="dt">Bool</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>step <span class="ot">=</span> extend</span></code></pre></div>
<p>Two things here, we've defined <code>step = extend</code> which we can partially apply with a rule for our game, turning it into just <code>Grid Bool -&gt; Grid Bool</code> which is perfect for iterating through cycles! The other interesting thing is the use of <code>experiment</code> which is provided by the <code>ComonadStore</code> typeclass. Here's the generalized signature alongside our specialized version:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="ot">experiment ::</span> (<span class="dt">Functor</span> f, <span class="dt">ComonadStore</span> s w) <span class="ot">=&gt;</span> (s <span class="ot">-&gt;</span> f s) <span class="ot">-&gt;</span> w a <span class="ot">-&gt;</span> f a</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="ot">experiment ::</span> (<span class="dt">Coord</span> <span class="ot">-&gt;</span> [<span class="dt">Coord</span>]) <span class="ot">-&gt;</span> <span class="dt">Grid</span> a <span class="ot">-&gt;</span> [a]</span></code></pre></div>
<p>Experiment uses a function which turns an index into a functor of indexes, then runs it on the index in a store and extracts a value for each index using fmap to replace each index with its value from the store! A bit confusing perhaps, but it fits our use case perfectly!</p>
<p>Now we need a way to render our board to text!</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="ot">render ::</span> <span class="dt">Grid</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>render (<span class="dt">StoreT</span> (<span class="dt">Identity</span> (<span class="dt">Compose</span> g)) _) <span class="ot">=</span> <span class="fu">foldMap</span> ((<span class="op">++</span> <span class="st">&quot;\n&quot;</span>) <span class="op">.</span> <span class="fu">foldMap</span> (bool <span class="st">&quot;.&quot;</span> <span class="st">&quot;#&quot;</span>)) g</span></code></pre></div>
<p>First we're unpacking the underlying <code>VBounded (VBounded a)</code>, then we convert each bool to a representative string, fold those strings into lines, then fold those lines into a single string by packing newlines in between.</p>
<p>We cleverly defined <code>mkGrid</code> earlier to take a list of coords which were alive to define a board; if we make up some interesting combinators we can make a little DSL for setting up a starting grid!</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">at ::</span> [<span class="dt">Coord</span>] <span class="ot">-&gt;</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> [<span class="dt">Coord</span>]</span>
<span id="cb7-2"><a href="#cb7-2"></a>at xs (x, y) <span class="ot">=</span> <span class="fu">fmap</span> ((<span class="op">+</span>x) <span class="op">***</span> (<span class="op">+</span>y)) xs</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a>glider, blinker,<span class="ot"> beacon ::</span> [<span class="dt">Coord</span>]</span>
<span id="cb7-5"><a href="#cb7-5"></a>glider <span class="ot">=</span> [(<span class="dv">1</span>, <span class="dv">0</span>), (<span class="dv">2</span>, <span class="dv">1</span>), (<span class="dv">0</span>, <span class="dv">2</span>), (<span class="dv">1</span>, <span class="dv">2</span>), (<span class="dv">2</span>, <span class="dv">2</span>)]</span>
<span id="cb7-6"><a href="#cb7-6"></a>blinker <span class="ot">=</span> [(<span class="dv">0</span>, <span class="dv">0</span>), (<span class="dv">1</span>, <span class="dv">0</span>), (<span class="dv">2</span>, <span class="dv">0</span>)]</span>
<span id="cb7-7"><a href="#cb7-7"></a>beacon <span class="ot">=</span> [(<span class="dv">0</span>, <span class="dv">0</span>), (<span class="dv">1</span>, <span class="dv">0</span>), (<span class="dv">0</span>, <span class="dv">1</span>), (<span class="dv">3</span>, <span class="dv">2</span>), (<span class="dv">2</span>, <span class="dv">3</span>), (<span class="dv">3</span>, <span class="dv">3</span>)]</span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="ot">start ::</span> <span class="dt">Grid</span> <span class="dt">Bool</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>start <span class="ot">=</span> mkGrid <span class="op">$</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>     glider <span class="ot">`at`</span> (<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="op">++</span> beacon <span class="ot">`at`</span> (<span class="dv">15</span>, <span class="dv">5</span>)</span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="op">++</span> blinker <span class="ot">`at`</span> (<span class="dv">16</span>, <span class="dv">4</span>)</span></code></pre></div>
<p>That's pretty slick if you ask me!</p>
<p>It's not terribly important, but here's the actual game loop if you're interested:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">import</span> <span class="dt">Conway</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">import</span> <span class="dt">Control.Concurrent</span></span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="ot">tickTime ::</span> <span class="dt">Int</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>tickTime <span class="ot">=</span> <span class="dv">200000</span></span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb8-8"><a href="#cb8-8"></a>main <span class="ot">=</span> loop (step basicRule) start</span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="ot">loop ::</span> (<span class="dt">Grid</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Grid</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Grid</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb8-11"><a href="#cb8-11"></a>loop stepper g <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="fu">putStr</span> <span class="st">&quot;\ESC[2J&quot;</span> <span class="co">-- Clear terminal screen</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>  <span class="fu">putStrLn</span> (render g)</span>
<span id="cb8-14"><a href="#cb8-14"></a>  threadDelay tickTime</span>
<span id="cb8-15"><a href="#cb8-15"></a>  loop stepper (stepper g)</span></code></pre></div>
<p>That's about it, hope you found something interesting!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Radix Sort, Trie Trees, and Maps from Representable Functors</title>
      <link href="https://chrispenner.ca/posts/representable-discrimination"/>
      <id>https://chrispenner.ca/posts/representable-discrimination</id>
      <updated>2017-07-23T00:00:00Z</updated>
      <summary>Representable Functors can be used to create Map-like data structures or perform Radix-like sorts.</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/containers.jpg" alt="Radix Sort, Trie Trees, and Maps from Representable Functors">
              <p>I recommend you follow along in ghci and experiment with things as you go; There's a Literate Haskell version of this post <a href="https://gist.github.com/ChrisPenner/eb6a4efa0d57f39dc5f3c7bb2d31c2d7">here</a>, you can load it straight into ghci!</p>
<p>Looking at my recent posts it's clear I've been on a bit of a Representable kick lately; turns out there's a lot of cool things you can do with it! We'll be adding 'sorting' to that list of things today. Representable Functors bring with them an intrinsic notion of sorting; not in the traditional 'ordered' sense, but rather a sense of 'structural' sorting. Since every 'slot' in a Representable Functor <code>r</code> can be uniquely identified by some <code>Rep r</code> we can talk about sorting items into some named slot in <code>r</code>. If we like we can also define <code>Ord (Rep r)</code> to get a total ordering over the slots, but it's not required.</p>
<p>I'll preface this post by saying I'm more interested in exploring the structural 'form' of representable sorting than the performance of the functions we'll define, in fact the performance of some of them as they're written here is going to be quite poor as I'm sacrificing speed to gain simplicity for the sake of pedagogy. The intent is to observe the system from a high-level to see some interesting new patterns and shapes we gain from using Representable to do our sorting. Most of the structures we build could quite easily be optimized to perform reasonably if one was so inclined.</p>
<h2 id="building-up-sorting-over-representable">Building up Sorting over Representable</h2>
<p>I'll step through my thought process on this one:</p>
<p>We've got a Representable Functor <code>r</code>; If we have a <code>Rep r</code> for some <code>a</code> we know which slot to put it into in an <code>r a</code>. We can get a <code>Rep r</code> for every <code>a</code> by using a function <code>a -&gt; Rep r</code>. Now we want to embed the <code>a</code> into an <code>r a</code> using the <code>Rep r</code>, the tool we have for this is <code>tabulate</code>, in order to know which index is which and put it into the right slot we'll need to require <code>Eq (Rep r)</code>. We know which slot our one element goes to, but we need something to put into all the other slots. If <code>a</code> were a Monoid we could use <code>mempty</code> for the other slots; then if we map that function over every element in an input list we could build something like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a>(<span class="dt">Representable</span> r, <span class="dt">Monoid</span> a, <span class="dt">Eq</span> (<span class="dt">Rep</span> r)) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Rep</span> r) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [r a]</span></code></pre></div>
<p>We want a single <code>r a</code> as a result rather than a list, so we need to collapse <code>[r a]</code>. We could use <code>mconcat</code> if <code>r a</code> was a Monoid! We can actually write a monoid instance for any representable if the inner <code>a</code> type also has a Monoid instance, later we'll define a custom newtype wrapper with that instance! This gives:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a>(<span class="dt">Representable</span> r, <span class="dt">Monoid</span> a, <span class="dt">Eq</span> (<span class="dt">Rep</span> r)) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Rep</span> r) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> r a</span></code></pre></div>
<p>We can generalize the list to any foldable by just calling <code>Data.Foldable.toList</code> on it, and we get:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a>(<span class="dt">Representable</span> r, <span class="dt">Monoid</span> a, <span class="dt">Foldable</span> f, <span class="dt">Eq</span> (<span class="dt">Rep</span> r)) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Rep</span> r) <span class="ot">-&gt;</span> f a <span class="ot">-&gt;</span> r a</span></code></pre></div>
<p>Nifty! But this requires that every <code>a</code> type we want to work is also a Monoid, that's going to seriously limit the usecases for this. We can increase the utility by allowing the caller to specifying a way to build a Monoid from an <code>a</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a>(<span class="dt">Representable</span> r, <span class="dt">Monoid</span> m, <span class="dt">Foldable</span> f, <span class="dt">Eq</span> (<span class="dt">Rep</span> r)) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Rep</span> r) <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m) <span class="ot">-&gt;</span> f a <span class="ot">-&gt;</span> r m</span></code></pre></div>
<p>And that's our final fully generalized type signature!</p>
<p>We're going to need a bunch of imports before we start implementing things, prepare yourself:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="ot">{-# language DeriveFunctor #-}</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="ot">{-# language TypeFamilies #-}</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ot">{-# language MultiParamTypeClasses #-}</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="ot">{-# language FlexibleInstances #-}</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="ot">{-# language ScopedTypeVariables #-}</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="ot">{-# language FlexibleContexts #-}</span></span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="ot">{-# OPTIONS_GHC -fno-warn-orphans #-}</span></span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="kw">module</span> <span class="dt">RepSort</span> <span class="kw">where</span></span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="kw">import</span> <span class="dt">Data.Distributive</span> (<span class="dt">Distributive</span>(..))</span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="kw">import</span> <span class="dt">Data.Functor.Rep</span> (<span class="dt">Representable</span>(..), <span class="dt">Co</span>(..), distributeRep)</span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="kw">import</span> <span class="dt">Data.Monoid</span> (<span class="dt">Sum</span>(..))</span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Stream.Infinite</span> <span class="kw">as</span> <span class="dt">S</span> (<span class="dt">Stream</span>, iterate)</span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="kw">import</span> <span class="dt">Control.Comonad.Cofree</span> (<span class="dt">Cofree</span>)</span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Sequence</span> <span class="kw">as</span> <span class="dt">Seq</span> (<span class="dt">Seq</span>, fromList)</span></code></pre></div>
<p>So here's my implementation for <code>repSort</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">-- Firstly, the signature we came up with:</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ot">repSort ::</span> (<span class="dt">Representable</span> r, <span class="dt">Monoid</span> m, <span class="dt">Foldable</span> f, <span class="dt">Eq</span> (<span class="dt">Rep</span> r)) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Rep</span> r) <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m) <span class="ot">-&gt;</span> f a <span class="ot">-&gt;</span> r m</span>
<span id="cb6-3"><a href="#cb6-3"></a>repSort indOf toM <span class="ot">=</span> unMRep <span class="op">.</span> <span class="fu">foldMap</span> (<span class="dt">MRep</span> <span class="op">.</span> tabulate <span class="op">.</span> desc)</span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="kw">where</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="co">-- desc takes an &#39;a&#39; from the foldable and returns a descriptor function which can be passed to &#39;tabulate&#39;,</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="co">-- The descriptor just returns mempty unless we&#39;re on the slot where the &#39;a&#39;s result is supposed to end up.</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>    desc a i</span>
<span id="cb6-8"><a href="#cb6-8"></a>      <span class="op">|</span> i <span class="op">==</span> indOf a <span class="ot">=</span> toM a</span>
<span id="cb6-9"><a href="#cb6-9"></a>      <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="fu">mempty</span></span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">-- Here&#39;s our newtype with a Monoid over Representables</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="kw">newtype</span> <span class="dt">MRep</span> r a <span class="ot">=</span> <span class="dt">MRep</span> {<span class="ot">unMRep ::</span>r a}</span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="kw">instance</span> (<span class="dt">Monoid</span> a, <span class="dt">Representable</span> r) <span class="ot">=&gt;</span> <span class="dt">Monoid</span> (<span class="dt">MRep</span> r a) <span class="kw">where</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>  <span class="co">-- The empty Representable is filled with mempty</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>  <span class="fu">mempty</span> <span class="ot">=</span> <span class="dt">MRep</span> <span class="op">$</span> tabulate (<span class="fu">const</span> <span class="fu">mempty</span>)</span>
<span id="cb6-19"><a href="#cb6-19"></a>  <span class="co">-- We can just tabulate a new representable where the value is the `mappend` of</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>  <span class="co">-- the other two representables. BTW (index a `mappend` index b) depends on</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>  <span class="co">-- the monoid instance for functions, so go check that out if you haven&#39;t seen it!</span></span>
<span id="cb6-22"><a href="#cb6-22"></a>  (<span class="dt">MRep</span> a) <span class="ot">`mappend`</span> (<span class="dt">MRep</span> b) <span class="ot">=</span> <span class="dt">MRep</span> <span class="op">.</span> tabulate <span class="op">$</span> <span class="fu">index</span> a <span class="ot">`mappend`</span> <span class="fu">index</span> b</span></code></pre></div>
<h2 id="using-repsort">Using <code>repSort</code></h2>
<p>Great! Let's see some examples so we can get a handle on what this does! First I'll set up a super simple but useful Representable for Pair:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">data</span> <span class="dt">Pair</span> a <span class="ot">=</span> <span class="dt">Pair</span> a a</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">-- This instance is required, but we can just lean on our Representable instance</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">-- `Data.Functor.Rep` provides all sorts of these helpers.</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="kw">instance</span> <span class="dt">Distributive</span> <span class="dt">Pair</span> <span class="kw">where</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>  distribute <span class="ot">=</span> distributeRep</span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="kw">instance</span> <span class="dt">Representable</span> <span class="dt">Pair</span> <span class="kw">where</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>  <span class="co">-- Bool is a great index for this!</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>  <span class="kw">type</span> <span class="dt">Rep</span> <span class="dt">Pair</span> <span class="ot">=</span> <span class="dt">Bool</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="fu">index</span> (<span class="dt">Pair</span> a _) <span class="dt">True</span> <span class="ot">=</span> a</span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="fu">index</span> (<span class="dt">Pair</span> _ b) <span class="dt">False</span> <span class="ot">=</span> b</span>
<span id="cb7-14"><a href="#cb7-14"></a></span>
<span id="cb7-15"><a href="#cb7-15"></a>  tabulate desc <span class="ot">=</span> <span class="dt">Pair</span> (desc <span class="dt">True</span>) (desc <span class="dt">False</span>)</span></code></pre></div>
<p>So since Pair is indexed by a <code>Bool</code> the <code>a -&gt; Rep Pair</code> is actually just a predicate <code>a -&gt; Bool</code>! Let's try sorting out some odd and even integers!</p>
<p>Remember that <code>repSort</code> needs a function from <code>a -&gt; Rep r</code>, in this case <code>Rep r ~ Bool</code> (<code>~</code> means 'is equal to' when we're talking about types), so we can use <code>odd</code> to split the odd and even integers up! Next it needs a function which transforms an <code>a</code> into a monoid! The simplest one of these is <code>(:[])</code> which just puts the element into a list! Let's see what we get!</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="ot">sortedInts ::</span> <span class="dt">Pair</span> [<span class="dt">Int</span>]</span>
<span id="cb8-2"><a href="#cb8-2"></a>sortedInts <span class="ot">=</span> repSort <span class="fu">odd</span> (<span class="op">:</span>[]) [<span class="dv">1</span><span class="op">..</span><span class="dv">10</span>]</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>λ<span class="op">&gt;</span> sortedInts</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="dt">Pair</span> [<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">9</span>] [<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">8</span>,<span class="dv">10</span>]</span></code></pre></div>
<p>We used lists in the last example, but remember that the function is generalized over that parameter so we can actually choose any Monoid we like! Let's say we wanted the sums of all odd and even ints respectively between 1 and 10:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="ot">oddEvenSums ::</span> <span class="dt">Pair</span> (<span class="dt">Sum</span> <span class="dt">Int</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a>oddEvenSums <span class="ot">=</span> repSort <span class="fu">odd</span> <span class="dt">Sum</span> [<span class="dv">1</span><span class="op">..</span><span class="dv">10</span>]</span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a>λ<span class="op">&gt;</span> oddEvenSums</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="dt">Pair</span> (<span class="dt">Sum</span> {getSum <span class="ot">=</span> <span class="dv">25</span>}) (<span class="dt">Sum</span> {getSum <span class="ot">=</span> <span class="dv">30</span>})</span></code></pre></div>
<p>Choosing our own monoid and index function gives us a lot of flexibility and power!</p>
<p>This pattern generalizes to any Representable you can think of, and most Representables which have an interesting <code>Rep r</code> will have some sort of cool structure or use-case! Think about some other Representables and see what you can come up with!</p>
<h2 id="indexing-by-integers-using-stream">Indexing by Integers using Stream</h2>
<p>Let's try another Functor and see what happens, here we'll go with an infinite <code>Stream</code> from <a href="http://hackage.haskell.org/package/streams-3.3/docs/Data-Stream-Infinite.html">Data.Stream.Infinite</a> in the <a href="http://hackage.haskell.org/package/streams">streams package</a>, whose representation is <code>Int</code>, that is; <code>Rep Stream ~ Int</code>.</p>
<p>With a representation type of <code>Int</code> we could do all sorts of things! Note here how the Functor (<code>Stream</code>) is infinite, but the representable is actually bounded by the size of Int. This is fine as long as we don't try fold the result or get every value out of it in some way, we'll primarily be using the <code>index</code> function from <code>Representable</code> so it should work out okay.</p>
<p>The streams are infinite, but Haskell's inherent laziness helps us out in handling this, not only can we represent infinite things without a problem, Haskell won't actually calculate the values stored in any slots where we don't look, and since the whole thing is a data structure any computations that do occur are automatically memoized! This also means that you don't pay the cost for any value transformation or monoidal append unless you actually look inside the bucket. Only the initial <code>a -&gt; Rep r</code> must be computed for each element.</p>
<p>Let's sort some stuff! See if you can figure this one out:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">byLength ::</span> <span class="dt">S.Stream</span> [<span class="dt">String</span>]</span>
<span id="cb10-2"><a href="#cb10-2"></a>byLength <span class="ot">=</span> repSort <span class="fu">length</span> (<span class="op">:</span>[]) [<span class="st">&quot;javascript&quot;</span>, <span class="st">&quot;purescript&quot;</span>, <span class="st">&quot;haskell&quot;</span>, <span class="st">&quot;python&quot;</span>]</span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a>λ<span class="op">&gt;</span> <span class="fu">index</span> byLength <span class="dv">10</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>[<span class="st">&quot;javascript&quot;</span>,<span class="st">&quot;purescript&quot;</span>]</span>
<span id="cb10-6"><a href="#cb10-6"></a>λ<span class="op">&gt;</span> <span class="fu">index</span> byLength <span class="dv">7</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>[<span class="st">&quot;haskell&quot;</span>]</span>
<span id="cb10-8"><a href="#cb10-8"></a>λ<span class="op">&gt;</span> <span class="fu">index</span> byLength <span class="dv">3</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>[]</span></code></pre></div>
<p>We didn't have to change our implementation of repSort at all! <code>index</code> knows how to find values in a <code>Stream</code> from an <code>Int</code> and all of that complexity is taken care of for us in the instance of <code>Representable</code>.</p>
<p>The fact that <code>Int</code> is the <code>Rep</code> for Stream provides us with a few quick wins, any Enumerable type can be injected into <code>Int</code> via <code>fromEnum</code> from the Prelude: <code>fromEnum: (Enum e) =&gt; e -&gt; Int</code>. This means we can turn any Enumerable type into an index into <code>Stream</code> without much trouble and we gain a whole new set of possibilities:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="ot">byFirstChar ::</span> <span class="dt">S.Stream</span> [<span class="dt">String</span>]</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co">-- We get the Int value from the first char of a string and use that as the index!</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>byFirstChar <span class="ot">=</span> repSort (<span class="fu">fromEnum</span> <span class="op">.</span> <span class="fu">head</span>) (<span class="op">:</span>[]) [<span class="st">&quot;cats&quot;</span>, <span class="st">&quot;antelope&quot;</span>, <span class="st">&quot;crabs&quot;</span>, <span class="st">&quot;aardvarks&quot;</span>]</span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a>λ<span class="op">&gt;</span> <span class="fu">index</span> byFirstChar <span class="op">.</span> <span class="fu">fromEnum</span> <span class="op">$</span> <span class="ch">&#39;c&#39;</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>[<span class="st">&quot;cats&quot;</span>,<span class="st">&quot;crabs&quot;</span>]</span>
<span id="cb11-7"><a href="#cb11-7"></a>λ<span class="op">&gt;</span> <span class="fu">index</span> byFirstChar <span class="op">.</span> <span class="fu">fromEnum</span> <span class="op">$</span> <span class="ch">&#39;a&#39;</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>[<span class="st">&quot;antelope&quot;</span>,<span class="st">&quot;aardvarks&quot;</span>]</span>
<span id="cb11-9"><a href="#cb11-9"></a>λ<span class="op">&gt;</span> <span class="fu">index</span> byFirstChar <span class="op">.</span> <span class="fu">fromEnum</span> <span class="op">$</span> <span class="ch">&#39;z&#39;</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>[]</span></code></pre></div>
<p>So that's all pretty cool, but working with a single infinite stream gets unwieldy quickly when we start dealing with indexes in the thousands! <code>Stream</code> is effectively a linked list, so we need to step along the nodes until we reach our index every time we look something up! Maybe we can do better on that somehow...</p>
<p>Straying a bit from sorting into the idea of data storage let's say we wanted to store values in a structure where they're keyed by a <code>String</code>. The first step would be to find a Representable whose index type could be a <code>String</code>. Hrmm, our <code>Stream</code> representation can index by <code>Char</code>, which is close; what if we nested further representables and used a 'path' to the value as the index? Something like <code>Stream (Stream (Stream ...))</code>. This looks like an infinite tree of trees at this point; but has the issue that we never actually make it to any <code>a</code>s! Whenever I think of tagging a tree-like structure with values I go straight to Cofree, let's see how it can help.</p>
<h2 id="diving-into-tries-using-cofree">Diving into Tries using Cofree</h2>
<p>One way you could think of Cofree is as a Tree where every branch and node has an annotation <code>a</code> and the branching structure is determined by some Functor! For example, a simple Rose tree is isomorphic to <code>Cofree [] a</code>, <code>Cofree Maybe a</code> makes a degenerate tree with only single branches, etc.</p>
<p>We want a tree where the branching structure is indexed by a <code>String</code>, so let's give <code>Cofree Stream a</code> a try! Effectively this creates an infinite number of branches at every level of the tree, but in practice we'll only actually follow paths which are represented by some string that we're indexing with, the rest of the structure will be never be evaluated!</p>
<p>As it turns out, we made a good choice! <code>Cofree r a</code> is Representable whenever <code>r</code> is Representable, but which type indexes into it? The Representable instance for Cofree (defined in <a href="http://hackage.haskell.org/package/free-4.12.4/docs/Control-Comonad-Cofree.html">Control.Comonad.Cofree</a> from the <a href="http://hackage.haskell.org/package/free">free</a> package) It relies on the underlying Representable Index, but since the tree could have multiple layers it needs a sequence of those indexes! That's why the index type for <code>Cofree</code> of a Representable is <code>Seq (Rep r)</code>, when we index into a <code>Cofree</code> we follow one index at a time from the Sequence of indexes until we reach the end, then we return the value stored at that position in the tree! Under the hood the <code>Rep</code> for our structure is going to be specialized to <code>Seq Int</code>, but we can easily write <code>mkInd :: String -&gt; Seq Int</code> to index by Strings!</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="ot">mkInd ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Seq.Seq</span> <span class="dt">Int</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>mkInd <span class="ot">=</span> Seq.fromList <span class="op">.</span> <span class="fu">fmap</span> <span class="fu">fromEnum</span></span></code></pre></div>
<p>Great! Now we can 'sort' values by strings and index into a tree structure (pseudo) performantly! If this whole sort of structure is looking a bit familiar you've probably seen it by the name of a <a href="https://en.wikipedia.org/wiki/Trie">"Trie Tree"</a>, a datastructure often used in <a href="https://en.wikipedia.org/wiki/Radix_sort">Radix sorts</a> and search problems. Its advantage is that it gives <code>O(m)</code> lookups where <code>m</code> is the length of the key string, in our case it will be slightly slower than the traditional method since we don't have <code>O(1)</code> random memory access, and have to move through each child tree to the appropriate place before diving deeper, but you could fix that pretty easily by using a proper <code>Vector</code> as the underlying representation rather than <code>Stream</code>. I'll leave that one as an exercise for the reader.</p>
<h2 id="building-maps-from-tries">Building Maps from Tries</h2>
<p>That's a whole lot of explaining without any practical examples, so I bet you're itching to try out our new Trie-based Sorter/Map! With a few helpers we can build something quickly!</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">-- I&#39;m going to specialize the signature to `Cofree Stream` to make it a bit more</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co">-- readable, but you could re-generalize this idea if you wanted to.</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="ot">trieSort ::</span> (<span class="dt">Monoid</span> m, <span class="dt">Foldable</span> f) <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">String</span>) <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m) <span class="ot">-&gt;</span> f a <span class="ot">-&gt;</span> <span class="dt">Cofree</span> <span class="dt">S.Stream</span> m</span>
<span id="cb13-4"><a href="#cb13-4"></a>trieSort getInd <span class="ot">=</span> repSort (mkInd <span class="op">.</span> getInd)</span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">-- Build a map out of some key and a Monoidal value!</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="ot">trieMap ::</span> <span class="dt">Monoid</span> m <span class="ot">=&gt;</span> [(<span class="dt">String</span>, m)] <span class="ot">-&gt;</span> <span class="dt">Cofree</span> <span class="dt">S.Stream</span> m</span>
<span id="cb13-8"><a href="#cb13-8"></a>trieMap <span class="ot">=</span> trieSort <span class="fu">fst</span> <span class="fu">snd</span></span>
<span id="cb13-9"><a href="#cb13-9"></a></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="ot">get ::</span> <span class="dt">Cofree</span> <span class="dt">S.Stream</span> a <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> a</span>
<span id="cb13-11"><a href="#cb13-11"></a>get r ind <span class="ot">=</span> <span class="fu">index</span> r (mkInd ind)</span>
<span id="cb13-12"><a href="#cb13-12"></a></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="ot">bankAccounts ::</span> <span class="dt">Cofree</span> <span class="dt">S.Stream</span> (<span class="dt">Sum</span> <span class="dt">Int</span>)</span>
<span id="cb13-14"><a href="#cb13-14"></a>bankAccounts <span class="ot">=</span> trieMap [(<span class="st">&quot;Bob&quot;</span>, <span class="dt">Sum</span> <span class="dv">37</span>), (<span class="st">&quot;Sally&quot;</span>, <span class="dv">5</span>)]</span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a>λ<span class="op">&gt;</span> get bankAccounts <span class="st">&quot;Bob&quot;</span></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="dt">Sum</span> {getSum <span class="ot">=</span> <span class="dv">37</span>}</span>
<span id="cb13-18"><a href="#cb13-18"></a>λ<span class="op">&gt;</span> get bankAccounts <span class="st">&quot;Sally&quot;</span></span>
<span id="cb13-19"><a href="#cb13-19"></a><span class="dt">Sum</span> {getSum <span class="ot">=</span> <span class="dv">5</span>}</span>
<span id="cb13-20"><a href="#cb13-20"></a><span class="co">-- Empty keys are mempty</span></span>
<span id="cb13-21"><a href="#cb13-21"></a>λ<span class="op">&gt;</span> get bankAccounts <span class="st">&quot;Edward&quot;</span></span>
<span id="cb13-22"><a href="#cb13-22"></a><span class="dt">Sum</span> {getSum <span class="ot">=</span> <span class="dv">0</span>}</span>
<span id="cb13-23"><a href="#cb13-23"></a></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="ot">withdrawals ::</span> <span class="dt">Cofree</span> <span class="dt">S.Stream</span> (<span class="dt">Sum</span> <span class="dt">Int</span>)</span>
<span id="cb13-25"><a href="#cb13-25"></a>withdrawals <span class="ot">=</span> trieMap [(<span class="st">&quot;Bob&quot;</span>, <span class="dt">Sum</span> (<span class="op">-</span><span class="dv">10</span>))]</span>
<span id="cb13-26"><a href="#cb13-26"></a></span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="co">-- And of course we can still make use of our MRep helper to combine maps!</span></span>
<span id="cb13-28"><a href="#cb13-28"></a>λ<span class="op">&gt;</span> get (unMRep <span class="op">$</span> <span class="dt">MRep</span> bankAccounts <span class="ot">`mappend`</span> <span class="dt">MRep</span> withdrawals ) <span class="st">&quot;Bob&quot;</span></span>
<span id="cb13-29"><a href="#cb13-29"></a><span class="dt">Sum</span> {getSum <span class="ot">=</span> <span class="dv">27</span>}</span></code></pre></div>
<p>There are TONS of other possibilities here, we can swap out the underlying Representable to get new behaviour and performance, we can use <code>Data.Functor.Compose</code> to nest multiple <code>Representable</code>s to build new and interesting structures! We can sort, store, lookup and search using <code>repSort</code>!</p>
<p>Let me know which interesting ideas you come up with! Either leave a comment here or find me on Twitter <a href="https://twitter.com/chrislpenner">@chrislpenner</a>.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Free and Forgetful Functors</title>
      <link href="https://chrispenner.ca/posts/free-forgetful-functors"/>
      <id>https://chrispenner.ca/posts/free-forgetful-functors</id>
      <updated>2017-07-20T00:00:00Z</updated>
      <summary>Building adjunctions from Free and Forgetful Functors</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/books.jpg" alt="Free and Forgetful Functors">
              <p>Today I'm going to continue the previous topic of Adjunctions, <a href="/posts/adjunction-battleship">last time</a> we talked about how you can build a sensible adjunction from any Representable functor, this time we're going to talk about a (semantically) different form of adjunction, one formed by a pair of Free and Forgetful Functors. First I'll describe the relationship of Free and Forgetful Functors, then we'll see how an Adjunction can making translating between them slightly easier.</p>
<p>Let's define our terms, hopefully you already know what a Functor is, it's any type with a <code>map</code> method (called <code>fmap</code> in Haskell). A Free Functor is a functor which can embed any element "for free". So any Functor where we could just 'inject' a value into is considered a Free Functor. If the functor has an Applicative instance then <code>inject</code> is called <code>pure</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">inject ::</span> a <span class="ot">-&gt;</span> f a</span></code></pre></div>
<p>To do this maybe it means we make up some of the structure, or have some default values we use in certain parts. Let's see some contrived examples of Free Functors.</p>
<p>Simple single slot functors like Identity:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a>inject a <span class="ot">=</span> <span class="dt">Identity</span> a</span></code></pre></div>
<p>Simple structures like List or Maybe or Either:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a>inject a <span class="ot">=</span> [a]</span>
<span id="cb3-2"><a href="#cb3-2"></a>inject a <span class="ot">=</span> <span class="dt">Just</span> a</span>
<span id="cb3-3"><a href="#cb3-3"></a>inject a <span class="ot">=</span> <span class="dt">Right</span> a</span>
<span id="cb3-4"><a href="#cb3-4"></a>inject a <span class="ot">=</span> <span class="dt">Pair</span> a a</span>
<span id="cb3-5"><a href="#cb3-5"></a>inject a <span class="ot">=</span> <span class="fu">repeat</span> a</span></code></pre></div>
<p>Or even anything paired with a monoid, since we can 'make up' the monoid's value using mempty.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="ot">inject ::</span> <span class="dt">Monoid</span> t <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Tagged</span> t a</span>
<span id="cb4-2"><a href="#cb4-2"></a>inject a <span class="ot">=</span> <span class="dt">Tagged</span> <span class="fu">mempty</span> a</span></code></pre></div>
<p>Note however that some of these Free functors are unsuitable for use with adjunctions since <em><em>Sum</em></em> types like Maybe, List and Either aren't Distributive because the number of <code>a</code> slots in the functor can change between values.</p>
<p>Next we need the forgetful functor, this is a functor which 'loses' or 'forgets' some data about some other functor when we wrap it. The idea is that for each pair of Free and Forgetful functors there's a Natural Transformation to the Identity Functor: <code>Forget (Free a) ~&gt; Identity a</code>; and since there's an isomorphism <code>Identity a ≅ a</code> we end up with something like <code>Forget (Free a) ~&gt; a</code>. This expresses that when we forget a free functor we end up back where we started.</p>
<p>Let's see what 'forgetting' the info from a Free functor looks like by implementing <code>forget :: Free a -&gt; a</code> for different Free functors.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">-- Identity never had any extra info to begin with</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="ot">forget ::</span> <span class="dt">Identity</span> a <span class="ot">-&gt;</span> a</span>
<span id="cb5-3"><a href="#cb5-3"></a>forget (<span class="dt">Identity</span> a) <span class="ot">=</span> a</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">-- The extra info in a nonempty list is the extra elements</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="ot">forget ::</span> <span class="dt">List.NonEmpty</span> a <span class="ot">-&gt;</span> a</span>
<span id="cb5-7"><a href="#cb5-7"></a>forget (a<span class="op">:|</span>_) <span class="ot">=</span> a</span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">-- The extra info in a &#39;Tagged&#39; is the tag</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="ot">forget ::</span> <span class="dt">Tagged</span> t a <span class="ot">-&gt;</span> a</span>
<span id="cb5-11"><a href="#cb5-11"></a>forget (<span class="dt">Tagged</span> _ a) <span class="ot">=</span> a</span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">-- The extra info in a Pair is the duplication</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="ot">forget ::</span> <span class="dt">Pair</span> a <span class="ot">-&gt;</span> a</span>
<span id="cb5-15"><a href="#cb5-15"></a>forget (<span class="dt">Pair</span> a _) <span class="ot">=</span> a</span></code></pre></div>
<p>You can imagine this sort of thing for many types; for any Comonad type we have <code>forget = extract</code>. Implementations for <code>Maybe</code> or <code>Either</code> or <code>List</code> are a bit trickier since it's possible that no value exists, we'd have to require a Monoid for the inner type <code>a</code> to do these. Notice that these are the same types for which we can't write a proper instance of Distributive, so we'll be avoiding them as we move forwards.</p>
<p>Anyways, enough chatting, let's build something! We're going to do a case study in the <code>Tagged</code> type we showed above.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="ot">{-# language DeriveFunctor #-}</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ot">{-# language TypeFamilies #-}</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="ot">{-# language MultiParamTypeClasses #-}</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="ot">{-# language FlexibleInstances #-}</span></span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="kw">module</span> <span class="dt">Tagged</span> <span class="kw">where</span></span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="kw">import</span> <span class="dt">Data.Distributive</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="kw">import</span> <span class="dt">Data.Functor.Rep</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="kw">import</span> <span class="dt">Data.Functor.Adjunction</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="kw">import</span> <span class="dt">Data.Char</span></span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="kw">newtype</span> <span class="dt">Forget</span> a <span class="ot">=</span> <span class="dt">Forget</span> {<span class="ot"> getForget ::</span> a } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="kw">data</span> <span class="dt">Tagged</span> t a <span class="ot">=</span> <span class="dt">Tagged</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>  {<span class="ot"> getTag ::</span> t</span>
<span id="cb6-16"><a href="#cb6-16"></a>  ,<span class="ot"> untag ::</span> a</span>
<span id="cb6-17"><a href="#cb6-17"></a>  } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span></code></pre></div>
<p>Okay so we've got our two functors! <code>Tagged</code> promotes an 'a' to a 'a' which is tagged by some tag 't'. We'll need a Representable instance for Forget, which need Distributive, these are pretty easy to write for such simple types. Notice that we have a Monoid constraint on our tag which makes Distributive possible.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">instance</span> <span class="dt">Distributive</span> <span class="dt">Forget</span> <span class="kw">where</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  distribute fa <span class="ot">=</span> <span class="dt">Forget</span> (getForget <span class="op">&lt;$&gt;</span> fa)</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="kw">instance</span> <span class="dt">Representable</span> <span class="dt">Forget</span> <span class="kw">where</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="kw">type</span> <span class="dt">Rep</span> <span class="dt">Forget</span> <span class="ot">=</span> ()</span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">index</span> (<span class="dt">Forget</span> a) () <span class="ot">=</span> a</span>
<span id="cb7-7"><a href="#cb7-7"></a>  tabulate describe <span class="ot">=</span> <span class="dt">Forget</span> (describe ())</span></code></pre></div>
<p>Hopefully this is all pretty easy to follow, we've chosen <code>()</code> as the representation since each data type has only a single slot.</p>
<p>Now for Adjunction! We'll unfortunately have to choose a concrete type for our tag here since the definition of Adjunction has functional dependencies. This means that for a given Left Adjoint there can only be one Right Adjoint. We can see it in the class constraint here:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">class</span> (<span class="dt">Functor</span> f, <span class="dt">Representable</span> u) <span class="ot">=&gt;</span> <span class="dt">Adjunction</span> f u <span class="op">|</span> f <span class="ot">-&gt;</span> u, u <span class="ot">-&gt;</span> f <span class="kw">where</span></span></code></pre></div>
<p>It's a shame, but we'll just pick a tag type; how about <code>Maybe String</code>, a <code>Just</code> means we've tagged the value and a <code>Nothing</code> means we haven't. <code>Maybe String</code> is a monoid since <code>String</code> is a Monoid.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">type</span> <span class="dt">Tag</span> <span class="ot">=</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="kw">instance</span> <span class="dt">Adjunction</span> (<span class="dt">Tagged</span> <span class="dt">Tag</span>) <span class="dt">Forget</span> <span class="kw">where</span></span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="ot">  unit ::</span> a <span class="ot">-&gt;</span> <span class="dt">Forget</span> (<span class="dt">Tagged</span> <span class="dt">Tag</span> a)</span>
<span id="cb9-6"><a href="#cb9-6"></a>  unit a <span class="ot">=</span> <span class="dt">Forget</span> (<span class="dt">Tagged</span> <span class="dt">Nothing</span> a)</span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="ot">  counit ::</span> <span class="dt">Tagged</span> <span class="dt">Tag</span> (<span class="dt">Forget</span> a) <span class="ot">-&gt;</span> a</span>
<span id="cb9-8"><a href="#cb9-8"></a>  counit (<span class="dt">Tagged</span> _ (<span class="dt">Forget</span> a)) <span class="ot">=</span> a</span>
<span id="cb9-9"><a href="#cb9-9"></a></span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="co">-- leftAdjunct and rightAdjunct have default implementations in terms of unit &amp; counit</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="ot">  leftAdjunct ::</span> (<span class="dt">Tagged</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Forget</span> b</span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="ot">  rightAdjunct ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Forget</span> b) <span class="ot">-&gt;</span> <span class="dt">Tagged</span> a <span class="ot">-&gt;</span> b</span></code></pre></div>
<p>There we go! Here we say that Forget is Right Adjoint to Tagged, which roughly means that we lose information when we move from <code>Tagged</code> to <code>Forget</code>. <code>unit</code> and <code>counit</code> correspond to the <code>inject</code> and <code>forget</code> that we wrote earlier, they've just got that extra <code>Forget</code> floating around. That's okay though, it's isomorphic to <code>Identity</code> so anywhere we see a <code>Forget a</code> we can pull it out into just an <code>a</code> and vice versa if we need to embed an <code>a</code> to get <code>Forget a</code>.</p>
<p>We now have access to helpers which allow us to promote and demote functions from one functor into the other; so if we've got a function which operates over tagged values we can get a function over untagged values, the same goes for turning functions accepting untagged values into ones taking tagged values. These helpers are <code>leftAdjunct</code> and <code>rightAdjunct</code> respectively! We're going to wrap them up in a small layer to perform the <code>a ≅ Forget a</code> isomorphism for us so we can clean up the signatures a little.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">overUntagged ::</span> (<span class="dt">Tagged</span> <span class="dt">Tag</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b</span>
<span id="cb10-2"><a href="#cb10-2"></a>overUntagged f <span class="ot">=</span> getForget <span class="op">.</span> leftAdjunct f </span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="ot">overTagged ::</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">Tagged</span> <span class="dt">Tag</span> a <span class="ot">-&gt;</span> b</span>
<span id="cb10-5"><a href="#cb10-5"></a>overTagged f <span class="ot">=</span> rightAdjunct (<span class="dt">Forget</span> <span class="op">.</span> f)</span></code></pre></div>
<p>To test these out let's write a small function which takes Strings which are Tagged with a String annotation and appends the tag to the string:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="ot">applyTag ::</span> <span class="dt">Tagged</span> <span class="dt">Tag</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>applyTag (<span class="dt">Tagged</span> <span class="dt">Nothing</span> s) <span class="ot">=</span> s</span>
<span id="cb11-3"><a href="#cb11-3"></a>applyTag (<span class="dt">Tagged</span> (<span class="dt">Just</span> tag) s) <span class="ot">=</span> tag <span class="op">++</span> <span class="st">&quot;: &quot;</span> <span class="op">++</span> s</span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a>λ<span class="op">&gt;</span> applyTag (<span class="dt">Tagged</span> (<span class="dt">Just</span> <span class="st">&quot;Book&quot;</span>) <span class="st">&quot;Ender&#39;s Game&quot;</span>)</span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">&quot;Book: Ender&#39;s Game&quot;</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>λ<span class="op">&gt;</span> applyTag (<span class="dt">Tagged</span> <span class="dt">Nothing</span> <span class="st">&quot;Steve&quot;</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="st">&quot;Steve&quot;</span></span></code></pre></div>
<p>Using our helpers we can call <code>applyTag</code> over untagged strings too, though the results are expectedly boring:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a>λ<span class="op">&gt;</span> overUntagged applyTag <span class="st">&quot;Boring&quot;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="st">&quot;Boring&quot;</span></span></code></pre></div>
<p>Now let's see the other half of our adjunction, we can define a function over strings and run it over Tagged strings!</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="ot">upperCase ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>upperCase <span class="ot">=</span> <span class="fu">fmap</span> <span class="fu">toUpper</span></span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a>λ<span class="op">&gt;</span> upperCase <span class="st">&quot;Steve&quot;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="st">&quot;STEVE&quot;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>λ<span class="op">&gt;</span> overTagged upperCase (<span class="dt">Tagged</span> (<span class="dt">Just</span> <span class="st">&quot;Book&quot;</span>) <span class="st">&quot;Ender&#39;s Game&quot;</span>)</span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="st">&quot;ENDER&#39;S GAME&quot;</span></span></code></pre></div>
<p>Notice that we lose the tag when we do this, that's the price we pay with a lossy Adjunction! The utility of the construct seems pretty limited here since <code>fmap</code> and <code>extract</code> would pretty much give us the same options, but the idea is that Adjunctions represent a structure which we can generalize over in certain cases. This post was more about understanding adjunctions and Free/Forgetful functors than it was about programming anyways :)</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Adjunctions and Battleship</title>
      <link href="https://chrispenner.ca/posts/adjunction-battleship"/>
      <id>https://chrispenner.ca/posts/adjunction-battleship</id>
      <updated>2017-07-19T00:00:00Z</updated>
      <summary>Using Adjunctions and Representable to build a Battleship game</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/battleship.jpg" alt="Adjunctions and Battleship">
              <p>Today we'll be looking into Kmett's <a href="http://hackage.haskell.org/package/adjunctions">adjunctions</a> library, particularly the meat of the library in Data.Functor.Adjunction.</p>
<p>This post as a literate haskell file <a href="https://gist.github.com/ChrisPenner/291038ae1343333fb41523b41181a9d4">here</a>, so if you prefer to have the code running in ghci as you read along then go for it! Like any good haskell file we need half a dozen language pragmas and imports before we get started.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">{-# language DeriveFunctor #-}</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ot">{-# language TypeFamilies #-}</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ot">{-# language MultiParamTypeClasses #-}</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="ot">{-# language InstanceSigs #-}</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="ot">{-# language FlexibleContexts #-}</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw">module</span> <span class="dt">Battleship</span> <span class="kw">where</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw">import</span> <span class="dt">Data.Functor</span> (void)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">import</span> <span class="dt">Data.Functor.Adjunction</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">import</span> <span class="dt">Data.Functor.Rep</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw">import</span> <span class="dt">Data.Distributive</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="kw">import</span> <span class="dt">Control.Arrow</span> ((&amp;&amp;&amp;))</span></code></pre></div>
<p>I've been struggling to understand this library for a little while now and have been poking at it from different angles trying to gain some intuition. My previous post on <a href="http://chrispenner.ca/posts/representable-cofree-zippers">Zippers using Representable and Cofree</a> is part of that adventure so I'd suggest you read that first if you haven't yet.</p>
<p>Like most higher-level mathematic concepts Adjunctions themselves are just an abstract collection of types and shapes that fit together in a certain way. This means that they have little practical meaning on their own, but provide a useful set of tools to us if we happen to notice that some problem we're working on matches their shape. The first time I dug into adjunctions I went straight to the typeclass to check out which requirements and methods it had. Here are the signatures straight from the source code in Data.Functor.Adjunction</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">class</span> (<span class="dt">Functor</span> f, <span class="dt">Representable</span> u) <span class="ot">=&gt;</span> <span class="dt">Adjunction</span> f u <span class="op">|</span> f <span class="ot">-&gt;</span> u, u <span class="ot">-&gt;</span> f <span class="kw">where</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ot">  unit         ::</span> a <span class="ot">-&gt;</span> u (f a)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="ot">  counit       ::</span> f (u a) <span class="ot">-&gt;</span> a</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="ot">  leftAdjunct  ::</span> (f a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> u b</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="ot">  rightAdjunct ::</span> (a <span class="ot">-&gt;</span> u b) <span class="ot">-&gt;</span> f a <span class="ot">-&gt;</span> b</span></code></pre></div>
<p>Hrmm... not the most illuminating. Unfortunately there's not much in the way of documentation to help us out, but that's because the type signatures pretty much explain how to USE adjunctions, but tragically they don't tell us WHERE or HOW to use them. For this I think examples are the most useful, and that's where I'll try to help out.</p>
<p>The first place to look for examples is in the 'instances' section of the type-class itself, let's see what's in there:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">Adjunction</span> <span class="dt">Identity</span> <span class="dt">Identity</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="dt">Adjunction</span> ((,) e) ((<span class="ot">-&gt;</span>) e)</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="dt">Adjunction</span> f g <span class="ot">=&gt;</span> <span class="dt">Adjunction</span> (<span class="dt">IdentityT</span> f) (<span class="dt">IdentityT</span> g)</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="dt">Adjunction</span> f u <span class="ot">=&gt;</span> <span class="dt">Adjunction</span> (<span class="dt">Free</span> f) (<span class="dt">Cofree</span> u)</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="dt">Adjunction</span> w m <span class="ot">=&gt;</span> <span class="dt">Adjunction</span> (<span class="dt">EnvT</span> e w) (<span class="dt">ReaderT</span> e m)</span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="dt">Adjunction</span> m w <span class="ot">=&gt;</span> <span class="dt">Adjunction</span> (<span class="dt">WriterT</span> s m) (<span class="dt">TracedT</span> s w)</span>
<span id="cb3-7"><a href="#cb3-7"></a>(<span class="dt">Adjunction</span> f g, <span class="dt">Adjunction</span> f&#39; g&#39;) <span class="ot">=&gt;</span> <span class="dt">Adjunction</span> (<span class="dt">Compose</span> f&#39; f) (<span class="dt">Compose</span> g g&#39;)</span>
<span id="cb3-8"><a href="#cb3-8"></a>(<span class="dt">Adjunction</span> f g, <span class="dt">Adjunction</span> f&#39; g&#39;) <span class="ot">=&gt;</span> <span class="dt">Adjunction</span> (<span class="dt">Sum</span> f f&#39;) (<span class="dt">Product</span> g g&#39;)</span></code></pre></div>
<p>Hrmm, still not the most helpful, most of these instances depend on some underlying functor ALREADY having an adjunction so those won't tell us how to implement one. I see one for <code>Adjunction Identity Identity</code>, but something tells me that's not going to provide much depth either. Let's dive into the one remaining example: <code>Adjunction ((,) e) ((-&gt;) e)</code></p>
<p>This one looks a little funny if you're not used to type sigs for functions and tuples, but it gets a lot easier to read if we substitute it into the typeclass methods. To specialize for the tuple/function adjunction we'll replace every <code>f a</code> with <code>(e, a)</code> and each <code>u a</code> with <code>e -&gt; a</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">-- Tuple/Function adjunction specializations:</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="ot">tfUnit ::</span> a <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> (e, a))</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="ot">tfCounit ::</span> (e, (e <span class="ot">-&gt;</span> a)) <span class="ot">-&gt;</span> a</span>
<span id="cb4-4"><a href="#cb4-4"></a>tfLeftAdjunct,<span class="ot"> tfLeftAdjunct&#39;  ::</span> ((e, a) <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> b)</span>
<span id="cb4-5"><a href="#cb4-5"></a>tfRightAdjunct,<span class="ot"> tfRightAdjunct&#39; ::</span> (a <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> b)) <span class="ot">-&gt;</span> (e, a) <span class="ot">-&gt;</span> b</span></code></pre></div>
<p>Hrmm, okay! That's a bit confusing but it's something we can work with. Let's try to implement the functions! We'll implement our specialized versions so as not to collide with the existing instance.</p>
<p>Unit and Counit are good starting points for understanding an adjunction. The minimal definition of an adjunction is (unit AND counit) OR (leftAdjunct AND rightAdjunct). That lets us know that unit and counit can themselves represent the entire adjunction (i.e. leftAdjunct and rightAdjunct can be implemented in terms of unit and counit; or vice versa).</p>
<p>Starting with <code>unit</code> we see from the type <code>a -&gt; (e -&gt; (e, a))</code> that we need to take an arbitrary 'a' and embed it into a function which returns a tuple of the same type as the function. Well, there's pretty much only one way I can think to make this work!</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a>tfUnit a <span class="ot">=</span> \e <span class="ot">-&gt;</span> (e, a)</span></code></pre></div>
<p>Solid! We just converted the type signature into an implementation. One down, three to go. This may not provide much insight, but don't worry we'll get there yet. Next is counit which essentially does the opposite, exactly one implementation seems clear to me: <code>(e, (e -&gt; a)) -&gt; a</code></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a>tfCounit (e, eToA) <span class="ot">=</span> eToA e</span></code></pre></div>
<p>If we stop here for a minute we can notice a few things, we built this adjunction out of two functors, <code>(e, a)</code> and <code>e -&gt; a</code>. These functors have a unique relationship to one another in that they both hold <em>pieces</em> of the whole picture, the tuple has an 'e' but doesn't know what to do with it, while <code>e -&gt; a</code> knows what to do with an 'e' but doesn't have one to work with! Only when we pair the functors together do we have the full story!</p>
<p>The next thing to notice is that these functors are only readily useful when nested in a specific ordering, we can write a counit which takes <code>(e, (e -&gt; a)) -&gt; a</code>, BUT if we tried to put the function on the outside instead: <code>(e -&gt; (e, a)) -&gt; a</code>; we have no way to get our 'a' out without having more information since the 'e' is now hidden inside! This non-symmetric relationship shows us that the nesting of functors matters. This is why we refer to the functors in an adjunction as either <code>left adjoint</code> or <code>right adjoint</code>; (<code>f</code> and <code>u</code> respectively).</p>
<p>In our case <code>(e,)</code> is left adjoint and <code>(e -&gt;)</code> is right adjoint. This is probably still a bit confusing and that's okay! Try to hold on until we get to start playing Battleship and I promise we'll have a more concrete example! One more thing first, let's see how leftAdjunct and rightAdjunct play out for our tuple/function adjunction.</p>
<p>Here's a refresher of the types:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">tfLeftAdjunct ::</span> ((e, a) <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> b)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ot">tfRightAdjunct ::</span> (a <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> b)) <span class="ot">-&gt;</span> (e, a) <span class="ot">-&gt;</span> b</span></code></pre></div>
<p>Now that we've written 'unit' and 'counit' we can implement these other functions in terms of those. I'll provide two implementations here; one using unit/counit and one without.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a>tfLeftAdjunct f <span class="ot">=</span> <span class="fu">fmap</span> f <span class="op">.</span> tfUnit</span>
<span id="cb8-2"><a href="#cb8-2"></a>tfRightAdjunct f <span class="ot">=</span> tfCounit <span class="op">.</span> <span class="fu">fmap</span> f</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a>tfLeftAdjunct&#39; eaToB a <span class="ot">=</span> \e <span class="ot">-&gt;</span> eaToB (e, a)</span>
<span id="cb9-2"><a href="#cb9-2"></a>tfRightAdjunct&#39; aToEToB (e, a) <span class="ot">=</span> aToEToB a e</span></code></pre></div>
<p>We can see from the first set of implementations that <code>leftAdjunct</code> somehow 'lifts' a function that we give it from one that operates over the left-hand functor into a result within the right-hand functor.</p>
<p>Similarly <code>rightAdjunct</code> takes a function which results in a value in left-hand functor, and when given an argument embedded in the left-hand functor gives us the result. The first set of implementations know nothing about the functors in specific, which shows that if we write unit and counit we can let the default implementations take over for the rest.</p>
<p>If you're keen you'll notice that this adjunction represents the curry and uncurry functions! Can you see it?</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="ot">tfLeftAdjunct ::</span> ((e, a) <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> b)</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">curry</span><span class="ot"> ::</span> ((a, b) <span class="ot">-&gt;</span> c) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> c</span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="ot">tfRightAdjunct ::</span> (a <span class="ot">-&gt;</span> (e <span class="ot">-&gt;</span> b)) <span class="ot">-&gt;</span> (e, a) <span class="ot">-&gt;</span> b</span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="fu">uncurry</span><span class="ot"> ::</span> (a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> c) <span class="ot">-&gt;</span> (a, b) <span class="ot">-&gt;</span> c</span></code></pre></div>
<p>I haven't gotten to a point where I can prove it yet, but I believe all adjunctions are actually isomorphic to this curry/uncurry adjunction! Maybe someone reading can help me out with the proof.</p>
<p>Again, it's fun to see this play out, but where are the practical applications?? Let's play a game. It's time to see if we can match these shapes and patterns to a real(ish) problem. We're going to make a mini game of Battleship, an old board game where players can guess where their opponents ships are hiding within a grid and see if they can hit them! We'll start by setting up some data-types and some pre-requisite instances, then we'll tie it all together with an Adjunction!</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">data</span> <span class="dt">Row</span> <span class="ot">=</span> <span class="dt">A</span> <span class="op">|</span> <span class="dt">B</span> <span class="op">|</span> <span class="dt">C</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="kw">data</span> <span class="dt">Column</span> <span class="ot">=</span> <span class="dt">I</span> <span class="op">|</span> <span class="dt">II</span> <span class="op">|</span> <span class="dt">III</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co">-- I&#39;m going to define this as a Functor type to save time later, but for now</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co">-- we&#39;ll use the alias Coord;</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="kw">data</span> <span class="dt">CoordF</span> a <span class="ot">=</span> <span class="dt">CoordF</span> <span class="dt">Row</span> <span class="dt">Column</span> a</span>
<span id="cb11-8"><a href="#cb11-8"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="kw">type</span> <span class="dt">Coord</span> <span class="ot">=</span> <span class="dt">CoordF</span> ()</span></code></pre></div>
<p>Each cell can hold a Vessel of some kind, maybe a Ship or Submarine; It's also possible for a cell to be empty.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">data</span> <span class="dt">Vessel</span> <span class="ot">=</span> <span class="dt">Ship</span> <span class="op">|</span> <span class="dt">Sub</span> <span class="op">|</span> <span class="dt">Sunk</span> <span class="op">|</span> <span class="dt">Empty</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span></code></pre></div>
<p>We'll start with a 3x3 board to keep it simple, each row is represented by a 3-tuple. We've learned by now that making our types into Functors makes them more usable, so I'm going to define the board as a functor parameterized over the contents of each cell.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">data</span> <span class="dt">Board</span> a <span class="ot">=</span> <span class="dt">Board</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  (a, a, a)</span>
<span id="cb13-3"><a href="#cb13-3"></a>  (a, a, a)</span>
<span id="cb13-4"><a href="#cb13-4"></a>  (a, a, a)</span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Functor</span>)</span></code></pre></div>
<p>I'm going to add a quick Show instance, it's not perfect but it lets us see the board!</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">instance</span> (<span class="dt">Show</span> a) <span class="ot">=&gt;</span> <span class="dt">Show</span> (<span class="dt">Board</span> a) <span class="kw">where</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">show</span> (<span class="dt">Board</span> top middle bottom) <span class="ot">=</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="st">&quot;       I  |  II | III\n&quot;</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="op">++</span> <span class="st">&quot;A   &quot;</span> <span class="op">++</span> <span class="fu">show</span> top <span class="op">++</span> <span class="st">&quot;\n&quot;</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="op">++</span> <span class="st">&quot;B   &quot;</span> <span class="op">++</span> <span class="fu">show</span> middle <span class="op">++</span> <span class="st">&quot;\n&quot;</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="op">++</span> <span class="st">&quot;C   &quot;</span> <span class="op">++</span> <span class="fu">show</span> bottom <span class="op">++</span> <span class="st">&quot;\n&quot;</span></span></code></pre></div>
<p>Here's a good starting position, the board is completely empty!</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="ot">startBoard ::</span> <span class="dt">Board</span> <span class="dt">Vessel</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>startBoard <span class="ot">=</span> <span class="dt">Board</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  (<span class="dt">Empty</span>, <span class="dt">Empty</span>, <span class="dt">Empty</span>)</span>
<span id="cb15-4"><a href="#cb15-4"></a>  (<span class="dt">Empty</span>, <span class="dt">Empty</span>, <span class="dt">Empty</span>)</span>
<span id="cb15-5"><a href="#cb15-5"></a>  (<span class="dt">Empty</span>, <span class="dt">Empty</span>, <span class="dt">Empty</span>)</span></code></pre></div>
<p>It's at this point we want to start making guesses using a Coord and seeing what's in each position! How else are we going to sink the battleship? Well, when we start talking about 'Indexing' into our board (which is a functor) I think immediately of the Representable typeclass from <a href="https://hackage.haskell.org/package/adjunctions-4.3/docs/Dat%20a-Functor-Rep.html#t:Representable">Data.Functor.Rep</a>. Don't let the name scare you, one of the things that Representable gives you is the notion of <em>indexing</em> into a functor.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">instance</span> <span class="dt">Representable</span> <span class="dt">Board</span> <span class="kw">where</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="co">-- We index into our functor using Coord</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="kw">type</span> <span class="dt">Rep</span> <span class="dt">Board</span> <span class="ot">=</span> <span class="dt">Coord</span></span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="co">-- Given an index and a board, pull out the matching cell</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="fu">index</span> (<span class="dt">Board</span> (a, _, _) _ _) (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">I</span> _) <span class="ot">=</span> a</span>
<span id="cb16-7"><a href="#cb16-7"></a>  <span class="fu">index</span> (<span class="dt">Board</span> (_, a, _) _ _) (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">II</span> _) <span class="ot">=</span> a</span>
<span id="cb16-8"><a href="#cb16-8"></a>  <span class="fu">index</span> (<span class="dt">Board</span> (_, _, a) _ _) (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">III</span> _) <span class="ot">=</span> a</span>
<span id="cb16-9"><a href="#cb16-9"></a>  <span class="fu">index</span> (<span class="dt">Board</span> _ (a, _, _) _) (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">I</span> _) <span class="ot">=</span> a</span>
<span id="cb16-10"><a href="#cb16-10"></a>  <span class="fu">index</span> (<span class="dt">Board</span> _ (_, a, _) _) (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">II</span> _) <span class="ot">=</span> a</span>
<span id="cb16-11"><a href="#cb16-11"></a>  <span class="fu">index</span> (<span class="dt">Board</span> _ (_, _, a) _) (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">III</span> _) <span class="ot">=</span> a</span>
<span id="cb16-12"><a href="#cb16-12"></a>  <span class="fu">index</span> (<span class="dt">Board</span> _ _ (a, _, _)) (<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">I</span> _) <span class="ot">=</span> a</span>
<span id="cb16-13"><a href="#cb16-13"></a>  <span class="fu">index</span> (<span class="dt">Board</span> _ _ (_, a, _)) (<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">II</span> _) <span class="ot">=</span> a</span>
<span id="cb16-14"><a href="#cb16-14"></a>  <span class="fu">index</span> (<span class="dt">Board</span> _ _ (_, _, a)) (<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">III</span> _) <span class="ot">=</span> a</span>
<span id="cb16-15"><a href="#cb16-15"></a></span>
<span id="cb16-16"><a href="#cb16-16"></a>  <span class="co">-- Given a function which describes a slot, build a Board</span></span>
<span id="cb16-17"><a href="#cb16-17"></a>  tabulate desc <span class="ot">=</span> <span class="dt">Board</span></span>
<span id="cb16-18"><a href="#cb16-18"></a>      (desc (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">I</span> ()), desc (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">II</span> ()), desc (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">III</span> ()))</span>
<span id="cb16-19"><a href="#cb16-19"></a>      (desc (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">I</span> ()), desc (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">II</span> ()), desc (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">III</span> ()))</span>
<span id="cb16-20"><a href="#cb16-20"></a>      (desc (<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">I</span> ()), desc (<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">II</span> ()), desc (<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">III</span> ()))</span></code></pre></div>
<p>If you find it easier to implement unit and counit (which we'll explore soon) you can implement those and then use <code>indexAdjunction</code> and <code>tabulateAdjunction</code> provided by Data.Functor.Adjunction as your implementations for your Representable instance.</p>
<p>For Representable we also have a prerequisite of Distributive from <a href="https://hackage.haskell.org/package/distributive-0.5.0.2/do%20cs/Data-Distributive.html#t:Distributive">Data.Distributive</a>, All Representable functors are also Distributive and this library has decided to make that an explicit requirement.</p>
<p>No problem though, it turns out that since every Representable is Distributive that Data.Functor.Rep has a <code>distributeRep</code> function which provides an appropriate implementation for us for free! We just need to slot it in:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">instance</span> <span class="dt">Distributive</span> <span class="dt">Board</span> <span class="kw">where</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  distribute <span class="ot">=</span> distributeRep</span></code></pre></div>
<p>Phew! A lot of work there, but now we can do some cool stuff! Let's say that as a player we want to build a game board with some ships on it. We now have two choices, we can either define a board and put some ships on it, or define a function which says what's at a given coordinate and use that to build a board. Let's do both, for PEDAGOGY!</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a><span class="ot">myBoard1 ::</span> <span class="dt">Board</span> <span class="dt">Vessel</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>myBoard1 <span class="ot">=</span> <span class="dt">Board</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  (<span class="dt">Empty</span>, <span class="dt">Empty</span>, <span class="dt">Ship</span>)</span>
<span id="cb18-4"><a href="#cb18-4"></a>  (<span class="dt">Sub</span>,   <span class="dt">Empty</span>, <span class="dt">Sub</span>)</span>
<span id="cb18-5"><a href="#cb18-5"></a>  (<span class="dt">Ship</span>,  <span class="dt">Empty</span>, <span class="dt">Empty</span>)</span>
<span id="cb18-6"><a href="#cb18-6"></a></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="co">-- Now we&#39;ll define the same board using a function</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="ot">define ::</span> <span class="dt">Coord</span> <span class="ot">-&gt;</span> <span class="dt">Vessel</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>define (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">III</span> _) <span class="ot">=</span> <span class="dt">Ship</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>define (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">I</span> _) <span class="ot">=</span> <span class="dt">Sub</span></span>
<span id="cb18-11"><a href="#cb18-11"></a>define (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">III</span> _) <span class="ot">=</span> <span class="dt">Sub</span></span>
<span id="cb18-12"><a href="#cb18-12"></a>define (<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">I</span> _) <span class="ot">=</span> <span class="dt">Ship</span></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="co">-- Otherwise it&#39;s Empty!</span></span>
<span id="cb18-14"><a href="#cb18-14"></a>define _ <span class="ot">=</span> <span class="dt">Empty</span></span>
<span id="cb18-15"><a href="#cb18-15"></a></span>
<span id="cb18-16"><a href="#cb18-16"></a><span class="co">-- Now we build up a board using our descriptor function.</span></span>
<span id="cb18-17"><a href="#cb18-17"></a><span class="co">-- Notice that (myBoard1 == myBoard2)</span></span>
<span id="cb18-18"><a href="#cb18-18"></a><span class="ot">myBoard2 ::</span> <span class="dt">Board</span> <span class="dt">Vessel</span></span>
<span id="cb18-19"><a href="#cb18-19"></a>myBoard2 <span class="ot">=</span> tabulate define</span></code></pre></div>
<p>Okay this is already pretty cool; but I <em>DID</em> promise we'd use an adjunction here somewhere, but for that we need TWO functors. Remember how CoordF is actually a functor hidden undernath Coord? We can use that! This functor doesn't make much sense on its own, but the important bit is that it's a functor which contains part of the information about our system. Remember that only one of our functors needs to be Representable in an Adjunction, so we can take it easy and don't need to worry about Distributive or Representable for CoordF</p>
<p>Now for the good stuff; let's crack out Adjunction and see if we can write an instance!</p>
<p>I'm lazy, so I'm going to rely on Representable to do the dirty work, Embedding an a into a Board filled with coordinates and values doesn't make a ton of sense, but the most sensible way that I can think of to do that is to put the a in every slot where the Coord represents the index of the cell its in.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">instance</span> <span class="dt">Adjunction</span> <span class="dt">CoordF</span> <span class="dt">Board</span> <span class="kw">where</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="ot">  unit ::</span> a <span class="ot">-&gt;</span> <span class="dt">Board</span> (<span class="dt">CoordF</span> a)</span>
<span id="cb19-3"><a href="#cb19-3"></a>  unit a <span class="ot">=</span> tabulate (\(<span class="dt">CoordF</span> row col ()) <span class="ot">-&gt;</span> <span class="dt">CoordF</span> row col a)</span></code></pre></div>
<p>Counit actually makes sense in this case! We have our two pieces of info which form the parts of the adjunction; The board contains the values in ALL positions and the CoordF contains info which tells us exactly WHICH position we're currently interested in.</p>
<p>For counit I'm just going to use index to pull the value out of the underlying board.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1"></a><span class="ot">  counit ::</span> <span class="dt">CoordF</span> (<span class="dt">Board</span> a) <span class="ot">-&gt;</span> a</span>
<span id="cb20-2"><a href="#cb20-2"></a>  counit (<span class="dt">CoordF</span> row col board) <span class="ot">=</span> <span class="fu">index</span> board (<span class="dt">CoordF</span> row col ())</span></code></pre></div>
<p>Done! We've written our Adjunction, let's keep building to game to see how we can use the system! Here're the other type sigs for our Adjunction:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1"></a><span class="ot">leftAdjunct  ::</span> (<span class="dt">CoordF</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Board</span> b</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="ot">rightAdjunct ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Board</span> b) <span class="ot">-&gt;</span> <span class="dt">CoordF</span> a <span class="ot">-&gt;</span> b</span></code></pre></div>
<p>First let's observe unit and co-unit in action!</p>
<p><code>unit</code> Always does the naive thing, so if we pass it a Vessel it'll just set the whole board to that value; note that each slot is also labelled with its index!</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1"></a>λ<span class="op">&gt;</span> unit <span class="dt">Ship</span><span class="ot"> ::</span> <span class="dt">Board</span> (<span class="dt">CoordF</span> <span class="dt">Vessel</span>)</span>
<span id="cb22-2"><a href="#cb22-2"></a>       <span class="dt">A</span>  <span class="op">|</span>  <span class="dt">B</span>  <span class="op">|</span> <span class="dt">C</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="dt">I</span>   (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">I</span> <span class="dt">Ship</span>,<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">II</span> <span class="dt">Ship</span>,<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">III</span> <span class="dt">Ship</span>)</span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="dt">II</span>  (<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">I</span> <span class="dt">Ship</span>,<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">II</span> <span class="dt">Ship</span>,<span class="dt">CoordF</span> <span class="dt">B</span> <span class="dt">III</span> <span class="dt">Ship</span>)</span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="dt">III</span> (<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">I</span> <span class="dt">Ship</span>,<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">II</span> <span class="dt">Ship</span>,<span class="dt">CoordF</span> <span class="dt">C</span> <span class="dt">III</span> <span class="dt">Ship</span>)</span></code></pre></div>
<p>If we already have our game board and also have an index then counit folds down the structure by choosing the index specified by the outer CoordF Functor.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1"></a><span class="co">-- Remember our board:</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>λ<span class="op">&gt;</span> myBoard1</span>
<span id="cb23-3"><a href="#cb23-3"></a>       <span class="dt">A</span>  <span class="op">|</span>  <span class="dt">B</span>  <span class="op">|</span> <span class="dt">C</span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="dt">I</span>   (<span class="dt">Empty</span>,<span class="dt">Empty</span>,<span class="dt">Ship</span>)</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="dt">II</span>  (<span class="dt">Sub</span>,<span class="dt">Empty</span>,<span class="dt">Sub</span>)</span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="dt">III</span> (<span class="dt">Ship</span>,<span class="dt">Empty</span>,<span class="dt">Empty</span>)</span>
<span id="cb23-7"><a href="#cb23-7"></a></span>
<span id="cb23-8"><a href="#cb23-8"></a>λ<span class="op">&gt;</span> counit <span class="op">.</span> <span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">III</span> <span class="op">$</span> myBoard1</span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="dt">Ship</span></span></code></pre></div>
<p>So what about leftAdjunct and rightAdjunct? Conceptually you can think of these as functions which let you operate over one piece of information and the Adjunction will form the other piece of information for you! For instance leftAdjunct:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1"></a><span class="ot">leftAdjunct  ::</span> (<span class="dt">CoordF</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Board</span> b</span></code></pre></div>
<p>lets you build a value in the right adjoint functor by specifying how to handle each index, this is similar to <code>tabulate</code> from from Representable. Earlier we used tabulate to generate a game board from a shoot function, we can do the same thing using leftAdjunct, we could re-implement our <code>shoot</code> function from above in terms of leftAdjunct:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1"></a><span class="ot">myBoard3 ::</span> <span class="dt">Board</span> <span class="dt">Vessel</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>myBoard3 <span class="ot">=</span> leftAdjunct define ()</span></code></pre></div>
<p>Right adjunct works similarly, but in reverse! Given a way to create a board from a solitary value we can extract a value from the board matching some CoordF. Just like leftAdjunct lines up with 'tabulate', rightAdjunct lines up with 'index', but with a smidge of extra functionality.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1"></a><span class="ot">rightAdjunct ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Board</span> b) <span class="ot">-&gt;</span> <span class="dt">CoordF</span> a <span class="ot">-&gt;</span> b</span></code></pre></div>
<p>I don't have any illuminating uses of rightAdjunct for our Battleship example, but you can use it to reimplement 'index' from Representable if you like!</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1"></a><span class="ot">myIndex ::</span> <span class="dt">Board</span> a <span class="ot">-&gt;</span> <span class="dt">CoordF</span> () <span class="ot">-&gt;</span> a</span>
<span id="cb27-2"><a href="#cb27-2"></a>myIndex board coord <span class="ot">=</span> rightAdjunct (<span class="fu">const</span> board) coord</span></code></pre></div>
<p>Cool, now let's try and make this game a little more functional!</p>
<p>Already we've got most of the basics for a simple game of battleship, earlier we defined a game board in terms of a 'firing' function, now let's write a function which takes a game board and mutates it according to a player's layout.</p>
<p>War has changed over the years so our version of battleship is going to be a bit more interesting than the traditional version. In our case each player places ships OR submarines on each square, and when firing on a square they may fire either a torpedo (hits ships) OR a depth charge (hits subs).</p>
<p>This means that we need a way to check not only if a cell is occupied, but also if the vessel there can be hit by the weapon which was fired! For this we'll take a look at the useful but vaguely named <code>zapWithAdjunction</code> function.</p>
<p>This function has its roots in an 'Pairing' typeclass which eventually was absorbed by Adjunction. The idea of a Functor Pairing is that there's a relationship between the structure of the two paired functors regardless of what's inside. Sounds like an adjunction right?? <code>zapWithAdjunction</code> looks like this:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1"></a><span class="ot">zapWithAdjunction ::</span> <span class="dt">Adjunction</span> f u <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> c) <span class="ot">-&gt;</span> u a <span class="ot">-&gt;</span> f b <span class="ot">-&gt;</span> c</span></code></pre></div>
<p>or for our types:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1"></a><span class="ot">zapWithAdjunction ::</span> (a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> c) <span class="ot">-&gt;</span> <span class="dt">Board</span> a <span class="ot">-&gt;</span> <span class="dt">CoordF</span> b <span class="ot">-&gt;</span> c</span></code></pre></div>
<p>So it pairs a Board and Coord together, but applies a function <em>across</em> the values stored there. It uses the adjunction to do this, so it will automagically choose the 'right' value from the Board to apply with the value from the CoordF!</p>
<p>First we need weapons!</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">data</span> <span class="dt">Weapon</span> <span class="ot">=</span> <span class="dt">Torpedo</span> <span class="op">|</span> <span class="dt">DepthCharge</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span></code></pre></div>
<p>Now we can write something like this:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1"></a><span class="ot">checkHit ::</span> <span class="dt">Vessel</span> <span class="ot">-&gt;</span> <span class="dt">Weapon</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>checkHit <span class="dt">Ship</span> <span class="dt">Torpedo</span> <span class="ot">=</span> <span class="dt">True</span></span>
<span id="cb31-3"><a href="#cb31-3"></a>checkHit <span class="dt">Sub</span> <span class="dt">DepthCharge</span> <span class="ot">=</span> <span class="dt">True</span></span>
<span id="cb31-4"><a href="#cb31-4"></a>checkHit _ _ <span class="ot">=</span> <span class="dt">False</span></span>
<span id="cb31-5"><a href="#cb31-5"></a></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="ot">shoot ::</span> <span class="dt">Board</span> <span class="dt">Vessel</span> <span class="ot">-&gt;</span> <span class="dt">CoordF</span> <span class="dt">Weapon</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb31-7"><a href="#cb31-7"></a>shoot <span class="ot">=</span> zapWithAdjunction checkHit</span></code></pre></div>
<p>And of course we can try that out!</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1"></a>λ<span class="op">&gt;</span> myBoard1</span>
<span id="cb32-2"><a href="#cb32-2"></a>       <span class="dt">A</span>  <span class="op">|</span>  <span class="dt">B</span>  <span class="op">|</span> <span class="dt">C</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="dt">I</span>   (<span class="dt">Empty</span>,<span class="dt">Empty</span>,<span class="dt">Ship</span>)</span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="dt">II</span>  (<span class="dt">Sub</span>,<span class="dt">Empty</span>,<span class="dt">Sub</span>)</span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="dt">III</span> (<span class="dt">Ship</span>,<span class="dt">Empty</span>,<span class="dt">Empty</span>)</span>
<span id="cb32-6"><a href="#cb32-6"></a>λ<span class="op">&gt;</span> shoot myBoard1 (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">III</span> <span class="dt">Torpedo</span>)</span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="dt">True</span></span>
<span id="cb32-8"><a href="#cb32-8"></a>λ<span class="op">&gt;</span> shoot myBoard1 (<span class="dt">CoordF</span> <span class="dt">A</span> <span class="dt">III</span> <span class="dt">DepthCharge</span>)</span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="dt">False</span></span></code></pre></div>
<p>It's really unique how Adjunctions let us specify our data as a functor like this!</p>
<p>Now what if we want to see what happens at each spot in the board if we hit it with a Torpedo OR a DepthCharge? No problem;</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1"></a><span class="ot">hitMap ::</span> <span class="dt">Board</span> (<span class="dt">Bool</span>, <span class="dt">Bool</span>)</span>
<span id="cb33-2"><a href="#cb33-2"></a>hitMap <span class="ot">=</span> <span class="fu">fmap</span> (<span class="fu">flip</span> checkHit <span class="dt">Torpedo</span> <span class="op">&amp;&amp;&amp;</span> <span class="fu">flip</span> checkHit <span class="dt">DepthCharge</span>) myBoard1</span></code></pre></div>
<p>We use (&amp;&amp;&amp;) from Control.Arrow which combines two functions which take the same input and makes a single function which returns a tuple!</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1"></a><span class="ot">(&amp;&amp;&amp;) ::</span> <span class="dt">Arrow</span> a <span class="ot">=&gt;</span> a b c <span class="ot">-&gt;</span> a b c&#39; <span class="ot">-&gt;</span> a b (c, c&#39;)</span></code></pre></div>
<p>Now we've got a <code>Board (Bool, Bool)</code>, Since the right adjoint functor (Board) is distributive, flipping the the tuple to the outside is trivial:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb35-1"><a href="#cb35-1"></a><span class="ot">hitMap&#39; ::</span> (<span class="dt">Board</span> <span class="dt">Bool</span>, <span class="dt">Board</span> <span class="dt">Bool</span>)</span>
<span id="cb35-2"><a href="#cb35-2"></a>hitMap&#39; <span class="ot">=</span> unzipR hitMap</span></code></pre></div>
<p>Now we've got two Boards, showing where we could get a hit if we used a Torpedo or DepthCharge respectively.</p>
<p>Most of the functions we've written are a bit contrived. Sometimes the adjunction-based approach was a bit clunkier than just writing a simple function to do what you needed on a Board, but I hope this provides some form of intuition for adjunctions. Good luck!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Zippers using Representable and Cofree</title>
      <link href="https://chrispenner.ca/posts/representable-cofree-zippers"/>
      <id>https://chrispenner.ca/posts/representable-cofree-zippers</id>
      <updated>2017-07-05T00:00:00Z</updated>
      <summary>Using Representable and Cofree to build a zipper datatype</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/math.jpeg" alt="Zippers using Representable and Cofree">
              <p>We're going to take a look at an alternative way to define a Zipper Comonad over a data type. Typically one would define a Zipper Comonad by defining a new datatype which represents the Zipper; then implementing <code>duplicate</code> and <code>extract</code> for it. <code>extract</code> is typically straightforward to write, but I've had some serious trouble writing <code>duplicate</code> for some more complex data-types like trees.</p>
<p>We're looking at a different way of building a zipper, The advantages of this method are that we can build it up out of smaller instances piece by piece. Each piece is a easier to write, and we also gain several utility functions from the Typeclasses we'll be implementing along the way! It's not terribly practical, but it's a fun experiment.</p>
<p>You can find this post as a literate haskell file <a href="https://gist.github.com/ChrisPenner/4527dd0d9c60983562e03c28731bb3bd">here</a> so that means you can load it up directly in GHC and play around with it if you want to follow along! Let's get started.</p>
<p>First we'll need a few language extensions, In case you're wondering; TypeFamilies is used by the <code>Representable</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">{-# language DeriveFunctor #-}</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ot">{-# language TypeFamilies #-}</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ot">{-# language InstanceSigs #-}</span></span></code></pre></div>
<p>We're going to be writing a Zipper into a list. In case you're unfamiliar, a zipper is essentially a 'view' into a structure which is focused on a single element. We'll call our focused view into a list a 'Tape'</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">module</span> <span class="dt">Tape</span> <span class="kw">where</span></span></code></pre></div>
<p>Go ahead and import everything we'll need:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">-- http://hackage.haskell.org/package/comonad-5/docs/Control-Comonad.html#t:Comonad</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">import</span> <span class="dt">Control.Comonad</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">-- http://hackage.haskell.org/package/free-4.12.4/docs/Control-Comonad-Cofree.html</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">import</span> <span class="dt">Control.Comonad.Cofree</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">-- https://hackage.haskell.org/package/distributive-0.5.0.2/docs/Data-Distributive.html#t:Distributive</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="kw">import</span> <span class="dt">Data.Distributive</span></span>
<span id="cb3-7"><a href="#cb3-7"></a> <span class="co">-- https://hackage.haskell.org/package/adjunctions-4.3/docs/Data-Functor-Rep.html#t:Representable</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="kw">import</span> <span class="dt">Data.Functor.Rep</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">-- https://hackage.haskell.org/package/containers-0.5.10.2/docs/Data-Sequence.html</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Sequence</span> <span class="kw">as</span> <span class="dt">S</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">-- https://hackage.haskell.org/package/base-4.9.1.0/docs/Data-List-NonEmpty.html</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.List.NonEmpty</span> <span class="kw">as</span> <span class="dt">NE</span></span></code></pre></div>
<p>Great! At this point one would typically define their zipper data type, which for lists would look like: <code>data Tape a = Tape [a] a [a]</code>, This represents the idea of having a single element of the list 'under focus' with other elements to the left and right.</p>
<p>We're trying something different, we're going to define TWO types. One type which represents all of the POSSIBLE movements, and one which represents a CHOICE of a specific movement.</p>
<p>First we'll define the possible movements in our tape using the PRODUCT tape <code>TPossible</code>, we'll have a slot in our structure for both leftward and rightward movements:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">data</span> <span class="dt">TPossible</span> a <span class="ot">=</span> <span class="dt">TPossible</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  {<span class="ot"> leftward ::</span> a</span>
<span id="cb4-3"><a href="#cb4-3"></a>  ,<span class="ot"> rightward ::</span> a</span>
<span id="cb4-4"><a href="#cb4-4"></a>  } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Functor</span>)</span></code></pre></div>
<p>We're deriving Functor here too, that'll come in handy later.</p>
<p>Next we represent a choice of direction as a SUM type, i.e. we can choose to go either LEFT or RIGHT at any given focus in the list.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">data</span> <span class="dt">TChoice</span> <span class="ot">=</span> <span class="dt">L</span> <span class="op">|</span> <span class="dt">R</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span></code></pre></div>
<p>Notice that each piece contains a different piece of the information we need, a value in <code>TPossible</code> knows what's to the left or right, a value in <code>TChoice</code> knows which way to move, but not what's there. This sort of relationship shows us that <code>TPossible</code> is a <code>Representable Functor</code>.</p>
<p>Let's talk about what that means. A Representable Functor is any functor from which you can extract elements by giving it an index. That is; it's any functor that you can describe completely using a function from an index to a value. Given <code>Index -&gt; a</code> you can build up an <code>f a</code> if you have a relationship between <code>Index</code> and <code>f</code>!</p>
<p>In our case we have such a relationship; and if we have a function <code>TChoice -&gt; a</code> we could build up a <code>TPossible a</code> by calling the function for the leftward and rightward slots using <code>L</code> and <code>R</code> respectively.</p>
<p>But we're getting a bit ahead of ourselves; we'll need to build up a Distributive Instance first, it's a pre-requisite for the Representable class, and in fact every instance of Representable is also Distributive; If we like we can actually just implement Representative and use <code>distributeRep</code> from <code>Data.Functor.Rep</code> as your implementation of Distributive, but we'll do it the long way here.</p>
<p>Distributive can seem strange if you haven't worked with it before, it's the dual of Traversable; Traversable can pull out other Applicative Effects from within its structure, and so Distributive can pull its own structure from any functor to the outside. You can define an instance by implementing either <code>distribute</code> or <code>collect</code>.</p>
<p>Here're the signatures:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="ot">distribute ::</span> <span class="dt">Functor</span> f <span class="ot">=&gt;</span> f (g a) <span class="ot">-&gt;</span> g (f a)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ot">collect ::</span> <span class="dt">Functor</span> f <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> g b) <span class="ot">-&gt;</span> f a <span class="ot">-&gt;</span> g (f b)</span></code></pre></div>
<p>Let's see a few examples to solidify the idea:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">distribute ::</span> [<span class="dt">Identity</span> a] <span class="ot">-&gt;</span> <span class="dt">Identity</span> [a]</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ot">distribute ::</span> [<span class="dt">Bool</span> <span class="ot">-&gt;</span> a] <span class="ot">-&gt;</span> (<span class="dt">Bool</span> <span class="ot">-&gt;</span> [a])</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="ot">distribute ::</span> [<span class="dt">TPossible</span> a] <span class="ot">-&gt;</span> <span class="dt">TPossible</span> [a]</span></code></pre></div>
<p>The list here could be ANY functor, I just used lists because it's something most people are familiar with. In many cases sequence and distribute are interchangeable since a lot of types have reasonableApplicative instances, but it's important to note that <code>distribute</code> pulls a distributive functor OUT from any wrapping functor while <code>sequence</code> from Data.Traversable pushes a traversable INTO a wrapping Applicative.</p>
<p>A good intuition for determining whether a functor is distributive is to ask whether values of that functor (f a) always have the same number of elements of 'a'. If they do, and they don't have extra information aside from their structure, then it's probably distributive. Note that this means that we actually can't define Distributive for finite-length lists, give it a try if you don't believe me!</p>
<p>We've got exactly two slots in EVERY <code>TPossible</code> so we can implement distribute by creating an outer <code>TPossible</code> where the left slot is the functor containing all the left values and likewise for the right slot.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">instance</span> <span class="dt">Distributive</span> <span class="dt">TPossible</span> <span class="kw">where</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ot">  distribute ::</span> <span class="dt">Functor</span> f <span class="ot">=&gt;</span> f (<span class="dt">TPossible</span> a) <span class="ot">-&gt;</span> <span class="dt">TPossible</span> (f a)</span>
<span id="cb8-3"><a href="#cb8-3"></a>  distribute fga <span class="ot">=</span> <span class="dt">TPossible</span> (<span class="fu">fmap</span> leftward fga) (<span class="fu">fmap</span> rightward fga)</span></code></pre></div>
<p>Now that's out of the way, let's get back to Representable! Remembering our previous definition <code>TPossible</code> is Representable because it has exactly two slots, a left and a right which can be indexed by <code>TChoice</code>! We need 3 things for an instance of Representable:</p>
<ul>
<li>A type which represents our index (called Rep)</li>
<li><code>index</code> which pulls out the value at a given index.</li>
<li><code>tabulate</code> which builds up an object from a function.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">instance</span> <span class="dt">Representable</span> <span class="dt">TPossible</span> <span class="kw">where</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="kw">type</span> <span class="dt">Rep</span> <span class="dt">TPossible</span> <span class="ot">=</span> <span class="dt">TChoice</span></span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="ot">  index ::</span> <span class="dt">TPossible</span> a <span class="ot">-&gt;</span> <span class="dt">TChoice</span> <span class="ot">-&gt;</span> a</span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="fu">index</span> (<span class="dt">TPossible</span> l _) <span class="dt">L</span> <span class="ot">=</span> l</span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="fu">index</span> (<span class="dt">TPossible</span> _ r) <span class="dt">R</span> <span class="ot">=</span> r</span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="ot">  tabulate ::</span> (<span class="dt">TChoice</span> <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">TPossible</span> a</span>
<span id="cb9-9"><a href="#cb9-9"></a>  tabulate describe <span class="ot">=</span> <span class="dt">TPossible</span> (describe <span class="dt">L</span>) (describe <span class="dt">R</span>)</span></code></pre></div>
<p>We're moving along quick! We've got the necessary tools to index into our <code>TPossible</code> structure, which we can use to follow a 'path' through the zipper to find an element, but currently we only have a way to represent a single choice of direction at once. We can say we want to move right using 'R', but then we're stuck! Similarly with <code>TPossible</code> we have places to store the value to the left and right, but can't check the value at the current position! We can solve the problem by wrapping our <code>TPossible</code> in Cofree!</p>
<p>Cofree allows us to promote a functor that we have into a Comonad by ensuring we always have an element in focus and that we have a way to move around amongst possible options while still maintaining a focus. It does this by using an infinitely recursive structure which wraps around a given functor (in our case <code>TPossible</code>). Let's build up a few of these structures by combining <code>TPossible</code> with Cofree! (:&lt;) is the Cofree constructor and has the following structure: <code>a :&lt; f (Cofree f a)</code>.</p>
<p>Lucky for us, if we have a Representable instance for a functor f, we get Representable of Cofree f for free! We can cheat a little and use our Representable class to build up the data structure for us by simply providing a describe function to 'tabulate' which returns the value we want to appear at any given index. Remember, the index we chose for <code>TPossible</code> is <code>TChoice</code>. The index for <code>Cofree TPossible</code> is a Sequence of <code>TChoice</code>!</p>
<p>Let's build our first actual 'Tape' using tabulate with our Cofree Representable instance! Here's an infinite number-line going out in both directions from our focus:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">relativePosition ::</span> <span class="dt">S.Seq</span> <span class="dt">TChoice</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>relativePosition <span class="ot">=</span> <span class="fu">sum</span> <span class="op">.</span> <span class="fu">fmap</span> valOf</span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="kw">where</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>    valOf <span class="dt">L</span> <span class="ot">=</span> (<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a>    valOf <span class="dt">R</span> <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb10-6"><a href="#cb10-6"></a></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="ot">numberLine ::</span> <span class="dt">Cofree</span> <span class="dt">TPossible</span> <span class="dt">Int</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>numberLine <span class="ot">=</span> tabulate relativePosition</span></code></pre></div>
<p>Kinda weird to look at eh? Effectively we're saying that if we move left the position is 1 less than whatever we were at before, and moving right adds one to the previous total. You could also write a recursive version of <code>describe</code> which calculates the result by pulling each index off of the sequence and returns the result! Let's look at another example where we want a zipper into a finite list!</p>
<p>We'll define a function which 'projects' a list into an infinite Cofree; we define the behaviour such that moving left 'off the edge' just leaves you at the leftmost element and similar with the right. I'm going to re-use our previous helper 'relativePosition' here, but this time I'll use it to index into a list! We'll put some checks in place to ensure we never get an index which is out of bounds, if we're given an out of bounds index we'll just give the first or last element respectively; i.e. the zipper will never 'fall off the end'</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="ot">project ::</span> <span class="dt">NE.NonEmpty</span> a <span class="ot">-&gt;</span> <span class="dt">Cofree</span> <span class="dt">TPossible</span> a</span>
<span id="cb11-2"><a href="#cb11-2"></a>project l <span class="ot">=</span> tabulate describe</span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="kw">where</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>    describe <span class="ot">=</span> (l <span class="op">NE.!!</span>) <span class="op">.</span> <span class="fu">foldl</span> go <span class="dv">0</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>    maxIndex <span class="ot">=</span> <span class="fu">length</span> l <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>    minIndex <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>    go n <span class="dt">L</span> <span class="ot">=</span> <span class="fu">max</span> minIndex (n <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a>    go n <span class="dt">R</span> <span class="ot">=</span> <span class="fu">min</span> maxIndex (n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="ot">elems ::</span> <span class="dt">NE.NonEmpty</span> <span class="dt">String</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>elems <span class="ot">=</span> <span class="st">&quot;one&quot;</span> <span class="op">NE.:|</span> [<span class="st">&quot;two&quot;</span>, <span class="st">&quot;three&quot;</span>]</span></code></pre></div>
<p>Now we can write a sequence of directions to form a path and see where we end up! Remember, the zipper 'sticks' to the ends if we try and go off!</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a><span class="ot">path ::</span> <span class="dt">S.Seq</span> <span class="dt">TChoice</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>path <span class="ot">=</span> S.fromList [<span class="dt">R</span>, <span class="dt">R</span>, <span class="dt">R</span>, <span class="dt">R</span>, <span class="dt">L</span>]</span></code></pre></div>
<p>Now we can <code>index (project elems) path</code> to get "two"!</p>
<p>All this talk and we still haven't mentioned Comonad yet! Well lucky us; the 'free' package describes an instance of Comonad for all <code>(Functor f =&gt; Cofree f a)</code>! So our <code>(Cofree TPossible a)</code> is a Comonad over a for free! Remember that a Comonad instance gives us access to <code>extend</code>, <code>extract</code> and <code>duplicate</code> functions. You can see their types in <a href="https://hackage.haskell.org/package/comonad-5/docs/Control-Co%20monad.html#t:Comonad">Control.Comonad</a>.</p>
<p>We already have a way to extract an element at a given position via 'index', but don't really have a way to move our zipper WITHOUT extracting; don't fret though, we can describe this behaviour in terms of our new Comonad instance by using extend!</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="ot">moveTo ::</span> <span class="dt">S.Seq</span> <span class="dt">TChoice</span> <span class="ot">-&gt;</span> <span class="dt">Cofree</span> <span class="dt">TPossible</span> a <span class="ot">-&gt;</span> <span class="dt">Cofree</span> <span class="dt">TPossible</span> a</span>
<span id="cb13-2"><a href="#cb13-2"></a>moveTo ind <span class="ot">=</span> extend (\cfr <span class="ot">-&gt;</span> <span class="fu">index</span> cfr ind)</span></code></pre></div>
<p>Great! Extend works by duplicating the Comonad meaning we'll have a <code>(Cofree TPossible (Cofree TPossible a))</code>, then it fmaps over the duplicated parts with the given function. The function 'move' will move the element in each slot of the Cofree over by a given amount, which is the same result as 'scanning' our Tape over to a given position.</p>
<p>Cool stuff! I hope you've learned a little about Distributive, Representable, Comonads, Cofree, and zippers! If you have any questions find me on twitter @chrislpenner</p>
<p>Cheers!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Shipping Haskell via Homebrew</title>
      <link href="https://chrispenner.ca/posts/homebrew-haskell"/>
      <id>https://chrispenner.ca/posts/homebrew-haskell</id>
      <updated>2017-04-24T00:00:00Z</updated>
      <summary>How to set up your Haskell project to distribute via Homebrew</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/homebrew.jpg" alt="Shipping Haskell via Homebrew">
              <p>If you're reading this I assume you already love Haskell; so I won't convince you of why it's great to work in. One thing that isn't so great is Haskell's story for distributing code to non-haskellers. <code>stack install</code> is great, but most folks don't have stack installed and compiling Haskell projects from source is a lengthy process. These barriers prevented me from sharing my Haskell projects for a long time.</p>
<p>Here's how I eventually set up my project to be installed via Homebrew.</p>
<p>We'll be using Homebrew's binary deployment strategy since it's the easiest to both set up and for users to install.</p>
<p>If you're content to build binaries using stack locally and upload them to Github yourself then you can skip down to the Homebrew Formula section.</p>
<h2 id="building-binaries-with-travis-ci">Building Binaries with Travis-CI</h2>
<p>Here's a look at my <code>.travis.yml</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">addons</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="at">  </span><span class="fu">apt</span><span class="kw">:</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="at">    </span><span class="fu">packages</span><span class="kw">:</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="at">    </span><span class="kw">-</span><span class="at"> libgmp-dev</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">language</span><span class="kw">:</span><span class="at"> c</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">sudo</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">cache</span><span class="kw">:</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="at">  </span><span class="fu">directories</span><span class="kw">:</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="at">  </span><span class="kw">-</span><span class="at"> $HOME/.local/bin</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="at">  </span><span class="kw">-</span><span class="at"> $HOME/.stack</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="fu">os</span><span class="kw">:</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="kw">-</span><span class="at"> linux</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="kw">-</span><span class="at"> osx</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="fu">before_install</span><span class="kw">:</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="kw">-</span><span class="at"> sh tools/install-stack.sh</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="kw">-</span><span class="at"> sh tools/install-ghr.sh</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="fu">script</span><span class="kw">:</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="kw">-</span><span class="at"> stack setup</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="kw">-</span><span class="at"> stack build --ghc-options -O2 --pedantic</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="fu">after_success</span><span class="kw">:</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="kw">-</span><span class="at"> sh tools/attach-binary.sh</span></span></code></pre></div>
<p>This is just a basic setup for building haskell on Travis-CI; we need the additional package <code>libgmp-dev</code>, cache a few things, and specify to build for both linux and osx. This way we'll have both linux and osx binaries when we're done! In the pre-install hooks we install stack manually, then install <a href="https://github.com/tcnksm/ghr">ghr</a> a github resource management tool.</p>
<p>You can find <a href="https://github.com/ChrisPenner/tempered/blob/master/tools/install-stack.sh">install-stack.sh</a> and <a href="https://github.com/ChrisPenner/tempered/blob/master/tools/install-ghr.sh">install-ghr.sh</a> scripts on my <a href="https://github.com/ChrisPenner/tempered">Tempered</a> project. They use Travis Env variables for everything, so you can just copy-paste them into your project.</p>
<p>Inside <code>script</code> we build the project as normal you can do this however you like so long as a binary is produced.</p>
<p>Lastly is the <a href="https://github.com/ChrisPenner/tempered/blob/master/tools/attach-binary.sh"><code>attach-binary.sh</code></a> script. This runs after the build and uploads the generated binaries to the releases page on Github. It first checks if the current release is tagged and will only build and upload tagged releases, so make sure you <code>git tag vx.y.z</code> your commits before you push them or it won't run the upload step. Next it pulls in your github token which ghr will use to do the upload. You must manually add this to your Travis-CI Environment variables for the project. Create a new github access token <a href="https://github.com/settings/tokens">here</a> then add it to your Travis-CI project at <code>https://travis-ci.org/&lt;user&gt;/&lt;repo&gt;/settings</code> under the name <code>GITHUB_TOKEN</code>.</p>
<p>The script assumes the binary has the same name as your repo, if that's not the case you can hard-code the script to something else. At this point whenever you upload a tagged release Travis-CI should run a mac and a linux build and upload the result of each to your Github Repo's releases page. You'll likely need to trouble-shoot one or two things to get it just right.</p>
<h2 id="setting-up-a-homebrew-formula">Setting up a Homebrew Formula</h2>
<p>You can follow <a href="http://octavore.com/posts/2016/02/15/distributing-go-apps-os-x">this guide by octavore</a> to set up your own homebrew tap; then we'll make a formula. Here's what mine for my tempered project looks like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">class</span> <span class="dt">Tempered</span> &lt; <span class="dt">Formula</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  desc <span class="st">&quot;A dead-simple templating utility for simple shell interpolation&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  homepage <span class="st">&quot;https://github.com/ChrisPenner/tempered&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>  url <span class="st">&quot;https://github.com/ChrisPenner/tempered/releases/download/v0.1.0/tempered-v0.1.0-osx.tar.gz&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>  sha256 <span class="st">&quot;9241be80db128ddcfaf9d2fc2520d22aab47935bcabc117ed874c627c0e1e0be&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>  bottle <span class="st">:unneeded</span></span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="kw">def</span> install</span>
<span id="cb2-10"><a href="#cb2-10"></a>    bin.install <span class="st">&quot;tempered&quot;</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="kw">end</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a>  test <span class="kw">do</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>    system <span class="st">&quot;</span><span class="ot">#{</span>bin<span class="ot">}</span><span class="st">/tempered&quot;</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="kw">end</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="kw">end</span></span></code></pre></div>
<p>You'll of course have to change the names, and you'll need to change the url to match the uploaded tar.gz file (for osx) on your github releases page from step one.</p>
<p>Lastly we'll need to get the <code>sha 256</code> of the bundle; you can just download it and run <code>shasum -a 256 &lt;filename&gt;</code> if you like; or you can look in your Travis-CI logs for the osx build under the <code>attach-binary.sh</code> step; the script logs out the sha sum before uploading the binary.</p>
<p>After you've pushed up your homebrew formula pointing to the latest binary then users can install it by running:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Replace the names respectively</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">brew</span> update <span class="kw">&amp;&amp;</span> <span class="ex">brew</span> install githubuser/tapname/reponame</span></code></pre></div>
<p>Each time you release a new version you'll need to update the url and sha in the homebrew formula; you could automate this as a script to run in Travis if you like; I haven't been bothered enough to do it yet, but if you do it let me know and I'll update this post!</p>
<p>This guide was inspired by (and guided by) <a href="http://taylor.fausak.me/2016/05/09/add-files-to-github-releases/">Taylor Fausak's post</a> on a similar topic; most of the scripts are adapted from his.</p>
<p>Cheers and good luck!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Kleisli Endomorphisms</title>
      <link href="https://chrispenner.ca/posts/kleisli-endo"/>
      <id>https://chrispenner.ca/posts/kleisli-endo</id>
      <updated>2017-04-08T00:00:00Z</updated>
      <summary>Discovering an isomorphism between the Kleisli version of Endomorphisms to the mtl StateT transformer.</summary>
      <content type="html"><![CDATA[
              <p>After listening to the latest <a href="https://twitter.com/MagicReadAlong">Magic Read-along</a> episode <a href="http://www.magicreadalong.com/episode/45">"You should watch this"</a> (which you should go listen to now) I got caught up thinking about Brian's idea of an Endomorphism version of Kleisli composition for use with <a href="https://github.com/reactjs/react-redux">Redux</a>, it's actually a very similar model to what I'm using in my <a href="github.com/chrispenner/eve">event framework</a> for event listeners so I figured I'd try to formalize the pattern and recognize some of the concepts involved. They talk about the idea of a Redux-reducer, which is usually of type <code>s -&gt; Action -&gt; s</code>, it takes a state and an action and returns a new state. He then re-arranged the arguments to <code>Action -&gt; s -&gt; s</code>. He then recognized this as <code>Action -&gt; Endo s</code> (an Endo-morphism is just any function from one type to itself: <code>a -&gt; a</code>). He would take his list of reducers and partially apply them with the <code>Action</code>, yielding a list of type <code>Endo s</code> where <code>s</code> is the state object the reducer operates over. At this point we can use the Monoid instance <code>Endo</code> has defined, so we foldmap with Endo to combine the list of reducers into a sort of pipeline where each function feeds into the next; the Endo instance of Monoid is just function composition over functions which return the same type as their input.</p>
<p>This cleans up the interface of the reducers a fair amount, but what about an alternate kind of <code>Endo</code> which uses Kleisli composition instead of normal function composition? <a href="http://hackage.haskell.org/package/base-4.9.1.0/docs/Control-Monad.html#v:-62--61--62-">Kleisli composition</a> often referenced as (&gt;=&gt;); takes two functions which return monads and composes them together using the underlying bind/flatmap of the Monad. The type of Kleisli composition is: <code>(&gt;=&gt;) :: Monad m =&gt; (a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c</code>. If we could define a nice Endo-style monoid over this type then we could compose reducers like we did above, but also allow the functions to perform monadic effects (which is a bad idea in Redux, but there are other times this would be useful, imagine running a user through a pipeline of transformations which interact with a database or do some error handling). We can easily define this instance like so:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">import</span> <span class="dt">Control.Monad</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">newtype</span> <span class="dt">KEndo</span> m a <span class="ot">=</span> <span class="dt">KEndo</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  {<span class="ot"> getKEndo ::</span> (a <span class="ot">-&gt;</span> m a) }</span>
<span id="cb1-4"><a href="#cb1-4"></a>  </span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Monoid</span> (<span class="dt">KEndo</span> m a) <span class="kw">where</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="fu">mempty</span> <span class="ot">=</span> <span class="dt">KEndo</span> <span class="fu">return</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>  (<span class="dt">KEndo</span> a) <span class="ot">`mappend`</span> (<span class="dt">KEndo</span> b) <span class="ot">=</span> <span class="dt">KEndo</span> (a <span class="op">&gt;=&gt;</span> b)  </span></code></pre></div>
<p>This is great, now if we have a list of functions of some type <code>[User -&gt; Writer Error User]</code> or something we can use foldmap to combine them into a single function! It works like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="ot">actions ::</span> [<span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">Writer</span> <span class="dt">Error</span> <span class="dt">User</span>]</span>
<span id="cb2-2"><a href="#cb2-2"></a>actions <span class="ot">=</span> [<span class="op">...</span>]</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="ot">pipeline ::</span> <span class="dt">User</span> <span class="ot">-&gt;</span> <span class="dt">Writer</span> <span class="dt">Error</span> <span class="dt">User</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>pipeline <span class="ot">=</span> getKEndo <span class="op">.</span> <span class="fu">foldMap</span> <span class="dt">KEndo</span> <span class="op">$</span> actions</span></code></pre></div>
<p>The whole Kleisli Endo thing is a cool idea; but this thing has actually been done before! It's actually the same as the <a href="http://hackage.haskell.org/package/mtl-2.2.1/docs/Control-Monad-State-Lazy.html#v:StateT"><code>StateT</code></a> state monad transformer from mtl; let's see how we can make the comparison. A generic Endo is of type <code>s -&gt; s</code>, this is isomorphic to <code>s -&gt; ((), s)</code>, aka <code>State s ()</code>. The trick is that the Kleisli Endo (<code>s -&gt; m s</code> or by isomorphism <code>s -&gt; m ((), s)</code>) can actually be generalized over the <code>()</code> to <code>s -&gt; m (a, s)</code> which incidentally matches <code>runStateT :: StateT s m a -&gt; s -&gt; m (a, s)</code> from mtl!</p>
<p>So basically KEndo is isomorphic to StateT, but we'd still like a monoid instance for it, Gabriel shows a monoid over the IO monad in <a href="https://youtu.be/WsA7GtUQeB8">"Applied category theory and abstract algebra"</a>, the Monoid he shows actually generalizes to any monad as this instance:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">instance</span> (<span class="dt">Monad</span> m, <span class="dt">Monoid</span> a) <span class="ot">=&gt;</span> <span class="dt">Monoid</span> (m a) <span class="kw">where</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">mempty</span> <span class="ot">=</span> <span class="fu">return</span> <span class="fu">mempty</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  ma <span class="ot">`mappend`</span> mb <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    a <span class="ot">&lt;-</span> ma</span>
<span id="cb3-5"><a href="#cb3-5"></a>    b <span class="ot">&lt;-</span> mb</span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="fu">return</span> (a <span class="ot">`mappend`</span> b)</span></code></pre></div>
<p>So that means we can use this instance for StateT (which is a monad). Since <code>()</code> is a trivial monoid (where every mappend just returns <code>()</code>) the simple case is <code>State s ()</code> which was our <code>KEndo</code> of <code>s -&gt; ((), s)</code> but now we have the Monoid instance, which behaves the same as the <code>KEndo</code> instance, so we don't need <code>KEndo</code> anymore. If we want to allow arbitrary effects we use the Transformer version: <code>StateT s m ()</code> where <code>m</code> is a monad containing any additional effects we want. In addition to being able to add additional effects we also gain the ability to aggregate information as a monoid! If you decided you wanted your reducers to also aggregate some form of information, then they'd be: <code>Monoid a =&gt; Action -&gt; s -&gt; (a, s)</code>, which is <code>Action -&gt; State s a</code>, and if <code>a</code> is a monoid, then the monoid instance of <code>State</code> acts like Endo, but also aggregates the 'a's along the way!</p>
<p>Lastly we recognize that in the case of the Redux Reducers, if we have a whole list of reducers: <code>Action -&gt; State s ()</code> then we can rephrase it as the ReaderT Monad: <code>ReaderT Action (State s) ()</code>, which maintains all of the nice monoids we've set up so far, and becomes even more composable!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Tail Recursion In Python</title>
      <link href="https://chrispenner.ca/posts/python-tail-recursion"/>
      <id>https://chrispenner.ca/posts/python-tail-recursion</id>
      <updated>2016-07-26T00:00:00Z</updated>
      <summary>Tail Recursion in python without introspection</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/ouroboros.jpg" alt="Tail Recursion In Python">
              <p>Some programming languages are <a href="https://en.wikipedia.org/wiki/Tail_call">tail-recursive</a>, essentially this means is that they're able to make optimizations to functions that return the result of calling themselves. That is, the function returns <strong>only</strong> a call to itself.</p>
<p>Confusing, I know, but stick with me. It turns out that most recursive functions can be reworked into the tail-call form. Here's an example of the factorial function in it's original form, then reworked into the tail-call form.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">def</span> factorial(n):</span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span>: <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="cf">else</span>: <span class="cf">return</span> factorial(n<span class="dv">-1</span>) <span class="op">*</span> n</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw">def</span> tail_factorial(n, accumulator<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span>: <span class="cf">return</span> accumulator</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="cf">else</span>: <span class="cf">return</span> tail_factorial(n<span class="dv">-1</span>, accumulator <span class="op">*</span> n)</span></code></pre></div>
<p>They both look similar, and in fact the original even <strong>looks</strong> like it's in the tail call form, but since there's that pesky multiplication which is outside of the recursive call it can't be optimized away. In the non-tail version the computer needs to keep track of the number you're going to multiply it with, whereas in the tail-call version the computer can realize that the only work left to do is another function call and it can forget about all of the variables and state used in the current function (or if it's really smart, it can re-use the memory of the last function call for the new one)</p>
<p>This is all great, but there's a problem with that example, namely that python doesn't support tail-call optimization. There's a few reasons for this, the simplest of which is just that python is built more around the idea of iteration than recursion.</p>
<p>But hey, I don't really care if this is something we should or shouldn't be doing, I'm just curious if we can! Let's see if we can make it happen.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># factorial.py</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">from</span> tail_recursion <span class="im">import</span> tail_recursive, recurse</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"># Normal recursion depth maxes out at 980, this one works indefinitely</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="at">@tail_recursive</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="kw">def</span> factorial(n, accumulator<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb2-8"><a href="#cb2-8"></a>        <span class="cf">return</span> accumulator</span>
<span id="cb2-9"><a href="#cb2-9"></a>    recurse(n<span class="dv">-1</span>, accumulator<span class="op">=</span>accumulator<span class="op">*</span>n)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># tail_recursion.py</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">class</span> Recurse(<span class="pp">Exception</span>):</span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb3-4"><a href="#cb3-4"></a>        <span class="va">self</span>.args <span class="op">=</span> args</span>
<span id="cb3-5"><a href="#cb3-5"></a>        <span class="va">self</span>.kwargs <span class="op">=</span> kwargs</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="kw">def</span> recurse(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="cf">raise</span> Recurse(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb3-9"><a href="#cb3-9"></a>        </span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="kw">def</span> tail_recursive(f):</span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="kw">def</span> decorated(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb3-12"><a href="#cb3-12"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb3-13"><a href="#cb3-13"></a>            <span class="cf">try</span>:</span>
<span id="cb3-14"><a href="#cb3-14"></a>                <span class="cf">return</span> f(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb3-15"><a href="#cb3-15"></a>            <span class="cf">except</span> Recurse <span class="im">as</span> r:</span>
<span id="cb3-16"><a href="#cb3-16"></a>                args <span class="op">=</span> r.args</span>
<span id="cb3-17"><a href="#cb3-17"></a>                kwargs <span class="op">=</span> r.kwargs</span>
<span id="cb3-18"><a href="#cb3-18"></a>                <span class="cf">continue</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>    <span class="cf">return</span> decorated</span></code></pre></div>
<p>Now, don't get scared by decorators if you haven't seen them before, in fact go <a href="http://thecodeship.com/patterns/guide-to-python-function-decorators/">read about them now</a>, basically they're functions which are called on other functions and change the behaviour in some way.</p>
<p>This decorator will call the function it's given and will check to see if it wants to 'recurse'. We signal a 'recursion' by simply raising an exception with the arguments we'd like to recurse with. Then our decorator simply unpacks the variables from the exception and tries calling the function again.</p>
<p>Eventually we'll reach our exit condition (we hope) and the function will <strong>return</strong> instead of raising an exception. At this point the decorator just passes along that return value to whoever was asking for it.</p>
<p>This particular method helps out with doing recursive calls in python because python has a rather small limit to how many recursive calls can be made (typically ~1000). The reason for this limit is (among other things) doing recursive calls takes a lot of memory and resources because each frame in the call stack must be persisted until the call is complete. Our decorator gets around that problem by continually entering and exiting a single call, so technically our function isn't actually recursive anymore and we avoid the limits.</p>
<p>I tested out both versions, the normal version hits the tail-recursion limit at factorial(980) whereas the tail-recursive version will happily compute numbers as large as your computer can handle.</p>
<p>There's an <a href="http://code.activestate.com/recipes/474088-tail-call-optimization-decorator/">alternative approach</a> that actually uses stack introspection to do it, but it's a bit more complex than the one we built here.</p>
<p>Hope you learned something, cheers!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>The Interface We Need</title>
      <link href="https://chrispenner.ca/posts/dont-argue"/>
      <id>https://chrispenner.ca/posts/dont-argue</id>
      <updated>2016-02-15T00:00:00Z</updated>
      <summary>Starting with the interface can make things easier for everyone</summary>
      <content type="html"><![CDATA[
              <p>I suffer from a not-so-rare condition where as soon as a problem is presented to me I immediately start trying to solve it with the tools I know well. This may not sound like a bad thing, but what happens is that I end up with a user interface built around supporting the implementation I was planning to write, which is very rarely an interface that anyone would actually like to use. In the worst case I end up changing my implementation plans along the way and now we're stuck with a crappy API designed around an implementation that doesn't even exist! I've been learning that it's usually better to design an interface that's elegant and does what you need, then the implementation will fall into place from there.</p>
<p>Anyway, I ended up learning this lesson once more the other day, here's the story: I was writing a laughably simple script and I wanted it to be able to accept arguments from the command line. I remembered that Python has an argument parsing module in its standard library (argparse), but upon looking it up I remembered how much of a pain it was to get all your arguments set up. Argparse is great in that it allows you to do complex things with arguments, but I think there should be an alternate path to avoid the complexity when all you need is to grab a few arguments from the command line. Sure I could have just used sys.argv manually, but I wanted to use command line '--options' and parsing those out from argv would be a royal pain.</p>
<p>In the end I decided to write my own little helper module for this sort of thing, which you can find here. The goal was to design the simplest possible interface that just does the right thing.</p>
<p>At this point I would usually write out a few example use-cases with an interface that I'd want to use even if I'm not sure it's possible to implement that way. For some reason I avoided my own advice this time and started on the implementation first. Here's an example of the interface that resulted from my original implementation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="at">@supply_args</span>(<span class="st">&#39;first&#39;</span>, <span class="st">&#39;second&#39;</span>, <span class="st">&#39;third&#39;</span>, keyword<span class="op">=</span><span class="dv">42</span>, args<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">def</span> main(first, second, third, keyword<span class="op">=</span><span class="dv">42</span>, args):</span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="bu">print</span> first, second, third, keyword, args</span></code></pre></div>
<p>Hrmm, so it works, but you can see that we're writing each argument out twice. Keyword args are also doubled, and for some reason keywords aren't strings, whereas the other arguments are. The worst offender is the 'args' syntax. In order to specify we want to collect extra arguments into a list we set "args=True", then have an argument named args below. Hrmm, all of this is a little clunky, this definitely isn't an "it just works" scenario and honestly it's just as easy to screw up as using argparse in the first place. It was at this point that I realized I built it this way because it was easy to implement, not because it was easy to use! So back to the drawing board, let's design something we'd like to use first, then see if we can implement it!</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="at">@supply_args</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">def</span> main(first, second, keyword<span class="op">=</span><span class="dv">42</span>, <span class="op">*</span>extras):</span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="bu">print</span> first, second, keyword, extras</span></code></pre></div>
<p>Whoah, okay that's a lot simpler! No more duplication, I'd use that! But it almost seems a bit too much like magic, is it even possible to implement it this way? Let's try it out, one of the things we wanted was to be able to handle '--options' on the command line, and argparse has that ability, so we should probably take advantage of that. To that end we need to pass the names of the arguments to argparse to set it up, how can we do that now that we're not passing argument names to our decorator? After a quick dive into the depths of Stack Overflow I discovered what we need in the 'inspect' module from the standard library.</p>
<p>The <strong>inspect</strong> module allows us to peer into code that's running during execution. What I though was impossible is actually pretty easy to do! Using inspect's getargspec function we can get the names of the arguments of a function just like we need! From this point it was just a matter of outfitting the decorator to handle different combinations of arguments, keyword arguments, and splat arguments properly and we can end up with exactly the API we wanted! The code ends up being much cleaner too since we don't have to deal with as many edge cases.</p>
<p>We ended up with a much simpler interface, one that we probably wouldn't have even thought was possible if we'd started thinking about the implementation too early on. This just goes to show that designing a nice interface first can lead to better design, a much improved user experience, and in this case: cleaner code! Remember to put the interface first the next time you're implementing some new feature for your app.</p>
<p>You can find the full decorator <a href="https://github.com/chrispenner/dont-argue">here</a>, it's only a few lines long.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Let there be Truth</title>
      <link href="https://chrispenner.ca/posts/let-there-be-truth"/>
      <id>https://chrispenner.ca/posts/let-there-be-truth</id>
      <updated>2016-01-02T00:00:00Z</updated>
      <summary>Let&#39;s re-visit truthy/falsy.</summary>
      <content type="html"><![CDATA[
              <p>Okay, so here's the deal. The idea of "truthy" and "falsy" values is a pretty common language pattern these days that saves us all some time and effort. I've been thinking about it lately and I think we made a pretty big mistake as to the implementation of this idea in most languages, namely that 0 is usually considered "falsy". Why did we do that? Yes, I know that it's how false was represented in C, but modern languages aren't C and they can make their own choices. We have types and classes and all sorts of nice tools now, we don't need 0 to represent false.</p>
<p>So what should 0 be then? I think we should revisit this and actually think about it rather than just allowing old limitations to make our decision for us. I'm going to make the case that 0 should be truthy, the argument for this is very simple: 0 is a value. In most cases where I've seen truthyness and falsyness used in code it's used to check whether a variable has a value; something like <code>if(account){do stuff with account}</code>. We need to check that the 'account' we returned from a function or API call actually exists before we perform operations on it, ensuring that it isn't 'null' or 'None' or something like that. This case works great, but what about this: <code>if(number_of_accounts){do stuff} else {raise APIError}</code>? Granted, this is a simplified case that won't come up often, but in this case if there are 0 accounts, our code will raise an APIError rather than executing our operation. In this case 0 is clearly a value, and so should be considered truthy.</p>
<p>While the previous example may seem contrived, it comes from a real-life case that I dealt with at work one day. We were doing some pretty complex work with web forms using JavaScript and had multiple field-types in the form. Some of these fields used numerical values, and since <code>if (value !== null &amp;&amp; value !== undefined)</code> is a bit wordy, in most cases we were just using <code>if (value)</code>. This worked great in almost all cases, including checking whether or not the user had typed in a text field (<code>""</code> is falsy). Unfortunately we hadn't handled the case where the value of a numerical field was 0, and were incorrectly throwing validation errors. We knew 0 was a value, but JavaScript disagreed and treats it as falsy, causing us a bug or twelve.</p>
<p>I'm sure we're not the only ones to have made that mistake. Clever folks can probably come up with some case where it makes sense for 0 to be falsy, but I think that the value-checking scenario I've presented above is the most common use-case of truthy/falsy by far.</p>
<p>It's unfortunate, but languages are largely undecided on truthy/falsy. Python has all of <code>'', 0, {}, []</code> and <code>None</code> as falsy values, in JavaScript <code>0, '', null,</code> and <code>undefined</code> are all falsy, but <code>[]</code> and <code>{}</code> are truthy! PHP even considers <code>'0'</code> to be false! Ruby has the strict definition that only nil and False are considered falsy, everything else (including <code>0, '', [], {}</code>) are ALL considered true!</p>
<p>I'm still undecided as to the fate of <code>'', [],</code> and <code>{}</code>, but I think it's time for 0 to be truthy.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Autoenv Trick</title>
      <link href="https://chrispenner.ca/posts/auto-env-trick"/>
      <id>https://chrispenner.ca/posts/auto-env-trick</id>
      <updated>2015-09-04T00:00:00Z</updated>
      <summary>Use Auto-env to streamline your workflow.</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/autoenv.gif" alt="Autoenv Trick">
              <p>Firstly, if you haven't heard of <a href="https://github.com/kennethreitz/autoenv">autoenv</a> then I suggest you go check it out now. Basically it allows you to run arbitrary shell scripts any time you enter a directory or any of its children, it's pretty useful.</p>
<p>You can do all sorts of things with this tool, though most people use it to configure their environment variables (hence the name). I use it for that as well, but I've added a new trick.</p>
<p>Basically, each time you enter a project it will try to join an existing tmux session for that project, if none exist it will create one.</p>
<p>Here's what's in each project's '.env' file now:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># Echo the root folder of the current git repo.</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">gitroot()</span><span class="kw">{</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="bu">echo</span> <span class="kw">`</span><span class="fu">git</span> rev-parse --show-toplevel<span class="kw">`</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw">}</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># Reconnect tmux session</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">tmuxproj()</span><span class="kw">{</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co"># Don&#39;t attach to tmux if already in tmux</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="kw">if</span> ! <span class="kw">{</span><span class="bu"> [</span> <span class="st">&quot;</span><span class="va">$TERM</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;screen&quot;</span><span class="bu"> ]</span> <span class="kw">||</span><span class="bu"> [</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="va">$TMUX</span><span class="st">&quot;</span><span class="bu"> ]</span>; <span class="kw">}</span> <span class="kw">then</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="co"># Attach to project tmux session if it exists, otherwise create it.</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>        <span class="ex">tmux</span> attach -t <span class="kw">`</span><span class="ex">gitroot</span><span class="kw">`</span> <span class="kw">||</span> <span class="ex">tmux</span> new -s <span class="kw">`</span><span class="ex">gitroot</span><span class="kw">`</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>    <span class="kw">fi</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="kw">}</span></span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># inside a project&#39;s .env:</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="ex">tmuxproj</span></span></code></pre></div>
<p>I use vim with tmux extensively, and so I often set up a workplace with several tmux windows and splits. Setting all this up and remembering what I was working on every time I context switch can be a bit of a pain, so now I use autoenv to manage it for me. What would usually happen to me is that I'd set up a tmux session with all of this, then forget about it next time I went to work on this project, but now every time I enter a project's directory it automagically puts me back into the session.</p>
<p>Simple! Now I can't forget!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Semantic Versioning</title>
      <link href="https://chrispenner.ca/posts/use-semantic-versioning"/>
      <id>https://chrispenner.ca/posts/use-semantic-versioning</id>
      <updated>2015-04-02T00:00:00Z</updated>
      <summary>Semantic versioning helps, use it!</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/versioning.jpg" alt="Semantic Versioning">
              <p>So! I'm going to talk about Semantic Versioning today because it's something that I think <em>everyone</em> should be using. Why? Because it takes something that is largely arbitrary and meaningless and redeems it by giving it meaning. A side effect of the system is that everyone thinks a little more about how their software changes affect those who actually use it.</p>
<p>How's this whole Semantic Versioning thing work? Well essentially it's a set of conventions for how version numbers are changed when software is altered. I recommend reading the whole description <a href="http://semver.org/">here</a>, but I'll give you the TL;DR version. The idea is that versions should take the form X.Y.Z where each letter is an integer (e.g. 2.5.17). Each number has it's own meaning; MAJOR.MINOR.PATCH</p>
<p>X = MAJOR-version: This is incremented any time the new API is not back compatible with an API you've previously shipped. It doesn't matter how different it is, if the API acts differently, change the MAJOR version.</p>
<p>Y = MINOR-version: This is incremented when the API is changed, but it's completely back compatible with previous versions of this MAJOR release. Use this when ADDING features to your API.</p>
<p>Z = PATCH-version: This is incremented when you make bugfixes that don't affect the API.</p>
<p>The idea is to allow devs to reason about when/how to update their dependencies. Under this system, the dev knows that they can safely update to any version that changes the MINOR or PATCH versions, but that a change in the MAJOR version will mean API alterations which may break their application.</p>
<p>It's as simple as that. Read <a href="http://semver.org/">semver.org</a> for more info on all of this, and start using this system TODAY!</p>
<p>Cheers!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>BoxKite: Open-Sourced</title>
      <link href="https://chrispenner.ca/posts/boxkite"/>
      <id>https://chrispenner.ca/posts/boxkite</id>
      <updated>2015-03-25T00:00:00Z</updated>
      <summary>I&#39;ve open-sourced the code that I use to generate this blog.</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/boxkite.png" alt="BoxKite: Open-Sourced">
              <p>When I was first developing interested in web-technologies (almost exactly a year ago now) I wanted to build some things to test my skills. I've always believed that book learning will only get you so far, you discover so much more about a system by building something tangible with it. I decided as a first project to make a blog for myself. I looked at things like Jekyll and Wordpress, but I initially had trouble customizing Jekyll (though I'm sure I could manage it now). I didn't think I'd learn what I wanted to from building with Wordpress, so I decided to go with a custom solution.</p>
<p>I fiddled around and made a few handlers in a Python Google App Engine site, adding a bit of logic to convert Markdown files into HTML and insert them into jinja templates. This worked pretty well so I cleaned it up, added a few functions to parse metadata about each post, using it to build a table of contents and a site structure. Pretty soon I had a working blog framework that I knew from front to back and it was simple enough to extend in any way I could imagine.</p>
<p>The result is an adaptable and intuitive framework that for some unknown reason I've decided to call "BoxKite". Check out the Source (and installation instructions) here: <a href="http://github.com/ChrisPenner/BoxKite">BoxKite</a></p>
<p>So why should you try out BoxKite? Well, it depends on what you want to use it for; but here are some things that I like about it:</p>
<ul>
<li>ALL data related to a post is stored plain-as-day in the post's markdown file. (I can't stress how nice this is for organizational purposes)</li>
<li>No managing images or content through clunky CMS systems, just put it in the right folder and reference it in your post or template.</li>
<li>Need to change a post or it's tags/categories/image? Just edit the text file and everything dependent on it will be updated when you deploy.</li>
<li>Want to add something unique to your site? Just edit the jinja template (or CSS), everything is available to you.</li>
<li>The entire site can be exported statically if you have a vendetta against using web-servers (or performance concerns, see the README).</li>
<li>It's responsive and scales to the viewport size. It also reflows content properly for a good mobile experience.</li>
<li>Did I mention that comments and social media connectivity are a breeze? They're configured by default. You just need to input your Disqus name.</li>
</ul>
<p>Who shouldn't use BoxKite?</p>
<ul>
<li>People who aren't interested in learning anything about websites</li>
<li>Companies with hundreds and hundreds of posts.</li>
<li>Blogs with many authors, this set-up is great for personal blogs, but breaks down with more than a few people posting.</li>
</ul>
<p>In conclusion, I'd highly recommend building something like this from scratch in whatever web framework you like to use (node, rails, appengine, etc.). It's a great way to learn, and you'll understand the whole framework better (and web tech as a whole) as a result. This is actually my first try at open-source and any sort of distributable project, so take it with a grain of salt, but take a look at it, mess around with it, and let me know what you think! Cheers!</p>
<p><a href="http://github.com/ChrisPenner/BoxKite">BoxKite at Github</a></p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Getting Schooled</title>
      <link href="https://chrispenner.ca/posts/getting-schooled"/>
      <id>https://chrispenner.ca/posts/getting-schooled</id>
      <updated>2015-03-19T00:00:00Z</updated>
      <summary>When did schooling become more important than skill? Should we really be discriminating against people based on the school they went to?</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/getting-schooled.png" alt="Getting Schooled">
              <p>I must prefix this discussion with the disclaimer that I haven't done any studies nor performed official research, however I have a general feeling, it's an atmosphere, that I've noticed. And often a shared feeling like this, or a bias perpetuated in the media is enough to make a difference in the way we think about things.</p>
<p>In the TV Series <strong>Suits</strong> (which I've been watching lately) the main law firm has a strict policy wherein they hire exclusively from Harvard. "Of course!" many people say... "Harvard is the best!", but are they really? Is everyone who graduates from Harvard just inherently better than those girls and guys who get their community college degrees or go to a local state University in Mississippi somewhere?</p>
<blockquote>
<p>When did schooling become more important than skill?</p>
</blockquote>
<p>Certainly these schools have obtained their reputations as a result of careful planning, good professors, and a rigorous and uncompromising gauntlet of education. This means that to make it through one of these schools you must be rather clever, and that graduating there DOES mean something, but I'm not convinced that it means enough to justify this educational prejudice that I've seen.</p>
<p>These Ivy League schools require amazing marks, community involvement, and LOTS of money for students to attend. If a student is missing one or more of these things, they will miss out on the opportunity to attend one of these schools, and as a result will miss many further opportunities that they may have otherwise been been qualified for. Many companies will pass over State University degrees for someone from Yale without even a second thought. When did schooling become more important than skill? Someone who made a few poor choices in high school and didn't find their passions until a few years into college is systematically disadvantaged from that point on. It doesn't have to be this way!</p>
<p>I'm Canadian, and as far as I can tell, this problem hasn't gained much traction here. I can get just as far with a degree from University of Saskatchewan as I can with one from University of Toronto. In fact, I'd never even heard of University of Toronto until now when I needed to look it up to confirm that it actually exists. Companies here tend to use degrees as a baseline requirement for a job, but not as a strong indicator of skill or personal ability. This is good, it gives equal opportunity to all qualified applicants and makes the job hunt about finding the person most qualified, not the one with the most family money or who happened to be the smartest when they were</p>
<ol>
<li>Additional benefits are that students can go to school close to home (further reducing financial barriers to education), or can choose a school that has programs that are interesting to them; making these choices without fear that their future will suffer as a result.</li>
</ol>
<p>Discrimination is discrimination; if a company is hiring someone based on their age, race, religion, OR their Alma Mater instead of solely evaluating their skills as objectively as possible, then it's still discrimination.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Gem: Duckling</title>
      <link href="https://chrispenner.ca/posts/gem-duckling"/>
      <id>https://chrispenner.ca/posts/gem-duckling</id>
      <updated>2015-02-21T00:00:00Z</updated>
      <summary>Check out the Duckling project</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/duckling.png" alt="Gem: Duckling">
              <p>Duckling is a very interesting project that I think exemplifies many great design principles. It's a parser written in Clojure that can turn natural language sentences into structured computer readable data. Clojure, if you haven't heard, is a Lisp that runs on Java's virtual machine. Now's a good a time as any to check it out!</p>
<p>Here are some things Duckling can understand:</p>
<ul>
<li>"from 9:30 - 11:00 on Thursday</li>
<li>"the day before labor day 2020"</li>
<li>"thirty two Celsius"</li>
<li>"seventh"</li>
</ul>
<p>Some of the design decisions that really set Duckling apart:</p>
<ul>
<li>Extensibility: Easily write your own set of rules to make it work for your own purposes.</li>
<li>Probabilistic: Duckling doesn't always know what's right, but it'll take its best guess and tell you how sure it is.</li>
<li>Data Agnostic: Duckling doesn't make assumptions about what you need, it can be trained to do whatever you like.</li>
</ul>
<p>Go ahead and check out the docs and give building your own parser a try: <a href="http://duckling-lib.org/">Duckling</a>.</p>
<p>Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to catch new articles as they come!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Worth a Read #4 - Unix Tools</title>
      <link href="https://chrispenner.ca/posts/worth-a-read-4"/>
      <id>https://chrispenner.ca/posts/worth-a-read-4</id>
      <updated>2015-02-13T00:00:00Z</updated>
      <summary>Check out these posts!</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/unix-prompt.png" alt="Worth a Read #4 - Unix Tools">
              <p>Okay! This time we're reading about cool and useful Unix tools. We've got some wargames to start us off, a fun way to learn Unix better through a series of challenges. Next is a great series of articles regarding using Unix as a development environment, then an overview of awk and tmux, some of the most useful Unix tools that I use. Finally a list of some other cool tools you may want to check out. I hope you find that it's worth a read!</p>
<p>Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to keep up with future posts!</p>
<h3 id="worth-a-read">Worth a read:</h3>
<ul>
<li><a href="http://overthewire.org/wargames/bandit/">Some fun wargames to learn the secrets of Unix</a></li>
<li><a href="http://blog.sanctum.geek.nz/series/unix-as-ide/">Using Unix as an IDE</a></li>
<li><a href="http://code.tutsplus.com/tutorials/intro-to-tmux--net-33889">Overview of tmux, a session manager</a></li>
<li><a href="http://www.vectorsite.net/tsawk.html">Basic 'awk' overview, the swiss-army knife of text filtering</a></li>
<li><a href="http://kkovacs.eu/cool-but-obscure-unix-tools">A list of cool and useful tools, pick a new one to learn</a></li>
</ul>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Vim vs. Emacs?</title>
      <link href="https://chrispenner.ca/posts/vim-vs-emacs"/>
      <id>https://chrispenner.ca/posts/vim-vs-emacs</id>
      <updated>2015-02-06T00:00:00Z</updated>
      <summary>I&#39;ve tried out both; here are some thoughts</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/vim-vs-emacs.png" alt="Vim vs. Emacs?">
              <p>So about a year ago I realized that as someone going into Computer Science as a career I would be typing for the rest of my life. Somewhere on the vastness of the internet I read that learning how to properly use a text editor (or, how to use a proper editor) would not only help me type faster, but also that being able to get what's in my head onto the screen efficiently would help keep me focused on the task at hand. These posts all came with the disclaimer that it would take time, effort, and that learning something new would slow me down at the start. However, if I can spend a few hours here and there to save myself countless hours throughout my career, it doesn't take complex mental math to see that it's a worthwhile thing to do.</p>
<p>I started researching the best editor to learn, there're hundreds out there, and most shortcuts and advanced techniques tend to be non-transferable (at least among the more complex editors). After a short period of watching some videos and reading a thing or two I quickly uncovered the presence of the everlasting holy war between Emacs and Vi users. Personally I've never been interested in participating in fanboy-ism. I don't particularly care what anyone else uses; as long as I'm content and efficient with what I have. Unfortunately though, due to the holy war it's nearly impossible to get any sort of objective assessment of the pros and cons of each editor.</p>
<p>Nonetheless I picked one and started spending some time with it. One thing is for certain, learning a new system definitely changes the way you approach data entry. I felt pretty much useless and slow at first, but held to my stubbornness and waited it out. It wasn't long before I had the basics down, and I realized that having something so amazingly customizable was really an amazing thing. In fact, thinking of it now I can't come up with a single other system that I use that offers this level of highly accessible customization. My car doesn't let me record a macro of me backing out of my driveway, (probably a good thing), I can't easily get my web-browser to load specific sites dependent on the time of day, heck I can't even change most keyboard shortcuts in my OS. The customization quickly became an addiction, I'd think constantly about how I could improve my work-flow or shave a few keystrokes off of a task I do often. Granted, all this thought and consideration often caused me to take an hour or so to figure out something that saved me a total of 30 seconds; but in that hour I'd also learn 2 or 3 other tricks that would also save me 30 seconds each time I used them. It became really fun actually to find new tricks and improve my expertise, and now I consider myself something of a Guru in my editor of choice (though I still have endless amounts to learn).</p>
<p>This post isn't to tell you which editor to use, I'd sooner help you decide whether you should bother learning one at all. First, if you're not a programmer, writer, or typist, I'd say it's probably just not worth the effort. I absolutely love these editors, but that's because as a programmer I'm often doing complicated reformatting, refactoring, editing dozens of files at a time, and testing code alongside it. If all that you do is type up an essay now and again or write up your grocery list, you're just not going to get a very good return on your investment. If you fit into one of the typing-centric categories however it MAY be worth your while. If you spend a lot of time in code then I'd say it's worth it (even if you're already far along in your career). Note that Vim and Emacs actually do relatively little in the way of helping with your TYPING, but rather help almost exclusively with EDITING and ORGANIZATION.</p>
<p>Without further delay, here's a list of objective (see: opinionated) pros and cons (take with a grain [or boulder] of salt).</p>
<h2 id="emacs">Emacs</h2>
<p>Emacs is often mocked by Vim users as "A great operating system, lacking only a decent editor", while Emacs users would disagree, there's still a shadow of truth in this statement. Emacs prides itself on being able to organize your projects, write your email, play Tetris, compile your code, and even tie your shoes for you in the morning! (Oh and it'll edit text too!)</p>
<p>This means that if you choose Emacs you'll likely end up using Emacs for almost everything text related, which is great actually because it means you'll only need to learn one set of shortcuts and one interface.</p>
<p>Emacs is also great (and far ahead of Vim) when it comes to doing more than one thing at once, and for being able to run and check code as you work on it. It's the defacto editor of most Lisps (it's also written in a Lisp variant, which helps) because it's a cinch to get a shell or REPL running alongside your project. All of these things are possible in Vim too of course, though you'll be in for more than a few headaches.</p>
<p>The downsides of emacs include the famed 'Emacs-pinky', a reference to the strain and difficulty of inputting some of Emacs's long mapping sequences. Since Emacs has decided to leave the keyboard open for typing it means all editor commands and shortcuts use one or more modifiers like control or alt to enter. This has the benefit of letting beginners type away on the keyboard as they expect it to work, but these complicated sequences can get tiresome and difficult to remember later on.</p>
<p>Emacs has <strong>strong</strong> extensibility in the way of plugins and sheer Lisp hackability. If there's something you want to do, you can probably find an Emacs plugin to help you do it, or build one yourself. You'll need to learn a bit of eLisp to do accomplish anything, but it makes sense and comes with a lot of power once you get used to it. Though honestly in most cases whichever functionality you require is probably already a part of some plugin in the repository.</p>
<h2 id="vim">Vim</h2>
<p>First off, Vim is a modal editor, that is to say that keys on your keyboard will do different things depending on which state the editor is in. This is both its weakest and strongest point. Most user interface designers will tell you that modes should be avoided whenever possible, consult the insightful <a href="http://www.azarask.in/blog/post/is_visual_feedback_enough_why_modes_kill/">Aza Raskin</a> for further study. However, in this case the modes are central to the whole design, so although they definitely confuse new users, seasoned Vimmers never forget which mode they're in because they use them very particularly, staying in 'normal' mode always except when switching to insert or visual mode for a quick change.</p>
<p>Vim takes a different design philosophy and runs with it. Vim is about having a dialog with your editor. You tell it what you want it to do and where to do it and Vim will happily oblige. It's best to think of Vim commands and shortcuts more as a language than as individual keypresses. For example, to change a paragraph to something else you position the cursor within the paragraph and press the keys (ignore the quotes) "cip". This is a small statement in Vim's 'language' that states (c)hange (i)nside this (p)aragraph. It has a verb (change) and an object to do the verb to (inside the paragraph). This system makes it very easy to remember Vim commands because you only need to spell out what you'd like to do (most keys have a pretty good mnemonic associated with them). Once you learn an action for use in one area you can automatically assume it'll also work on the other object and motion commands you already know.</p>
<p>Vim excels at editing the text that's in front of you as quickly and efficiently as possible. What it lacks in organization it makes up for in speed. It boots up in milliseconds and works just as well over ssh as it does locally. It's installed <em>almost</em> everywhere and like Emacs has a large userbase that is constantly adding functionality in the way of plugins.</p>
<p>Vim is very easy to customize, maybe not as easy as ticking boxes in a preferences panel, but you can get it to do almost anything you'd like if you think about it. One of the beautiful things about creating vim commands or mappings is that it uses the same interface as normal editing. The mapping you need is exactly what you'd type inside the editor. This means that the more you learn in the main editor, the more customization options you unlock.</p>
<p>Unfortunately if you'd like to write any plugins or more complex functions you'll need to learn some Vimscript, which honestly is simply an atrocious language (nearly everyone agrees).</p>
<p>Another area Vim currently has trouble is mostly related to concurrency. Vim is primarily single-threaded and so can't do more than one thing at a time. This currently is being addressed in an offshoot called NeoVim, (see my post on that <a href="http://www.chrispenner.ca/post/gem-neovim">here</a>), though it's got a bit of a way to go yet. Vim isn't great at multitasking or doing complex tasks like email or chat, but it's blazing fast at doing the editing it's designed for.</p>
<h2 id="summary">Summary</h2>
<p>So, there's good and bad to each, though they definitely do fill two different niches at the end of the day, if only we could have both... oh wait! There's a way to do that actually. There's a plugin called Evil that emulates Vim's modal interface almost flawlessly within Emacs. This allows the quick and effective editing commands of Vim within the adaptability and all-inclusiveness of Emacs. Some would say this is the way to go, the best of both worlds, but the jury is still out on this one.</p>
<p>Some things to check out (check back for more posts on getting started soon):</p>
<ul>
<li>Type vimtutor on your terminal to get started on Vim.</li>
<li>Download &amp; open Emacs then press Ctrl + h, t for an Emacs starter.</li>
<li>Bling has written some great articles on Emacs, Vim, and their intersection <a href="http://bling.github.io/blog/2013/10/16/emacs-as-my-leader-evil-mode/">here,</a> <a href="http://bling.github.io/blog/2013/10/27/emacs-as-my-leader-vim-survival-guide/">here,</a> and <a href="http://bling.github.io/blog/2013/10/16/emacs-as-my-leader-evil-mode/">here.</a></li>
</ul>
<p>Anyways, I hope you consider putting in a bit of an investment to save yourself time in the long run! It's totally worth it, no matter which tool you use (Sublime Text is pretty good too!). Drop a comment or find me on twitter if you have any questions. Cheers!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Gem: Font-Awesome</title>
      <link href="https://chrispenner.ca/posts/gem-font-awesome"/>
      <id>https://chrispenner.ca/posts/gem-font-awesome</id>
      <updated>2015-01-21T00:00:00Z</updated>
      <summary>Check out Font-Awesome</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/font-awesome-logo.png" alt="Gem: Font-Awesome">
              <p>Not all open-source projects are software or code! Here's a project that has definitely helped me out as I build various websites.</p>
<p>Their site states their project best: "Font Awesome gives you scalable vector icons that can instantly be customized — size, color, drop shadow, and anything that can be done with the power of CSS." This has many advantages over using images for these icons. Firstly they can be included with other text in-line without any trouble, no need to worry about margins/padding etc. The icons will also scale with their font size according to the CSS. Lastly (this was a game-changer for me) you can change the colour of the icons in any way you can change text-colour. This makes mouse-over responsive buttons a cinch and also means you don't need to recolor every icon on the site when you change your colour-scheme.</p>
<p>All of these perks are on top of the fact that you don't need to hire an artist to create these icons in the first place, they've got quite a comprehensive collection already.</p>
<p>TLDR:</p>
<ul>
<li>Every type of icon you could need available as one easy font.</li>
<li>Icons scale, change color, and react like text.</li>
<li>Free!</li>
</ul>
<p>Go ahead and check out the icons and maybe even add one of your own here: <a href="http://fortawesome.github.io/Font-Awesome/">Font-Awesome</a>.</p>
<p>Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to catch new articles as they come!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Worth a Read #3 - Typography</title>
      <link href="https://chrispenner.ca/posts/worth-a-read-3"/>
      <id>https://chrispenner.ca/posts/worth-a-read-3</id>
      <updated>2015-01-13T00:00:00Z</updated>
      <summary>Check out these posts!</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/typography-t.png" alt="Worth a Read #3 - Typography">
              <p>This time we're talking typography. Some would say that good web-design is 90-99% typography. I'll let you decide whether you want to believe that, but regardless a few more tools in the typography tool-chest sure doesn't hurt. Here are a few articles to check out.</p>
<p>Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to keep up with future posts!</p>
<p>###Worth a read:</p>
<ul>
<li><a href="http://typ.io">Some well curated heading &amp; body font pairings</a></li>
<li><a href="http://tendollarfonts.com/">Beautiful Ten Dollar Fonts!</a></li>
<li><a href="http://femmebot.github.io/google-type/">Some very beautiful handpicked font-pairs from (Free) Google Webfonts</a></li>
<li><a href="http://hellohappy.org/beautiful-web-type/">More of the best (Free!) Google Webfont pairings</a></li>
<li><a href="http://flippingtypical.com/">Display and peruse all the fonts on your computer</a></li>
<li><a href="http://trentwalton.com/2012/06/19/fluid-type/">A discussion of adapting typography to the web. Mostly here because I just really wanted to link to Trent Walton, he's a typography/web-design genius</a></li>
<li><a href="https://tobi.oetiker.ch/lshort/lshort.pdf">A not so short introduction to the LaTeX document layout and typesetting system</a></li>
</ul>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Gem: Git</title>
      <link href="https://chrispenner.ca/posts/gem-git"/>
      <id>https://chrispenner.ca/posts/gem-git</id>
      <updated>2015-01-05T00:00:00Z</updated>
      <summary>Check out git</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/git-logo.png" alt="Gem: Git">
              <p>Speaking of open-source gems, it's tough to make it too far into this topic without mentioning Git. If you've been at all involved in the open source community recently then you're certainly familiar with it already. If not, then learning Git is a great place to start your journey into open-source tech.</p>
<p>Git is a distributed version control system that has taken the open-source world by storm. In contrast with most previous version control systems, everyone working on a project has access to their own copy of the source files. They can change them as they like, and then may merge their changes back into the main repository when their change is complete. This method allows hundreds of people to work on the same project at a time, and git's focus on branching and merging makes it painless to add experimental features. In addition to it's unique design, git is also blazing fast in comparison with it's competition.</p>
<p>Git has seamless integration with Github, a website dedicated to hosting open-source software that is managed with git. At any rate, I can yammer on about it, or you can just go check it out and start using it.</p>
<p>TLDR:</p>
<ul>
<li>Git's <em>Distributed</em> nature allows hundreds of people to work on a project at the same time.</li>
<li>Git is fast and is built around the ideals of quick branching and merging</li>
<li>Git's integration with Github (for hosting) make it a great choice for hosting open-source projects.</li>
</ul>
<p>If you want to check out the source, of course you can find it on <a href="https://github.com/git/git">Github</a>, read the documentation to learn how to contribute.</p>
<p>Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to catch new articles as they come!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Procedural Generation is the Future</title>
      <link href="https://chrispenner.ca/posts/procedural-content"/>
      <id>https://chrispenner.ca/posts/procedural-content</id>
      <updated>2015-01-03T00:00:00Z</updated>
      <summary>Procedural generation allows us to build incredibly vast and rich systems</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/no-mans-sky.png" alt="Procedural Generation is the Future">
              <p>I 've been noticing a trend in gaming recently towards procedurally generated content. <a href="https://minecraft.net/">Minecraft</a> has it, <a href="http://playstarbound.com/">Starbound</a> and <a href="http://terraria.org/">Terraria</a> have it, and randomized rogue-likes are running amok. No longer do we just play the same level over and over again until we memorize it well enough (remember Super Mario Bros?). The new gaming paradigm is one of discovery and adventure! While I know from experience that meticulously planned dungeons and carefully crafted levels can deliver an amazing experience, there are several reasons as to why I think the trend towards procedurally generated content is a good one.</p>
<p>These are some of the primary benefits I've discovered in using procedural generation:</p>
<ol>
<li><strong>PG Allows you to produce near unlimited amounts of content.</strong></li>
<li><strong>PG Saves disk space.</strong></li>
<li><strong>PG Spikes Creativity</strong></li>
</ol>
<p>##1) pg allows you to produce near unlimited amounts of content.</p>
<p>If <a href="https://minecraft.net/">Minecraft</a> or <a href="http://terraria.org/">Terraria</a> had been built by hand with only one world to explore, people would have figured out its tricks, read about them online, figured out the quickest way to their goal and would be done with them by now. A key part of what makes these games special is that they have amazing replay value because the whole world changes every time you start over. You can explore as far as you like, the developer didn't need to put bounds on the world because the computer can just follow its rules and continue to create! A procedural generation approach lets your world create and discover itself!</p>
<p>##2) pg saves disk space.</p>
<p>One amazing and mostly unintended benefit of generating your world on the fly is that an entire game world can be represented as a seed value of just a few letters or numbers. If a part of the world hasn't been altered, then any given section of that world can be regenerated as needed from the seed value. Since math doesn't change, it will turn out the same every time. In a world like <a href="https://minecraft.net/">Minecraft</a> where the world morphs and changes, only the differences from the generated world need to be remembered and can be applied like a patch. This means that in a game like <a href="http://www.no-mans-sky.com/">No Man's Sky</a> with 18 quintillion planets, every one of those planets can be remembered with a single seed value taking up no more than a few bits.</p>
<p>##3) pg spikes creativity</p>
<p>When things are randomly generated, sometimes they don't always go according to plan. While this is one of the bigger frustrations with creating this sort of game, it's also one of the best sources of inspiration. Did a bug in your system accidentally create an entire city under the ocean biome? Cool, that might be fun! Uh-oh, gorillas are accidentally spawning all over the north pole, what would a tribe of arctic apes look like? The unexpected nature of generators like this can spark some interesting ideas. I can't remember how many times I've been cruising through Spelunky when something so beautifully unplanned causes my run to come to a hilarious and unpredictable demise.</p>
<h2 id="case-study">Case Study</h2>
<p>Let's examine two cases, that of Assassin's Creed and that of No Man's Sky, which is unreleased at the writing of this article, however most of its design principles have been announced through various developer interviews. Assassin's Creed is made by Ubisoft, a corporate giant; ballpark estimates for the number of employees working on <a href="http://assassinscreed.ubi.com/en-us/games/assassins-creed-black-flag.aspx">Assassin's Creed IV: Black Flag</a> range between 900 and 1000 people. In the other corner we have Hello Games, a team of less than a dozen people who are developing No Man's Sky, a far reaching game about space exploration that according to the developers could have as many as 18 quintillion possible planets. How is it that it takes a team of over 900 people to craft one world, when a team of 10 can craft 18 quintillion? It's a matter of where they've invested their effort.</p>
<p>Ubisoft is using a more traditional development paradigm. They are designing their world by hand, carefully crafting graphical assets to fit that world as it is designed. This means that every window, building, nook and handhold are intentionally placed, by hand, in spots that a designer chose. This method, while effective, is clearly time consuming and can sometimes seem too contrived.</p>
<p>Hello Games on the other hand have decided to leverage the full power of their paradigm and have decided to put their hard work into creating a clever system that will do the rest of their work for them. They decided that instead of crafting worlds, they would create a world-crafter. The initial work-load to do this is substantial, but the payoff is that now they can create as many worlds as they like with little effort, able to tweak their algorithm as they go along.</p>
<p>The take-home point here isn't that every game should be using procedural generation, but rather that every developer should at least <strong>consider</strong> whether it's appropriate for their current use case. Who knows, could end up saving you a ton of time and adding some awesome new features.</p>
<p>Cheers everyone!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Worth a Read #2 - CSS</title>
      <link href="https://chrispenner.ca/posts/worth-a-read-2"/>
      <id>https://chrispenner.ca/posts/worth-a-read-2</id>
      <updated>2014-11-10T00:00:00Z</updated>
      <summary>Check out these posts!</summary>
      <content type="html"><![CDATA[
              <p>This Worth A Read highlights some articles about CSS. See how the pros do things and learn a new trick or two.</p>
<p>Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to keep up with future posts!</p>
<p>###Worth a read:</p>
<ul>
<li><a href="http://codepen.io/chriscoyier/blog/codepens-css">Overview of CodePen's CSS Organization and Design</a></li>
<li><a href="http://codyhouse.co/gem/icons-filling-effect/">Learn how to create an icon-filling scroll effect</a></li>
<li><a href="http://www.hugeinc.com/ideas/perspective/why-the-best-designers-dont-specialize">Why the best designers don't specialize</a></li>
<li><a href="http://demosthenes.info/blog/908/The-First-CSS-Variable-currentColor">The first CSS variable: currentColor</a></li>
<li><a href="http://alistapart.com/blog/post/ten-css-one-liners-to-replace-native-apps">Ten CSS one-liners that replace native-apps</a></li>
</ul>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Gem: Jekyll</title>
      <link href="https://chrispenner.ca/posts/gem-jekyll"/>
      <id>https://chrispenner.ca/posts/gem-jekyll</id>
      <updated>2014-11-03T00:00:00Z</updated>
      <summary>Check out Jekyll</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/jekyll-logo.png" alt="Gem: Jekyll">
              <p>Jekyll is a web-framework written in Ruby for creating <em>static</em> pages. If you're unfamiliar with the term, <em>static</em> means that it can take a set of input files and turn it into a site that's linked up very nicely, but cannot provide any interaction with the user, nor can it react to it's environment by using a web-server. Interactivity is still available on the client-side through the use of javascript of course.</p>
<p>Jekyll is very good at things like making informational sites, or even simple blogs. It will parse markdown and load it into templates for you, which makes it quick and easy to write content for your site. If creating a blog is something that interests you, also check out <a href="http://octopress.org/">Octopress</a>, which is a blog framework built on top of Jekyll.</p>
<p>If you've always wanted your own blog, or even just want to get started learning out to create a website, now is a good a time as any. Jekyll and Octopress integrate perfectly with <a href="https://pages.github.com/">Github Pages</a>, which allow you to host static sites completely free!</p>
<p>TLDR:</p>
<ul>
<li>Jekyll is a quick and easy static site framework.</li>
<li>Host a blog for free on <a href="https://pages.github.com/">Github Pages</a>.</li>
</ul>
<p>If you want to check out the source it's available on the Jekyll <a href="https://github.com/jekyll/jekyll">Github page</a>.</p>
<p>Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to catch new articles as they come!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Worth a Read #1</title>
      <link href="https://chrispenner.ca/posts/worth-a-read-1"/>
      <id>https://chrispenner.ca/posts/worth-a-read-1</id>
      <updated>2014-10-31T00:00:00Z</updated>
      <summary>Check out these posts!</summary>
      <content type="html"><![CDATA[
              <p>This marks the beginning of a new feature, <strong>Worth a Read</strong>, which will contain a quick and easy list of blog posts and articles that I've found interesting recently. They may have to do with programming, design, lifestyle, cool products, or anything else I've been reading. Might be themed, might not! Hope you enjoy it!</p>
<p>This week's list contains a variety of topics from different disciplines, hopefully you'll find something interesting! Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to keep up with future posts!</p>
<p>###Worth a read:</p>
<ul>
<li><a href="http://vimeo.com/100264064">A clever and informative talk about CSS's quirks</a></li>
<li><a href="http://lifehacker.com/wordmark-it-instantly-previews-all-your-installed-fonts-1624496407">Wordmark.it helps preview all your fonts</a></li>
<li><a href="http://nothingbutsnark.svbtle.com/how-to-argue-for-pythons-use">Python (vs?) Go</a></li>
<li><a href="http://www.agencypost.com/10-principles-design-transformed-gorgeous-colored-paper-posters/">Principles of design as a poster series</a></li>
<li><a href="http://lifehacker.com/the-30-percent-rule-and-the-art-of-early-feedback-1619474527">The 30% rule of early feedback</a></li>
</ul>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Gem: Neovim</title>
      <link href="https://chrispenner.ca/posts/gem-neovim"/>
      <id>https://chrispenner.ca/posts/gem-neovim</id>
      <updated>2014-10-15T00:00:00Z</updated>
      <summary>Check out Neovim</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/neovim-logo.png" alt="Gem: Neovim">
              <p>This is the first of a series which will highlight open-source "Gems in the rough" that is, projects which are worth taking a look at, downloading, or contributing to. Let's get started!</p>
<p>Neovim is a rebirth of the retro text editor <a href="http://en.wikipedia.org/wiki/Vim_(text_editor)">Vim</a> (circa 1991). It's interesting that the team decided to rebuild it because Vim itself is still very much alive, there are new plugins and patches released often and development on it continues. The folks at Neovim have realized however that it's getting old and the Vim Script language that original vim plugins are written in is a syntax nightmare. It's tougher to extend and interact with than it could be, so they decided to renew the project by rebuilding the entire code-base into something easier to maintain.</p>
<p>Some of Neovim's driving principals are as follows:</p>
<ul>
<li>Allow vim to be extended in any language.</li>
<li>Allow plugins to run asynchronously and send events.</li>
<li>Implement an embedded text interface, ready for integration into any application.</li>
</ul>
<p>I'll be writing more about vim and what it's capable of soon, so keep an eye out for more, and run vimtutor on your terminal to try it out! You can help out right now by checking out the source on <a href="http://github.com/neovim/neovim">Github</a> or by donating on <a href="https://www.bountysource.com/teams/neovim/">BountySource</a>.</p>
<p>Follow me on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> to catch new articles as they come!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>You Own Your Data</title>
      <link href="https://chrispenner.ca/posts/you-own-your-data"/>
      <id>https://chrispenner.ca/posts/you-own-your-data</id>
      <updated>2014-09-26T00:00:00Z</updated>
      <summary>Don&#39;t give up control over your data</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/security-vs-privacy.jpg" alt="You Own Your Data">
              <p>First off, thanks for taking the time to read this, please send me a message on twitter <a href="http://www.twitter.com/chrislpenner">@chrislpenner</a> if you have ideas or comments, and share this post around if you agree with it.</p>
<p><em>Comic used with permission of <a href="http://www.claybennett.com/">Clay Bennett</a>.</em></p>
<p>Okay, so what's this whole thing about? To put it in a nutshell for you: our data is important, our data isn't safe, therefore something needs to change. What is Facebook doing with your data? Are they giving it to the NSA? What if my employer finds out about such and such? We spend far too much time worrying about whether our data is safe and what would happen if these businesses that we trust with our virtual lives decide to go bad.</p>
<p>Most people you ask would say that Facebook (who I'll be picking on because they're most popular at the time) is free to use, but the reality is far from that, the cost is your data. Facebook doesn't work unless everyone shares data. You can't actively use your FB account unless you take the plunge and decide to give them your pictures, thoughts, buying habits, movie and music likes and dislikes... the list goes on. Everyone knows that they're giving this information away, but when asked, most would say they don't really have much of a choice. They either share their data, or Facebook becomes useless. Heck, I myself have been keenly aware of this for years, but I still participate because having access to my friend's thoughts, contact info and photos is far too convenient to justify giving up. We've grown to a place where every one of us needs social media in some form or another, that's not even a question at this point, the question then becomes: Who do we trust to handle all this data?</p>
<p><em>Think about that for a minute, maybe even two...</em></p>
<p>No, seriously, stop looking at this screen and actually think: Who do you really trust to handle all of your personal data? Trust is important.</p>
<p>Now I don't know about you, but my answer was simple, I can only trust myself. I propose we address this issue by decentralizing data storage. There's a very important clarification to make: the data is separate from the service. Facebook isn't a collection of data, it's a service that curates and presents a collection of data to you. What this means is that programs like Facebook's "news feed" could exist and be maintained separately from the data itself.</p>
<blockquote>
<p>Who do we trust to handle all this data?</p>
</blockquote>
<p>I propose that as an open-source community we devise a generic social media program which users can download and run on their computers which pulls in data and presents data about users from personal data repositories. Users can choose to host their data wherever they feel comfortable, maybe on their own secure web server, maybe on Dropbox, maybe they trust a third party site with it, maybe they can even host it on their own computer, the point is that this choice is up to the user and the user alone. This data would then be pulled down to the program when requested if and only if the user who is signed into the program has that person's permission to do so, either through a link or some sort of case by case verification system; think of friending on Facebook or sharing a document on Google Drive. These permissions can be revoked by the owner of the data at any time, or the data can simply be deleted from their own storage container.</p>
<blockquote>
<p>The data is separate from the service</p>
</blockquote>
<p>Though this system has its own challenges, I believe it solves some major problems. In the new model:</p>
<ul>
<li>Data is decentralized. (No one company controls it all)</li>
<li>Control belongs to the data's owner. (They can change, delete, or revoke the permissions of their own data)</li>
<li>No middleman. (The open-source software would pull data directly from people's sources to the user's computer, no opportunity for it to be snatched up)</li>
<li>Extensible. (Once everyone is hosting their own data and the process is standardized in some fashion, new programs and social networks can simply use existing data-stores and people don't need to rebuild their virtual life every 5 years)</li>
</ul>
<p><em>It'll take work, it'll be a tough change, but if we don't demand it, it'll never happen.</em></p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>The Future of Software</title>
      <link href="https://chrispenner.ca/posts/modular-software"/>
      <id>https://chrispenner.ca/posts/modular-software</id>
      <updated>2014-09-24T00:00:00Z</updated>
      <summary>The future of software exists in modularity and modularity</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/modular.png" alt="The Future of Software">
              <p>I 've always been annoyed with software, the particular reasons have changed consistently over the years, but I think that for all of us there's always been something that gets on our nerves; whether it's how your word processor never indents your lists properly, or how your computer's calendar starts on Sunday when you'd prefer to have it start on Monday.</p>
<p>Lately what's been bothering me is the closed-ness of most desktop software in general. Don't like the default colour-scheme? Too bad, you can't change it. Don't like the way your notes are laid out? Too bad, can't change that either. Want to use your favourite text editor instead of that tiny box they're giving you? Nope!</p>
<p>This problem has actually already been solved for the most part. The solution exists in <em>modularity</em>. For the uninitiated, modular design means that the way a thing works is separated into distinct sections. A home theater system would be a good example to think of: you have a source for your sound and video (A DVD player perhaps) the video signal proceeds to your Television, the sound goes to your amplifier, then continues to your speakers. Each link in this chain has a specific purpose and works independently from the other links. If you'd like to switch out your speakers, you simply unplug the old ones and plug the new ones in. Similarly with the video signal; the DVD player doesn't care where the video ends up. If you'd like to switch your Television out for a Projector, Video Recorder, or even a toaster it doesn't know the difference and continues to happily send video. Whether you'd like to view your movie on a toaster or an IMAX screen is entirely up to the user (though the viewing experience is likely to change dramatically).</p>
<blockquote>
<p>The solution exists in modularity.</p>
</blockquote>
<p>Unfortunately, in the world of software the parts aren't as clearly defined. Where should one box end and another box start? Modern web technologies provide insight into this. Websites are complicated these days. On any given news website you'll have writers, designers, programmers and editors all working together to deliver a good experience. To keep these groups from stepping all over each other's toes content, presentation, and behaviour must be separated from each other. These aspects correspond to HTML, CSS, and Javascript respectively. HTML contains the content and gives the content meaning, CSS tells the browser how to present it, which colours to use and what goes where, while Javascript handles any user interaction and responds accordingly. I believe this is how we should be modelling our desktop software.</p>
<p>Whether this means actually using HTML, CSS and Javascript for desktop software I'm not sure (that's certainly a possible solution), but whichever tools are used, the programs created must recognize what they're actually trying to do and should focus solely on that. If a program is an email client it should handle the sending and receiving of email and should do it well, and do no more and no less. Allow the user to patch in and use any text editor they'd like to create those emails. All programs should allow mixing and matching of different program components.</p>
<p>A strong benefit to this approach is that it would allow programs to easily interact with one another and solve problems together. This is something that is nearly impossible to do given the current architecture. Imagine a "Dashboard" plugin that focused only on bringing multiple programs from your computer together in one place. You'd have a column of emails on the right, some favourite music playlists on the left, your favourite text editor in the middle that can send directly to Evernote, Microsoft Word, Email, or a text message. When the user chooses an action to perform the Dashboard sends the appropriate <em>event</em> to the corresponding program with any necessary text or user information as parameters. A timer app could send an email, start a song or switch into "work-mode" when certain timer events fire. Users could easily design new facades for their favourite clients so long as it sends any necessary events and data to the program behind the scenes.</p>
<p>Responding to any and every event in any way you like provides extensive hackability to everything. Note-taking apps and Email clients wouldn't need to go through all the work to (poorly) implement autocompletion or spell-checks because that would be the job of the text editor (which it would do well).</p>
<p>I'm sure that you can see that the possibilities are nearly endless if we can just unlock this method of interaction and modularization. Everyone can work on doing just one thing well and can borrow all the other functionality from other programs.I can only hope we'll end up there eventually.</p>
<p>Until next time.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Set the Data Free</title>
      <link href="https://chrispenner.ca/posts/set-the-data-free"/>
      <id>https://chrispenner.ca/posts/set-the-data-free</id>
      <updated>2014-08-02T00:00:00Z</updated>
      <summary>Simple formats afford adaptability</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/set-the-data-free.png" alt="Set the Data Free">
              <p>So lately I've been noticing something. The way we consume our data is changing, suddenly just having data isn't good enough, it's all about presentation. Most modern data formats such as Microsoft Word documents, Powerpoint Slides and PDFs are increasingly focused on making your data LOOK good.</p>
<p>This is a good thing, it's good that consumer computing has developed to a point where we have enough tools to easily format and present our data the way we want, and it's great that as a result we can send messages not only through the text itself, but also through the way we display it, but we're losing something valuable with this transition as well: The ability to manipulate plain-old vanilla text. Most data is now being trapped inside proprietary layers of code. While tools like grep can still sometimes decipher these encodings and still find what you're looking for, piping text from a Powerpoint file, formatting the string with Unix utilities, then compiling it with several other Powerpoint files and their text would not be a pleasent experience.</p>
<p>I understand that all of this formatting is complicated, that it would not be easy to encode a modern day Word document without using special characters and bytes and bytes of stored settings; however, I think it's worth looking for a compromise.</p>
<p>Two options come readily to mind. Perhaps text from Word Documents, Powerpoints, PDF files, and other proprietary formats could be included in full as a precursor to the needed code which would then use combinations of line-numbers or character addresses to apply formatting to code in chunks. Perhaps transformations could be performed through the use of recognized tags (similar to HTML) which could be parsed or ignored depending on context. These both have the downside of unnecessarily bloating the files and increasing the data stored on disc, and would get complicated very quickly with more complex presentations, however they would allow common command-line programs to be taught to understand them properly and allow full command-line piping and functionality.</p>
<p>Unfortunately, it would be very difficult (see: impossible) to get vendors to agree on a set convention for this and would most-likely lead to big tangled mess of competing standards, but as I learn more and more about Unix utilities and the wealth of functionality that they provide, it seems a crying shame to invalidate them all just because we'd like a bold word or want to position our margins correctly. Ideally there would be a strong way to separate content from formatting a la HTML and CSS.</p>
<p>It is also unfortunate that so few people know and use the command line these days, there are so many shortcuts and so much functionality in their computers that they're missing. Let's hope more will be inspired to explore!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Legacy in Design</title>
      <link href="https://chrispenner.ca/posts/legacy-in-design"/>
      <id>https://chrispenner.ca/posts/legacy-in-design</id>
      <updated>2014-07-26T00:00:00Z</updated>
      <summary>Things that come before greatly affect the success of our design</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/legacy-in-design.png" alt="Legacy in Design">
              <p>Designers often feel pressure to come up with something new and revolutionary. They want to make their mark on the design world by revolutionizing some new concept or idea. Certainly this form of thinking is a good thing; it fuels innovation and leads to exciting new possibilities that others wouldn't have ever contrived. However, humans build habits, and if we're designing for humans we simply must take this into account.</p>
<p>##Habits. Have you ever switched operating systems and found yourself trying to close a window but the 'X' is on the wrong side? Have you ever driven a friend's car and suddenly jerked forward because their gas pedal was more sensitive than you were used to? Humans are habit forming creatures, we build muscle memory and our brains will begin to automate tasks that we perform often enough. This is a great thing! Can you imagine the effort that typing would require if you had to consciously remember where each key was and deliberately press them in sequence?</p>
<p>Whether we like it or not, our design 'ancestors' have pioneered the field and have developed many habits in users. Some good, some great, some absolutely terrible. This means that whenever you make a design decision we must all be conscious of how the user expects it to work from past experience, and then only change it if we're certain that the improvement strongly outweighs the discomfort the user will endure learning the new system.</p>
<p>You must ask yourself, will the user do this enough to develop a new habit? If you're designing a simple company website, or a simple utility program the answer is no. It is better to follow convention and lay out the site as people would expect, even if your design and layout is 'improved' in some way.</p>
<p>##Innovation. How then can we innovate? There's a few options here. Unfortunately in most cases, as a single designer it is simply impossible to have a large enough effect to change the design landscape. Existing habits are strongly formed by years of legacy and shift only slightly over many many years.</p>
<p>One way the design landscape changes is through the introduction of new mediums. Mobile devices and tablets, though they are computers, are different enough from laptops and desktops so as to require a fundamental shift in design paradigms. It is in these moments that designers thrive. When technology is new, habits have yet to form and designers can form the landscape as they see fit. These are times when designers must be conscious of every little decision they make, for it again sets precedent for all future designers in the medium.</p>
<p>Good luck!</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>Caps-lock</title>
      <link href="https://chrispenner.ca/posts/capslock"/>
      <id>https://chrispenner.ca/posts/capslock</id>
      <updated>2014-05-25T00:00:00Z</updated>
      <summary>Caps lock is poorly designed. Read to find out why</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/capslock.png" alt="Caps-lock">
              <p>Any time I consider decisions of designers past, my mind always drifts towards the keyboard. It is a ubiquitous piece of hardware that most take for granted. If you take more than a second to think about it, it's a very strange design. The letters seem to be placed without rhyme or reason, most layouts have rows staggered by a seemingly arbitrary amount from one another, some keys are mirrored on either side (shift, control, etc) others are not (tab, return). It seems as though no-one in their right mind would ever design such a piece of work! The keyboard is the result of years of 'legacy' design, one or two things get carried over from iteration to iteration and over time the sense of it all is lost.</p>
<p>Even stranger is that the nonsensical layout doesn't tend to slow us down in the slightest. Once learned it is sufficiently fast. Studies have shown that even laboriously designed key layouts (Dvorak) provide only very modest improvements to typing speeds.</p>
<p>The worst offender of design legacy that I have yet to come across is the Caps-lock key. Here's just a few of the many reasons why:</p>
<p>Caps-lock is the only modal key on the keyboard, (i.e. press to engage, again to disengage), this is extremely unintuitive and is a source of constant frustration. Consult the brilliant <a href="http://www.azarask.in/blog/post/is_visual_feedback_enough_why_modes_kill/">Aza Raskin</a> for more on how modes break things. People begin to type without knowing that Caps-lock is engaged and after writing one or two lines they notice that they've been yelling the whole time. They must then delete the whole thing because for some reason there's STILL no easy way to switch cases on already typed text in most editors.</p>
<p>This would be bad enough as-is, however someone had the gall to place this evil key in prime real-estate where it is easily accessible, and is often pressed by accident.I don't know how it ended up where it is, but I do know that it shouldn't be there. Why not use this position for shift or Ctrl/Cmd ? I can't think of any good reasons, can you?</p>
<p>Caps-lock offends again in the behaviour department. Standard Caps-lock behaviour is nonsensical. At first glance it appears as though engaging Caps-lock simply locks the shift key ON, though when one attempts to type a symbol or number key, one finds that this isn't the case. This destroys the initial mental model that is formed and forces each person to learn a completely new typing paradigm for these few small use-cases.</p>
<p>I don't we ended up here, but I think it's about time to start a trend towards making the Caps-lock key useful again or deprecating it from future designs. You can start right now by rebinding it to something useful to you and encouraging your friends to do the same. Being a faithful Vim user I've bound it to act as Escape on every system I own. If you're not a Vim user, I'd recommend trying Ctrl/Cmd. Rebinding on OSX is as simple as looking through the system settings and changing the modifier keys, for more complex mappings I recommend <a href="http://pqrs.org/macosx/keyremap4macbook/pckeyboardhack.html.en">PCKeyboardHack</a>. For Windows I'd check out <a href="http://www.autohotkey.com/">AutoHotKey</a>. For Linux try googling an appropriate xmodmap command.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
  <entry>
      <title>The Switch To Mac</title>
      <link href="https://chrispenner.ca/posts/switch-to-mac"/>
      <id>https://chrispenner.ca/posts/switch-to-mac</id>
      <updated>2014-05-19T00:00:00Z</updated>
      <summary>I switched to using a Mac, and I love it</summary>
      <content type="html"><![CDATA[
          <img src="https://chrispenner.ca/images/the-switch-to-mac.png" alt="The Switch To Mac">
              <p>The time had come to replace my slowly fading laptop, it had served me well in the last four years, but all good things must come to an end. I was faced with a choice: which operating system do I commit to for my next four years? As a Computer Science student I wanted to make the right choice. These days most things I could ever want to do are possible on any one of the big three (Windows, OSX or Linux), so it was mostly a choice of form factor and style. How would each choice affect my experience throughout the years to come? Would I have to give up some long-loved programs that I had invested my time and money into? How could it affect my workflow? Here's a bit about my past experience with each OS.</p>
<h2 id="windows">Windows</h2>
<p>I've always been a Windows guy. My family grew up with them. I can still remember playing computer games with my father on our old Windows 2.1 desktop. My Father works in IT, so we managed to keep up with trends and usually had the latest version Windows on mostly-decent hardware. I'd gotten used to it and didn't have any reason to mess with a good thing so when I got my first personal laptop as a graduation gift naturally I went with Windows 7. It mostly did as it was told, it rarely complained, it handled device drivers like a champ. Aside from the occasional annoying "Your computer will reboot for updates in 5 minutes" I didn't have any major complaints. It was only once I started to get a little deeper into programming (mostly in C++) that I started to find a few shortfalls. Installing any sort of IDE was a nightmare due to way the file system was (mis)organized. Things you attempt to install would misplace libraries or install them twice. There's really no system for where programs were meant to put things and often programs would clutter up my own files with their junk. Since when do Adobe plugin files count as "Documents"?</p>
<p>Installation problems could usually be fixed by editing some complicated system settings that weren't meant to be messed with. Editing the system path consisted of fumbling through a long jumbled line of file paths all sandwiched together in a fixed size text-box, making it impossible to see what's already there, nor what you're changing. The native command-line interface is lacking in most areas and isn't meant for doing any serious work in. These design warts, legacies of the Microsoft's past OS's have been patched and repaired, but continue to cause problems in their modern OS's. Around this time I started fiddling around with Linux, more specifically Ubuntu, to see what it could do.</p>
<h2 id="linux">Linux</h2>
<p>After getting fed up with some of Windows' more annoying design and organization problems I sought to try out the veteran-praised Linux. I started out with Ubuntu because I'd been told it was easy both to install and understand, which was perfect for someone new to the command-line like me. I installed it onto a partition on my Laptop, choosing to dual-boot with Windows because I wasn't sure I'd be ready to make the switch cold turkey. Once Ubuntu had very kindly walked me through the installation I excitedly began to study the BASH command line and some of the things it could do. I was amazed when I learned I could type a simple 'sudo apt-get' to have my system download, install, and update most common programs. Though it uses the command-line, this seems like a vastly superior method of installation. No need to hope you downloaded the right version for your system, installing it manually, then deleting the installation files afterwards.</p>
<p>The Unix core's structure is very well defined, you know where to look for your programs, hard-drives, configuration files, etc. Your home folder is kept separate for your own personal use where you won't accidentally mess with anything important. Everything is properly modularized for easy organization and security. The 'root' permissions system seems much more secure than the Windows 'always administrator' approach that most people default to. Unfortunately, my laptop wasn't supported 100% in everything, so I had to do a little fiddling to get things like my function keys and headphone jack to work properly, but once configured it worked fine. Flash was an issue, my browsers couldn't load YouTube videos or listen to flash-based music players, but after installing a more recent version of Ubuntu most of those problems went away. Overall it worked great and I really enjoyed the system, but Linux still has fewer options available for software than the other OS's.</p>
<h2 id="mac">Mac</h2>
<p>I had never had an apple computer before, in fact prior to purchasing my macbook I had never purchased a single product from apple. I knew their reputation well however, "It just works!" my friends would exclaim. I liked the idea of it, but of course I used Windows with pride, sure it was a little tougher to do some things, but hey, I'm a Computer Science student so of course I can figure it out. Of course, I never stopped to ask myself weather I should actually have to put that work in. The philosophy and design of apple products eluded me, I just wasn't convinced. Then I started comparing bullet points.</p>
##Pros/Cons
<p>###Windows <strong>Pros</strong></p>
<ul>
<li>Familiarity</li>
<li>Well-supported</li>
<li>Inexpensive</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Disorganized OS structure</li>
<li>Difficulty with programming tools</li>
<li>Bad command-line (bring on the hate-mail)</li>
</ul>
<p>###Linux (Ubuntu) <strong>Pros</strong></p>
<ul>
<li>Open Source</li>
<li>Constantly updated</li>
<li>Free</li>
<li>Unix command-line</li>
<li>Unix system structure</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>Poorly supported on some hardware</li>
<li>Less choice of software</li>
</ul>
<p>###OSX <strong>Pros</strong></p>
<ul>
<li>Lots of software available</li>
<li>Powerful and reliable hardware.</li>
<li>Unix system structure</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>"Hold your hand" approach</li>
<li>Expensive</li>
<li>Stuck in apple's dictatorship</li>
</ul>
<p>After considering the pros and cons of each, I pulled out my yellow legal pad and began to rank things based on their importance to me. After a few minutes I realized that I was really quite fed up with the Windows file structure and sloppy organization/installation. The registry is really just a bad idea, made worse by every new iteration. That left me with two options, Linux or OSX. I really liked Ubuntu and how much control it gave me over everything, it was well organized, supports the free-software movement and was also free of charge. OSX is also very well organized, it limits control over some aspects, but in turn delivers a well designed experience that is intuitive and efficient. In the end, the combination of a large software ecosystem, well-built hardware, and good customer support won out in the end and I dove in head-first, purchasing a re-furbished 13" macbook pro retina with a 2.6 GHz processor.</p>
<p>Now that the dust has settled I'm very happy with my decision. There were a few bumps in the road of adapting to the new OS, but most things were just a matter of learning a slightly new way of doing things. I can confidently say that I'm very impressed with how OSX handles application installation (in most cases you simply drag application files onto your hard-drive and they work as-is). I haven't experienced a single crash or hang-up yet, and if one were to occur I know that time-machine would allow me to recover gracefully. I've been able to reconstruct most of my old Windows workflows, as well as develop some new ones. Overall I would say that choosing an OS is very much situational, something that's good for one person may be bad for another and in most cases doing research and trying out each OS you're considering is probably the best way to make a decision.</p>
        <p>Hopefully you learned something 🤞! Did you know I'm currently writing a book? It's all about Lenses and Optics! It takes you all the way from beginner to optics-wizard and it's currently in early access! Consider supporting it, and more posts like this one by pledging on my <a
            href="https://www.patreon.com/bePatron?u=7263362">Patreon page</a>! It takes quite a bit of work to put
        these things together, if I managed to teach your something or even just entertain you for a minute or two
        maybe send a few bucks my way for a coffee? Cheers! 🍻</p>
    <div class="centered"> <a href="https://www.patreon.com/bePatron?u=7263362"><img width="170" height="40" src="data:image/png;base64,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" alt="Become a Patron!"></a></div>
              ]]></content>
      </entry>
</feed>
